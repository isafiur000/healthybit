' Gambas class file

Private $encid As String
Private $rData2 As Result
Private $aMyFields2 As String[]
Private $InvoiceFormat As Boolean

Private $tblpatbilling As String
Private $tblpatlabtest As String
Private $tblpatlabsubtest As String

Public Sub Form_Open()

  Dim xoption As String

  modGeneralMain.ArrangeEmbedForms(Me, Panel1)
  Panel5.Height = Panel1.Height - (Panel2.Height + 5)
  Panel7.Height = Panel1.Height - (Panel2.Height + 5)
  Panel9.Height = Panel1.Height - (Panel2.Height + 5)
  Me.Icon = Picture[modGeneralMain.$strLogo]
  cmbsamtype.List = modBasic.$LabSpecimenList
  If modGlobalSetting.ShowSettingFromDB("GeneralSettings/Laboratory_SampleDateLock") = "No" Then
    dtcurr.Enabled = True
    dtcurr.Value = Now()
  Endif
  modSettings.ShowCheckBox(rbwork, "TestSampling/WorkSheet")
  modSettings.ShowCheckBox(rbbar, "TestSampling/BarCode")
  modSettings.ShowCheckBox(chkall, "TestSampling/ShowAll")
  cmbcategory.List = modMedicine.GetPathoCategoryList("Test")
  cmbcategory.Add("%")
  cmbcategory.Text = modSettings.ShowSettingFromFIle("Laboratory/DefaultDepartment")
  cmbsourcedept.List = modGeneral.GetDepartmentAllList("%")
  dtlisted.Value = Now()
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/Laboratory_DateSelect")
  If xoption = "Yes" Then
    chklist.Value = True
  Else If xoption = "No" Then
    chklist.Value = False
  Endif
  DateSelectionSett()
  ShowInputForm()
  modAccount.PasInvoiceSetting(cmbfiscal, False)
  LoadTableNames()

  If rbencounter.Value = True Then
    modGeneralMain.SetEncIDPrefix(txtencid)
  Else If rbinvoice.Value = True Then
    modGeneralMain.SetInvoicePrefix(txtencid)
  Else If rbindoor.Value = True Then
    modGeneralMain.SetEncIDPrefix(txtencid)
  Endif

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_Activate()

  If Not txtencid.Text Then
    txtencid.SetFocus
  Else If txtencid.Text = modBasic.$EncIdPrefix Then
    txtencid.SetFocus
  Else If txtencid.Text = modBasic.$InvoicePrefix Then
    txtencid.SetFocus
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key["O"] And If Key.Control Then
    btnpic_Click()
  Else If Key.Code = Key["R"] And If Key.Control Then
    btnrefresh_Click()
  Else If Key.Code = Key.F1 Then
    btnsearch_Click()
  Else If Key.Code = Key.F2 Then
    btnseartext_Click()
  Else If Key.Code = Key.F12 Then
    btnupdate_Click()
  Else If Key.Code = Key["A"] And If Key.Control Then
    AddSampling()
  Else If Key.Code = Key["D"] And If Key.Control Then
    DeleteSampling()
  Else If Key.Code = Key["I"] And If Key.Control Then
    btnsampid_Click()
    txtsamid.SetFocus
  Else If Key.Code = Key["W"] And If Key.Control Then
    btnwork_Click()
  Else If Key.Code = Key["Q"] And If Key.Control Then
    btnbarcode_Click()
  Else If Key.Code = Key["F"] And If Key.Control Then
    txtencid.Text = GetEncid()
  Else If Key.Code = Key["X"] And If Key.Control Then
    Me.Close()
  Else If Key.Code = Key["B"] And If Key.Control Then
    Me.Close
    Wait
    modWorkSpace.Add(fmSampling)
  Endif

End

Public Sub Form_Close()

  modSettings.SaveSettingsToFile("Laboratory/DefaultDepartment", cmbcategory.Text)
  modGeneralMain.RecordFormExit(Me)

End

Public Sub btnrefresh_Click()

  Inc Application.Busy
  txtlabbill.Text = ""
  If rbencounter.Value = True Then
    FillSamplingEncounters()
    ShowEncounterTests("")
  Else If rbinvoice.Value = True Then
    FillSamplingInvoices()
    ShowInvoicsTests("")
  Else If rbindoor.Value = True Then
    FillSamplingSaved()
    ShowEncSavedTests("")
  Endif
  ShowSampled("")
  Dec Application.Busy
  ClearSpecimenVal()
  GridView2.SetFocus

End

Private Sub DateSelectionSett()

  If chklist.Value = True Then
    Panel13.Enabled = True
  Else
    Panel13.Enabled = False
  Endif

End

Private Sub ShowInputForm()

  Dim xx As String

  If modBasic.$TestAddSource Then
    If modBasic.$TestAddSource = "Invoice" Then
      rbinvoice.Value = True
      rbencounter.Enabled = False
      btnseartext.Enabled = False
    Else If modBasic.$TestAddSource = "Encounter" Then
      rbencounter.Value = True
      rbinvoice.Enabled = False
      btnseartext.Enabled = True
    Else
      rbencounter.Value = True
      btnseartext.Enabled = True
    Endif

  Else
    xx = modSettings.ShowSettingFromFIle("Laboratory/InputFormat")
    If xx = "Invoice" Then
      rbinvoice.Value = True
    Else If xx = "Saved" Then
      rbindoor.Value = True
    Else
      rbencounter.Value = True
    Endif

  Endif

End

Private Sub LoadTableNames()

  Dim res As Result

  If cmbfiscal.Text = "Current" Then
    $tblpatbilling = "tblpatbilling"
    $tblpatlabtest = "tblpatlabtest"
    $tblpatlabsubtest = "tblpatlabsubtest"
  Else
    res = modDatabase.$myConn.Exec("select fldpatbilling,fldpatbilldetail,fldtempbilldetail,fldpatlabtest,fldpatlabsubtest from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", cmbfiscal.Text, "Active")
    If res.Available Then
      If res["fldpatbilling"] Then
        $tblpatbilling = res["fldpatbilling"]
      Else
        $tblpatbilling = "tblpatbilling"
      Endif
      If res["fldpatlabtest"] Then
        $tblpatlabtest = res["fldpatlabtest"]
      Else
        $tblpatlabtest = "tblpatlabtest"
      Endif
      If res["fldpatlabsubtest"] Then
        $tblpatlabsubtest = res["fldpatlabsubtest"]
      Else
        $tblpatlabsubtest = "tblpatlabsubtest"
      Endif
    Else
      $tblpatbilling = "tblpatbilling"
      $tblpatlabtest = "tblpatlabtest"
      $tblpatlabsubtest = "tblpatlabsubtest"
    Endif
  Endif

End

Public Sub cmbfiscal_Click()

  LoadTableNames()

End

Public Sub rbencounter_Click()

  modSettings.SaveSettingsToFile("Laboratory/InputFormat", "Encounter")

End

Public Sub rbinvoice_Click()

  modSettings.SaveSettingsToFile("Laboratory/InputFormat", "Invoice")

End

Public Sub rbindoor_Click()

  modSettings.SaveSettingsToFile("Laboratory/InputFormat", "Saved")

End

Public Sub chklist_Click()

  modSettings.EnterCheckSetting(chklist, "EntrySetting/Laboratory_DateSelect")
  DateSelectionSett()

End

Public Sub dtneplist_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlisted.Value))
  If xx Then
    dtlisted.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

''---------------------------- sample grids -------------------------
Public Sub cmbcategory_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbcategory)
  modFillContainer.RestrictComboToContent(cmbcategory)

End

Private Sub FillSamplingSaved()

  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&9" & xsource                                               ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &8)) and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&9" & xsource                                                 ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategory.Text, xcomp)
    Endif
  Else
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&7" & xsource                                                 ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&7" & xsource                                                ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, xcomp)
    Endif
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()
  $InvoiceFormat = False

End

Private Sub FillSamplingEncounters()

  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&9" & xsource                                                ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &8)) and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&9" & xsource                                                 ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategory.Text, xcomp)
    Endif
  Else
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&7" & xsource                                                ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&7" & xsource                                                ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, xcomp)
    Endif
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()
  $InvoiceFormat = False

End

Private Sub FillSamplingInvoices()

  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and " & xstr & "&9" & xsource                                                ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &8)) and flditemqty>fldretqty and " & xstr & "&9" & xsource                                              ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategory.Text, xcomp)
    Endif
  Else
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and " & xstr & "&7" & xsource                                               ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and flditemqty>fldretqty and " & xstr & "&7" & xsource                                               ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, xcomp)
    Endif
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()
  $InvoiceFormat = True

End

Private Sub FillSamplingSelectedSaved(encid As String)

  Dim sql As String

  If cmbcategory.Text = "%" Then
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NULL"                                                                         ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", encid)
  Else
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NULL"                                                                         ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, encid)
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()
  $InvoiceFormat = False

End

Private Sub FillSamplingSelectedEncounter(encid As String)

  Dim sql As String

  If cmbcategory.Text = "%" Then
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NOT NULL"                                                                         ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", encid)
  Else
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NOT NULL"                                                                         ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, encid)
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()
  $InvoiceFormat = False

End

Private Sub FillSamplingSelectedInvoices(xbillNo As String)

  Dim sql As String

  If cmbcategory.Text = "%" Then
    sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldbillno=&7 and flditemqty>fldretqty"                                                                         ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", xbillNo)
  Else
    sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and fldbillno=&7 and flditemqty>fldretqty"                                                                         ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, xbillNo)
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()
  $InvoiceFormat = True

End

Private Sub SHowPatientGrid()

  With GridView2
    .Columns[0].Width = 125 * modBasic.$AppWidthRatio
    .Columns[1].Width = 10 * modBasic.$AppWidthRatio
    .Columns[2].Width = 175 * modBasic.$AppWidthRatio
    .Columns[3].Width = 75 * modBasic.$AppWidthRatio
    .Columns[4].Width = 125 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio

    If rbencounter.Value = True Then
      .Columns[0].Text = "EncID"
    Else If rbinvoice.Value = True Then
      .Columns[0].Text = "Invoice"
    Else If rbindoor.Value = True Then
      .Columns[0].Text = "EncID"
    Endif
    .Columns[2].Text = "Name"
    .Columns[3].Text = "Sender"
    .Columns[4].Text = "EncID"
    .Columns[5].Text = "Location"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData2.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 1 Then
    GridView2.Data.Text = ""
    GridView2.Data.Background = modPatient.GetPatientColor($rData2[$aMyFields2[Column]])
  Else If Column = 2 Then
    GridView2.Data.Text = modPatient.GetPatientNameByEnc($rData2[$aMyFields2[Column]])
  Else If Column = 5 Then
    GridView2.Data.Text = modPatient.GetPatientLocation($rData2[$aMyFields2[Column]])
  Else
    GridView2.Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End

Public Sub btnsearch_Click()

  Dim enc As String
  Dim xlast As String
  Dim xbillno As String

  If rbencounter.Value = True Then
    If modBasic.$AutoEncounterF1 = "Yes" Then
      xlast = modSettings.ShowLogValues("LastValue/Encounter")
    Else
      xlast = ""
    Endif

    If modBasic.$AutoEncPrefix Then
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix & xlast)
    Else
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), xlast)
    Endif
    If enc Then
      txtlabbill.Text = ""
      FillSamplingSelectedEncounter(Trim(enc))
      ShowEncounterTests(Trim(enc))
    Endif

  Else If rbinvoice.Value = True Then
    xbillno = InputBox(("Laboratory Invoice No"), ("Search Patient"), "")
    If xbillno Then
      txtlabbill.Text = ""
      FillSamplingSelectedInvoices(Trim(xbillno))
      ShowInvoicsTests(Trim(xbillno))
    Endif

  Else If rbindoor.Value = True Then
    If modBasic.$AutoEncounterF1 = "Yes" Then
      xlast = modSettings.ShowLogValues("LastValue/Encounter")
    Else
      xlast = ""
    Endif

    If modBasic.$AutoEncPrefix Then
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix & xlast)
    Else
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), xlast)
    Endif
    If enc Then
      txtlabbill.Text = ""
      FillSamplingSelectedSaved(Trim(enc))
      ShowEncSavedTests(Trim(enc))
    Endif

  Endif
  ShowSampled("")
  ClearSpecimenVal()
  GridView3.SetFocus

End

Public Sub btnseartext_Click()

  Dim xname As String[]
  Dim sql As String

  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  If xname Then
    If cmbcategory.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &7 and lower(fldptnamelast) like &8)) and flditemqty>fldretqty"                                                                         ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", "%", LCase(xname[0]), LCase(xname[1]))
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &6)) and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &7 and lower(fldptnamelast) like &2)) and flditemqty>fldretqty"                                                                         ''
      $rData2 = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", cmbcategory.Text, LCase(xname[0]), LCase(xname[1]))
    Endif

    rbencounter.Value = True
    $InvoiceFormat = False
    txtlabbill.Text = ""

    $aMyFields2 = New String[]
    modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
    SHowPatientGrid()
    ShowEncounterTests("")
    ShowSampled("")
    ClearSpecimenVal()
    GridView3.SetFocus

  Endif

End

Public Sub GridView2_Click()

  If GridView2.Rows.Selection.Count > 0 Then
    txtlabbill.Text = ""
    If $InvoiceFormat = True Then
      ShowInvoicsTests(GridView2[GridView2.Row, 0].Text)
    Else
      If rbencounter.Value = True Then
        ShowEncounterTests(GridView2[GridView2.Row, 0].Text)
      Else If rbindoor.Value = True Then
        ShowEncSavedTests(GridView2[GridView2.Row, 0].Text)
      Endif
    Endif
    btnpayto.Tag = modBillings.GetPayableUserSetting("Test", GridView2[GridView2.Row, 4].Text)
    If btnpayto.Tag Then
      btnpayto.Text = modGeneral.GetUserFullName(btnpayto.Tag)
    Endif
    If modBasic.$PayableLockEntry = "Yes" Then
      btnpayto.Enabled = False
    Endif
    txtcolor.Background = modPatient.GetPatientColor(GridView2[GridView2.Row, 4].Text)
    ShowSampled("")
    ClearSpecimenVal()
    GridView3.SetFocus
  Endif

End

Public Sub GridView2_KeyRelease()

  If GridView2.Rows.Selection.Count > 0 Then
    If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
      GridView2_Click()
    Endif
  Endif

End

Private Sub ShowEncSavedTests(encid As String)

  Dim sql As String
  Dim res As Result

  If chklist.Value = True Then
    If cmbcategory.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and fldtime>=&7 and fldtime<=&8 and flditemqty>fldretqty and fldbillno IS NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and fldtime>=&7 and fldtime<=&8 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &9)) and flditemqty>fldretqty and fldbillno IS NULL"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", encid, True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategory.Text)

  Else
    If cmbcategory.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty and fldbillno IS NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &7)) and flditemqty>fldretqty and fldbillno IS NULL"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", encid, True, modBasic.$compID, "%", cmbcategory.Text)

  Endif
  ShowLeftGridView(res)

End

Private Sub ShowEncounterTests(encid As String)

  Dim sql As String
  Dim res As Result

  If chklist.Value = True Then
    If cmbcategory.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and fldtime>=&7 and fldtime<=&8 and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and fldtime>=&7 and fldtime<=&8 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &9)) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", encid, True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategory.Text)

  Else
    If cmbcategory.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &7)) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", encid, True, modBasic.$compID, "%", cmbcategory.Text)

  Endif
  ShowLeftGridView(res)

End

Private Sub ShowInvoicsTests(xbillNo As String)

  Dim sql As String
  Dim res As Result

  If chklist.Value = True Then
    If cmbcategory.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and fldtime>=&7 and fldtime<=&8 and flditemqty>fldretqty"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and fldtime>=&7 and fldtime<=&8 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &9)) and flditemqty>fldretqty"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", xbillNo, True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategory.Text)

  Else
    If cmbcategory.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &7)) and flditemqty>fldretqty"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", xbillNo, True, modBasic.$compID, "%", cmbcategory.Text)

  Endif
  ShowLeftGridView(res)

End

Private Sub ShowLeftGridView(res As Result)

  Dim Column As Integer
  Dim fld As ResultField

  GridView3.Clear
  GridView3.Columns.Count = res.Fields.Count
  GridView3.Rows.Count = res.Count

  With GridView3
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 225 * modBasic.$AppWidthRatio
    .Columns[1].Width = 25 * modBasic.$AppWidthRatio
    .Columns[2].Width = 1
    .Columns[3].Width = 1
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio
    .Columns[0].Text = "Test Name"
    .Columns[4].Text = "DateTime"
  End With

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView3, res.Index, Column)
      If Column = 0 Then
        GridView3[res.Index, Column].Text = res[fld.Name]
        GridView3.Rows[res.Index].Height = Max(GridView3.Rows[res.Index].Height, GridView3[res.Index, Column].Font.RichTextHeight(GridView3[res.Index, Column].Text, GridView3.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView3.Rows.Height - GridView3.Font.Height))
      Else If Column = 1 Then
        GridView3[res.Index, Column].Tag = res[fld.Name]
        GridView3[res.Index, Column].Picture = Picture[GetPresenceIcon(res[fld.Name])]
      Else If Column = 4 Then
        GridView3[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldtime"], gb.GeneralDate)
      Else
        GridView3[res.Index, Column].Text = res[fld.Name]
      Endif
      GridView3[res.Index, Column].WordWrap = True

      Column = Column + 1
    Next
  Next
  GridView3.Row = 0

End

Private Function GetPresenceIcon(sText As String) As String

  Dim sval As String

  If sText Then
    sval = "icon:/small/info"
  Else
    sText = ""
  Endif
  Return sval

End

Public Sub GridView3_Click()

  If GridView3.Column = 1 Then
    If GridView3[GridView3.Row, 1].Tag Then
      Message.Info(GridView3[GridView3.Row, 1].Tag)
    Endif
  Endif

End

Public Sub GridView3_Menu()

  mnutree.Popup

End

Public Sub btnexpotree_Click()

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim sql As String
  Dim res As Result
  Dim xcomp As String

  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif

  Inc Application.Busy
  $BillingReport = New CReportHTML([("Encounter"), ("PatientName"), ("Age/Sex"), ("Particulars"), ("Remarks")], " ", "")
  $BillingReport.UserData.Add("TEST REQUESTS", "PARAM1")
  $BillingReport.UserData.Add("Category : " & cmbcategory.Text, "PARAM2")

  If cmbcategory.Text = "%" Then
    sql = "select distinct(fldencounterval) from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldordcomp like &6 and flditemqty>fldretqty"
  Else
    sql = "select distinct(fldencounterval) from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldordcomp like &6 and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &7)) and flditemqty>fldretqty"
  Endif
  res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", True, modBasic.$compID, "%", xcomp, cmbcategory.Text)

  If res.Available Then
    For Each res
      With asx
        .Add(res!fldencounterval)
        .Add(modPatient.GetPatientNameByEnc(res!fldencounterval))
        .Add(modPatient.GetPatientAgeString(res!fldencounterval, Now()) & "/" & modPatient.GetPatientSex(res!fldencounterval))
        .Add(GetTestListForSample(res!fldencounterval).Join("; "))
        .Add("")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next
  Endif

  Dec Application.Busy
  modControlSub.OpenHTMLPreview("", $BillingReport.NewHTMLPath(), "ReportSize")

End

Private Sub GetTestListForSample(encid As String) As String[]

  Dim xx As String[]
  Dim sql As String
  Dim res As Result

  If cmbcategory.Text = "%" Then
    sql = "select flditemname from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty"
  Else
    sql = "select flditemname from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgrouptest where fldtestid in(select fldtestid from tbltest where fldcategory like &7)) and flditemqty>fldretqty"
  Endif
  res = modDatabase.$myConn.Exec(sql, "Diagnostic Tests", "Waiting", encid, True, modBasic.$compID, "%", cmbcategory.Text)
  xx = modControlSub.GetDirectFillresult(res)
  Return xx

End

Private Sub AddSamplingAll()

  Dim res As Result
  Dim res1 As Result
  Dim j As Integer
  Dim res2 As Result
  Dim Row As Integer

  If GridView3.Rows.Count Then
    If $InvoiceFormat = True Then
      $encid = GridView3[0, 3].Text
      BasicInfoPatient()
      txtlabbill.Text = GridView2[GridView2.Row, 0].Text
    Else
      $encid = GridView3[0, 3].Text
      BasicInfoPatient()
      txtlabbill.Text = ""
    Endif

    Inc Application.Busy
    For Row = 0 To GridView3.Rows.Count - 1
      res2 = modDatabase.$myConn.Exec("select flditemqty,fldretqty,fldbillno,fldrefer,fldreason from " & $tblpatbilling & " where fldid=&1 and flditemqty>&2", GridView3[Row, 2].Text, 0)
      If res2["flditemqty"] > res2["fldretqty"] Then
        res = modDatabase.$myConn.Exec("select distinct(fldtestid) as fldtestid,fldtesttype,fldactive from tblgrouptest where fldgroupname=&1", GridView3[Row, 0].Text)
        If res.Available = True Then

          modDatabase.$myConn.Begin
          For Each res
            For j = 1 To (res2["flditemqty"] - res2["fldretqty"])
              modLabSub.InsertLabTestOrder(GridView3[Row, 3].Text, res["fldtestid"], res["fldtesttype"], res["fldactive"], GridView3[Row, 2].Text, modGeneral.GetUserFullNamePrint(res2["fldrefer"]), res2["fldbillno"], res2["fldreason"])
            Next
          Next
          If $InvoiceFormat = True Then
            txtencid.Text = GridView2[GridView2.Row, 0].Text
          Else
            txtencid.Text = GridView2[GridView2.Row, 0].Text
          Endif
          res1 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView3[Row, 2].Text)
          res1["fldtarget"] = modBasic.$compID
          res1["fldsample"] = "Sampled"
          res1["fldpayto"] = btnpayto.Tag
          res1["fldhostmac"] = modHelpVariable.$MACAddress
          res1["xyz"] = False
          res1.Update()
          modDatabase.$myConn.Commit

        Endif
      Endif
    Next
    Dec Application.Busy

    If $InvoiceFormat = True Then
      ShowSampledBill($encid, txtlabbill.Text)
      ShowInvoicsTests(GridView2[GridView2.Row, 0].Text)
    Else
      ShowSampled($encid)
      If rbencounter.Value = True Then
        ShowEncounterTests(GridView2[GridView2.Row, 0].Text)
      Else If rbindoor.Value = True Then
        ShowEncSavedTests(GridView2[GridView2.Row, 0].Text)
      Endif
    Endif

  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

Private Sub AddSampling()

  Dim res As Result
  Dim res1 As Result
  Dim j As Integer
  Dim res2 As Result

  If GridView3.Rows.Selection.Count > 0 Then
    res2 = modDatabase.$myConn.Exec("select flditemqty,fldretqty,fldbillno,fldrefer,fldreason from " & $tblpatbilling & " where fldid=&1 and flditemqty>&2", GridView3[GridView3.Row, 2].Text, 0)
    If res2["flditemqty"] > res2["fldretqty"] Then
      res = modDatabase.$myConn.Exec("select distinct(fldtestid) as fldtestid,fldtesttype,fldactive from tblgrouptest where fldgroupname=&1", GridView3[GridView3.Row, 0].Text)
      If res.Available = True Then

        Inc Application.Busy
        modDatabase.$myConn.Begin
        For Each res
          For j = 1 To (res2["flditemqty"] - res2["fldretqty"])
            modLabSub.InsertLabTestOrder(GridView3[GridView3.Row, 3].Text, res["fldtestid"], res["fldtesttype"], res["fldactive"], GridView3[GridView3.Row, 2].Text, modGeneral.GetUserFullNamePrint(res2["fldrefer"]), res2["fldbillno"], res2["fldreason"])
          Next
        Next
        If $InvoiceFormat = True Then
          txtencid.Text = GridView2[GridView2.Row, 0].Text
        Else
          txtencid.Text = GridView2[GridView2.Row, 0].Text
        Endif
        res1 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView3[GridView3.Row, 2].Text)
        res1["fldtarget"] = modBasic.$compID
        res1["fldsample"] = "Sampled"
        res1["fldpayto"] = btnpayto.Tag
        res1["fldhostmac"] = modHelpVariable.$MACAddress
        res1["xyz"] = False
        res1.Update()
        modDatabase.$myConn.Commit
        Dec Application.Busy

      Endif

      If $InvoiceFormat = True Then
        $encid = GridView3[GridView3.Row, 3].Text
        BasicInfoPatient()
        txtlabbill.Text = GridView2[GridView2.Row, 0].Text
        ShowSampledBill($encid, txtlabbill.Text)
        ShowInvoicsTests(GridView2[GridView2.Row, 0].Text)
      Else
        $encid = GridView3[GridView3.Row, 3].Text
        BasicInfoPatient()
        txtlabbill.Text = ""
        ShowSampled($encid)
        If rbencounter.Value = True Then
          ShowEncounterTests(GridView2[GridView2.Row, 0].Text)
        Else If rbindoor.Value = True Then
          ShowEncSavedTests(GridView2[GridView2.Row, 0].Text)
        Endif
      Endif
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

Private Sub DeleteSampling()

  Dim res As Result
  Dim xmsg As String
  Dim xcashcrd As Float

  xmsg = InputBox("Reason for Cancellation", "Laboratory", "")
  If GridView3.Rows.Selection.Count > 0 Then
    If xmsg Then

      If modBasic.$BillAutoReturn = "No" Then
        Message.Warning("Not allowed", "OK")
      Else
        Inc Application.Busy
        modDatabase.$myConn.Begin
        res = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView3[GridView3.Row, 2].Text)
        If res.Available = True Then
          If res["fldcashincredit"] Then
            xcashcrd = res["fldcashincredit"]
          Else
            xcashcrd = 0
          Endif
          modBillings.InsertBlankBillItemNewApp(res["fldencounterval"], res["fldbilltype"], res["fldbillingmode"], res["flddisctype"], res["fldacledger"], res["flditemtype"], res["flditemno"], res["flditemname"], res["flditemrate"], 0 - res["flditemqty"], res["fldtaxper"], res["flddiscper"], xcashcrd, "Done", res["fldid"], True, False, res["fldtarget"], res["fldpayto"], res["fldrefer"], Trim(xmsg), res["fldbillno"])
          res["fldsample"] = "Removed"
          res["fldretqty"] = res["flditemqty"]
          res["xyz"] = False
          res.Update()
        Endif
        modDatabase.$myConn.Commit
        Dec Application.Busy
      Endif

      If $InvoiceFormat = True Then
        ShowInvoicsTests(GridView2[GridView2.Row, 0].Text)
      Else
        If rbencounter.Value = True Then
          ShowEncounterTests(GridView2[GridView2.Row, 0].Text)
        Else If rbindoor.Value = True Then
          ShowEncSavedTests(GridView2[GridView2.Row, 0].Text)
        Endif
      Endif
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

Public Sub mnuadd_Click()

  AddSampling()

End

Public Sub mnudel_Click()

  DeleteSampling()

End

Public Sub btnaddin_Click()

  If chkselall.Value = True Then
    AddSamplingAll()
  Else
    AddSampling()
  Endif

End

Public Sub mnutransf_Click()

  Dim res As Result
  Dim xx As String

  If GridView3.Rows.Selection.Count > 0 Then
    xx = InputCombo(("Enter Target Location"), ("Transfer"), modBasic.$AllCompList, "", True)
    If xx Then
      res = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView3[GridView3.Row, 2].Text)
      res["fldtarget"] = xx
      res["xyz"] = False
      res.Update()
      If xx <> modBasic.$compID Then
        If $InvoiceFormat = True Then
          ShowInvoicsTests(GridView2[GridView2.Row, 0].Text)
        Else
          If rbencounter.Value = True Then
            ShowEncounterTests(GridView2[GridView2.Row, 0].Text)
          Else If rbindoor.Value = True Then
            ShowEncSavedTests(GridView2[GridView2.Row, 0].Text)
          Endif
        Endif
      Endif
    Endif
  Endif

End

Public Sub btnpayto_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  If xMedUser And If xMedUser.Count Then
    btnpayto.Tag = xMedUser[0]
    btnpayto.Text = xMedUser[1]
  Else
    btnpayto.Tag = ""
    btnpayto.Text = ""
  Endif

End

''------------------------------------------ patient profile -------------------------------------
Public Sub btngetsample_Click()

  Dim xsampNo As String

  xsampNo = InputBox("Required Sample ID", "Search", "")
  If xsampNo Then
    txtlabbill.Text = ""
    $InvoiceFormat = False
    $encid = modLabTest.GetEncounterFromSampleID(xsampNo, $tblpatlabtest)
    BasicInfoPatient()
    ShowSampledDone(xsampNo)
  Endif

End

Public Sub btnshow_Click()

  If Not txtencid.Text Then Return
  If modBasic.$EncIdPrefix And If txtencid.Text = modBasic.$EncIdPrefix Then
    txtencid.SetFocus
    Return
  Endif

  If txtencid.Text Then
    If rbencounter.Value = True Then
      txtlabbill.Text = ""
      $InvoiceFormat = False
      $encid = Trim(txtencid.Text)
      BasicInfoPatient()
      ShowSampled($encid)
    Else If rbinvoice.Value = True Then
      txtlabbill.Text = Trim(txtencid.Text)
      $InvoiceFormat = True
      $encid = modNonMedical.GetEncounterFromBillNo(txtencid.Text, cmbfiscal.Text)
      BasicInfoPatient()
      ShowSampledBill($encid, txtlabbill.Text)
    Else If rbindoor.Value = True Then
      txtlabbill.Text = ""
      $InvoiceFormat = False
      $encid = Trim(txtencid.Text)
      BasicInfoPatient()
      ShowSampled($encid)
    Endif
  Endif

End

Private Sub BasicInfoPatient()

  Dim xstatus As String

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)
  txtpatientaddress.Text = modPatient.GetPatientAddressByEnc($encid)

  xstatus = modPatient.CurrentAdmissionStatus($encid)
  txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
  lsticdisease.List = modPathoSub.GetProvisionalDiagnosisList($encid)
  modAppSupport.RecordPatientActivity("Patient Data", Me.Name, "EncounterID", $encid)

  btnupdate.Enabled = False
  modImage.ShowPhotoSplash("Patient", modPatient.GetPatientNoByEnc($encid))
  cmbsamtype.Text = ""
  txtsamid.Text = ""

End

Public Sub btnpic_Click()

  Dim hForm As FmPersonImage

  If $encid Then
    hForm = New FmPersonImage("Patient", modPatient.GetPatientNoByEnc($encid), False)
    hForm.ShowModal
  Endif

End

Public Sub btndemog_Click()

  Dim hForm As FmPatdemograph

  If $encid Then
    hForm = New FmPatdemograph($encid, "Clinical")
    hForm.ShowModal
  Endif

End

Public Sub btndiagnohelp_Click()

  Dim hCls As CReportCustom

  If $encid Then
    If modSettings.ShowSettingFromFIle("Diagnostic Help/Name") Then
      hCls = New CReportCustom($encid, "Diagnostic Help", "ReportSize", MMain.$defUnit)
      hCls.Preview()
    Endif
  Endif

End

Public Sub cmbsamtype_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbsamtype)
  If modBasic.$LabLockSpecimen = "No" Then
  Else
    modFillContainer.RestrictComboToContent(cmbsamtype)
  Endif

End

'''------------------------------------------ added tests -------------------------------------------
Private Sub ShowSampledDone(xSampNo As String)

  Dim sql As String
  Dim res As Result

  If chkall.Value = True Then
    sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start from " & $tblpatlabtest & " where (fldstatus=&1 or fldstatus=&2) and fldsampleid=&3 and fldcomp_sample=&4 ORDER BY fldsampleid,fldid"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", xSampNo, modBasic.$compID)
  Else
    sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start from " & $tblpatlabtest & " where fldstatus=&1 and fldsampleid=&2 and fldcomp_sample=&3 ORDER BY fldsampleid,fldid"
    res = modDatabase.$myConn.Exec(sql, "Ordered", xSampNo, modBasic.$compID)
  Endif
  FillSamplingGrid(res)

End

Private Sub ShowSampled(encid As String)

  Dim sql As String
  Dim res As Result

  If chkall.Value = True Then
    sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start from " & $tblpatlabtest & " where (fldstatus=&1 or fldstatus=&2) and fldencounterval=&3 and fldcomp_sample=&4 ORDER BY fldsampleid,fldid"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", encid, modBasic.$compID)
  Else
    sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start from " & $tblpatlabtest & " where fldstatus=&1 and fldencounterval=&2 and fldcomp_sample=&3 ORDER BY fldsampleid,fldid"
    res = modDatabase.$myConn.Exec(sql, "Ordered", encid, modBasic.$compID)
  Endif
  FillSamplingGrid(res)

End

Private Sub ShowSampledBill(encid As String, billno As String)

  Dim sql As String
  Dim res As Result

  If chkall.Value = True Then
    sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start from " & $tblpatlabtest & " where (fldstatus=&1 or fldstatus=&2) and fldencounterval=&3 and fldcomp_sample=&4 and fldbillno=&5 ORDER BY fldsampleid,fldid"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", encid, modBasic.$compID, billno)
  Else
    sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start from " & $tblpatlabtest & " where fldstatus=&1 and fldencounterval=&2 and fldcomp_sample=&3 and fldbillno=&4 ORDER BY fldsampleid,fldid"
    res = modDatabase.$myConn.Exec(sql, "Ordered", encid, modBasic.$compID, billno)
  Endif
  FillSamplingGrid(res)

End

Private Sub FillSamplingGrid(res As Result)

  Dim Column As Integer
  Dim fld As ResultField
  Dim Row As Integer

  GridView1.Clear
  GridView1.Columns.Count = res.Fields.Count
  GridView1.Rows.Count = res.Count

  With GridView1
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 25 * modBasic.$AppWidthRatio
    .Columns[2].Width = 125 * modBasic.$AppWidthRatio
    .Columns[3].Width = 225 * modBasic.$AppWidthRatio
    .Columns[4].Width = 125 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio
    .Columns[6].Width = 150 * modBasic.$AppWidthRatio
    .Columns[7].Width = 1
    .Columns[8].Width = 120 * modBasic.$AppWidthRatio
    .Columns[9].Width = 1
    .Columns[10].Width = 1
    .Columns[11].Width = 150 * modBasic.$AppWidthRatio

    .Columns[2].Text = "Account"
    .Columns[3].Text = "Test Name"
    .Columns[4].Text = "Specimen"
    .Columns[5].Text = "SampleID"
    .Columns[6].Text = "SampleDate"
    .Columns[8].Text = "Referral"
    .Columns[11].Text = "LoadDate"
  End With

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView1, res.Index, Column)
      If Column = 1 Then
        GridView1[res.Index, Column].Picture = Picture["icons/unchecked.png"]
        GridView1[res.Index, Column].Text = ""
      Else If Column = 2 Then
        GridView1[res.Index, Column].Text = modNonMedical.GetBillingItemFromID(res[fld.Name], $tblpatbilling)
      Else If Column = 6 Then
        GridView1[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldtime_sample"], gb.GeneralDate)
      Else If Column = 11 Then
        GridView1[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldtime_start"], gb.GeneralDate)
      Else
        GridView1[res.Index, Column].Text = res[fld.Name]
      Endif
      GridView1.Rows[res.Index].Height = Max(GridView1.Rows[res.Index].Height, GridView1[res.Index, Column].Font.RichTextHeight(GridView1[res.Index, Column].Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
      GridView1[res.Index, Column].WordWrap = True

      Column = Column + 1
    Next
  Next
  For Row = 0 To GridView1.Rows.Count - 1
    If GridView1[Row, 11].Text Then
      GridView1[Row, 6].Picture = Picture["icons/coll4.png"]
    Endif
  Next
  GridView1.Row = 0

End

Public Sub GridView1_Click()

  Dim xsample As String
  Dim xx As String
  Dim xRow As Integer

  If GridView1.Column = 4 Then
    If modBasic.$LabLockSpecimen = "No" Then
      xx = GetTextArea(("Test Specimen"), GridView1[GridView1.Row, 4].Text)
    Else
      xx = InputCombo(("Test Specimen"), GridView1[GridView1.Row, 3].Text, modBasic.$LabSpecimenList, GridView1[GridView1.Row, 4].Text, True)
    Endif
    If Trim(xx) Then
      xRow = GridView1.Row
      modLabSub.UpdateSpecimenTest(GridView1[GridView1.Row, 0].Text, Trim(xx))
      If $InvoiceFormat = True Then
        ShowSampledBill(Trim(txtencid.Text), txtlabbill.Text)
      Else
        ShowSampled(Trim(txtencid.Text))
      Endif
      GridView1.Row = xRow
    Endif

  Else
    xsample = GridView1[GridView1.Row, 4].Text
    If Not xsample Then
      xsample = modFixLab.GetTestSpecimen(GridView1[GridView1.Row, 3].Text)
    Endif

    If GridView1[GridView1.Row, 5].Text Then
      txtsamid.Text = GridView1[GridView1.Row, 5].Text
    Endif

    cmbsamtype.Text = xsample
    modGridView.CheckUncheckGridNoDB(GridView1, 1)
    btnupdate.Enabled = True
  Endif

End

Public Sub GridView1_Menu()

  mnuhide.Popup

End

Public Sub btnsampid_Click()

  If Not txtsamid.Text Then
    If cmbsamtype.Text And If GridView1.Rows.Count > 0 Then
      txtsamid.Text = modLabSub.GetAutoIncreasingNo()
    Endif
  Endif

End

Public Sub btnclrsamid_Click()

  txtsamid.Text = ""

End

Public Sub btnaddspecimen_Click()

  Dim hForm As FmAddVariableGrid

  hForm = New FmAddVariableGrid("fldsampletype", "tblsampletype")
  hForm.ShowModal
  modBasic.LoadLabRadioList()
  cmbsamtype.List = modBasic.$LabSpecimenList

End

Public Sub btnclrspec_Click()

  cmbsamtype.Text = ""

End

Public Sub btnupdate_Click()

  Dim Row As Integer
  Dim res As Result
  Dim xxx As String[]
  Dim xallow As Boolean
  Dim xRow As Integer
  Dim xspec As String
  Dim txtsampno As String
  Dim xorder As Integer

  If modBasic.$LabAutoSampleID = "Yes" Then
    If GridView1.Rows.Count > 0 Then
      If Not txtsamid.Text Then
        txtsamid.Text = modLabSub.GetAutoIncreasingNo()
      Endif
    Endif
  Endif

  If txtsamid.Text Then
    xRow = GridView1.Row

    Inc Application.Busy
    For Row = 0 To GridView1.Rows.Count - 1
      If GridView1[Row, 1].Picture = Picture["icons/checked.png"] Then

        If modBasic.$LabAutoSampleSuffix = "Yes" Then
          txtsampno = Trim(txtsamid.Text) & modFixLab.GetTestSampleSuffix(GridView1[Row, 3].Text)
        Else
          txtsampno = Trim(txtsamid.Text)
        Endif
        xorder = modFixLab.GetLabTestOrder(GridView1[Row, 3].Text)

        xallow = modLabTest.AllowSampleID($encid, txtsampno)
        If xallow = True Then

          If modBasic.$LabAutoSpecimen = "Yes" Then
            xspec = modFixLab.GetTestSpecimen(GridView1[Row, 3].Text)
            If Not xspec Then
              xspec = Trim(cmbsamtype.Text)
            Endif
            modLabSub.UpdateLabTestSample(GridView1[Row, 0].Text, txtsampno, xspec, "", "", "", "", xorder,, $tblpatlabtest)
          Else
            If cmbsamtype.Text Then
              If dtcurr.Value Then
                modLabSub.UpdateLabTestSample(GridView1[Row, 0].Text, txtsampno, Trim(cmbsamtype.Text), "", "", "", "", xorder, dtcurr.Value, $tblpatlabtest)
              Else
                modLabSub.UpdateLabTestSample(GridView1[Row, 0].Text, txtsampno, Trim(cmbsamtype.Text), "", "", "", "", xorder,, $tblpatlabtest)
              Endif
            Endif
          Endif

          res = modDatabase.$myConn.Exec("select fldsubtest from " & $tblpatlabsubtest & " where fldtestid=&1", GridView1[Row, 0].Text)
          If res.Available = False Then
            Select modFixLab.GetLabTestOptionType(GridView1[Row, 3].Text)
              Case "Fixed Components", "Left/Right Components"
                xxx = modFixLab.GetSubTestArray(GridView1[Row, 3].Text)     'modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldsubtest) as col from tbltestquali where fldtestid=&1", GridView1[Row, 3].Text))
                If xxx.Count Then
                  modLabSub.InsertLabSubTest(GridView1[Row, 10].Text, GridView1[Row, 0].Text, GridView1[Row, 3].Text, xxx, $tblpatlabsubtest)
                Endif
            End Select
          Endif

        Else
          Message.Warning(("Same Sample ID for different patients not possible"), ("OK"))
        Endif

      Endif
    Next
    Dec Application.Busy

    If rbbar.Value = True Then
      btnbarcode_Click()
    Endif
    If rbwork.Value = True Then
      btnwork_Click()
    Endif
    If modBasic.$AutoSampleLoad = "All" Then
      LoadSpecimens()
    Else If modBasic.$AutoSampleLoad = "Machine" Then
      LoadSpecimensMachine()
    Endif
    If rbinvoice.Value = True Then
      ShowSampledBill($encid, txtlabbill.Text)
    Else If rbencounter.Value = True Then
      ShowSampled($encid)
    Else If rbindoor.Value = True Then
      ShowSampled($encid)
    Endif
    If chkall.Value = True Then
      GridView1.Row = xRow
    Endif
    Balloon.Info(("Information updated"), btnupdate)
    Balloon.Delay = modBasic.$BalloonDelay

  Endif

End

Public Sub mnuselall_Click()

  Dim i As Integer
  Dim xsample As String

  If modBasic.$LabAutoSpecimen = "Yes" Then
    For i = 0 To GridView1.Rows.Count - 1
      If Not GridView1[i, 4].Text Then
        If Not xsample Then
          xsample = modFixLab.GetTestSpecimen(GridView1[i, 3].Text)
          If xsample Then
            GridView1[i, 1].Picture = Picture["icons/checked.png"]
            cmbsamtype.Text = xsample
          Endif
        Endif
        If xsample Then
          If modFixLab.GetTestSpecimen(GridView1[i, 3].Text) = xsample Then
            GridView1[i, 1].Picture = Picture["icons/checked.png"]
          Endif
        Endif
      Endif
    Next

  Else
    For i = 0 To GridView1.Rows.Count - 1
      If Not GridView1[i, 5].Text Then
        GridView1[i, 1].Picture = Picture["icons/checked.png"]
      Endif
    Next
  Endif

  btnupdate.Enabled = True
  ' cmbsamtype.SetFocus

End

Public Sub mnudesel_Click()

  Dim i As Integer

  For i = 0 To GridView1.Rows.Count - 1
    GridView1[i, 1].Picture = Picture["icons/unchecked.png"]
  Next
  btnupdate.Enabled = False

End

Private Sub ClearSpecimenVal()

  cmbsamtype.Text = ""
  txtsamid.Text = ""

End

Public Sub btnwork_Click()

  Dim categ As String[]
  Dim newCateg As String[]
  Dim xx As String
  Dim i As Integer
  Dim xval As String

  If GridView1.Rows.Count Then

    categ = New String[]
    For i = 0 To GridView1.Rows.Count - 1
      If GridView1[i, 1].Picture = Picture["icons/checked.png"] Then
        xval = modFixLab.GetLabTestCategory(GridView1[i, 3].Text)

        If categ.Count = 0 Then
          categ.Add(xval)
        Else
          If categ.Exist(xval) = False Then
            categ.Add(xval)
          Endif
        Endif

      Endif
    Next
    newCateg = categ

    If modBasic.$LabWorkSheet = "Categorical" Then
      For Each xx In newCateg
        SampleWorkSheet([xx])
      Next
    Else
      SampleWorkSheet(newCateg)
    Endif

  Endif

End

Private Sub SampleWorkSheet(sCategList As String[])

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim i As Integer
  Dim rs As Result
  Dim res As Result
  Dim xval As String

  Dim sCateg As String

  Dim $referName As String[]
  Dim $condiName As String[]
  Dim $sampleID As String[]
  Dim $sampleType As String[]
  Dim $sampleDate As String[]
  Dim $invoiceNo As String[]

  $BillingReport = New CReportHTML([("Test Name"), ("Observations")], "LaboratoryReport", $encid, ["Footer"])
  $BillingReport.UserData.Add("Department: ", "Report")
  $BillingReport.UserData.Add(sCateg, "PARAM1")
  $BillingReport.UserData.Add(txtencid.Text, "SearchVariable")
  $BillingReport.UserData.Add(txtsamid.Text, "SampleID")
  $BillingReport.UserData.Add(cmbsamtype.Text, "Specimen")

  $referName = New String[]
  $condiName = New String[]
  $sampleID = New String[]
  $sampleType = New String[]
  $sampleDate = New String[]
  $invoiceNo = New String[]

  For Each sCateg In sCategList
    $BillingReport.AddSection(sCateg, False)

    For i = 0 To GridView1.Rows.Count - 1
      If GridView1[i, 1].Picture = Picture["icons/checked.png"] And If modFixLab.GetLabTestCategory(GridView1[i, 3].Text) = sCateg Then
        res = modDatabase.$myConn.Exec("select fldtestid,fldmethod,fldsampleid,fldsampletype,fldtest_type,fldrefername,fldcondition,fldtime_sample,fldbillno from " & $tblpatlabtest & " where fldid=&1", GridView1[i, 0].Text)

        $referName.Add(res["fldrefername"])
        $condiName.Add(res["fldcondition"])
        $sampleID.Add(res["fldsampleid"])
        $sampleType.Add(res["fldsampletype"])
        $sampleDate.Add(modReportVar.GetDateTimeReport(res["fldtime_sample"], gb.MediumDate))
        $invoiceNo.Add(res["fldbillno"])

        xval = "<b>" & res!fldtestid & "</b>" & "<br>" & "[" & res!fldmethod & "]"
        If GridView1[i, 7].Text = "Qualitative" Then
          rs = modDatabase.$myConn.Exec("select fldsubtest,fldreport,fldid from " & $tblpatlabsubtest & " where fldtestid=&1", GridView1[i, 0].Text)
          For Each rs
            xval = xval & "<br>" & modString.HTMLBlankSpace(4) & rs!fldsubtest
          Next
        Endif

        With asx
          .Add(xval)
          .Add("")
        End With
        $BillingReport.Add(asx)
        asx.Clear()

      Endif
    Next

  Next

  ''header
  $BillingReport.UserData.Add("", "EXTRA1")
  $BillingReport.UserData.Add("", "EXTRA2")
  $BillingReport.UserData.Add("", "EXTRA3")
  $BillingReport.UserData.Add("", "EXTRA4")
  $BillingReport.UserData.Add("", "EXTRA5")
  $BillingReport.UserData.Add("", "EXTRA6")
  $BillingReport.UserData.Add("", "EXTRA7")
  $BillingReport.UserData.Add("", "EXTRA8")

  If modSettings.ShowSettingFromFIle("Laboratory/Show_ExtraLabel") And If modSettings.ShowSettingFromFIle("Laboratory/Show_ExtraLabel") = "Yes" Then
    If modLabSub.GetLabExtraColumnName("SampleDate") Then
      $BillingReport.UserData.Add("Sampling Date: " & modString.BinaryDistinctStringArray($sampleDate).Join(","), modLabSub.GetLabExtraColumnName("SampleDate"))
    Endif
    If modLabSub.GetLabExtraColumnName("SampleID") Then
      $BillingReport.UserData.Add("Sample No: " & modString.BinaryDistinctStringArray($sampleID).Join(","), modLabSub.GetLabExtraColumnName("SampleID"))
    Endif
    If modLabSub.GetLabExtraColumnName("Specimen") Then
      $BillingReport.UserData.Add("Specimen: " & modString.BinaryDistinctStringArray($sampleType).Join(","), modLabSub.GetLabExtraColumnName("Specimen"))
    Endif
    If modLabSub.GetLabExtraColumnName("ReferBy") Then
      $BillingReport.UserData.Add("Reffered By: " & modString.BinaryDistinctStringArray($referName).Join(","), modLabSub.GetLabExtraColumnName("ReferBy"))
    Endif
    If modLabSub.GetLabExtraColumnName("Condition") Then
      $BillingReport.UserData.Add("Clinical Note: " & modString.BinaryDistinctStringArray($condiName).Join(","), modLabSub.GetLabExtraColumnName("Condition"))
    Endif
    If modLabSub.GetLabExtraColumnName("InvoiceNo") Then
      $BillingReport.UserData.Add("Invoice No: " & modString.BinaryDistinctStringArray($invoiceNo).Join(","), modLabSub.GetLabExtraColumnName("InvoiceNo"))
    Endif

  Else
    If modLabSub.GetLabExtraColumnName("SampleDate") Then
      $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($sampleDate).Join(","), modLabSub.GetLabExtraColumnName("SampleDate"))
    Endif
    If modLabSub.GetLabExtraColumnName("Specimen") Then
      $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($sampleType).Join(","), modLabSub.GetLabExtraColumnName("Specimen"))
    Endif
    If modLabSub.GetLabExtraColumnName("SampleID") Then
      $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($sampleID).Join(","), modLabSub.GetLabExtraColumnName("SampleID"))
    Endif
    If modLabSub.GetLabExtraColumnName("ReferBy") Then
      $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($referName).Join(","), modLabSub.GetLabExtraColumnName("ReferBy"))
    Endif
    If modLabSub.GetLabExtraColumnName("Condition") Then
      $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($condiName).Join(","), modLabSub.GetLabExtraColumnName("Condition"))
    Endif
    If modLabSub.GetLabExtraColumnName("InvoiceNo") Then
      $BillingReport.UserData.Add(modString.BinaryDistinctStringArray($invoiceNo).Join(","), modLabSub.GetLabExtraColumnName("InvoiceNo"))
    Endif

  Endif
  If modLabSub.GetLabExtraColumnName("SampleIDBarCode") Then
    $BillingReport.UserData.Add(modDevAll.GetBarCodeWithOptions(modString.BinaryDistinctStringArray($sampleID)[0]), modLabSub.GetLabExtraColumnName("SampleIDBarCode"))
  Endif
  If modLabSub.GetLabExtraColumnName("SampleIDQRCode") Then
    $BillingReport.UserData.Add(modDevAll.MakeQRCode(modString.BinaryDistinctStringArray($sampleID)[0]), modLabSub.GetLabExtraColumnName("SampleIDQRCode"))
  Endif
  If modLabSub.GetLabExtraColumnName("InvoiceBarCode") Then
    $BillingReport.UserData.Add(modDevAll.GetBarCodeWithOptions(modString.BinaryDistinctStringArray($invoiceNo)[0]), modLabSub.GetLabExtraColumnName("InvoiceBarCode"))
  Endif
  If modLabSub.GetLabExtraColumnName("InvoiceQRCode") Then
    $BillingReport.UserData.Add(modDevAll.MakeQRCode(modString.BinaryDistinctStringArray($invoiceNo)[0]), modLabSub.GetLabExtraColumnName("InvoiceQRCode"))
  Endif

  modControlSub.OpenHTMLPreview($encid, $BillingReport.NewHTMLPath(), "ReportSize")

End

Public Sub rbwork_Click()

  modSettings.EnterCheckSetting(rbwork, "TestSampling/WorkSheet")

End

Public Sub rbbar_Click()

  modSettings.EnterCheckSetting(rbbar, "TestSampling/BarCode")

End

Public Sub btnbarcode_Click()

  Dim i As Integer
  Dim xval As String[]
  Dim xsect As String

  Dim xx As String

  If txtsamid.Text And If $encid Then
    If GridView1.Rows.Count Then

      xval = New String[]
      For i = 0 To GridView1.Rows.Count - 1
        If GridView1[i, 1].Picture = Picture["icons/checked.png"] Then

          If modBasic.$LabBarPrint = "Section" Then
            xsect = modFixLab.GetLabTestCategory(GridView1[i, 3].Text)
          Else If modBasic.$LabBarPrint = "TestName" Then
            xsect = GridView1[i, 3].Text
          Else If modBasic.$LabBarPrint = "BillItem" Or If modBasic.$LabBarPrint = "Section/BillItem" Then
            xsect = GridView1[i, 2].Text
          Else
            xsect = ""
          Endif

          If xsect Then
            If xval.Count = 0 Then
              xval.Add(xsect)
            Else
              If xval.Exist(xsect) = False Then
                xval.Add(xsect)
              Endif
            Endif
          Endif

        Endif
      Next

      If xval.Count Then
        If modBasic.$LabBarPrint = "Section/BillItem" Then
          modLabSub.PrintBarLabDeptSampling($encid, Trim(txtsamid.Text), xval, txtencid.Text)
        Else
          For Each xx In xval
            modLabSub.PrintBarCodeSampling($encid, Trim(txtsamid.Text), cmbsamtype.Text, xx, txtencid.Text)
          Next
        Endif
      Else
        modLabSub.PrintBarCodeSampling($encid, Trim(txtsamid.Text), cmbsamtype.Text, "", txtencid.Text)
      Endif

    Endif
  Endif

End

Public Sub btnpayto_Change()

  If btnpayto.Text = "" Then
    btnpayto.Tag = ""
  Endif

End

Public Sub MessageView1_Open()

  If modBasic.$InfoMusic Then
    Music.Load(modBasic.$InfoMusic)
    If modBasic.$InfoMusicVol Then
      Music.Volume = modBasic.$InfoMusicVol
    Endif
    Music.Play()
  Endif

End

Public Sub MessageView1_Close()

  If modBasic.$InfoMusic Then
    Music.Stop()
  Endif

End

Public Sub chkall_Click()

  modSettings.EnterCheckSetting(chkall, "TestSampling/ShowAll")

End

Public Sub txtsamid_KeyPress()

  modGeneralMain.InputUpCaseOnly()

End

Public Sub txtencid_KeyPress()

  If Key.Code = Key.Down Then
    If Not txtencid.Text Then
      txtencid.Text = PatSearch("Encounter")
      txtencid.SetFocus
    Else
      If modBasic.$AutoEncSuffix = "Yes" Then
        txtencid.Text = txtencid.Text & modBasic.$HospCode
      Endif
    Endif
  Else
    modGeneralMain.InputUpCaseOnly()
  Endif

End

Public Sub btncomment_Click()

  Dim xx As String
  Dim res As Result
  Dim xRow As Integer

  If GridView1.Rows.Selection.Count > 0 Then
    xx = GetTextArea(GridView1[GridView1.Row, 3].Text, GridView1[GridView1.Row, 9].Text)
    If xx Then
      xRow = GridView1.Row
      res = modDatabase.$myConn.Edit($tblpatlabtest, "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldcomment"] = xx
      res["xyz"] = False
      res.Update
      If $InvoiceFormat = True Then
        ShowSampledBill(Trim(txtencid.Text), txtlabbill.Text)
      Else
        ShowSampled(Trim(txtencid.Text))
      Endif
      GridView1.Row = xRow
    Endif
  Endif

End

Public Sub btnrefer_Click()

  Dim res As Result
  Dim xx As String
  Dim xRow As Integer
  Dim reflist As String

  If GridView1.Rows.Selection.Count > 0 Then
    reflist = modSettings.ShowSettingFromFIle("Laboratory/ReferralList")
    If reflist Then
      If Exist(reflist) Then
        xx = InputCombo(("Enter Referral Name"), ("Referral"), modString.GetStringArrayFromFile(reflist), GridView1[GridView1.Row, 8].Text, False)
      Endif
    Else
      xx = InputBox(("Enter Referral Name"), ("Referral"), GridView1[GridView1.Row, 8].Text)
    Endif

    If xx Then
      xRow = GridView1.Row
      res = modDatabase.$myConn.Edit($tblpatlabtest, "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldrefername"] = xx
      res["xyz"] = False
      res.Update
      If $InvoiceFormat = True Then
        ShowSampledBill(Trim(txtencid.Text), txtlabbill.Text)
      Else
        ShowSampled(Trim(txtencid.Text))
      Endif
      GridView1.Row = xRow
    Endif
  Endif

End

Private Sub LoadSpecimensMachine()

  Dim res As Result
  Dim Row As Integer

  For Row = 0 To GridView1.Rows.Count - 1
    If GridView1[Row, 1].Picture = Picture["icons/checked.png"] Then
      If modInterface.$IntfaceTestList And If modInterface.$IntfaceTestList.Exist(GridView1[Row, 3].Text) Then

        res = modDatabase.$myConn.Edit($tblpatlabtest, "fldid=&1 and fldstatus=&2 and fldsampleid like &3", GridView1[Row, 0].Text, "Sampled", "%")
        If res.Available Then
          If res["flduserid_start"] Then
          Else
            modInterface.InsertSampleForInterface(res["fldencounterval"], res["fldtestid"], res["fldsampleid"], res["fldsampletype"])
          Endif
          res["flduserid_start"] = modBasic.$lbluser
          If res["fldtime_start"] Then
            res["flduptime_start"] = Now()
          Else
            res["fldtime_start"] = Now()
          Endif
          res["fldcomp_start"] = modBasic.$compID
          res["fldsave_start"] = True
          res["xyz"] = True
          res.Update
        Endif

      Endif
    Endif
  Next

End

Private Sub LoadSpecimens()

  Dim res As Result
  Dim Row As Integer

  For Row = 0 To GridView1.Rows.Count - 1
    If GridView1[Row, 1].Picture = Picture["icons/checked.png"] Then
      res = modDatabase.$myConn.Edit($tblpatlabtest, "fldid=&1 and fldstatus=&2 and fldsampleid like &3", GridView1[Row, 0].Text, "Sampled", "%")
      If res.Available Then
        If res["flduserid_start"] Then
        Else
          modInterface.InsertSampleForInterface(res["fldencounterval"], res["fldtestid"], res["fldsampleid"], res["fldsampletype"])
        Endif
        res["flduserid_start"] = modBasic.$lbluser
        If res["fldtime_start"] Then
          res["flduptime_start"] = Now()
        Else
          res["fldtime_start"] = Now()
        Endif
        res["fldcomp_start"] = modBasic.$compID
        res["fldsave_start"] = True
        res["xyz"] = True
        res.Update
      Endif
    Endif
  Next

End

Public Sub btnprocedure_Click()

  Dim xRow As Integer

  xRow = GridView1.Row
  LoadSpecimens()
  If $InvoiceFormat = True Then
    ShowSampledBill(Trim(txtencid.Text), txtlabbill.Text)
  Else
    ShowSampled(Trim(txtencid.Text))
  Endif
  GridView1.Row = xRow

End

Public Sub btnbulkwork_Click()

  Dim res As Result
  Dim sql As String
  Dim xList As String[]
  Dim aList As String[]

  If chklist.Value = True Then
    sql = "select distinct(fldsampleid) as col from " & $tblpatlabtest & " where fldstatus=&1 and fldcomp_sample=&2 and fldtestid in(select fldtestid from tbltest where fldcategory like &3) and fldtime_sample>=&4 and fldtime_sample<=&5"
    res = modDatabase.$myConn.Exec(sql, "Sampled", modBasic.$compID, cmbcategory.Text, modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)))
  Else
    sql = "select distinct(fldsampleid) as col from " & $tblpatlabtest & " where fldstatus=&1 and fldcomp_sample=&2 and fldtestid in(select fldtestid from tbltest where fldcategory like &3)"
    res = modDatabase.$myConn.Exec(sql, "Sampled", modBasic.$compID, cmbcategory.Text)
  Endif
  xList = modControlSub.GetDirectFillresult(res)
  If xList Then
    aList = GridListView("Select Sample ID", xList)
    If aList Then
      SampleBukWorkSheet(cmbcategory.Text, aList)
    Endif
  Endif

End

Private Sub SampleBukWorkSheet(sCategory As String, sampleList As String[])

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]

  Dim rs As Result
  Dim sql As String
  Dim res As Result
  Dim xval As String

  Dim xsample As String

  $BillingReport = New CReportHTML([("Test Name"), ("Observations")], "", "")
  $BillingReport.UserData.Add(sCategory, "PARAM1")
  $BillingReport.UserData.Add("DATE: " & modReportVar.GetDateTimeReport(Now(), gb.GeneralDate), "PARAM2")

  For Each xsample In sampleList
    $BillingReport.AddSection(xsample & " : " & modPatient.GetPatientNameByEnc(modLabTest.GetEncounterFromSampleID(xsample)), False)

    If chklist.Value = True Then
      sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start,fldmethod from " & $tblpatlabtest & " where fldstatus=&1 and fldsampleid=&2 and fldcomp_sample=&3 and fldtestid in(select fldtestid from tbltest where fldcategory like &4) and fldtime_sample>=&5 and fldtime_sample<=&6"
      res = modDatabase.$myConn.Exec(sql, "Sampled", xsample, modBasic.$compID, sCategory, modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)))
    Else
      sql = "select fldid,fldchk,fldgroupid,fldtestid,fldsampletype,fldsampleid,fldtime_sample,fldtest_type,fldrefername,fldcomment,fldencounterval,fldtime_start,fldmethod from " & $tblpatlabtest & " where fldstatus=&1 and fldsampleid=&2 and fldcomp_sample=&3 and fldtestid in(select fldtestid from tbltest where fldcategory like &4)"
      res = modDatabase.$myConn.Exec(sql, "Sampled", xsample, modBasic.$compID, sCategory)
    Endif
    If res.Available Then
      For Each res

        xval = "<b>" & res!fldtestid & "</b> : " & " (" & res!fldsampletype & ")" & "<br>" & "<small>[" & res!fldmethod & "]</small>"
        If res["fldtest_type"] = "Qualitative" Then
          rs = modDatabase.$myConn.Exec("select fldsubtest,fldreport,fldid from " & $tblpatlabsubtest & " where fldtestid=&1", res["fldid"])
          For Each rs
            xval = xval & "<br>" & modString.HTMLBlankSpace(4) & rs!fldsubtest
          Next
        Endif

        With asx
          .Add(xval)
          .Add("")
        End With
        $BillingReport.Add(asx)
        asx.Clear()

      Next
    Endif

    With asx
      .Add("****")
      .Add("****")
    End With
    $BillingReport.Add(asx)
    asx.Clear()
  Next

  modControlSub.OpenHTMLPreview("", $BillingReport.NewHTMLPath(), "ReportSize")

End

Public Sub btnsendout_Click()

  Dim Row As Integer
  Dim res As Result

  If Message.Question("Do you want to send selected tests out of the hospital. Are you sure?", ("No"), ("Yes")) = 2 Then
    For Row = 0 To GridView1.Rows.Count - 1
      If GridView1[Row, 1].Picture = Picture["icons/checked.png"] Then
        res = modDatabase.$myConn.Edit("tblpatlabtest", "fldid=&1 and fldsampleid IS NULL", GridView1[Row, 0].Text)
        res["fldstatus"] = "Sent Out"
        res.Update
      Endif
    Next
    If $InvoiceFormat = True Then
      ShowSampledBill(Trim(txtencid.Text), txtlabbill.Text)
    Else
      ShowSampled(Trim(txtencid.Text))
    Endif
  Endif

End
