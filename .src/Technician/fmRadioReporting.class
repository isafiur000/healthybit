' Gambas class file

Private $encid As String
Private $PatientNum As String
Private $InvoiceFormat As Boolean

Private $package As String
Private $BillMode As String

Private $ProcBill As Long
Private $sBillMode As String
Private $sItemName As String
Private $sLevel As String

Private $rData2 As Result
Private $aMyFields2 As String[]

Private $rData3 As Result
Private $aMyFields3 As String[]
Private $PositionList As String[]

Private $tblpatbilling As String

Public Sub Form_Open()
  
  Dim xoption As String
  Dim xoption1 As String
  
  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Column")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  btnhistory.Menu = "mnuhistory"
  cmbcategory.List = modMedicine.GetPathoCategoryList("Radio")
  cmbcategory.Text = modSettings.ShowSettingFromFIle("Radiology/DefaultDepartment")
  cmbcategorynew.List = modMedicine.GetPathoCategoryList("Radio")
  cmbcategorynew.Add("%")
  cmbcategorynew.Text = modSettings.ShowSettingFromFIle("Radiology/DefaultDepartment")
  cmbsourcedept.List = modGeneral.GetDepartmentAllList("%")
  modSettings.ShowCheckBox(chkall, "RadioReporting/ShowAll")
  dtsort.Value = Now()
  dtplan.Value = Now()
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/Radiology_DateSelect")
  If xoption = "Yes" Then
    chkdate.Value = True
  Else If xoption = "No" Then
    chkdate.Value = False
  Endif
  dtlisted.Value = Now()
  xoption1 = modSettings.ShowSettingFromFIle("EntrySetting/Radiology_DateSelect")
  If xoption1 = "Yes" Then
    chklist.Value = True
  Else If xoption1 = "No" Then
    chklist.Value = False
  Endif
  DateSelectionSett()
  If modBasic.$PayableSettingVerify = "Enable" Then
    $sLevel = "Waiting"
  Else
    $sLevel = "Active"
  Endif
  If modGlobalSetting.ShowSettingFromDB("GeneralSettings/Radiology_TestAddition") = "Yes" Then
    mnuaddtest.Enabled = True
    mnuaddgroup.Enabled = True
    mnuaddpacs.Enabled = True
  Endif
  rbwaiting.Value = True
  If modBasic.$ShareRadiologyAccess = "Yes" Then
    btnaddperson.Visible = True
    mnudelsurguser.Visible = True
  Else
    btnaddperson.Visible = False
    mnudelsurguser.Visible = False
  Endif
  
  modRepository.ReadRemoteRepoConfig()
  If modRepository.$RepoPACSHost Then
    btnupload.Enabled = True
  Endif
  
  ShowInputForm()
  modAccount.PasInvoiceSetting(cmbfiscal, False)
  LoadTableNames()
  
  If rbencounter.Value = True Then
    modGeneralMain.SetEncIDPrefix(txtencid)
  Else If rbinvoice.Value = True Then
    modGeneralMain.SetInvoicePrefix(txtencid)
  Else If rbindoor.Value = True Then
    modGeneralMain.SetEncIDPrefix(txtencid)
  Endif
  
End

Public Sub Form_Activate()
  
  If Not txtencid.Text Then
    txtencid.SetFocus
  Else If txtencid.Text = modBasic.$EncIdPrefix Then
    txtencid.SetFocus
  Else If txtencid.Text = modBasic.$InvoicePrefix Then
    txtencid.SetFocus
  Endif
  
End

Public Sub Form_Resize()
  
  modGeneralMain.ShowSelectedFormMenu(Me)
  txtencid.SetFocus
  
End

Private Sub ShowInputForm()
  
  Dim xx As String
  
  If modBasic.$TestAddSource Then
    If modBasic.$TestAddSource = "Invoice" Then
      rbinvoice.Value = True
      rbencounter.Enabled = False
      btnsearname.Enabled = False
    Else If modBasic.$TestAddSource = "Encounter" Then
      rbencounter.Value = True
      rbinvoice.Enabled = False
      btnsearname.Enabled = True
    Else
      rbencounter.Value = True
      btnsearname.Enabled = True
    Endif
    
  Else
    xx = modSettings.ShowSettingFromFIle("Radiology/InputFormat")
    If xx = "Invoice" Then
      rbinvoice.Value = True
    Else If xx = "Saved" Then
      rbindoor.Value = True
    Else
      rbencounter.Value = True
    Endif
    
  Endif
  
End

Public Sub Form_KeyRelease()
  
  If Key.Code = Key.F5 Then
    TabPanel1.Index = 0
  Else If Key.Code = Key.F6 Then
    TabPanel1.Index = 1
  Else If Key.Code = Key.F1 Then
    btnnewsearch_Click()
  Else If Key.Code = Key.F2 Then
    btnsearname_Click()
  Else If Key.Code = Key["O"] And If Key.Control Then
    btnwebcam_Click()
  Else If Key.Code = Key["F"] And If Key.Control Then
    txtencid.Text = GetEncid()
  Else If Key.Code = Key["B"] And If Key.Control Then
    Me.Close
    Wait
    modWorkSpace.Add(fmRadioReporting)
  Else If Key.Code = Key["R"] And If Key.Control Then
    If TabPanel1.Index = 0 Then
      btnnewrefresh_Click()
    Else If TabPanel1.Index = 1 Then
      btnrefresh_Click()
    Endif
  Else If Key.Code = Key["X"] And If Key.Control Then
    Me.Close()
  Endif
  
End

Private Sub LoadTableNames()
  
  Dim res As Result
  
  If cmbfiscal.Text = "Current" Then
    $tblpatbilling = "tblpatbilling"
  Else
    res = modDatabase.$myConn.Exec("select fldpatbilling,fldpatbilldetail,fldtempbilldetail from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", cmbfiscal.Text, "Active")
    If res.Available Then
      If res["fldpatbilling"] Then
        $tblpatbilling = res["fldpatbilling"]
      Else
        $tblpatbilling = "tblpatbilling"
      Endif
    Else
      $tblpatbilling = "tblpatbilling"
    Endif
  Endif
  
End

Public Sub cmbfiscal_Click()
  
  LoadTableNames()
  
End

Public Sub Form_Close()
  
  modSettings.SaveSettingsToFile("Radiology/DefaultDepartment", cmbcategorynew.Text)
  modGeneralMain.RecordFormExit(Me)
  
End

Public Sub chkall_Click()
  
  modSettings.EnterCheckSetting(chkall, "RadioReporting/ShowAll")
  
End

Public Sub rbencounter_Click()
  
  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Encounter")
  
End

Public Sub rbinvoice_Click()
  
  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Invoice")
  
End

Public Sub rbindoor_Click()
  
  modSettings.SaveSettingsToFile("Radiology/InputFormat", "Saved")
  
End

Private Sub DateSelectionSett()
  
  If chklist.Value = True Then
    Panel19.Enabled = True
  Else
    Panel19.Enabled = False
  Endif
  
End

Public Sub chklist_Click()
  
  modSettings.EnterCheckSetting(chklist, "EntrySetting/Radiology_DateSelect")
  DateSelectionSett()
  
End

Public Sub btnnewrefresh_Click()
  
  Inc Application.Busy
  If rbencounter.Value = True Then
    FillNewSamplingEncounters()
    ShowNewEncounterTests("")
  Else If rbinvoice.Value = True Then
    FillNewSamplingInvoices()
    ShowNewInvoiceTests("")
  Else If rbindoor.Value = True Then
    FillNewSamplingSaved()
    ShowNewEncSavedTests("")
  Endif
  ShowSampled("")
  Dec Application.Busy
  GridView3.SetFocus
  
End

Public Sub btndtplan_Click()
  
  Dim xx As String
  
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtplan.Value))
  If xx Then
    dtplan.Value = modDate.ConvertToEnglishdate(xx)
  Endif
  
End

Public Sub btnepsort_Click()
  
  Dim xx As String
  
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtsort.Value))
  If xx Then
    dtsort.Value = modDate.ConvertToEnglishdate(xx)
  Endif
  
End

Public Sub chkdate_Click()
  
  modSettings.EnterCheckSetting(chkdate, "EntrySetting/Radiology_DateSelect")
  
End

''---------------------------- sample grids -------------------------
Public Sub btnnewsearch_Click()
  
  Dim enc As String
  Dim xbillno As String
  Dim xlast As String
  
  rbwaiting.Value = True
  If rbencounter.Value = True Then
    If modBasic.$AutoEncounterF1 = "Yes" Then
      xlast = modSettings.ShowLogValues("LastValue/Encounter")
    Else
      xlast = ""
    Endif
    
    If modBasic.$AutoEncPrefix Then
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix & xlast)
    Else
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), xlast)
    Endif
    If enc Then
      txtlabbill.Text = ""
      FillNewSamplingSelectedEncounter(Trim(enc))
      ShowNewEncounterTests(Trim(enc))
    Endif
    
  Else If rbinvoice.Value = True Then
    xbillno = InputBox(("Laboratory Invoice No"), ("Search Patient"), "")
    If xbillno Then
      txtlabbill.Text = ""
      FillNewSamplingSelectedInvoice(Trim(xbillno))
      ShowNewInvoiceTests(Trim(xbillno))
    Endif
    
  Else If rbindoor.Value = True Then
    If modBasic.$AutoEncounterF1 = "Yes" Then
      xlast = modSettings.ShowLogValues("LastValue/Encounter")
    Else
      xlast = ""
    Endif
    
    If modBasic.$AutoEncPrefix Then
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix & xlast)
    Else
      enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), xlast)
    Endif
    If enc Then
      txtlabbill.Text = ""
      FillNewSamplingSelectedSaved(Trim(enc))
      ShowNewEncSavedTests(Trim(enc))
    Endif
    
  Endif
  ShowSampled("")
  
End

Public Sub btnsearname_Click()
  
  Dim xname As String[]
  Dim sql As String
  
  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  If xname Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &7 and lower(fldptnamelast) like &8)) and flditemqty>fldretqty"                                                                         ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", LCase(xname[0]), LCase(xname[1]))
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &7 and lower(fldptnamelast) like &8)) and flditemqty>fldretqty"                                                                         ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, LCase(xname[0]), LCase(xname[1]))
    Endif
    
    rbencounter.Value = True
    $InvoiceFormat = False
    txtlabbill.Text = ""
    
    $aMyFields3 = New String[]
    modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
    DisplayInitialGrid()
    ShowNewEncounterTests("")
    ShowSampled("")
    GridView4.SetFocus
  Endif
  
End

Private Sub FillNewSamplingSaved()
  
  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String
  
  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif
  
  If chklist.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&9" & xsource                                                      ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &8)) and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&9" & xsource                                                      ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategorynew.Text, xcomp)
    Endif
    
  Else
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&7" & xsource                                                      ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty and fldbillno IS NULL and " & xstr & "&7" & xsource                                                   ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xcomp)
    Endif
    
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False
  
End

Private Sub FillNewSamplingEncounters()
  
  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String
  
  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif
  
  If chklist.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &8)) and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategorynew.Text, xcomp)
    Endif
    
  Else
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&7" & xsource                                                       ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty and fldbillno IS NOT NULL and " & xstr & "&7" & xsource                                                  ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xcomp)
    Endif
    
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False
  
End

Private Sub FillNewSamplingInvoices()
  
  Dim sql As String
  Dim xcomp As String
  Dim xstr As String
  Dim xsource As String
  
  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  If modBasic.$LabSamplingFrom = "Not From" Then
    xstr = "fldordcomp not like "
  Else
    xstr = "fldordcomp like "
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif
  
  If chklist.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname like &8 and flditemqty>fldretqty and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), "%", xcomp)
    Else
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &8)) and flditemqty>fldretqty and " & xstr & "&9" & xsource                                                    ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), cmbcategorynew.Text, xcomp)
    Endif
    
  Else
    If cmbcategorynew.Text = "%" Then
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and flditemqty>fldretqty and " & xstr & "&7" & xsource                                                     ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xcomp)
    Else
      sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty and " & xstr & "&7" & xsource                                                  ''
      $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xcomp)
    Endif
    
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = True
  
End

Private Sub FillNewSamplingSelectedEncounter(encid As String)
  
  Dim sql As String
  
  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", encid)
  Else
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldencounterval=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, encid)
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False
  
End

Private Sub FillNewSamplingSelectedInvoice(xbillNo As String)
  
  Dim sql As String
  
  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldbillno=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", xbillNo)
  Else
    sql = "select distinct(fldbillno) as fldbillno,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldbillno=&7 and flditemqty>fldretqty"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, xbillNo)
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = True
  
End

Private Sub FillNewSamplingSelectedSaved(encid As String)
  
  Dim sql As String
  
  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname like &6 and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NULL"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", "%", encid)
  Else
    sql = "select distinct(fldencounterval) as fldencounterval,fldencounterval,fldencounterval,fldordcomp,fldencounterval,fldencounterval from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and fldencounterval=&7 and flditemqty>fldretqty and fldbillno IS NULL"                                                                         ''
    $rData3 = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, "%", cmbcategorynew.Text, encid)
  Endif
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)
  DisplayInitialGrid()
  $InvoiceFormat = False
  
End

Private Sub DisplayInitialGrid()
  
  With GridView3
    .Columns[0].Width = 125 * modBasic.$AppWidthRatio
    .Columns[1].Width = 10 * modBasic.$AppWidthRatio
    .Columns[2].Width = 175 * modBasic.$AppWidthRatio
    .Columns[3].Width = 75 * modBasic.$AppWidthRatio
    .Columns[4].Width = 125 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio
    
    If rbencounter.Value = True Then
      .Columns[0].Text = "EncID"
    Else If rbinvoice.Value = True Then
      .Columns[0].Text = "Invoice"
    Else If rbindoor.Value = True Then
      .Columns[0].Text = "EncID"
    Endif
    .Columns[2].Text = "Name"
    .Columns[3].Text = "Sender"
    .Columns[4].Text = "EncID"
    .Columns[5].Text = "Location"
  End With
  
End

Public Sub GridView3_Data(Row As Integer, Column As Integer)
  
  $rData3.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView3, Row)
  If Column = 1 Then
    GridView3.Data.Text = ""
    GridView3.Data.Background = modPatient.GetPatientColor($rData3[$aMyFields3[Column]])
  Else If Column = 2 Then
    GridView3.Data.Text = modPatient.GetPatientNameByEnc($rData3[$aMyFields3[Column]])
  Else If Column = 5 Then
    GridView3.Data.Text = modPatient.GetPatientLocation($rData3[$aMyFields3[Column]])
  Else
    GridView3.Data.Text = $rData3[$aMyFields3[Column]]
  Endif
  
End

Public Sub GridView3_Click()
  
  If GridView3.Rows.Selection.Count > 0 Then
    rbwaiting.Value = True
    If $InvoiceFormat = True Then
      ShowNewInvoiceTests(GridView3[GridView3.Row, 0].Text)
    Else
      If rbencounter.Value = True Then
        ShowNewEncounterTests(GridView3[GridView3.Row, 0].Text)
      Else If rbindoor.Value = True Then
        ShowNewEncSavedTests(GridView3[GridView3.Row, 0].Text)
      Endif
    Endif
    
    btnpayto.Tag = modBillings.GetPayableUserSetting("Radio", GridView3[GridView3.Row, 4].Text)
    If btnpayto.Tag Then
      btnpayto.Text = modGeneral.GetUserFullName(btnpayto.Tag)
    Endif
    If modBasic.$PayableLockEntry = "Yes" Then
      btnpayto.Enabled = False
    Endif
    GridView4.SetFocus
  Endif
  
End

Public Sub btnaddedsearch_Click()
  
  Dim enc As String
  
  If modBasic.$AutoEncPrefix Then
    enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), modBasic.$EncIdPrefix)
  Else
    enc = InputBox(("Encounter ID of Patient"), ("Search Patient"), "")
  Endif
  If enc Then
    ShowAddedEncounterTests(Trim(enc))
    ShowSampled("")
  Endif
  
End

Private Sub ShowNewEncSavedTests(encid As String)
  
  Dim sql As String
  Dim res As Result
  
  If rbwaiting.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty and fldbillno IS NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty and fldbillno IS NULL"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", encid, True, modBasic.$compID, "%", cmbcategorynew.Text)
    ShowLeftGridView(res)
  Endif
  
End

Private Sub ShowNewEncounterTests(encid As String)
  
  Dim sql As String
  Dim res As Result
  
  If rbwaiting.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty and fldbillno IS NOT NULL"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", encid, True, modBasic.$compID, "%", cmbcategorynew.Text)
    ShowLeftGridView(res)
  Endif
  
End

Private Sub ShowNewInvoiceTests(xBillNo As String)
  
  Dim sql As String
  Dim res As Result
  
  If rbwaiting.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldbillno=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", xBillNo, True, modBasic.$compID, "%", cmbcategorynew.Text)
    ShowLeftGridView(res)
  Endif
  
End

''for added tests
Private Sub ShowAddedEncounterTests(encid As String)
  
  Dim sql As String
  Dim res As Result
  
  If rbadded.Value = True Then
    If cmbcategorynew.Text = "%" Then
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemqty>fldretqty"
    Else
      sql = "select flditemname,fldreason,fldid,fldencounterval,fldtime,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and (fldtarget=&5 or fldtarget=&6) and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &7)) and flditemqty>fldretqty"
    Endif
    res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Sampled", encid, True, modBasic.$compID, "%", cmbcategorynew.Text)
    ShowLeftGridView(res)
  Endif
  
End

Private Sub ShowLeftGridView(res As Result)
  
  Dim Column As Integer
  Dim fld As ResultField
  
  GridView4.Clear
  GridView4.Columns.Count = res.Fields.Count
  GridView4.Rows.Count = res.Count
  
  With GridView4
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 225 * modBasic.$AppWidthRatio
    .Columns[1].Width = 25 * modBasic.$AppWidthRatio
    .Columns[2].Width = 1
    .Columns[3].Width = 1
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio
    .Columns[5].Width = 1
    .Columns[0].Text = "Test Name"
    .Columns[4].Text = "DateTime"
  End With
  
  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView4, res.Index, Column)
      If Column = 0 Then
        GridView4[res.Index, Column].Text = res[fld.Name]
        GridView4.Rows[res.Index].Height = Max(GridView4.Rows[res.Index].Height, GridView4[res.Index, Column].Font.RichTextHeight(GridView4[res.Index, Column].Text, GridView4.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView4.Rows.Height - GridView4.Font.Height))
      Else If Column = 1 Then
        GridView4[res.Index, Column].Tag = res[fld.Name]
        GridView4[res.Index, Column].Picture = Picture[GetPresenceIcon(res[fld.Name])]
      Else If Column = 4 Then
        GridView4[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldtime"], gb.GeneralDate)
      Else
        GridView4[res.Index, Column].Text = res[fld.Name]
      Endif
      GridView4[res.Index, Column].WordWrap = True
      
      Column = Column + 1
    Next
  Next
  GridView4.Row = 0
  
End

Private Function GetPresenceIcon(sText As String) As String
  
  Dim sval As String
  
  If sText Then
    sval = "icon:/small/info"
  Else
    sText = ""
  Endif
  Return sval
  
End

Public Sub GridView4_Click()
  
  Dim xx As String[]
  
  If GridView4.Column = 1 Then
    If GridView4[GridView4.Row, 1].Tag Then
      Message.Info(GridView4[GridView4.Row, 1].Tag)
    Endif
    
  Else
    cmbformat.Clear()
    xx = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldptsex) as col from tblgroupradio where fldgroupname=&1", GridView4[GridView4.Row, 0].Text))
    cmbformat.List = xx
    If xx.Count = 1 Then
      cmbformat.Text = xx[0]
    Endif
    cmbformat.SetFocus
    
  Endif
  
End

Public Sub btnformatlist_Click()
  
  Dim xlist As String[]
  
  If GridView4.Rows.Selection.Count Then
    xlist = InMultiCombo("Radio Diagnostics", GridView4[GridView4.Row, 5].Text, cmbformat.List)
    If xlist And If xlist.Count Then
      cmbformat.Text = xlist[0]
      btnformatlist.Tag = xlist.Join("|")
    Endif
  Endif
  
End

Public Sub cmbformat_KeyRelease()
  
  modFillContainer.AutoFillComboBox(cmbformat)
  modFillContainer.RestrictComboToContent(cmbformat)
  
End

Public Sub GridView4_Menu()
  
  mnutree.Popup
  
End

Public Sub btnnewexpotree_Click()
  
  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim sql As String
  Dim res As Result
  Dim xcomp As String
  
  If modBasic.$LabSamplingComp Then
    xcomp = modBasic.$LabSamplingComp
  Else
    xcomp = "%"
  Endif
  
  Inc Application.Busy
  $BillingReport = New CReportHTML([("Encounter"), ("PatientName"), ("Age/Sex"), ("Particulars"), ("Remarks")], " ", "")
  $BillingReport.UserData.Add("TEST REQUESTS", "PARAM1")
  $BillingReport.UserData.Add("Category : " & cmbcategorynew.Text, "PARAM2")
  
  If cmbcategorynew.Text = "%" Then
    sql = "select distinct(fldencounterval) from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and fldtarget=&4 and fldordcomp like &5 and flditemqty>fldretqty"
  Else
    sql = "select distinct(fldencounterval) from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and fldtarget=&4 and fldordcomp like &5 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6)) and flditemqty>fldretqty"
  Endif
  res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", True, modBasic.$compID, xcomp, cmbcategorynew.Text)
  If res.Available Then
    For Each res
      With asx
        .Add(res!fldencounterval)
        .Add(modPatient.GetPatientNameByEnc(res!fldencounterval))
        .Add(modPatient.GetPatientAgeString(res!fldencounterval, Now()) & "/" & modPatient.GetPatientSex(res!fldencounterval))
        .Add(GetTestListForSample(res!fldencounterval).Join("; "))
        .Add("")
      End With
      $BillingReport.Add(asx)
      asx.Clear()
    Next
  Endif
  
  Dec Application.Busy
  modControlSub.OpenHTMLPreview("", $BillingReport.NewHTMLPath(), "ReportSize")
  
End

Private Sub GetTestListForSample(encid As String) As String[]
  
  Dim xx As String[]
  Dim sql As String
  Dim res As Result
  
  If cmbcategorynew.Text = "%" Then
    sql = "select flditemname from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and fldtarget=&5"
  Else
    sql = "select flditemname from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldencounterval=&3 and fldsave=&4 and fldtarget=&5 and flditemname in(select fldgroupname from tblgroupradio where fldtestid in(select fldexamid from tblradio where fldcategory like &6))"
  Endif
  res = modDatabase.$myConn.Exec(sql, "Radio Diagnostics", "Waiting", encid, True, modBasic.$compID, cmbcategorynew.Text)
  xx = modControlSub.GetDirectFillresult(res)
  Return xx
  
End

Private Sub AddSampling(plandate As Date, sFormat As String)
  
  Dim res As Result
  Dim res1 As Result
  Dim resx As Result
  Dim j As Integer
  Dim res2 As Result
  Dim asx As String[]
  Dim xformat As String
  
  If btnformatlist.Tag Then
    asx = Split(btnformatlist.Tag, "|")
  Else
    asx = New String[]
  Endif
  If GridView4.Rows.Selection.Count > 0 Then
    res2 = modDatabase.$myConn.Exec("select fldbillno,fldrefer,fldreason,(flditemqty-fldretqty) as xqty from " & $tblpatbilling & " where fldid=&1", GridView4[GridView4.Row, 2].Text)
    If res2["xqty"] > 0 Then
      resx = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", GridView4[GridView4.Row, 0].Text, sFormat)
      If resx.Available Then
        
        Inc Application.Busy
        modDatabase.$myConn.Begin
        For j = 0 To res2["xqty"] - 1
          If asx.Count > j Then
            xformat = asx[j]
          Else
            xformat = sFormat
          Endif
          res = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", GridView4[GridView4.Row, 0].Text, xformat)
          If res.Available = True Then
            For Each res
              modRadioSub.InsertRadioTestOrder(GridView4[GridView4.Row, 3].Text, res["fldtestid"], res["fldtesttype"], res["fldactive"], GridView4[GridView4.Row, 2].Text, modGeneral.GetUserFullNamePrint(res2["fldrefer"]), res2["fldbillno"], res2["fldreason"], plandate, xformat)
            Next
          Endif
        Next
        
        If $InvoiceFormat = True Then
          txtencid.Text = GridView3[GridView3.Row, 0].Text
        Else
          txtencid.Text = GridView3[GridView3.Row, 0].Text
        Endif
        res1 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView4[GridView4.Row, 2].Text)
        res1["fldsample"] = "Sampled"
        res1["fldpayto"] = btnpayto.Tag
        res1["fldhostmac"] = modHelpVariable.$MACAddress
        res1["xyz"] = False
        res1.Update()
        modDatabase.$myConn.Commit
        Dec Application.Busy
        
        If $InvoiceFormat = True Then
          $encid = GridView4[GridView4.Row, 3].Text
          BasicInfoPatient()
          txtlabbill.Text = txtencid.Text
          ShowSampledBill($encid, txtlabbill.Text)
          ShowNewInvoiceTests(txtencid.Text)
        Else
          $encid = GridView4[GridView4.Row, 3].Text
          BasicInfoPatient()
          txtlabbill.Text = ""
          ShowSampled($encid)
          If rbencounter.Value = True Then
            ShowNewEncounterTests(txtencid.Text)
          Else If rbindoor.Value = True Then
            ShowNewEncSavedTests(txtencid.Text)
          Endif
        Endif
        
      Endif
    Endif
  Endif
  
Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()
  
End

Private Sub UpdateSampledTest()
  
  Dim resx As Result
  
  Dim res As Result
  Dim res1 As Result
  Dim j As Integer
  Dim res2 As Result
  
  If GridView4.Rows.Selection.Count > 0 Then
    If Message.Question("Are you sure to alter the selected Test addition ?", ("No"), ("Yes")) = 2 Then
      resx = modDatabase.$myConn.Edit("tblpatradiotest", "fldgroupid=&1 and fldstatus=&2", GridView4[GridView4.Row, 2].Text, "Sampled")
      If resx.Available Then
        
        res2 = modDatabase.$myConn.Exec("select flditemqty,fldretqty,fldbillno,fldrefer,fldreason from " & $tblpatbilling & " where fldid=&1", GridView4[GridView4.Row, 2].Text)
        If res2["flditemqty"] > res2["fldretqty"] Then
          res = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", GridView4[GridView4.Row, 0].Text, cmbformat.Text)
          If res.Available = True Then
            
            Inc Application.Busy
            modDatabase.$myConn.Begin
            For Each res
              For j = 1 To (res2["flditemqty"] - res2["fldretqty"])
                modRadioSub.InsertRadioTestOrder(GridView4[GridView4.Row, 3].Text, res["fldtestid"], res["fldtesttype"], res["fldactive"], GridView4[GridView4.Row, 2].Text, modGeneral.GetUserFullNamePrint(res2["fldrefer"]), res2["fldbillno"], res2["fldreason"], dtplan.Value, cmbformat.Text)
              Next
            Next
            If $InvoiceFormat = True Then
              txtencid.Text = resx["fldbillno"]
            Else
              txtencid.Text = resx["fldencounterval"]
            Endif
            res1 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView4[GridView4.Row, 2].Text)
            res1["fldsample"] = "Sampled"
            res1["fldpayto"] = btnpayto.Tag
            res1["fldhostmac"] = modHelpVariable.$MACAddress
            res1["xyz"] = False
            res1.Update()
            
            For Each resx
              resx["fldstatus"] = "Cancelled"
              resx["flduserid_report"] = modBasic.$lbluser
              resx["fldtime_report"] = ""
              resx["fldcomp_report"] = modBasic.$compID
              resx.Update
            Next
            modDatabase.$myConn.Commit
            Dec Application.Busy
            
          Endif
          
          If $InvoiceFormat = True Then
            $encid = GridView4[GridView4.Row, 3].Text
            BasicInfoPatient()
            txtlabbill.Text = txtencid.Text
            ShowSampledBill($encid, txtlabbill.Text)
            ShowNewInvoiceTests(txtencid.Text)
          Else
            $encid = GridView4[GridView4.Row, 3].Text
            BasicInfoPatient()
            txtlabbill.Text = ""
            ShowSampled($encid)
            If rbencounter.Value = True Then
              ShowNewEncounterTests(txtencid.Text)
            Else If rbindoor.Value = True Then
              ShowNewEncSavedTests(txtencid.Text)
            Endif
          Endif
        Endif
        
      Endif
    Endif
  Endif
  
Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()
  
End

Public Sub btnaddin_Click()
  
  If cmbformat.Text Then
    If rbwaiting.Value = True Then
      AddSampling(dtplan.Value, cmbformat.Text)
    Else If rbadded.Value = True Then
      UpdateSampledTest()
    Endif
  Endif
  btnformatlist.Tag = ""
  
End

Public Sub mnuadd_Click()
  
  If cmbformat.Text Then
    If rbwaiting.Value = True Then
      AddSampling(dtplan.Value, cmbformat.Text)
    Else If rbadded.Value = True Then
      UpdateSampledTest()
    Endif
  Endif
  btnformatlist.Tag = ""
  
End

Public Sub mnudel_Click()
  
  Dim res As Result
  Dim xmsg As String
  Dim xcashcrd As Float
  
  xmsg = InputBox("Reason for Cancellation", "Radiology", "")
  If GridView4.Rows.Selection.Count > 0 Then
    If xmsg Then
      
      If modBasic.$BillAutoReturn = "No" Then
        Message.Warning("Not allowed", "OK")
      Else
        Inc Application.Busy
        modDatabase.$myConn.Begin
        res = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView4[GridView4.Row, 2].Text)
        If res.Available = True Then
          If res["fldcashincredit"] Then
            xcashcrd = res["fldcashincredit"]
          Else
            xcashcrd = 0
          Endif
          modBillings.InsertBlankBillItemNewApp(res["fldencounterval"], res["fldbilltype"], res["fldbillingmode"], res["flddisctype"], res["fldacledger"], res["flditemtype"], res["flditemno"], res["flditemname"], res["flditemrate"], 0 - res["flditemqty"], res["fldtaxper"], res["flddiscper"], xcashcrd, "Done", res["fldid"], True, False, res["fldtarget"], res["fldpayto"], res["fldrefer"], Trim(xmsg), res["fldbillno"])
          res["fldsample"] = "Removed"
          res["fldretqty"] = res["flditemqty"]
          res["xyz"] = False
          res.Update()
        Endif
        modDatabase.$myConn.Commit
        Dec Application.Busy
      Endif
      
      ShowNewEncounterTests(GridView3[GridView3.Row, 0].Text)
    Endif
  Endif
  
Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()
  
End

Public Sub mnutransf_Click()
  
  Dim res As Result
  Dim xx As String
  
  If GridView4.Rows.Selection.Count > 0 Then
    xx = InputCombo(("Enter Target Location"), ("Transfer"), modBasic.$AllCompList, "", True)
    If xx Then
      res = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1", GridView4[GridView4.Row, 2].Text)
      res["fldtarget"] = xx
      res["xyz"] = False
      res.Update()
      If xx <> modBasic.$compID Then
        ShowNewEncounterTests(GridView3[GridView3.Row, 0].Text)
      Endif
    Endif
  Endif
  
End

Public Sub btnpayto_Click()
  
  Dim xMedUser As String[]
  
  xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  If xMedUser And If xMedUser.Count Then
    btnpayto.Tag = xMedUser[0]
    btnpayto.Text = xMedUser[1]
  Else
    btnpayto.Tag = ""
    btnpayto.Text = ""
  Endif
  
End

Public Sub btnpayto_Change()
  
  If btnpayto.Text = "" Then
    btnpayto.Tag = ""
  Endif
  
End

Public Sub mnublank_Click()
  
  Me.Close
  modWorkSpace.Add(fmRadioReporting)
  
End

Public Sub mnuaddtest_Click()
  
  Dim xx As String[]
  Dim xitem As String
  
  If txtencid.Text Then
    xx = GridListView(("Select requested Tests"), modMedicine.FillRadioTestCombo("%"))
    If xx And If xx.Count Then
      For Each xitem In xx
        modRadioSub.InsertRadioTestOrder(Trim(txtencid.Text), xitem, modFixRadio.GetRadioTestType(xitem), "Regular", 0, "", "", "", "", "")
      Next
      ShowSampled(Trim(txtencid.Text))
    Endif
  Endif
  
End

Public Sub mnuaddgroup_Click()
  
  Dim xList As String[]
  Dim xformat As String
  Dim xitem As String
  Dim res As Result
  Dim xmode As String
  
  If txtencid.Text Then
    xmode = $BillMode
    If xmode Then
      xitem = GridViewNew(("Select requested Test Groups"), modNonMedical.NonStockBillingItemArray("Radio Diagnostics", xmode), False)
      If xitem Then
        xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldptsex) as col from tblgroupradio where fldgroupname=&1", xitem))
        xformat = InputCombo("Select Format", xitem, xList, "", True)
        If xformat Then
          
          modDatabase.$myConn.Begin
          res = modDatabase.$myConn.Exec("select fldtestid,fldtesttype,fldactive from tblgroupradio where fldgroupname=&1 and fldptsex=&2", xitem, xformat)
          If res.Available = True Then
            For Each res
              modRadioSub.InsertRadioTestOrder(Trim(txtencid.Text), res["fldtestid"], res["fldtesttype"], res["fldactive"], 0, "", "", "", "", xformat)
            Next
          Endif
          modDatabase.$myConn.Commit
          ShowSampled(Trim(txtencid.Text))
          
        Endif
      Endif
    Endif
  Endif
  
Catch
  modDatabase.$myConn.Rollback
  modHelpVariable.CreateErrorReport()
  
End

Public Sub mnuaddpacs_Click()
  
  Dim hForm As FmAddPacsEntry
  
  If txtencid.Text Then
    hForm = New FmAddPacsEntry(Trim(txtencid.Text))
    hForm.ShowModal()
    ShowSampled(Trim(txtencid.Text))
  Endif
  
End

Public Sub mnusearchpat_Click()
  
  txtencid.Text = PatSearch("Encounter")
  
End

Public Sub mnulastencid_Click()
  
  txtencid.Text = modSettings.ShowLogValues("LastValue/Encounter")
  
End

''---------------------------- Added Grids -------------------------
Public Sub btnrefresh_Click()
  
  Inc Application.Busy
  FillSamplingEncounters()
  ShowSampled("")
  Dec Application.Busy
  GridView2.SetFocus
  
End

Private Sub FillSamplingEncounters()
  
  Dim sql As String
  Dim xdate As String
  Dim xcateg As String
  
  If chkdate.Value = True Then
    xdate = " and fldnewdate>=&4 and fldnewdate<=&5"
  Else
    xdate = ""
  Endif
  
  If cmbcategory.Text = "%" Then
    xcateg = ""
  Else
    xcateg = " and fldtestid in(select fldexamid from tblradio where fldcategory like &6)"
  Endif
  
  If rbencounter.Value = True Then
    sql = "select fldencounterval as fldparent,fldencounterval,fldencounterval,fldencounterval,fldtestid,fldnewdate,fldid,fldnewdate from tblpatradiotest where fldstatus=&1 and fldsave_report=&2 and fldcomp_report=&3" & xdate & xcateg                                        ''
  Else If rbinvoice.Value = True Then
    sql = "select fldbillno as fldparent,fldencounterval,fldencounterval,fldencounterval,fldtestid,fldnewdate,fldid,fldnewdate from tblpatradiotest where fldstatus=&1 and fldsave_report=&2 and fldcomp_report=&3" & xdate & xcateg
  Else If rbindoor.Value = True Then
    sql = "select fldencounterval as fldparent,fldencounterval,fldencounterval,fldencounterval,fldtestid,fldnewdate,fldid,fldnewdate from tblpatradiotest where fldstatus=&1 and fldsave_report=&2 and fldcomp_report=&3" & xdate & xcateg                                        ''
  Endif
  $rData2 = modDatabase.$myConn.Exec(sql, "Sampled", False, modBasic.$compID, modDate.StartSqlDate(dtsort.value), modDate.EndSqlDate(dtsort.value), cmbcategory.Text)
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  With GridView2
    .Columns[0].Width = 100 * modBasic.$AppWidthRatio
    .Columns[1].Width = 10 * modBasic.$AppWidthRatio
    .Columns[2].Width = 150 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[4].Width = 150
    .Columns[5].Width = 150
    .Columns[6].Width = 1
    .Columns[7].Width = 1
    
    .Columns[0].Text = "EncID"
    .Columns[2].Text = "Name"
    .Columns[4].Text = "TestName"
    .Columns[5].Text = "PlanDate"
  End With
  
End

Public Sub GridView2_Data(Row As Integer, Column As Integer)
  
  $rData2.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 1 Then
    GridView2.Data.Text = ""
    GridView2.Data.Background = modPatient.GetPatientColor($rData2[$aMyFields2[Column]])
  Else If Column = 2 Then
    GridView2.Data.Text = modPatient.GetPatientNameByEnc($rData2[$aMyFields2[Column]])
  Else If Column = 5 Then
    GridView2.Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else
    GridView2.Data.Text = $rData2[$aMyFields2[Column]]
  Endif
  
End

Public Sub GridView2_Click()
  
  Dim xstatus As String
  
  If GridView2.Rows.Selection.Count > 0 Then
    modRepository.$RepoDataStatus = False
    btnshow.Enabled = False
    txtencid.Text = GridView2[GridView2.Row, 0].Text
    $encid = GridView2[GridView2.Row, 3].Text
    $PatientNum = modPatient.GetPatientNoByEnc($encid)
    txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
    txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)
    txtpatientaddress.Text = modPatient.GetPatientAddressByEnc($encid)
    
    xstatus = modPatient.CurrentAdmissionStatus($encid)
    txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
    ShowGridMain()
    GridView1.SetFocus
  Endif
  
End

Private Sub ShowGridMain()
  
  If rbencounter.Value = True Then
    ShowSampled($encid)
  Else If rbinvoice.Value = True Then
    ShowSampledBill($encid, Trim(txtencid.Text))
  Else If rbindoor.Value = True Then
    ShowSampled($encid)
  Endif
  
End

Public Sub GridView2_KeyRelease()
  
  If GridView2.Rows.Selection.Count > 0 Then
    If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
      GridView2_Click()
    Endif
  Endif
  
End

Public Sub GridView2_Menu()
  
  mnuplan.Popup
  
End

Public Sub mnueditdate_Click()
  
  Dim res As Result
  Dim xdate As Date
  Dim Row As Integer
  Dim Column As Integer
  
  If GridView2.Rows.Selection.Count Then
    Row = GridView2.Row
    Column = GridView2.Column
    xdate = GetDateValue(("Select Plan Date for ") & GridView2[GridView2.Row, 4].Text, GridView2[GridView2.Row, 0].Text, GridView2[GridView2.Row, 7].Text)
    If xdate Then
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView2[GridView2.Row, 6].Text)
      res["fldnewdate"] = xdate
      res["xyz"] = False
      res.Update
      FillSamplingEncounters()
    Endif
    GridView2.Row = Row
    GridView2.Column = Column
  Endif
  
End

Public Sub btnexpotree_Click()
  
  modCHTMLReport.ExportGridToHTML(GridView2, "RADIOLOGY PLAN: " & cmbcategory.Text, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))
  
End

''------------------------------------------ patient profile -------------------------------------
Public Sub btnshow_Click()
  
  If Not txtencid.Text Then Return
  If modBasic.$EncIdPrefix And If txtencid.Text = modBasic.$EncIdPrefix Then
    txtencid.SetFocus
    Return
  Endif
  
  If txtencid.Text Then
    modRepository.$RepoDataStatus = False
    If rbencounter.Value = True Then
      txtlabbill.Text = ""
      $InvoiceFormat = False
      $encid = Trim(txtencid.Text)
      BasicInfoPatient()
      ShowSampled($encid)
    Else If rbinvoice.Value = True Then
      txtlabbill.Text = Trim(txtencid.Text)
      $InvoiceFormat = True
      $encid = modNonMedical.GetEncounterFromBillNo(txtencid.Text)
      BasicInfoPatient()
      ShowSampledBill($encid, txtlabbill.Text)
    Else If rbindoor.Value = True Then
      txtlabbill.Text = ""
      $InvoiceFormat = False
      $encid = Trim(txtencid.Text)
      BasicInfoPatient()
      ShowSampled($encid)
    Endif
  Endif
  
End

Private Sub BasicInfoPatient()
  
  Dim xstatus As String
  
  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  txtgender.Text = modPatient.GetPatientAgeString($encid, Now()) & "/" & modPatient.GetPatientSex($encid)
  txtpatientaddress.Text = modPatient.GetPatientAddressByEnc($encid)
  
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  xstatus = modPatient.CurrentAdmissionStatus($encid)
  txtlocation.Text = modPatient.GetLocationSetting($encid, xstatus)
  txtcolor.Background = modPatient.GetPatientColor($encid)
  $package = modNonMedical.DefaultBillingScheme($encid, modBasic.$compID)
  $BillMode = modNonMedical.GetDiscBindBillMode($package)
  If Not $BillMode Then
    $billMode = modPatient.GetPatBillingMode($encid)
  Endif
  modAppSupport.RecordPatientActivity("Patient Data", Me.Name, "EncounterID", $encid)
  
  btnshow.Enabled = False
  modImage.ShowPhotoSplash("Patient", $PatientNum)
  
End

Public Sub txtencid_GotFocus()
  
  btnshow.Enabled = True
  
End

Public Sub btnwebcam_Click()
  
  txtencid.Text = modDevice.ChooseBarCodeSource()
  txtencid.SetFocus
  txtencid.Pos = Len(txtencid.Text)
  
End

'''------------------------------------------ added tests -------------------------------------------
Private Sub ShowSampled(encid As String)
  
  Dim res As Result
  Dim sql As String
  
  If chkall.Value = False Then
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2) and fldencounterval=&3 and fldcomp_report=&4"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", encid, modBasic.$compID)
  Else
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2 or fldstatus=&3) and fldencounterval=&4 and fldcomp_report=&5"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", "Reported", encid, modBasic.$compID)
  Endif
  FillSamplingGrid(res)
  
End

Private Sub ShowSampledBill(encid As String, billno As String)
  
  Dim res As Result
  Dim sql As String
  
  If chkall.Value = False Then
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2) and fldencounterval=&3 and fldcomp_report=&4 and fldbillno=&5"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", encid, modBasic.$compID, billno)
  Else
    sql = "select fldid,fldchk,fldtestid,fldreportquali,flvisible,fldsampletype,fldreportquanti,fldtest_type,fldmethod,fldcondition,fldcomment,fldtime_report,fldencounterval,fldstatus,fldabnormal,fldpacstudy,fldgroupid,fldsampleid,fldreportquali,fldbillno,fldnewdate from tblpatradiotest where (fldstatus=&1 or fldstatus=&2 or fldstatus=&3) and fldencounterval=&4 and fldcomp_report=&5 and fldbillno=&6"
    res = modDatabase.$myConn.Exec(sql, "Ordered", "Sampled", "Reported", encid, modBasic.$compID, billno)
  Endif
  FillSamplingGrid(res)
  
End

Private Sub FillSamplingGrid(res As Result)
  
  Dim Column As Integer
  Dim fld As ResultField
  
  GridView1.Clear
  GridView1.Columns.Count = res.Fields.Count
  GridView1.Rows.Count = res.Count
  
  With GridView1
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 225 * modBasic.$AppWidthRatio
    .Columns[3].Width = 225 * modBasic.$AppWidthRatio
    .Columns[4].Width = 75 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio
    .Columns[6].Width = 1
    .Columns[7].Width = 1
    .Columns[8].Width = 125 * modBasic.$AppWidthRatio
    .Columns[9].Width = 1
    .Columns[10].Width = 1
    .Columns[11].Width = 150 * modBasic.$AppWidthRatio
    .Columns[12].Width = 1
    .Columns[13].Width = 1
    .Columns[14].Width = 1
    .Columns[15].Width = 1
    .Columns[16].Width = 1
    .Columns[17].Width = 125 * modBasic.$AppWidthRatio
    .Columns[18].Width = 1
    .Columns[19].Width = 150 * modBasic.$AppWidthRatio
    .Columns[20].Width = 1   ''book date
    
    .Columns[2].Text = "Examination"
    .Columns[3].Text = "Observation"     ''5
    .Columns[4].Text = "Visible" ''4
    .Columns[5].Text = "EvalSite"      ''3
    .Columns[8].Text = "Method"
    .Columns[11].Text = "ReportDate"
    .Columns[17].Text = "Index"
    .Columns[19].Text = "Invoice"
  End With
  
  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView1, res.Index, Column)
      If Column = 3 Then
        GridView1[res.Index, Column].RichText = res[fld.Name]
        If modBasic.$RichtextResizeRow = "Yes" Then
          GridView1.Rows[res.Index].Height = Max(GridView1.Rows[res.Index].Height, GridView1[res.Index, Column].Font.RichTextHeight(GridView1[res.Index, Column].RichText, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
        Endif
      Else If Column = 11 Then
        GridView1[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldtime_report"], gb.GeneralDate)
      Else
        GridView1[res.Index, Column].Text = res[fld.Name]
      Endif
      GridView1.Rows[res.Index].Height = Max(GridView1.Rows[res.Index].Height, GridView1[res.Index, Column].Font.RichTextHeight(GridView1[res.Index, Column].Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
      GridView1[res.Index, Column].WordWrap = True
      
      Column = Column + 1
    Next
  Next
  GridView1.Row = 0
  modGridView.SetLabReportIcon(GridView1, 13, 14, 3)
  
End

Public Sub GridView1_Menu()
  
  mnugridview.Popup()
  
End

Public Sub mnupdatesub_Click()
  
End

Public Sub GridView1_Click()
  
  Dim xx As String
  Dim xopt As String[] = ["Visible", "Hidden"]
  Dim res As Result
  Dim xspec As String[]
  Dim Row As Integer
  
  $ProcBill = GridView1[GridView1.Row, 16].Text
  ShowShareUsers($ProcBill)
  If GridView1.Column = 3 Then
    UpdateRadioValue()
    
  Else If GridView1.Column = 4 Then
    xx = InputCombo("Set Visibility", GridView1[GridView1.Row, 2].Text, xopt, GridView1[GridView1.Row, 4].Text, True)
    If xx Then
      Row = GridView1.Row
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["flvisible"] = xx
      res["xyz"] = False
      res.Update
      ShowGridMain()
      GridView1.Row = Row
    Endif
    
  Else If GridView1.Column = 8 Then
    xx = InputCombo(("Select Test Method"), ("Test Method"), modFixLab.GetTestExamEquipments("Radio"), GridView1[GridView1.Row, 8].Text, True)
    If xx Then
      Row = GridView1.Row
      modRadioSub.UpdateEquipmenRadiotMethod(GridView1[GridView1.Row, 0].Text, xx)
      ShowGridMain()
      GridView1.Row = Row
    Endif
    
  Else If GridView1.Column = 5 Then
    xspec = New String[]
    xx = InputCombo("Set Site of Evaluation Site", GridView1[GridView1.Row, 2].Text, xspec, GridView1[GridView1.Row, 5].Text, False)
    If xx Then
      Row = GridView1.Row
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldsampletype"] = xx
      res["xyz"] = False
      res.Update
      ShowGridMain()
      GridView1.Row = Row
    Endif
    
  Endif
  
End

Public Sub GridView1_KeyRelease()
  
  If GridView1.Rows.Selection.Count > 0 Then
    If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
      UpdateRadioValue()
    Endif
  Endif
  
End

Private Sub AddSubTestData(Row As Integer)
  
  Dim rs As Result
  Dim xxx As String[]
  
  rs = modDatabase.$myConn.Exec("select fldid,fldsubtest from tblpatradiosubtest where fldtestid=&1", GridView1[Row, 0].Text)
  If rs.Available = False Then
    Select modFixRadio.GetRadioTestOption(GridView1[Row, 2].Text)
      Case "Fixed Components", "Left/Right Components"
        xxx = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldsubexam) as col from tblradioquali where fldexamid=&1 ORDER BY fldindex", GridView1[Row, 2].Text))
        If xxx.Count Then
          modRadioSub.InsertRadioSubTest(GridView1[Row, 12].Text, GridView1[Row, 0].Text, GridView1[Row, 2].Text, xxx)
        Endif
    End Select
  Endif
  
End

Private Sub UpdateRadioValue()
  
  Dim yqualival As Variant[]
  Dim xquantival As Variant[]
  Dim hForm3 As FmEnterMultiple
  Dim hFormTwo As FmEnterMultipleTwo
  Dim hForm33 As FmEnterMultipleVer
  Dim res As Result
  Dim sql As String
  Dim xData As Variant[]
  Dim xx As Integer
  Dim xType As String
  Dim xdate As Date
  
  Dim xmax As Float
  Dim xmin As Float
  
  xx = GridView1.Row
  If GridView1[GridView1.Row, 7].Text = "Qualitative" Then
    AddSubTestData(GridView1.Row)
    
    xType = modFixRadio.GetRadioTestOption(GridView1[GridView1.Row, 2].Text)
    sql = "select fldid,fldsubtest,fldreport,fldtanswertype,fldabnormal,fldindex from tblpatradiosubtest where fldtestid=&1"
    res = modDatabase.$myConn.Exec(sql, GridView1[GridView1.Row, 0].Text)
    If res.Available = False Then 
      If xType = "Clinical Scale" Then
        yqualival = modExamOption.GetClinScalePopUp("Radio", GridView1[GridView1.Row, 2].Text)
        If yqualival Then
          ' modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, yqualival[0], yqualival[1], yqualival[2])
        Endif
      Else If xType = "Left and Right" Then
        yqualival = CLeftRight(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 18].Text, modFixClinic.GetLeftRightMainHeader("Radio", GridView1[GridView1.Row, 2].Text))
        If yqualival Then
          modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, yqualival[0], yqualival[1], "")
        Endif
      Else If xType = "Date Time" Then
        xdate = GetDateValue(GridView1[GridView1.Row, 2].Text, ("Select Date Time"), Val(GridView1[GridView1.Row, 18].Text))
        If xdate Then
          modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, modDate.DateStringForExam(xdate), False, "")
        Endif
      Else If xType = "BS Date" Then
        xdate = GetDateValue(GridView1[GridView1.Row, 2].Text, ("Select Date Time"), modDate.ConvertToEnglishdate(GridView1[GridView1.Row, 18].Text))
        If xdate Then
          modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, modDate.ConvertToLocaldate(xdate), False, "")
        Endif
      Else If xType = "Qualitative" Then
        yqualival = GetQualiString(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 18].Text, "Radio")
        If yqualival Then
          modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, yqualival[0], yqualival[1])
        Endif
      Else If xType = "RichText Area" Then
        yqualival = GetQualiRich(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 18].Text, "Radio")
        If yqualival Then
          modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, yqualival[0], yqualival[1], yqualival[2])
        Endif
      Else
        yqualival = GetQualiValues(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 18].Text, "Radio")
        If yqualival Then
          modRadioSub.UpdateRadioTestReportQuali(GridView1[GridView1.Row, 0].Text, yqualival[0], yqualival[1], yqualival[2])
        Endif
      Endif
      
    Else If res.Available = True Then
      xData = New Variant[]
      res.MoveFirst
      For Each res
        xData.Add([res["fldsubtest"], res["fldreport"], res["fldid"], res["fldtanswertype"], res["fldabnormal"], res["fldindex"]])
      Next
      xData.Add(["Final Impression", GridView1[GridView1.Row, 18].Text, 0, "RichText Area", False, ""])
      If xType = "Left/Right Components" Then
        hFormTwo = New FmEnterMultipleTwo(GridView1[GridView1.Row, 0].Text, "Radio", GridView1[GridView1.Row, 2].Text, xData, "", "Current")
        hFormTwo.ShowModal
      Else
        If modBasic.$FactorForm = "Vertical" Then
          hForm33 = New FmEnterMultipleVer(GridView1[GridView1.Row, 0].Text, "Radio", GridView1[GridView1.Row, 2].Text, xData, "", "Current")
          hForm33.ShowModal
        Else
          hForm3 = New FmEnterMultiple(GridView1[GridView1.Row, 0].Text, "Radio", GridView1[GridView1.Row, 2].Text, xData, "", "Current")
          hForm3.ShowModal
        Endif
      Endif 
    Endif
    
  Else If GridView1[GridView1.Row, 7].Text = "Quantitative" Then
    xmax = modRadioTest.GetMaxQuantiRadioVal(GridView1[GridView1.Row, 2].Text, $encid)
    xmin = modRadioTest.GetMinQuantiRadioVal(GridView1[GridView1.Row, 2].Text, $encid)
    xquantival = GetQuantiValues("Radio", Trim(txtencid.Text), GridView1[GridView1.Row, 2].Text, xmin, xmax, GridView1[GridView1.Row, 6].Text)
    If xquantival Then
      modRadioSub.UpdateRadioTestReportQuanti(GridView1[GridView1.Row, 0].Text, xquantival[0], xquantival[1])
    Endif
    
  Endif
  
  ShowGridMain()
  GridView1.Row = xx
  
End

''-------------------------------- button report ----------------------------------
Public Sub btnrepo_Click()
  
  Dim hCls As CReportCustom
  
  If $encid Then
    If modSettings.ShowSettingFromFIle("Diagnostic Help/Name") Then
      hCls = New CReportCustom($encid, "Diagnostic Help", "ReportSize", MMain.$defUnit)
      hCls.Preview()
    Endif
  Endif
  
End

Public Sub btnpacs_Click()
  
  Dim hForm As FmPacsFind
  
  If txtencid.Text Then
    hForm = New FmPacsFind($encid, "History")
    hForm.ShowModal
  Endif
  
End

Public Sub mnulocal_Click()
  
  Dim xPath As String
  Dim xpatno As String
  
  If txtencid.Text Then
    xpatno = $PatientNum
    If modPatientSub.GetPatPassCheck(modDatabase.$myConn, xpatno) = True Then
      Inc Application.Busy
      xPath = modCHTMLPatient.ShowPatRadioReportAllEnc($encid)
      Dec Application.Busy
      modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
    Endif
  Endif
  
End

Public Sub mnuremote_Click()
  
  Dim xPath As String
  Dim xpatno As String
  Dim sCon As Connection
  Dim xCon As Connection
  
  If txtencid.Text Then
    xpatno = $PatientNum
    
    If modPatientSub.GetPatPassCheck(modDatabase.$myConn, xpatno) = True Then
      sCon = modDatabase.$myConn
      xCon = modDatabase.$syConn
      Inc Application.Busy
      modRepository.TransferRemoConn(xpatno)
      xPath = modCHTMLPatient.ShowPatRadioReportAllEnc($encid)
      Dec Application.Busy
      modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
      modDatabase.$myConn = sCon
      modDatabase.$syConn = xCon
      MMain.InitialAppMode()
    Endif
    
  Endif
  
End

Public Sub btnrepoall_Click()
  
  Dim hForm As FmRadioRepPrint
  
  If txtencid.Text Then
    hForm = New FmRadioRepPrint($encid)
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif
  
End

Public Sub btnfullrep_Click()
  
  If txtencid.Text Then
    modCHTMLReport.ExportGridToHTML(GridView1, "", "RADIOLOGY REPORTING",, txtencid.Text)
  Endif
  
End

''----------------------------Message Bar -------------------------------------
Public Sub MessageView1_Open()
  
  If modBasic.$InfoMusic Then
    Music.Load(modBasic.$InfoMusic)
    If modBasic.$InfoMusicVol Then
      Music.Volume = modBasic.$InfoMusicVol
    Endif
    Music.Play()
  Endif
  
End

Public Sub MessageView1_Close()
  
  If modBasic.$InfoMusic Then
    Music.Stop()
  Endif
  
End

Public Sub txtencid_KeyPress()
  
  If Key.Code = Key.Down Then
    If Not txtencid.Text Then
      txtencid.Text = PatSearch("Encounter")
      txtencid.SetFocus
    Else
      If modBasic.$AutoEncSuffix = "Yes" Then
        txtencid.Text = txtencid.Text & modBasic.$HospCode
      Endif
    Endif
  Else
    modGeneralMain.InputUpCaseOnly()
  Endif
  
End

Public Sub btncomponent_Click()
  
  Dim xxx As String[]
  Dim yyy As String[]
  
  If GridView1.Rows.Selection.Count > 0 Then
    If modFixRadio.GetRadioTestOption(GridView1[GridView1.Row, 2].Text) = "Custom Components" Then
      xxx = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldsubexam) as col from tblradioquali where fldexamid=&1 ORDER BY fldindex", GridView1[GridView1.Row, 2].Text))
      yyy = GridListView(("Select Components"), xxx)
      If yyy And If yyy.Count Then
        modRadioSub.InsertRadioSubTest(GridView1[GridView1.Row, 12].Text, GridView1[GridView1.Row, 0].Text, GridView1[GridView1.Row, 2].Text, yyy)
      Endif
    Endif
  Endif
  
End

Public Sub btncondi_Click()
  
  Dim xx As String
  Dim xRow As Integer
  
  If GridView1.Rows.Selection.Count > 0 Then
    xx = GetTextArea(("Condition"), GridView1[GridView1.Row, 9].Text)
    If xx Then
      xRow = GridView1.Row
      modRadioSub.UpdateConditionRadio(GridView1[GridView1.Row, 0].Text, xx)
      ShowGridMain()
      Gridview1.Row = xRow
    Endif
  Endif
  
End

Public Sub btncomment_Click()
  
  Dim xx As String
  Dim res As Result
  Dim xRow As Integer
  
  If GridView1.Rows.Selection.Count > 0 Then
    xx = GetTextArea(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 10].Text)
    If xx Then
      xRow = Gridview1.Row
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldcomment"] = xx
      res["xyz"] = False
      res.Update
      ShowGridMain()
      Gridview1.Row = xRow
    Endif
  Endif
  
End

Public Sub btnrefer_Click()
  
  Dim res As Result
  Dim xx As String
  Dim row As Integer
  Dim reflist As String
  
  If GridView1.Rows.Selection.Count > 0 Then
    reflist = modSettings.ShowSettingFromFIle("Laboratory/ReferralList")
    If reflist Then
      If Exist(reflist) Then
        xx = InputCombo(("Enter Referral Name"), ("Referral"), modString.GetStringArrayFromFile(reflist), GridView1[GridView1.Row, 8].Text, False)
      Endif
    Else
      xx = InputBox(("Enter Referral Name"), ("Referral"), GridView1[GridView1.Row, 8].Text)
    Endif
    
    If xx Then
      row = GridView1.Row
      res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldrefername"] = xx
      res["xyz"] = False
      res.Update
      ShowSampled(Trim(txtencid.Text))
      GridView1.Row = row
    Endif
  Endif
  
End

Public Sub btnimage_Click()
  
  Dim hForm As FmTestImage
  
  If GridView1.Rows.Selection.Count > 0 Then
    hForm = New FmTestImage("IMAGE", $encid, GridView1[GridView1.Row, 0].Text, GridView1[GridView1.Row, 2].Text, "Radiology", "")
    hForm.ShowModal
  Endif
  
End

Public Sub btndicom_Click()
  
  Dim hForm As FmTestImage
  
  If GridView1.Rows.Selection.Count > 0 Then
    hForm = New FmTestImage("DICOM", $encid, GridView1[GridView1.Row, 0].Text, GridView1[GridView1.Row, 2].Text, "Radiology", "")
    hForm.ShowModal
  Endif
  
End

Public Sub btnplay_Click()
  
  Dim res As Result
  Dim xLink As String
  Dim xserver As String
  Dim hForm As FmPacsFind
  
  If GridView1.Rows.Selection.Count Then
    If GridView1[GridView1.Row, 15].Text Then
      
      res = modDatabase.$myConn.Exec("select fldpacstudy,fldpacseries,fldpacsform from tblpatradiotest where fldid=&1", GridView1[GridView1.Row, 0].Text)
      If res.Available Then
        If res["fldpacseries"] Then
          xserver = InputCombo("Select PACS Node to Use", "PACS", modMisc.GetPacsServerList(), "", True)
          If xserver Then
            modpacs.GetPacsSetting(xserver)
            xLink = modPACS.DicomSeriesWebView(res["fldpacsform"], $encid, res["fldpacstudy"], res["fldpacseries"])
            modControlSub.OpenBrowser(xLink)
          Endif
        Endif
      Endif
      
    Else
      hForm = New FmPacsFind($encid, CStr(GridView1[GridView1.Row, 0].Text))
      hForm.ShowModal
      ShowGridMain()
      
    Endif
  Endif
  
End

Public Sub btnsms_Click()
  
  Dim xmsg As String
  
  If GridView1.Rows.Selection.Count > 0 Then
    xmsg = modDevice.SendSMSLabPatient($encid, GridView1[GridView1.Row, 2].Text, modRadioTest.GetRadioTestValueString(GridView1[GridView1.Row, 0].Text, False))
  Endif
  If xmsg Then
    Balloon.Info(xmsg, btnsms)
    Balloon.Delay = modBasic.$BalloonDelay
  Endif
  
End

Public Sub mnudemog_Click()
  
  Dim hForm As FmPatdemograph
  
  If txtencid.Text Then
    hForm = New FmPatdemograph($encid, "Clinical")
    hForm.ShowModal
  Endif
  
End

''============================= Professional involved ====================================
Private Sub ShowShareUsers(sID As Long)
  
  Dim res As Result
  
  $sBillMode = ""
  $sItemName = ""
  $PositionList = New String[]
  If sID Then
    res = modDatabase.$myConn.Exec("select fldencounterval,fldbillingmode,flditemtype,flditemname from " & $tblpatbilling & " where fldid=&1 and fldencounterval=&2", sID, $encid)
    If res.Available Then
      $sBillMode = res["fldbillingmode"]
      $sItemName = res["flditemname"]
      $PositionList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldusertype) as col from tblprocedureshare where flditemtype=&1 and fldbillingmode like &2 and (flditemname like &3 or flditemname=&4) and fldactive=&5", "Radio Diagnostics", res["fldbillingmode"], res["flditemname"], "%", "Active"))
      ShowSurgUser()
      btnaddperson.Enabled = True
    Endif
  Endif
  
End

Public Sub cmbpertype_KeyRelease()
  
  modFillContainer.AutoFillComboBox(cmbpertype)
  modFillContainer.RestrictComboToContent(cmbpertype)
  
End

Public Sub cmbpertype_Click()
  
  Dim xval As String
  
  If cmbpertype.Text Then
    xval = GetDefaultUser(cmbpertype.Text)
    If xval Then
      btnconsult.Tag = xval
      btnconsult.Text = modGeneral.GetUserFullName(btnconsult.Tag)
      btnconsult.Enabled = False
    Endif
  Endif
  
End

Private Function GetDefaultUser(xUserType As String) As String
  
  Dim res As Result
  Dim xval As String
  
  If $ProcBill Then
    res = modDatabase.$myConn.Exec("select flddefault from tblprocedureshare where flditemtype=&1 and fldbillingmode like &2 and (flditemname like &3 or flditemname=&4) and fldactive=&5 and fldusertype=&6", "Radio Diagnostics", $sBillMode, $sItemName, "%", "Active", xUserType)
    If res.Available Then
      res.MoveFirst
      If res["flddefault"] Then
        xval = res["flddefault"]
      Else
        xval = ""
      Endif
    Else
      xval = ""
    Endif
  Endif
  Return xval
  
End

Public Sub btnconsult_Click()
  
  Dim xMedUser As String[]
  
  If modBasic.$PayableUserFormat = "Restricted" Then
    xMedUser = MedicalSelectedValue(("Select Payable User"), modGeneral.CategoricalUserList("fldpayable", cmbpertype.Text))
  Else
    xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  Endif
  If xMedUser And If xMedUser.Count Then
    btnconsult.Tag = xMedUser[0]
    btnconsult.Text = xMedUser[1]
  Else
    btnconsult.Tag = ""
    btnconsult.Text = ""
  Endif
  
End

Public Sub btnaddperson_Click()
  
  If $ProcBill Then
    If cmbpertype.Text And If btnconsult.Tag Then
      If Not btnpayto.Tag Then
        modPatientGeneral.AddClinicalSharingUser("Radio Diagnostics", $ProcBill, Trim(txtencid.Text), cmbpertype.Text, btnconsult.Tag, "", $sLevel, 100)
        ' ' modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), cmbpertype.Text, btnconsult.Tag, "")
        ShowSurgUser()
        cmbpertype.Text = ""
        btnconsult.Tag = ""
        btnconsult.Text = ""
        btnconsult.Enabled = True
        cmbpertype.SetFocus
      Endif
    Endif
  Else
    Message.Warning("User Sharing can be added only after Billing", ("OK"))
  Endif
  
End

Private Sub ShowSurgUser()
  
  Dim Column As Integer
  Dim fld As ResultField
  Dim $sData3 As Result
  Dim posList As String[]
  
  $sData3 = modDatabase.$myConn.Exec("select fldid,fldtime,fldusertype,fldvalue,fldreport from tblpatgenshare where flditemid=&1 and fldcategory=&2 and fldactive=&3", $ProcBill, "Radio Diagnostics", $sLevel)
  
  grdperson.Clear
  grdperson.Columns.Count = $sData3.Fields.Count
  grdperson.Rows.Count = $sData3.Count
  posList = New String[]
  
  For Each $sData3
    posList.Add($sData3["fldusertype"])
    Column = 0
    For Each fld In $sData3.Fields
      modGeneralMain.GridExplicitDecoration(grdperson, $sData3.Index, Column)
      If Column = 3 Then
        grdperson[$sData3.Index, Column].Text = modGeneral.GetUserFullName($sData3[fld.Name])
      Else
        grdperson[$sData3.Index, Column].Text = $sData3[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  grdperson.Row = 0
  cmbpertype.List = modString.GetRemainingArray($PositionList, posList)
  
  With grdperson
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 100 * modBasic.$AppWidthRatio
    .Columns[3].Width = 175 * modBasic.$AppWidthRatio
    .Columns[4].Width = 250 * modBasic.$AppWidthRatio
    
    .Columns[2].Text = "Category"
    .Columns[3].Text = "User Name"
    .Columns[4].Text = "Description"
  End With
  
End

Public Sub grdperson_Click()
  
  Dim res As Result
  Dim xx As String
  
  If grdperson.Column = 4 Then
    xx = GetTextArea(grdperson[grdperson.Row, 0].Text, grdperson[grdperson.Row, 4].Text)
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatgenshare", "fldid=&1 and fldsave=&2", grdperson[grdperson.Row, 0].Text, True)
      res["fldreport"] = xx
      res["flduptime"] = Now()
      res["xyz"] = False
      res.Update
      ShowSurgUser()
    Endif
  Endif
  
End

Public Sub grdperson_Menu()
  
  mnudelperson.Popup()
  
End

Public Sub mnudelsurguser_Click()
  
  If grdperson.Rows.Selection.Count Then
    modDatabase.$myConn.Delete("tblpatgenshare", "fldid=&1 and fldsave=&2", grdperson[grdperson.Row, 0].Text, True)
    ShowSurgUser()
  Endif
  
End

Public Sub btnprefix_Click()
  
  Dim res As Result
  Dim xrefer As String
  
  If GridView1.Rows.Selection.Count Then
    res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView1[GridView1.Row, 0].Text)
    If res["fldsampleid"] Then
      Message.Warning("Reference is " & res["fldsampleid"], "OK")
    Else
      
      xrefer = InputBox("Reference For this Examination", "Radiology", modRadioSub.GetRadioAutoIncreasingNo())
      If xrefer Then
        res["fldsampleid"] = xrefer
        res.Update
        ShowGridMain()
      Endif
      
    Endif
  Endif
  
End

Public Sub btnbarcode_Click()
  
  Dim sColl As New Collection
  
  If GridView1.Rows.Selection.Count Then
    If GridView1[GridView1.Row, 20].Text Then
      sColl.Add(modReportVar.GetDateTimeReport(GridView1[GridView1.Row, 20].Text, gb.MediumDate), "SampleBookingDate")
      modLabSub.PrintBarCodeSampling($encid, GridView1[GridView1.Row, 17].Text, GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 5].Text, txtencid.Text, sColl)
    Else
      modLabSub.PrintBarCodeSampling($encid, GridView1[GridView1.Row, 17].Text, GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 5].Text, txtencid.Text)
    Endif
  Endif
  
End

''====================== Repository ================
Public Sub btnupload_Click()
  
  Dim rsx1 As Result
  Dim rs1 As Result
  Dim hField1 As ResultField
  Dim res1 As Result
  
  Dim rsx2 As Result
  Dim rs2 As Result
  Dim hField2 As ResultField
  Dim res2 As Result
  
  Dim hForm As FmTeleRadio
  
  If GridView1.Rows.Selection.Count Then
    '' import tblpatradiotest
    rsx1 = modDatabase.$myConn.Exec("select fldid from tbltelradiotest where fldtestno=&1", GridView1[GridView1.Row, 0].Text)
    If Not rsx1.Available Then
      rs1 = modDatabase.$myConn.Exec("select *from tblpatradiotest where fldid=&1", GridView1[GridView1.Row, 0].Text)
      If rs1.Available Then
        res1 = modDatabase.$myConn.Create("tbltelradiotest")
        For Each hField1 In res1.Fields
          If hField1.Name = "fldtestno" Then
            res1["fldtestno"] = rs1["fldid"]
          Else If hField1.Name = "fldreportquali" Then
            res1["fldreportquali"] = ""
          Else If hField1.Name = "fldreportquanti" Then
            res1["fldreportquanti"] = 0
          Else
            res1[hField1.Name] = rs1[hField1.Name]
          Endif
        Next
        res1.Update
      Endif
    Endif
    
    ''import tblpatradiosubtest
    rsx2 = modDatabase.$myConn.Exec("select fldid from tbltelradiosubtest where fldencounterval=&1 and fldtestid=&2", $encid, GridView1[GridView1.Row, 0].Text)
    If Not rsx2.Available Then
      rs2 = modDatabase.$myConn.Exec("select *from tblpatradiosubtest where fldencounterval=&1 and fldtestid=&2", $encid, GridView1[GridView1.Row, 0].Text)
      If rs2.Available Then
        For Each rs2
          res2 = modDatabase.$myConn.Create("tbltelradiosubtest")
          For Each hField2 In res2.Fields
            If hField2.Name = "fldsubtestno" Then
              res2["fldsubtestno"] = rs2["fldid"]
            Else If hField2.Name = "fldreport" Then
              res2["fldreport"] = ""
            Else
              res2[hField2.Name] = rs2[hField2.Name]
            Endif
          Next
          res2.Update
        Next
      Endif
    Endif
    
    hForm = New FmTeleRadio($encid, "Radio")
    hForm.ShowModal()
  Endif
  
End

' ' ' ''======================== PAHS Customization ==========================
' ' ' Public Sub mnuaddques_Click()
' ' '
' ' '   Dim xdate As Date
' ' '
' ' '   xdate = GetDateValue("Select End Date for Radiology Que", "Add Parameters", Now())
' ' '   If xdate Then
' ' '     modPAHSRadio.AddRadiologyQues(xdate)
' ' '   Endif
' ' '
' ' ' End
' ' '
' ' ' Public Sub btnprefix_Click()
' ' '
' ' '   Dim res As Result
' ' '   Dim xdept As String
' ' '   Dim xrefer As String
' ' '   Dim Row As Integer
' ' '
' ' '   If GridView1.Rows.Selection.Count Then
' ' '     Row = GridView1.Row
' ' '     res = modDatabase.$myConn.Edit("tblpatradiotest", "fldid=&1", GridView1[GridView1.Row, 0].Text)
' ' '     If res["fldsampleid"] Then
' ' '       Message.Warning("Reference is " & res["fldsampleid"], "OK")
' ' '     Else
' ' '
' ' '       xdept = modFixRadio.GetRadioTestCategory(res["fldtestid"])
' ' '       If xdept Then
' ' '
' ' '         xrefer = modPAHSRadio.GetRadiologyInvoiceQueNo(res["fldencounterval"], xdept, res["fldbillno"])
' ' '         If Not xrefer Then
' ' '           xrefer = CStr(modPAHSRadio.GetRadiologyQueNo(Now(), xdept))
' ' '         Endif
' ' '         If xrefer Then
' ' '           res["fldsampleid"] = UCase(Left(xdept, 1)) & xrefer
' ' '           res.Update
' ' '           ShowGridMain()
' ' '         Endif
' ' '
' ' '       Endif
' ' '
' ' '     Endif
' ' '     GridView1.Row = Row
' ' '   Endif
' ' '
' ' ' End
' ' ' ''=======================================================================================
