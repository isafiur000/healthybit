' Gambas class file

''controls
Private aWebFrame As New Object[50]
Private aWebPanel As New Object[50]
Private aIndexLabel As New Object[50]    ''aLab
Private aNameLabel As New Object[50]       ''aObj
Private aAbnormCheck As New Object[50]       ''aObj2
Private aDelButton As New Object[50]
Private aComboBox As New Object[50]
Private aChkLock As New Object[50]
Private aDichoValue As New Object[50]
Private aHTMLText As New Object[50]          ''aObj11
Private aLineText As New Object[50]
Private aUnitText As New Object[50]
Private aValueBox As New Object[50]
Private aNullCheck As New Object[50]
Private aClinBox As New Object[50]
Private aTextArea As New Object[50]
Private aDateBox As New Object[50]
Private aBSDate As New Object[50]
Private aLeftRight As New Object[50]
Private aGridView As New Object[50]          ''aObg11
Private aGenTextArea As New Object[50]
Private aLimitLabel As New Object[50]
Private aCalcBox As New Object[50]
Private aCalcUnit As New Object[50]
Private aCalcNull As New Object[50]
Private aCalcLimit As New Object[50]
Private aButtonBox As New Object[50]
Private aHelpButton As New Object[50]           ''aObj3
Private aBlankBox As New Object[50]
Private aWebSpace As New Object[50]
''other variables
Private $frm As String
Private $id As Long
Private AppFactor As Float
''lists
Private $xData As Variant[]
Private $sYear As String
Private $encid As String

Private $tblpatlabtest As String
Private $tblpatlabsubtest As String

''----------------------------------------- create controls -----------------------------------------
Public Sub _new(id As Long, frm As String, strExam As String, xData As Variant[], xnote As String, sYear As String)

  Dim ht As String

  $id = id
  $frm = frm
  lblitem.Text = strExam
  $xData = xData
  $sYear = sYear

  If xnote Then
    lblnote.Text = xnote
  Else
    lblnote.Visible = False
    Label1.Visible = False
  Endif

  ht = modSettings.ShowSettingFromFIle("MultipleTextBox/Height")
  If ht Then
    Slider1.Value = CInt(ht)
  Else
    Slider1.Value = 3
  Endif
  AppFactor = modBasic.$AppScaleFactor
  LoadTableNames()
  $encid = modMedReports.GetPatientEncFromID($tblpatlabtest, $id)
  CreateControls()

End

Private Sub LoadTableNames()

  Dim res As Result

  If $sYear = "Current" Then
    $tblpatlabtest = "tblpatlabtest"
    $tblpatlabsubtest = "tblpatlabsubtest"
  Else
    res = modDatabase.$syConn.Exec("select fldpatlabtest,fldpatlabsubtest from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", $sYear, "Active")
    If res.Available Then
      If res["fldpatlabtest"] Then
        $tblpatlabtest = res["fldpatlabtest"]
      Else
        $tblpatlabtest = "tblpatlabtest"
      Endif
      If res["fldpatlabsubtest"] Then
        $tblpatlabsubtest = res["fldpatlabsubtest"]
      Else
        $tblpatlabsubtest = "tblpatlabsubtest"
      Endif
    Else
      $tblpatlabtest = "tblpatlabtest"
      $tblpatlabsubtest = "tblpatlabsubtest"
    Endif
  Endif

End

Private Sub CreateControls()

  Dim i As Integer

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      aWebFrame[i] = New HBox(Frame1)
      aIndexLabel[i] = New Label(aWebFrame[i]) As "IndexLabel"
      aNameLabel[i] = New TextLabel(aWebFrame[i]) As "NameLabel"

      aWebPanel[i] = New HBox(Frame1)
      Select $xData[i][3]
        Case "Drug Sensitivity", "WHO Sensitivity"
          aDelButton[i] = New Button(aWebPanel[i]) As "DeleteButton"
        Case Else
          aAbnormCheck[i] = New CheckBox(aWebPanel[i]) As "CheckBoxgroup"
      End Select
      Select $xData[i][3]
        Case "Multiple Selection", "Drug Sensitivity", "WHO Sensitivity", "Text Table", "Dual Columns", "Triple Columns", "Single Column"
          aGridView[i] = New GridView(aWebPanel[i]) As "Gridgroup"
        Case "Left and Right"
          aLeftRight[i] = New LeftRightTextArea(aWebPanel[i]) As "LeftRightGroup"
        Case "Date Time", "BS Date"
          aDateBox[i] = New DateBox(aWebPanel[i]) As "DateGroup"
          aBSDate[i] = New ToolButton(aWebPanel[i]) As "BSButton"
        Case "User Profile"
        Case "ImageValue"
          aButtonBox[i] = New ButtonBox(aWebPanel[i]) As "ImageBoxGroup"
        Case "Calculated"
          aCalcBox[i] = New ValueBox(aWebPanel[i]) As "CalcGroup"
          aCalcUnit[i] = New TextBox(aWebPanel[i]) As "CalcUnitGroup"
          aCalcNull[i] = New CheckBox(aWebPanel[i]) As "CalcCheckBox"
          aCalcLimit[i] = New Label(aWebPanel[i])
        Case "Quantitative", "Percent Sum"
          aValueBox[i] = New ValueBox(aWebPanel[i]) As "ValueGroup"
          aUnitText[i] = New TextBox(aWebPanel[i]) As "UnitGroup"
          aNullCheck[i] = New CheckBox(aWebPanel[i]) As "NullCheckBox"
          aLimitLabel[i] = New Label(aWebPanel[i])
        Case "Clinical Scale"
          aTextArea[i] = New TextArea(aWebPanel[i]) As "TextAreaGroup"
          aClinBox[i] = New ValueBox(aWebPanel[i]) As "ClinGroup"
        Case "Qualitative"
          aLineText[i] = New TextBox(aWebPanel[i]) As "TextLineGroup"
          aLimitLabel[i] = New Label(aWebPanel[i])
        Case "Single Selection"
          aComboBox[i] = New ComboBox(aWebPanel[i]) As "ComboGroup"
          aChkLock[i] = New CheckBox(aWebPanel[i]) As "CheckLock"
        Case "Dichotomous"
          aDichoValue[i] = New DichotomousValue(aWebPanel[i]) As "DichoText"
        Case "RichText Area"
          aHTMLText[i] = New TextHTML(aWebPanel[i]) As "TextHTMLgroup"
        Case "Label Only"
          aLineText[i] = New Label(aWebPanel[i]) As "LabelOnlygroup"
        Case Else
          aGenTextArea[i] = New TextPlain(aWebPanel[i]) As "GenAreaGroup"
      End Select
      aHelpButton[i] = New ToolButton(aWebPanel[i]) As "ButtonBoxgroup"
      aBlankBox[i] = New Label(aWebPanel[i])
      aWebSpace[i] = New Separator(Frame1)
    Endif
  Next
  DIsplayTextForm()

End

Private Sub DIsplayTextForm()

  Dim i As Integer
  Dim asx As String[]

  For i = 0 To $xData.Count - 1
    If i < 49 Then

      With aWebFrame[i]
        .Height = 25 * AppFactor
        .Width = Frame1.Width
      End With

      ''create index label
      With aIndexLabel[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = i + 1
        .Visible = False
        .Tag = i
      End With

      ''create Name Label
      With aNameLabel[i]
        .Expand = True
        .Height = 25 * AppFactor
        If $xData[i][3] = "Label Only" Then
          .Text = UCase($xData[i][0])
        Else
          .Text = "<p>" & $xData[i][0] & "</p>"
        Endif
        .Font.Bold = True
        .Tag = i
        .Wrap = True
      End With

      If $xData[i][3] = "Label Only" Then
        With aWebPanel[i]
          .Visible = False
        End With
      Else
        With aWebPanel[i]
          .AutoResize = True
          .Margin = True
          .Width = Frame1.Width
        End With
      Endif

      ''create abnormal checkbox
      If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
        With aDelButton[i]
          .Width = 25 * AppFactor
          .Height = 25 * AppFactor
          ' .Text = "Del"
          .Picture = Picture["icon:/small/cancel"]
          .Tag = i
        End With
      Else If $xData[i][3] = "Label Only" Then
      Else
        With aAbnormCheck[i]
          .Width = 75 * AppFactor
          .Height = 25 * AppFactor
          .Text = "Abn"
          .Value = $xData[i][4]
          If .Value = True Then
            .Foreground = Color.Red
          Else
            .Foreground = Color.Default
          Endif
          .Tag = i
        End With
      Endif

      ''create observation entry
      If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
        With aGridView[i]
          .Expand = True
          .Height = 25 * Slider1.Value * AppFactor
          .Mode = Select.Single
          If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Then
            .Header = GridView.Horizontal
          Endif
          .ScrollBar = Scroll.Both
          .AutoResize = True
          .Tag = i
        End With
        LoadSubTable($xData[i][2], $frm, aGridView[i])
        With aGridView[i]
          If $xData[i][3] = "Dual Columns" Then
            .Columns[0].Width = 1
            .Columns[1].Expand = True '150 * modBasic.$AppWidthRatio
            .Columns[2].Width = 150 * modBasic.$AppWidthRatio
            .Columns[3].Width = 150 * modBasic.$AppWidthRatio
            .Columns[1].Text = "Parameter"
            .Columns[2].Text = "LEFT"
            .Columns[3].Text = "RIGHT"
          Else If $xData[i][3] = "Triple Columns" Then
            .Columns[0].Width = 1
            .Columns[1].Expand = True '150 * modBasic.$AppWidthRatio
            .Columns[2].Width = 150 * modBasic.$AppWidthRatio
            .Columns[3].Width = 150 * modBasic.$AppWidthRatio
            .Columns[4].Width = 150 * modBasic.$AppWidthRatio
            .Columns[1].Text = "Parameter"
            .Columns[2].Text = "COLUMN-I"
            .Columns[3].Text = "COLUMN-II"
            .Columns[4].Text = "COLUMN-III"
          Else If $xData[i][3] = "WHO Sensitivity" Then
            .Columns[0].Width = 1
            .Columns[1].Expand = True '150 * modBasic.$AppWidthRatio
            .Columns[2].Width = 150 * modBasic.$AppWidthRatio
            .Columns[3].Width = 100 * modBasic.$AppWidthRatio
            .Columns[4].Width = 100 * modBasic.$AppWidthRatio
          Else If $xData[i][3] = "Drug Sensitivity" Then
            .Columns[0].Width = 1
            .Columns[1].Expand = True '150 * modBasic.$AppWidthRatio
            .Columns[2].Width = 150 * modBasic.$AppWidthRatio
          Else
            .Columns[0].Width = 1
            .Columns[1].Expand = True '150 * modBasic.$AppWidthRatio
          Endif
        End With

      Else If $xData[i][3] = "Left and Right" Then
        asx = GetListForControl($xData[i][0], $xData[i][3])
        With aLeftRight[i]
          .Expand = True
          .Height = 25 * Slider1.Value * AppFactor
          If asx.Count >= 1 Then
            .LeftTitle = asx[0]
            .RightTitle = asx[1]
          Endif
          .DataText = $xData[i][1]
          .Tag = i
        End With

      Else If $xData[i][3] = "Date Time" Then
        With aDateBox[i]
          .Width = 200 * AppFactor
          .Height = 25 * AppFactor
          .Mode = DateChooser.DateTime
          .Tag = i
          .Value = Val($xData[i][1])
        End With
        With aBSDate[i]
          .Width = 30 * AppFactor
          .Height = 25 * AppFactor
          .Picture = Picture["icon:/small/calendar"]
          .Tag = i
        End With

      Else If $xData[i][3] = "BS Date" Then
        With aDateBox[i]
          .Width = 200 * AppFactor
          .Height = 25 * AppFactor
          .Mode = DateChooser.DateTime
          .Tag = i
          .Value = modDate.ConvertToEngFullDateTime($xData[i][1])
        End With
        With aBSDate[i]
          .Width = 30 * AppFactor
          .Height = 25 * AppFactor
          .Picture = Picture["icon:/small/calendar"]
          .Tag = i
        End With

      Else If $xData[i][3] = "User Profile" Then
      Else If $xData[i][3] = "ImageValue" Then
        With aButtonBox[i]
          .Width = 250 * AppFactor
          .Height = 25 * AppFactor
          .Text = ""
          .Tag = i
        End With

      Else If $xData[i][3] = "Calculated" Then
        If $xData[i][1] Then
          asx = modString.SplitValueText($xData[i][1])
        Else
          asx = ["", ""]
        Endif
        With aCalcBox[i]
          .Width = 150 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
          If asx[0] Then
            .Value = CFloat(asx[0])
          Endif
        End With
        With aCalcUnit[i]
          .Width = 100 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
          .Text = asx[1]
        End With
        With aCalcNull[i]
          .Width = 75 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
          .Value = False
          .Text = "Null"
          ' If modBasic.$LabQuickMulti = "Yes" Then
          '   .Enabled = False
          ' Endif
        End With
        With aCalcLimit[i]
          .Expand = True
          .Height = 25 * AppFactor
          .Border = Border.Plain
          .Text = modFixLab.GetSubLatTestQualiReference(lblitem.Text, $xData[i][0])
          .Tag = i
        End With

      Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
        If $xData[i][1] Then
          asx = modString.SplitValueText($xData[i][1])
        Else
          asx = ["", ""]
        Endif
        With aValueBox[i]
          .Width = 150 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
          If asx[0] And If IsNumber(asx[0]) Then
            .Value = CFloat(asx[0])
          Endif
        End With
        With aUnitText[i]
          .Width = 100 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
          .Text = asx[1]
          ' If modBasic.$LabQuickMulti = "Yes" Then
          '   .Enabled = False
          ' Endif
        End With
        With aNullCheck[i]
          .Width = 75 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
          .Value = False
          .Text = "Null"
          ' If modBasic.$LabQuickMulti = "Yes" Then
          '   .Enabled = False
          ' Endif
        End With
        With aLimitLabel[i]
          .Expand = True
          .Height = 25 * AppFactor
          .Border = Border.Plain
          .Text = modFixLab.GetSubLatTestQualiReference(lblitem.Text, $xData[i][0])
          .Tag = i
        End With

      Else If $xData[i][3] = "Clinical Scale" Then
        With aTextArea[i]
          .Expand = True
          .Height = 25 * AppFactor
          .Tag = i
        End With
        With aClinBox[i]
          .Width = 150 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
        End With

      Else If $xData[i][3] = "Qualitative" Then
        With aLineText[i]
          .Width = 250 * AppFactor
          .Height = 25 * AppFactor
          .Text = $xData[i][1]
          .Tag = i
          ' If modBasic.$LabQuickMulti = "Yes" Then
          '   .Enabled = False
          ' Endif
        End With
        With aLimitLabel[i]
          .Expand = True
          .Height = 25 * AppFactor
          .Border = Border.Plain
          .Text = modFixLab.GetSubLatTestQualiReference(lblitem.Text, $xData[i][0])
          .Tag = i
        End With

      Else If $xData[i][3] = "Single Selection" Then
        With aComboBox[i]
          .Width = 300 * AppFactor
          .Height = 25 * AppFactor
          .List = GetListForControl($xData[i][0], $xData[i][3])
          .Text = $xData[i][1]
          If $xData[i][1] Then
            .Enabled = False
          Endif
          .Tag = i
        End With
        With aChkLock[i]
          .Width = 25 * AppFactor
          .Height = 25 * AppFactor
          If $xData[i][1] Then
            .Value = True
          Endif
          .Tag = i
        End With

      Else If $xData[i][3] = "Dichotomous" Then
        With aDichoValue[i]
          .Expand = True
          .Height = 25 * AppFactor
          .List = GetListForControl($xData[i][0], $xData[i][3])
          .Value = $xData[i][1]
          .Tag = i
        End With

      Else If $xData[i][3] = "RichText Area" Then
        With aHTMLText[i]
          .Expand = True
          .Height = 25 * Slider1.Value * AppFactor
          .RichText = $xData[i][1]
          .DictionaryPath = modBasic.$dictPathList
          .Tag = i
        End With

      Else If $xData[i][3] = "Label Only" Then
        With aLineText[i]
          .Expand = True
          .Height = 25 * AppFactor
          .Enabled = False
          .Text = ""
          .Tag = i
        End With

      Else
        With aGenTextArea[i]
          .Expand = True
          .Height = 25 * Slider1.Value * AppFactor
          .Text = $xData[i][1]
          .DictionaryPath = modBasic.$dictPathList
          .Tag = i
        End With

      Endif

      ''create help button
      With aHelpButton[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = ""
        .Picture = Picture["icon:/small/info"]
        .Tag = i
        .Tooltip = "[Ctrl+O] to display Options"
        ' If modBasic.$LabQuickMulti = "Yes" Then
        '   .Enabled = False
        ' Endif
      End With

      With aBlankBox[i]
        .Height = 25 * AppFactor
        .Width = 15 * AppFactor
      End With

      With aWebSpace[i]
        .Height = 15 * AppFactor
      End With

    Endif
  Next

  GetFocusControl(0)

End

Private Function GetListForControl(sItem As String, sSelection As String) As String[]

  Dim xList As String[]

  xList = modAllExam.SelectSubExamOptionList($frm, lblitem.Text, sItem, sSelection)

  Return xList

End

Private Sub GetFocusControl(i As Integer)

  If aHTMLText[i] Then
    ScrollView1.EnsureVisible(aHTMLText[i].X, aHTMLText[i].Y, aHTMLText[i].Width, aHTMLText[i].Height)
    aHTMLText[i].SetFocus
  Else If aLineText[i] Then
    ScrollView1.EnsureVisible(aLineText[i].X, aLineText[i].Y, aLineText[i].Width, aLineText[i].Height)
    aLineText[i].SetFocus
  Else If aComboBox[i] Then
    ScrollView1.EnsureVisible(aComboBox[i].X, aComboBox[i].Y, aComboBox[i].Width, aComboBox[i].Height)
    aComboBox[i].SetFocus
  Else If aDichoValue[i] Then
    ScrollView1.EnsureVisible(aDichoValue[i].X, aDichoValue[i].Y, aDichoValue[i].Width, aDichoValue[i].Height)
    aDichoValue[i].SetFocus
  Else If aCalcNull[i] Then
    ScrollView1.EnsureVisible(aCalcNull[i].X, aCalcNull[i].Y, aCalcNull[i].Width, aCalcNull[i].Height)
    aCalcNull[i].SetFocus
  Else If aValueBox[i] Then
    ScrollView1.EnsureVisible(aValueBox[i].X, aValueBox[i].Y, aValueBox[i].Width, aValueBox[i].Height)
    aValueBox[i].SetFocus
  Else If aDateBox[i] Then
    ScrollView1.EnsureVisible(aDateBox[i].X, aDateBox[i].Y, aDateBox[i].Width, aDateBox[i].Height)
    aDateBox[i].SetFocus
  Else If aGenTextArea[i] Then
    ScrollView1.EnsureVisible(aGenTextArea[i].X, aGenTextArea[i].Y, aGenTextArea[i].Width, aGenTextArea[i].Height)
    aGenTextArea[i].SetFocus
  Endif

Catch

End

Public Sub DeleteButton_Click()

  Dim j As Integer

  j = Last.Tag
  modDatabase.$myConn.Delete($tblpatlabsubtest, "fldid=&1", $xData[j][2])
  Wait
  Me.Close()

End

Public Sub BSButton_Click()

  Dim j As Integer
  Dim xx As String

  j = Last.Tag
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
  If xx Then
    aDateBox[j].Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub CheckBoxgroup_Click()

  Dim j As Integer

  j = Last.Tag
  If aAbnormCheck[j].Value = True Then
    aAbnormCheck[j].Foreground = Color.Red
  Else
    aAbnormCheck[j].Foreground = Color.Default
  Endif

End

''------------------------ General form
Public Sub Form_Open()

  Dim xoption As String
  Dim xRepoLock As String

  modGeneralMain.ArrangeFormCentre(Me, "False")
  modGeneralMain.ShowFormSizeParam(Me)
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/AutoDisplayOptions")
  If xoption = "Yes" Then
    chkautoption.Value = True
  Else If xoption = "No" Then
    chkautoption.Value = False
  Endif

  If modBasic.$LabPrintWithEntry = "Enable" Then
    xRepoLock = modBasic.$LabOutputLock
    If xRepoLock = "Verified" Then
      pnlprint.Visible = False
    Else
      If $frm = "Test" Then
        pnlprint.Visible = True
        cmbprintform.List = ["A", "B", "C", "D"]
      Else If $frm = "Radio" Then
        pnlprint.Visible = True
        cmbprintform.List = ["A", "B", "C"]
      Else
        pnlprint.Visible = False
      Endif
    Endif
  Endif

End

Public Sub Form_Close()

  modGeneralMain.DisableJavaScript()

End

Public Sub btnexectext_Click()

  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & modCloudAI.GetPatCloudAIResponse($encid, aHTMLText[j].Text)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & modCloudAI.GetPatCloudAIResponse($encid, aGenTextArea[j].Text)
  Endif

End

Public Sub dctexectext_Click()

  Dim xx As String
  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLText[j] Then
    xx = GetRichTextArea($xData[j][0], aHTMLText[j].RichText)
    If xx Then
      aHTMLText[j].RichText = xx
    Endif
  Else If aGenTextArea[j] Then
    xx = GetTextArea($xData[j][0], aGenTextArea[j].Text)
    If xx Then
      aGenTextArea[j].Text = xx
    Endif
  Endif

End

Public Sub btntempltext_Click()

  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & DictionaryVIew(modBasic.$dictadvPath)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & DictionaryVIew(modBasic.$dictadvPath)
  Endif

End

Public Sub chkautoption_Click()

  modSettings.EnterCheckSetting(chkautoption, "EntrySetting/AutoDisplayOptions")

End

Public Sub btnrefresh_Click()

  modSettings.SaveSettingsToFile("MultipleTextBox/Height", Slider1.Value)
  DIsplayTextForm()

End

Public Sub Form_Resize()

  DIsplayTextForm()

End

Public Sub btnBrChange_Click()

  modGeneralMain.SaveFormArrangement(Me)
  Me.Close()

End

Public Sub btnBrOK_Click()

  Dim i As Integer
  Dim xval As Float

  xval = 0
  For i = 0 To $xData.Count - 1
    If $xData[i][3] = "Percent Sum" Then
      xval = xval + aValueBox[i].Value
    Endif
  Next
  If xval = 0 Then
    SaveEntryData()
  Else
    If xval = 100 Then
      SaveEntryData()
    Else
      If Message.Question(("Percent Values Sum not equal to 100. Do you want to proceed?"), ("No"), ("Yes")) = 2 Then
        SaveEntryData()
      Endif
    Endif
  Endif

  Wait
  modGeneralMain.SaveFormArrangement(Me)
  modGeneralMain.SaveFormSizeParam(Me)
  If pnlprint.Visible = False Then
    Me.Close()
  Endif

End

Private Sub SaveEntryData()

  If $frm = "Test" Then
    FillLabTestSubTest()
  Else If $frm = "Exam" Then
    FillExamSubExam()
  Else If $frm = "Radio" Then
    FillRadioTestSubTest()
  Endif
  Balloon.Info(("Information saved"), btnBrOK)
  Balloon.Delay = modBasic.$BalloonDelay

End

''for examination
Private Sub FillExamSubExam()

  Dim i As Integer
  Dim res As Result

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      If $xData[i][0] = "Final Impression" Then
        If aHTMLText[i] Then
          modClinSub.UpdateQualiData($id, aHTMLText[i].RichText, aAbnormCheck[i].Value, aHTMLText[i].KeyList.Join(";"))
        Else If aGenTextArea[i] Then
          modClinSub.UpdateQualiData($id, aGenTextArea[i].Text, aAbnormCheck[i].Value, "")
        Endif

      Else
        If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
          res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = aAbnormCheck[i].Value
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
          res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = True
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLeftRight[i].DataText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Date Time" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.DateStringForExam(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "BS Date" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.ConvertToLocaldate(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "User Profile" Then
        Else If $xData[i][3] = "ImageValue" Then
          If aButtonBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then

            Endif
          Endif
        Else If $xData[i][3] = "Calculated" Then
          If aCalcBox[i].Value Or If aCalcNull[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aCalcBox[i].Value) & Space(1) & aCalcUnit[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
          If aValueBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aClinBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Qualitative" Then
          If Len(Trim(aLineText[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLineText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Single Selection" Then
          If aComboBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aComboBox[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aDichoValue[i].Value
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "RichText Area" Then
          If aHTMLText[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aHTMLText[i].RichText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aHTMLText[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Label Only" Then
          res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = False
            res["flduserid"] = ""
            res["fldtime"] = ""
            res["xyz"] = False
            res.Update()
          Endif
        Else
          If Len(Trim(aGenTextArea[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatientsubexam", "fldsubtexam=&1 and fldheadid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aGenTextArea[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aGenTextArea[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

End

''for lab tests
Private Sub FillLabTestSubTest()

  Dim i As Integer
  Dim res As Result

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      If $xData[i][0] = "Final Impression" Then
        If aHTMLText[i] Then
          modLabSub.UpdateLabTestReportQuali($id, aHTMLText[i].RichText, aAbnormCheck[i].Value, aHTMLText[i].KeyList.Join(";"), $tblpatlabtest)
        Else If aGenTextArea[i] Then
          modLabSub.UpdateLabTestReportQuali($id, aGenTextArea[i].Text, aAbnormCheck[i].Value, "", $tblpatlabtest)
        Endif

      Else
        If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
          res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = aAbnormCheck[i].Value
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
          res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = True
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLeftRight[i].DataText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Date Time" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.DateStringForExam(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "BS Date" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.ConvertToLocaldate(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "User Profile" Then
        Else If $xData[i][3] = "ImageValue" Then
          If aButtonBox[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then

            Endif
          Endif
        Else If $xData[i][3] = "Calculated" Then
          If aCalcBox[i].Value Or If aCalcNull[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aCalcBox[i].Value) & Space(1) & aCalcUnit[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
          If aValueBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aClinBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Qualitative" Then
          If Len(Trim(aLineText[i].Text)) Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLineText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Single Selection" Then
          If aComboBox[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aComboBox[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aDichoValue[i].Value
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "RichText Area" Then
          If aHTMLText[i].Text Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aHTMLText[i].RichText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aHTMLText[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Label Only" Then
          res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = False
            res["flduserid"] = ""
            res["fldtime"] = ""
            res["xyz"] = False
            res.Update()
          Endif
        Else
          If Len(Trim(aGenTextArea[i].Text)) Then
            res = modDatabase.$myConn.Edit($tblpatlabsubtest, "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aGenTextArea[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aGenTextArea[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

End

''for radio tests
Private Sub FillRadioTestSubTest()

  Dim i As Integer
  Dim res As Result

  For i = 0 To $xData.Count - 1
    If i < 49 Then
      If $xData[i][0] = "Final Impression" Then
        If aHTMLText[i] Then
          modRadioSub.UpdateRadioTestReportQuali($id, aHTMLText[i].RichText, aAbnormCheck[i].Value, aHTMLText[i].KeyList.Join(";"))
        Else If aGenTextArea[i] Then
          modRadioSub.UpdateRadioTestReportQuali($id, aGenTextArea[i].Text, aAbnormCheck[i].Value, "")
        Endif

      Else
        If $xData[i][3] = "Multiple Selection" Or If $xData[i][3] = "Text Table" Or If $xData[i][3] = "Dual Columns" Or If $xData[i][3] = "Triple Columns" Or If $xData[i][3] = "Single Column" Then
          res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = aAbnormCheck[i].Value
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Drug Sensitivity" Or If $xData[i][3] = "WHO Sensitivity" Then
          res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = True
            res["flduserid"] = modBasic.$lbluser
            res["fldtime"] = Now()
            res["xyz"] = False
            res.Update()
          Endif
        Else If $xData[i][3] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLeftRight[i].DataText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Date Time" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.DateStringForExam(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "BS Date" Then
          If aDateBox[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = modDate.ConvertToLocaldate(aDateBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "User Profile" Then
        Else If $xData[i][3] = "ImageValue" Then
          If aButtonBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then

            Endif
          Endif
        Else If $xData[i][3] = "Calculated" Then
          If aCalcBox[i].Value Or If aCalcNull[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aCalcBox[i].Value) & Space(1) & aCalcUnit[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Quantitative" Or If $xData[i][3] = "Percent Sum" Then
          If aValueBox[i].Value Or If aNullCheck[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = CStr(aClinBox[i].Value)
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Qualitative" Then
          If Len(Trim(aLineText[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aLineText[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Single Selection" Then
          If aComboBox[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aComboBox[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aDichoValue[i].Value
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "RichText Area" Then
          If aHTMLText[i].Text Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aHTMLText[i].RichText
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aHTMLText[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Else If $xData[i][3] = "Label Only" Then
          res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
          If res.Available Then
            res["fldreport"] = ""
            res["fldsave"] = True
            res["fldabnormal"] = False
            res["flduserid"] = ""
            res["fldtime"] = ""
            res["xyz"] = False
            res.Update()
          Endif
        Else
          If Len(Trim(aGenTextArea[i].Text)) Then
            res = modDatabase.$myConn.Edit("tblpatradiosubtest", "fldsubtest=&1 and fldtestid=&2", $xData[i][0], $id)
            If res.Available Then
              res["fldreport"] = aGenTextArea[i].Text
              res["fldsave"] = True
              res["fldabnormal"] = aAbnormCheck[i].Value
              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldfilepath"] = aGenTextArea[i].KeyList.Join(";")
              res["xyz"] = False
              res.Update()
            Endif
          Endif
        Endif
      Endif
    Endif
  Next

End

''for tabular data
Private Sub AddSubTableData(testid As Long, subtestid As Long, sIndex As String, sType As String, sVal As String[])

  Dim res As Result
  Dim xx As String
  Dim asx As String[]

  For Each xx In sVal
    asx = Split(Trim(xx), ";")

    If $frm = "Test" Then
      res = modDatabase.$myConn.Create("tblpatlabsubtable")
      res["fldtestid"] = testid
      res["fldsubtestid"] = subtestid
      res["fldindex"] = sIndex
    Else If $frm = "Exam" Then
      res = modDatabase.$myConn.Create("tblpatexamsubtable")
      res["fldexamid"] = testid
      res["fldsubexamid"] = subtestid
      res["fldindex"] = sIndex
    Else If $frm = "Radio" Then
      res = modDatabase.$myConn.Create("tblpatradiosubtable")
      res["fldexamid"] = testid
      res["fldsubexamid"] = subtestid
      res["fldindex"] = sIndex
    Endif
    res["fldtype"] = sType
    res["fldvariable"] = asx[0]
    If asx.Count > 1 Then
      res["fldvalue"] = asx[1]
    Endif
    If asx.Count > 2 Then
      res["fldcolm2"] = asx[2]
    Endif
    If asx.Count > 3 Then
      res["fldcolm3"] = asx[3]
    Endif
    If asx.Count > 4 Then
      res["fldcolm4"] = asx[4]
    Endif
    res["xyz"] = False
    res.Update
  Next

End

Private Sub SetQualitativeAbnormal(i As Integer)

  If $xData[i][3] = "Single Selection" Then
    If aComboBox[i].Text Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aComboBox[i].Text, $xData[i][3])
    Endif
  Else If $xData[i][3] = "Dichotomous" Then
    If aDichoValue[i].Value Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aDichoValue[i].Value, $xData[i][3])
    Endif
  Else If $xData[i][3] = "Left and Right" Then
    If aLeftRight[i].DataText Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aLeftRight[i].DataText, $xData[i][3])
    Endif
  Else If $xData[i][3] = "Qualitative" Then
    If aLineText[i].Text Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aLineText[i].Text, $xData[i][3])
    Endif
  Else If $xData[i][3] = "No Selection" Then
    If aGenTextArea[i].Text Then
      aAbnormCheck[i].Value = modAllExam.SelectSubExamAbnormal($frm, lblitem.Text, $xData[i][0], aGenTextArea[i].Text, $xData[i][3])
    Endif
  Endif

End

''-------------------------------- Create Grid data --------------------------------------------
Private Sub LoadSubTable(subTestID As Long, frm As String, GridView1 As GridView)

  Dim res As Result
  Dim i As Integer

  i = GridView1.Tag
  If frm = "Test" Then
    If $xData[i][3] = "Multiple Selection" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Else If $xData[i][3] = "Drug Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Else If $xData[i][3] = "WHO Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3 from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Else If $xData[i][3] = "Single Column" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Else If $xData[i][3] = "Dual Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2 from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Else If $xData[i][3] = "Triple Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3 from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Else If $xData[i][3] = "Text Table" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldcolm4 from tblpatlabsubtable where fldsubtestid=&1 and fldtestid=&2", subTestID, $id)
    Endif

  Else If frm = "Exam" Then
    If $xData[i][3] = "Multiple Selection" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Drug Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "WHO Sensitivity" Then
    Else If $xData[i][3] = "Single Column" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Dual Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2 from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Triple Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3 from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Text Table" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldcolm4 from tblpatexamsubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Endif

  Else If frm = "Radio" Then
    If $xData[i][3] = "Multiple Selection" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Drug Sensitivity" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "WHO Sensitivity" Then
    Else If $xData[i][3] = "Single Column" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Dual Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2 from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Triple Columns" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3 from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Else If $xData[i][3] = "Text Table" Then
      res = modDatabase.$myConn.Exec("select fldid,fldvariable,fldvalue,fldcolm2,fldcolm3,fldcolm4 from tblpatradiosubtable where fldsubexamid=&1 and fldexamid=&2", subTestID, $id)
    Endif

  Endif
  modGridView.ReadExplicitData(GridView1, res)

End

Public Sub Gridgroup_Click()

  Dim j As Integer
  Dim xx As String
  Dim res As Result
  Dim tbl As String
  Dim fld As String

  j = Last.Tag

  If $frm = "Test" Then
    tbl = "tblpatlabsubtable"
  Else If $frm = "Exam" Then
    tbl = "tblpatexamsubtable"
  Else If $frm = "Radio" Then
    tbl = "tblpatradiosubtable"
  Endif

  If $xData[j][3] = "Multiple Selection" Then
    fld = "fldvariable"
    xx = InputBox(("Edit Selected Value"), "Multiple Selection", aGridView[j][aGridView[j].Row, 1].Text)

  Else If $xData[j][3] = "Drug Sensitivity" Then
    fld = "fldvalue"
    xx = InputCombo(("Edit Sensitivity Value"), aGridView[j][aGridView[j].Row, 1].Text, ["Sensitive", "Intermediate", "Resistant", "Cancelled"], aGridView[j][aGridView[j].Row, 2].Text, True)                  ''                                       ''

  Else If $xData[j][3] = "WHO Sensitivity" Then
    If aGridView[j].Column = 2 Then
      fld = "fldvalue"
      xx = InputCombo(("Edit Sensitivity Value"), aGridView[j][aGridView[j].Row, 1].Text, ["Sensitive", "Intermediate", "Resistant", "Cancelled"], aGridView[j][aGridView[j].Row, 2].Text, True)                  ''                                       ''
    Else If aGridView[j].Column = 4 Then
      fld = "fldcolm3"
      xx = InputBox(("Edit Value"), aGridView[j][aGridView[j].Row, 1].Text, aGridView[j][aGridView[j].Row, 4].Text)
    Endif

  Else If $xData[j][3] = "Single Column" Then
    fld = "fldvalue"
    xx = InputBox(("Edit Observation"), aGridView[j][aGridView[j].Row, 1].Text, aGridView[j][aGridView[j].Row, 2].Text, True)                  ''                                       ''

  Else If $xData[j][3] = "Dual Columns" Then
    If aGridView[j].Column = 2 Then
      fld = "fldvalue"
      xx = InputBox(("Edit Value"), "LEFT", aGridView[j][aGridView[j].Row, 2].Text)
    Else If aGridView[j].Column = 3 Then
      fld = "fldcolm2"
      xx = InputBox(("Edit Value"), "RIGHT", aGridView[j][aGridView[j].Row, 3].Text)
    Endif

  Else If $xData[j][3] = "Triple Columns" Then
    If aGridView[j].Column = 2 Then
      fld = "fldvalue"
      xx = InputBox(("Edit Value"), "COLUMN-I", aGridView[j][aGridView[j].Row, 2].Text)
    Else If aGridView[j].Column = 3 Then
      fld = "fldcolm2"
      xx = InputBox(("Edit Value"), "COLUMN-II", aGridView[j][aGridView[j].Row, 3].Text)
    Else If aGridView[j].Column = 4 Then
      fld = "fldcolm3"
      xx = InputBox(("Edit Value"), "COLUMN-III", aGridView[j][aGridView[j].Row, 4].Text)
    Endif

  Else If $xData[j][3] = "Text Table" Then
    If aGridView[j].Column = 1 Then
      fld = "fldvariable"
      xx = InputBox(("Edit Value"), "Text Table", aGridView[j][aGridView[j].Row, 1].Text)
    Else If aGridView[j].Column = 2 Then
      fld = "fldvalue"
      xx = InputBox(("Edit Value"), "Text Table", aGridView[j][aGridView[j].Row, 2].Text)
    Else If aGridView[j].Column = 3 Then
      fld = "fldcolm2"
      xx = InputBox(("Edit Value"), "Text Table", aGridView[j][aGridView[j].Row, 3].Text)
    Else If aGridView[j].Column = 4 Then
      fld = "fldcolm3"
      xx = InputBox(("Edit Value"), "Text Table", aGridView[j][aGridView[j].Row, 4].Text)
    Else If aGridView[j].Column = 5 Then
      fld = "fldcolm4"
      xx = InputBox(("Edit Value"), "Text Table", aGridView[j][aGridView[j].Row, 5].Text)
    Endif

  Endif
  If xx Then
    res = modDatabase.$myConn.Edit(tbl, "fldid=&1", aGridView[j][aGridView[j].Row, 0].Text)
    res[fld] = xx
    res.Update
    LoadSubTable($xData[j][2], $frm, aGridView[j])
  Endif

End

''------------------------------------- short cut keys ------------------------------
Public Sub ValueGroup_Change()

  Dim i As Integer
  Dim xrange As Float[]

  i = Last.Tag
  If aValueBox[i].Value Then
    xrange = GetRefRange(aLimitLabel[i].Text)
    If xrange And If xrange.Count = 2 Then
      If aValueBox[i].Value < xrange[0] Then
        aAbnormCheck[i].Value = True
      Else If aValueBox[i].Value > xrange[1] Then
        aAbnormCheck[i].Value = True
      Else
        aAbnormCheck[i].Value = False
      Endif
    Else
      aAbnormCheck[i].Value = False
    Endif
  Else
    aAbnormCheck[i].Value = False
  Endif

  If aAbnormCheck[i].Value = True Then
    aAbnormCheck[i].Foreground = Color.Red
  Else
    aAbnormCheck[i].Foreground = Color.Default
  Endif

End

Public Sub CalcGroup_Change()

  Dim i As Integer
  Dim xrange As Float[]

  i = Last.Tag
  If aCalcBox[i].Value Then
    xrange = GetRefRange(aCalcLimit[i].Text)
    If xrange And If xrange.Count = 2 Then
      If aCalcBox[i].Value < xrange[0] Then
        aAbnormCheck[i].Value = True
      Else If aCalcBox[i].Value > xrange[1] Then
        aAbnormCheck[i].Value = True
      Else
        aAbnormCheck[i].Value = False
      Endif
    Else
      aAbnormCheck[i].Value = False
    Endif
  Else
    aAbnormCheck[i].Value = False
  Endif

  If aAbnormCheck[i].Value = True Then
    aAbnormCheck[i].Foreground = Color.Red
  Else
    aAbnormCheck[i].Foreground = Color.Default
  Endif

End

Public Sub ValueGroup_KeyRelease()

  Dim i As Integer

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    If modBasic.$LabQuickMulti = "Yes" Then
      i = Last.Tag
      Wait
      GetFocusControl(i + 1)
    Endif
  Endif

End

Public Sub ComboGroup_MouseWheel()

  Stop Event

End

Public Sub ComboGroup_KeyRelease()

  Dim i As Integer

  i = Last.Tag

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    If modBasic.$LabQuickMulti = "Yes" Then
      Wait
      GetFocusControl(i + 1)
    Endif

  Else
    ''enable on chnaging ComboBoxNew to ComboBox
    modFillContainer.AutoFillComboBox(aComboBox[i])
  Endif

End

Public Sub CheckLock_Click()

  Dim i As Integer

  i = Last.Tag
  If aChkLock[i].Value = True Then
    aComboBox[i].Enabled = False
  Else If aChkLock[i].Value = False Then
    aComboBox[i].Enabled = True
  Endif

End

Private Function GetRefRange(sRange As String) As Float[]

  Dim asx As String[]
  Dim bsx1 As String[]
  Dim bsx2 As String[]
  Dim afinal As Float[]

  afinal = New Float[]
  If sRange Then
    asx = Split(sRange, "-")
    bsx1 = Split(Trim(asx[0]), " ")
    Try afinal.Add(CFloat(Trim(bsx1[0])))
    If asx.Count > 1 Then
      bsx2 = Split(Trim(asx[1]), " ")
      Try afinal.Add(CFloat(Trim(bsx2[0])))
    Endif
  Endif
  Return afinal

End

Public Sub TextLineGroup_KeyRelease()

  Dim i As Integer

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    If modBasic.$LabQuickMulti = "Yes" Then
      i = Last.Tag
      GetFocusControl(i + 1)
    Endif
  Endif

End

Public Sub ComboGroup_GotFocus()

  Dim j As Integer

  j = Last.Tag
  If modBasic.$TabletModeEnable = "Yes" Then
    If Not aComboBox[j].Text Then
      aComboBox[j].Popup
    Endif
  Endif

End

Public Sub ComboGroup_Click()

  Dim j As Integer

  j = Last.Tag
  SetQualitativeAbnormal(j)

End

Public Sub DichoText_Click()

  Dim j As Integer

  j = Last.Tag
  SetQualitativeAbnormal(j)

End

Public Sub Form_KeyRelease()

  Dim i As Integer
  Dim j As Integer

  If Key.Code = Key.Esc Then
    Me.Close
  Else

    If Application.ActiveControl Then
      If Not Application.ActiveControl.Tag Then
        j = 0
      Else
        j = Application.ActiveControl.Tag
      Endif
      If Key.Code = Key["O"] And If Key.Control Then
        OpenOption(j)
      Else If Key.Code = Key["S"] And If Key.Control Then
        btnBrOK_Click()
      Else If Key.Code = Key["A"] And If Key.Control Then
        If aAbnormCheck[j].Value = False Then
          aAbnormCheck[j].Value = True
        Else If aAbnormCheck[j].Value = True Then
          aAbnormCheck[j].Value = False
        Endif
      Endif
    Endif

    If Key.Code = Key.F1 Then
      i = 1
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F2 Then
      i = 2
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F3 Then
      i = 3
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F4 Then
      i = 4
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F5 Then
      i = 5
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F6 Then
      i = 6
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F7 Then
      i = 7
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F8 Then
      i = 8
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F9 Then
      i = 9
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F10 Then
      i = 10
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F11 Then
      i = 11
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Else If Key.Code = Key.F12 Then
      i = 12
      OpenAutoOptions(i)
      GetFocusControl(i - 1)

    Endif

  Endif

End

''-----------------------------help options  --------------------------------------
Public Sub ButtonBoxgroup_Click()

  Dim j As Integer

  j = Last.Tag

  OpenOption(j)
  SetQualitativeAbnormal(J)

End

Private Sub OpenAutoOptions(j As Integer)

  If chkautoption.Value = True Then
    OpenOption(j - 1)
  Endif

End

Private Sub OpenOption(j As Integer)

  Dim sql1 As String
  Dim sql As String
  Dim res1 As Result
  Dim res As Result
  Dim xoption As String[]
  Dim sVal As String[]
  Dim sPath As String
  Dim xval As String

  Dim hForm As FmWHOSensitivity

  xoption = New String[]

  If $xData[j][0] = "Final Impression" Then
    If $frm = "Test" Then
      sql1 = "select fldoption as fldanswertype from tbltest where fldtestid=&1"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tbltestoption where fldtestid=&1 ORDER BY fldindex"
    Else If $frm = "Exam" Then
      sql1 = "select fldoption as fldanswertype from tblexam where fldexamid=&1"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblexamoption where fldexamid=&1 ORDER BY fldindex"
    Else If $frm = "Radio" Then
      sql1 = "select fldoption as fldanswertype from tblradio where fldexamid=&1"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblradiooption where fldexamid=&1 ORDER BY fldindex"
    Endif
    res1 = modDatabase.$myConn.Exec(sql1, lblitem.Text)
    res = modDatabase.$myConn.Exec(sql, lblitem.Text)
  Else
    If $frm = "Test" Then
      sql1 = "select fldtanswertype as fldanswertype from tbltestquali where fldsubtest=&1 and fldtestid=&2"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblsubtestquali where fldsubtest=&1 and fldtestid=&2 ORDER BY fldindex"
    Else If $frm = "Exam" Then
      sql1 = "select fldtanswertype as fldanswertype from tblexamquali where fldsubexam=&1 and fldexamid=&2"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblsubexamquali where fldsubexam=&1 and fldexamid=&2 ORDER BY fldindex"
    Else If $frm = "Radio" Then
      sql1 = "select fldtanswertype as fldanswertype from tblradioquali where fldsubexam=&1 and fldexamid=&2"
      sql = "select fldanswertype,fldanswer,fldscale,fldscalegroup from tblsubradioquali where fldsubexam=&1 and fldexamid=&2 ORDER BY fldindex"
    Endif
    res1 = modDatabase.$myConn.Exec(sql1, $xData[j][0], lblitem.Text)
    res = modDatabase.$myConn.Exec(sql, $xData[j][0], lblitem.Text)
  Endif

  If res1.Available Then
    If res1["fldanswertype"] = "Date Time" Then
      xval = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
      If xval Then
        aDateBox[j].Value = modDate.ConvertToEnglishdate(xval)
      Endif

    Else If res1["fldanswertype"] = "BS Date" Then
      xval = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
      If xval Then
        aDateBox[j].Value = modDate.ConvertToEnglishdate(xval)
      Endif

    Else If res1["fldanswertype"] = "User Profile" Then

    Else If res1["fldanswertype"] = "ImageValue" Then
      sPath = modImage.DisplayVisualData($frm, lblitem.Text, $xData[j][0], res1["fldanswertype"])
      sVal = CustomDraw(sPath)
      If sVal Then
        aButtonBox[j].Text = sVal[0]
      Endif

    Else If res1["fldanswertype"] = "Visual Input" Then
      sPath = modImage.DisplayVisualData($frm, lblitem.Text, $xData[j][0], res1["fldanswertype"])
      If sPath Then
        xval = CVisualValue(lblitem.Text, sPath, aGenTextArea[j].Text)
        If xval Then
          aGenTextArea[j].Text = xval
        Endif
      Endif

    Else If res1["fldanswertype"] = "Calculated" Then

    Else If res1["fldanswertype"] = "Quantitative" Or If res1["fldanswertype"] = "Percent Sum" Then
      aValueBox[j].Value = GetCalculateValue(modSettings.ShowEqnSettingFromFIle(lblitem.Text & "/" & $xData[j][0]))

    Else If res1["fldanswertype"] = "RichText Area" Then
      aHTMLText[j].RichText = aHTMLText[j].RichText & Space(1) & GetRichTextArea($xData[j][0], "")

    Else If res1["fldanswertype"] = "No Selection" Then
      aGenTextArea[j].Text = aGenTextArea[j].Text & Space(1) & GetTextArea($xData[j][0], "")

    Else
      If res.Available Then    ''if options available
        If res1["fldanswertype"] = "Single Selection" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Single Selection", $xData[j][0])
          If sVal Then
            aComboBox[j].Text = sVal[0]
          Endif

        Else If res1["fldanswertype"] = "Dichotomous" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Single Selection", $xData[j][0])
          If sVal Then
            aDichoValue[j].Value = sVal[0]
          Endif

        Else If res1["fldanswertype"] = "Multiple Selection" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Multiple Selection", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Multiple Selection", sVal)
            LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Text Table" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Text Table", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Text Table", sVal)
            LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Drug Sensitivity" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Drug Sensitivity", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Drug Sensitivity", sVal)
            LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "WHO Sensitivity" Then
          hForm = New FmWHOSensitivity($id, $xData[j][2], $xData[j][5], $xData[j][0], res["fldanswer"], lblnote.Text)
          hForm.ShowModal
          LoadSubTable($xData[j][2], $frm, aGridView[j])

        Else If res1["fldanswertype"] = "Single Column" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Single Column", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Single Column", sVal)
            LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Dual Columns" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Dual Columns", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Dual Columns", sVal)
            LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Triple Columns" Then
          For Each res
            xoption.Add(res["fldanswer"])
          Next
          sVal = SubChoose(xoption, "Triple Columns", $xData[j][0])
          If sVal Then
            AddSubTableData($id, $xData[j][2], $xData[j][5], "Triple Columns", sVal)
            LoadSubTable($xData[j][2], $frm, aGridView[j])
          Endif

        Else If res1["fldanswertype"] = "Clinical Scale" Then
          For Each res
            xoption.Add(res["fldanswer"] & "@" & res["fldscale"] & "@" & res["fldscalegroup"])
          Next
          sVal = SubChoose(xoption, "Clinical Scale", $xData[j][0])
          If sVal Then
            aClinBox[j].Value = sVal[0]
            aTextArea[j].Text = sVal[1]
          Endif

          ' Else If res1["fldanswertype"] = "Left and Right" Then
          '   aLeftRight[j].LeftText = aLeftRight[j].LeftText & res["fldanswer"]
          '   aLeftRight[j].RightText = aLeftRight[j].RightText & res["fldanswer"]

          ' Else If res1["fldanswertype"] = "Date Time" Then
          '   aDateBox[j].Value = Now()
          '
          ' Else If res1["fldanswertype"] = "BS Date" Then
          '   aDateBox[j].Value = Now()
          '
          ' Else If res1["fldanswertype"] = "Calculated" Then

        Endif
      Endif

    Endif
  Endif

End

Public Sub btnfill_Click()

  Dim j As Integer
  Dim res As Result
  Dim sql As String
  Dim asx As String[]

  For j = 0 To $xData.Count - 1
    If j < 49 Then

      If $xData[j][0] = "Final Impression" Then
        If aHTMLText[j] Then
          If Not aHTMLText[j].Text Then
            aHTMLText[j].RichText = modAllExam.GetExamDefaultValue($frm, lblitem.Text)
          Endif
        Else If aGenTextArea[j] Then
          If Not aGenTextArea[j].Text Then
            aGenTextArea[j].Text = modAllExam.GetExamDefaultValue($frm, lblitem.Text)
          Endif
        Endif

      Else
        If $frm = "Test" Then
          sql = "select flddetail from tbltestquali where fldsubtest=&1 and fldtestid=&2"
        Else If $frm = "Exam" Then
          sql = "select flddetail from tblexamquali where fldsubexam=&1 and fldexamid=&2"
        Else If $frm = "Radio" Then
          sql = "select flddetail from tblradioquali where fldsubexam=&1 and fldexamid=&2"
        Endif
        res = modDatabase.$myConn.Exec(sql, $xData[j][0], lblitem.Text)
        If res.Available Then

          res.MoveLast
          If aHTMLText[j] Then
            If Not aHTMLText[j].Text Then
              aHTMLText[j].RichText = res["flddetail"]
            Endif

          Else If aGenTextArea[j] Then
            If Not aGenTextArea[j].Text Then
              aGenTextArea[j].Text = res["flddetail"]
            Endif

          Else If aComboBox[j] Then
            If Not aComboBox[j].Text Then
              aComboBox[j].Text = res["flddetail"]
            Endif

          Else If aDichoValue[j] Then
            If Not aDichoValue[j].Value Then
              aDichoValue[j].Value = res["flddetail"]
            Endif

          Else If aLineText[j] Then
            If Not aLineText[j].Text Then
              aLineText[j].Text = res["flddetail"]
            Endif

          Else If aUnitText[j] Then
            asx = New String[]
            asx = Split(res["flddetail"], Space(1))
            If asx.Count = 2 Then
              aValueBox[j].Value = CFloat(asx[0])
              aUnitText[j].Text = asx[1]
            Else If asx.Count = 1 Then
              aValueBox[j].Value = CFloat(asx[0])
            Endif

          Else If aCalcUnit[j] Then
            asx = New String[]
            asx = Split(res["flddetail"], Space(1))
            If asx.Count = 2 Then
              aCalcBox[j].Value = modReportVar.GetCalcValueFloat(asx[0], $encid)
              aCalcUnit[j].Text = asx[1]
            Else If asx.Count = 1 Then
              aCalcBox[j].Value = modReportVar.GetCalcValueFloat(asx[0], $encid)
            Endif

          Endif

        Endif
      Endif

    Endif
  Next

End

Public Sub chkabnall_Click()

  Dim j As Integer

  For j = 0 To $xData.Count - 1
    If j < 49 Then
      aAbnormCheck[j].Value = chkabnall.Value
    Endif
  Next

End

Private Function GetCalculateValue(sLine As String) As Float

  Dim i As Integer
  Dim xval As Float

  If sLine Then
    For i = 0 To $xData.Count - 1
      If aValueBox[i] Then
        If (String.InStr(sLine, $xData[i][0]) > 0) Then                                   ''
          sLine = Replace(sLine, "{" & $xData[i][0] & "}", CStr(aValueBox[i].Value))
        Endif
      Endif
    Next
    If (String.InStr(sLine, "$Calc[") > 0) Then
      sLine = modReportVar.GetReportCalculation(sLine)
    Endif
    xval = CFloat(sLine)

  Else
    xval = 0
  Endif

  Return xval

End

Public Sub ImageBoxGroup_Click()

  Dim j As Integer

  j = Last.Tag
  Dialog.Filter = ["*.jpg;*.jpeg;*.png;*.bmp", "Picture files"]
  If Dialog.OpenFile() Then Return
  aButtonBox[j].Text = Dialog.Path

End

''================== Print ===================
Public Sub btnarchive_Click()

  Dim cLabForm As CLabReport
  Dim cRadioForm As CRadioReport

  If $frm = "Test" Then
    cLabForm = New CLabReport($id, cmbprintform.Text, "", chkprinted.Value)
    cLabForm.GetReportArchived()
  Else If $frm = "Radio" Then
    cRadioForm = New CRadioReport($id, cmbprintform.Text, chkprinted.Value)
    cRadioForm.GetReportArchived()
  Endif
  Me.Close()

End

Public Sub btnnohead_Click()

  Dim cLabForm As CLabReport
  Dim cRadioForm As CRadioReport

  If $frm = "Test" Then
    cLabForm = New CLabReport($id, cmbprintform.Text, "", chkprinted.Value)
    cLabForm.GetReportHeadless()
  Else If $frm = "Radio" Then
    cRadioForm = New CRadioReport($id, cmbprintform.Text, chkprinted.Value)
    cRadioForm.GetReportHeadless()
  Endif

End

Public Sub btnreport_Click()

  Dim cLabForm As CLabReport
  Dim cRadioForm As CRadioReport

  If $frm = "Test" Then
    cLabForm = New CLabReport($id, cmbprintform.Text, "", chkprinted.Value)
    cLabForm.GetReportComplete()
  Else If $frm = "Radio" Then
    cRadioForm = New CRadioReport($id, cmbprintform.Text, chkprinted.Value)
    cRadioForm.GetReportComplete()
  Endif

End
