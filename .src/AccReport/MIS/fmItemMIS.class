' Gambas class file

Private $sDepart As String
Private $ShareName As String
Private $dtfir As Date
Private $dtlast As Date
Private $cmbComp As String
Private $cmbDiscount As String
Private $tblpatbilling As String
Private $tblpatbilldetail As String

Private $ServiceTypeList As String[] = ["Diagnostic Tests", "Radio Diagnostics", "General Services", "Procedures", "Equipment", "Other Items"]
Private $PharmTypeList As String[] = ["Medicines", "Surgicals", "Extra Items"]

Private $rData As Result
Private $aMyFields As String[]
Private $RepoStr As String

Public Sub _new(sDepart As String, xShareName As String, dtfir As Date, dtlast As Date, cmbcomp As String, cmbdiscount As String, atblpatbilling As String, atblpatbilldetail As String)

  $sDepart = sDepart
  $ShareName = xShareName
  $dtfir = dtfir
  $dtlast = dtlast
  $cmbComp = cmbcomp
  $cmbDiscount = cmbdiscount
  $tblpatbilling = atblpatbilling
  $tblpatbilldetail = atblpatbilldetail

End

Public Sub Form_Open()

  lblitem.Text = $ShareName
  $RepoStr = modDataRepo.GetRepoLastStr($tblpatbilling)
  ShowGridDetaikl

End

Private Sub ShowGridDetaikl()

  Dim xfld As String
  Dim i As Integer

  For i = 0 To $ServiceTypeList.Count - 1
    $ServiceTypeList[i] = "'" & $ServiceTypeList[i] & "'"
  Next
  For i = 0 To $PharmTypeList.Count - 1
    $PharmTypeList[i] = "'" & $PharmTypeList[i] & "'"
  Next

  If $ShareName = "Hospital Share" Then
    xfld = "t2.fldhospitalshare"
  Else If $ShareName = "Instrument Share" Then
    xfld = "t2.fldinstrumshare"
  Else If $ShareName = "Department Share" Then
    xfld = "t2.flddepartshare"
  Else If $ShareName = "Anesthesia Share" Then
    xfld = "t2.fldanesthshare"
  Else If $ShareName = "Other Share" Then
    xfld = "t2.fldothershare"
  Endif

  If $sDepart = "Pharmacy Items" Then
    $rData = modDatabase.$syConn.Exec("select t1.flditemname,SUM(t1.flditemqty) as itemcnt,SUM(t1.flditemrate*t1.flditemqty) as fldgross,SUM(COALESCE(t1.fldsubsidy, 0)) as fldsubsidy,SUM(t1.flddiscamt - COALESCE(t1.fldsubsidy, 0)) as flddisc,SUM(t1.fldtaxamt) as fldtax,SUM(t1.fldditemamt) as fldnetamt,100 as fldshareper,SUM(t1.fldditemamt) as fldnetot from " & $tblpatbilling & " AS t1 where t1.fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldtime>=&1 and fldtime<=&2) and t1.fldsave=&3 and t1.fldcomp like &4 and t1.flddisctype like &5 and t1.flditemtype in(" & $PharmTypeList.Join(",") & ")" & $RepoStr & " GROUP BY t1.flditemname", modDate.StartSqlDate($dtfir), modDate.EndSqlDate($dtlast), True, $cmbComp, $cmbDiscount)
  Else If $sDepart = "Not Grouped" Then
    $rData = modDatabase.$syConn.Exec(Subst("select t1.flditemname,SUM(t1.flditemqty) as itemcnt,SUM(t1.flditemrate*t1.flditemqty) as fldgross,SUM(COALESCE(t1.fldsubsidy, 0)) as fldsubsidy,SUM(t1.flddiscamt - COALESCE(t1.fldsubsidy, 0)) as flddisc,SUM(t1.fldtaxamt) as fldtax,SUM(t1.fldditemamt) as fldnetamt,&1 as fldshareper,SUM(&1*t1.fldditemamt/100) as fldnetot from ", xfld) & $tblpatbilling & " AS t1 inner join tblservicecost as t2 on t1.flditemname=t2.flditemname where t1.flditemname not in(select flditemname from tblreportgroup) and t1.fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldtime>=&1 and fldtime<=&2) and t1.fldsave=&3 and t1.fldcomp like &4 and t1.flddisctype like &5 and " & xfld & ">&6 and t1.flditemtype in(" & $ServiceTypeList.Join(",") & ")" & $RepoStr & " GROUP BY t1.flditemname", modDate.StartSqlDate($dtfir), modDate.EndSqlDate($dtlast), True, $cmbComp, $cmbDiscount, 0)
  Else
    $rData = modDatabase.$syConn.Exec(Subst("select t1.flditemname,SUM(t1.flditemqty) as itemcnt,SUM(t1.flditemrate*t1.flditemqty) as fldgross,SUM(COALESCE(t1.fldsubsidy, 0)) as fldsubsidy,SUM(t1.flddiscamt - COALESCE(t1.fldsubsidy, 0)) as flddisc,SUM(t1.fldtaxamt) as fldtax,SUM(t1.fldditemamt) as fldnetamt,&1 as fldshareper,SUM(&1*t1.fldditemamt/100) as fldnetot from ", xfld) & $tblpatbilling & " AS t1 inner join tblservicecost as t2 on t1.flditemname=t2.flditemname where t1.flditemname in(select flditemname from tblreportgroup where fldgroup=&1) and t1.fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldtime>=&2 and fldtime<=&3) and t1.fldsave=&4 and t1.fldcomp like &5 and t1.flddisctype like &6 and " & xfld & ">&7 and t1.flditemtype in(" & $ServiceTypeList.Join(",") & ")" & $RepoStr & " GROUP BY t1.flditemname", $sDepart, modDate.StartSqlDate($dtfir), modDate.EndSqlDate($dtlast), True, $cmbComp, $cmbDiscount, 0)
  Endif
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Width = 250 * modBasic.$AppWidthRatio
    .Columns[1].Width = 75 * modBasic.$AppWidthRatio
    .Columns[2].Width = 100 * modBasic.$AppWidthRatio
    .Columns[3].Width = 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 100 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 100 * modBasic.$AppWidthRatio
    .Columns[7].Width = 100 * modBasic.$AppWidthRatio
    .Columns[8].Width = 100 * modBasic.$AppWidthRatio

    .Columns[0].Text = "Particulars"
    .Columns[1].Text = "Count"
    .Columns[2].Text = "Gross"
    .Columns[3].Text = "Subsidy"
    .Columns[4].Text = "Discount"
    .Columns[5].Text = "Tax"
    .Columns[6].Text = "NetTotal"
    .Columns[7].Text = "Share%"
    .Columns[8].Text = "NetShare"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  GridView1.Data.Text = $rData[$aMyFields[Column]]
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

Public Sub btnexport_Click()

  Dim xstr As String

  xstr = "Department: " & $sDepart & "  " & " Category: " & $ShareName
  modCHTMLReport.ExportGridToHTML(GridView1, "MIS Report: " & xstr, modReportVar.GetDateTimeReport($dtfir, gb.MediumDate) & " To " & modReportVar.GetDateTimeReport($dtlast, gb.MediumDate))

End

Public Sub GridView1_Click()

  Dim hForm As FmInvoiceMIS

  hForm = New FmInvoiceMIS($sDepart, GridView1[GridView1.Row, 0].Text, $ShareName, $dtfir, $dtlast, $cmbComp, $cmbDiscount, $tblpatbilling, $tblpatbilldetail)
  hForm.ShowModal

End
