' Gambas class file

Private $rData As Result
Private $aMyFields As String[]

Public Sub Form_Open()

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Column")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  cmbbillmode.List = modNonMedical.FillCashModeCombo()
  cmbroute.List = modMedicine.ComboRoute()
  If modHelpVariable.$LogInCategory = "Account" Then
    btnadd.Enabled = True
  Endif
  cmbbillmode.SetFocus

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Else
    modGeneralmain.GoToNextControlTab()
  Endif

End

Public Sub cmbbillmode_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbbillmode)
  modFillContainer.RestrictComboToContent(cmbbillmode)

End

Public Sub cmbroute_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbroute)
  modFillContainer.RestrictComboToContent(cmbroute)

End

Public Sub cmbroute_Click()

  txtcategory.Text = ""
  If cmbroute.Text Then
    txtcategory.Text = modNonMedical.GetBillItemCategoryFromCombo(cmbroute.Text)
  Endif

End

Public Sub cmbdrug_GotFocus()

  If Not cmbdrug.Text Then
    If modBasic.$ItemListFormat = "GridView" Then
      cmbdrug.Text = GridViewNew("Select Particulars", cmbdrug.List, False, cmbdrug, GridView1.Height)
      cmbstock.SetFocus
    Endif
  Endif

End

Public Sub cmbdrug_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdrug)
  modFillContainer.RestrictComboToContent(cmbdrug)

End

Public Sub cmbstock_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbstock)
  modFillContainer.RestrictComboToContent(cmbstock)

End

Public Sub cmbroute_LostFocus()

  cmbdrug.Clear()
  If cmbroute.Text Then
    If chkstock.Value = True Then
      cmbdrug.List = modStock.GetGenericListByRoute(cmbroute.Text, True)
    Else
      cmbdrug.List = modStock.GetGenericListByRoute(cmbroute.Text, False)
    Endif
  Endif

End

Public Sub cmbdrug_LostFocus()

  cmbstock.Clear()
  If cmbroute.Text And If cmbdrug.Text Then
    cmbstock.List = modStock.GetStockIDList(cmbroute.Text, cmbdrug.Text)
  Endif

End

Private Sub ClearAllText()

  txtid.Value = 0
  txtitem.Text = ""
  cmbroute.Text = ""
  txtcategory.Text = ""
  cmbdrug.Clear()
  cmbdrug.Text = ""
  txtitemcode.Text = ""
  cmbstock.Clear()
  cmbstock.Text = ""
  txtrate.Value = 0
  chkratenull.Value = False
  txtmaxdays.Value = 0
  txtmaxqty.Value = 0

End

Public Sub btnrefresh_Click()

  If cmbbillmode.Text Then
    ShowGridData(cmbbillmode.Text)
  Endif

End

Public Sub txtsearch_Change()

  If cmbbillmode.Text Then
    ShowGridData(cmbbillmode.Text)
  Endif

End

Public Sub btnadd_Click()

  Dim res As Result

  If Not cmbstock.Text Then
    cmbstock.Text = "%"
  Endif
  If txtitem.Text And If cmbbillmode.Text And If cmbdrug.Text Then
    res = modDatabase.$myConn.Create("tblstockrate")
    res["flditemname"] = Trim(txtitem.Text)
    res["fldbillingmode"] = cmbbillmode.Text
    res["fldcategory"] = txtcategory.Text
    res["flddrug"] = cmbdrug.Text
    res["flddrugcode"] = Trim(txtitemcode.Text)
    res["fldpackvol"] = txtpackvol.Value
    res["fldstockid"] = cmbstock.Text
    res["fldrate"] = txtrate.Value
    res["fldnullrate"] = chkratenull.Value
    res["fldwaitday"] = txtmaxdays.Value
    res["fldmaxqty"] = txtmaxqty.Value
    res["fldclaimtype"] = "Pharmacy"
    res["flduserid"] = modBasic.$lbluser
    res["fldtime"] = Now()
    res["fldcomp"] = modBasic.$compID
    res["fldsave"] = True
    res["flduptime"] = ""
    res["xyz"] = False
    res.Update
    ClearAllText()
    ShowGridData(cmbbillmode.Text)
    txtitem.SetFocus
  Endif

End

Public Sub btnedit_Click()

  Dim res As Result
  Dim Row As Integer

  If GridView1.Rows.Selection.Count Then
    If cmbbillmode.Text And If txtitem.Text Then
      Row = GridView1.Row
      res = modDatabase.$myConn.Edit("tblstockrate", "fldid=&1", txtid.Value)
      res["flditemname"] = Trim(txtitem.Text)
      res["fldbillingmode"] = cmbbillmode.Text
      res["fldcategory"] = txtcategory.Text
      res["flddrug"] = cmbdrug.Text
      res["flddrugcode"] = Trim(txtitemcode.Text)
      res["fldpackvol"] = txtpackvol.Value
      res["fldstockid"] = cmbstock.Text
      If modHelpVariable.$LogInCategory = "Account" Then
        res["fldrate"] = txtrate.Value
        res["fldnullrate"] = chkratenull.Value
      Endif
      res["fldwaitday"] = txtmaxdays.Value
      res["fldmaxqty"] = txtmaxqty.Value
      res["flduserid"] = modBasic.$lbluser
      res["fldcomp"] = modBasic.$compID
      res["fldsave"] = True
      res["flduptime"] = Now()
      res["xyz"] = False
      res.Update
      ShowGridData(cmbbillmode.Text)
      GridView1.Row = Row
    Endif
  Endif

End

Private Sub ShowGridData(sBillMode As String)

  $rData = modDatabase.$myConn.Exec("select fldid,flditemname,fldcategory,flddrug,flddrugcode,fldrate,fldbillingmode,fldpackvol,fldrate,fldstockid,fldnullrate,fldclaimtype,fldwaitday,fldmaxqty from tblstockrate where fldbillingmode=&1 and lower(flditemname) like &2 ORDER BY flditemname", sBillMode, LCase(txtsearch.Text) & "%")                                                       ''
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Width = 1
    .Columns[1].Width = 250 * modBasic.$AppWidthRatio
    .Columns[2].Width = 100 * modBasic.$AppWidthRatio
    .Columns[3].Width = 275 * modBasic.$AppWidthRatio
    .Columns[4].Width = 100 * modBasic.$AppWidthRatio
    .Columns[5].Width = 1
    .Columns[6].Width = 1
    .Columns[7].Width = 75 * modBasic.$AppWidthRatio
    .Columns[8].Width = 75 * modBasic.$AppWidthRatio
    .Columns[9].Width = 250 * modBasic.$AppWidthRatio
    .Columns[10].Width = 1
    .Columns[11].Width = 75 * modBasic.$AppWidthRatio
    .Columns[12].Width = 75 * modBasic.$AppWidthRatio
    .Columns[13].Width = 75 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "Category"
    .Columns[3].Text = "Generic"
    .Columns[4].Text = "Item Code"
    .Columns[7].Text = "Pack"
    .Columns[8].Text = "Rate"
    .Columns[9].Text = "Brand"
    .Columns[11].Text = "Type"
    .Columns[12].Text = "MaxDay"
    .Columns[13].Text = "MaxQTY"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 8 Then
    GridView1.Data.Text = modReportVar.GetLocaleNumberFormat($rData[$aMyFields[Column]], gb.Currency)
  Else
    GridView1.Data.Text = $rData[$aMyFields[Column]]
  Endif
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

Public Sub GridView1_Click()

  ClearAllText()
  txtid.Value = GridView1[GridView1.Row, 0].Text
  txtitem.Text = GridView1[GridView1.Row, 1].Text
  txtcategory.Text = GridView1[GridView1.Row, 2].Text
  cmbdrug.Text = GridView1[GridView1.Row, 3].Text
  txtitemcode.Text = GridView1[GridView1.Row, 4].Text
  cmbstock.Text = GridView1[GridView1.Row, 9].Text
  txtrate.Value = GridView1[GridView1.Row, 5].Text
  cmbbillmode.Text = GridView1[GridView1.Row, 6].Text
  txtpackvol.Value = GridView1[GridView1.Row, 7].Text
  If GridView1[GridView1.Row, 10].Text Then
    chkratenull.Value = CBool(GridView1[GridView1.Row, 10].Text)
  Else
    chkratenull.Value = False
  Endif

  If GridView1[GridView1.Row, 12].Text Then
    txtmaxdays.Value = GridView1[GridView1.Row, 12].Text
  Else
    txtmaxdays.Value = 0
  Endif
  If GridView1[GridView1.Row, 13].Text Then
    txtmaxqty.Value = GridView1[GridView1.Row, 13].Text
  Else
    txtmaxqty.Value = 0
  Endif

End

Public Sub GridView1_Menu()

  mnuhide.Popup

End

Public Sub mnudelete_Click()

  If GridView1.Rows.Selection.Count Then
    modDatabase.$myConn.Delete("tblstockrate", "fldid=&1", GridView1[GridView1.Row, 0].Text)
    ShowGridData(cmbbillmode.Text)
  Endif

End

Public Sub mnuservice_Click()

  Dim res As Result
  Dim xx As String

  If GridView1.Rows.Selection.Count Then
    xx = InputCombo("Select Category of Item for Claim Purpose", "Claim Type", ["Pharmacy", "Service"], "", True)
    If xx Then
      res = modDatabase.$myConn.Edit("tblstockrate", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldclaimtype"] = xx
      res.Update
      ShowGridData(cmbbillmode.Text)
    Endif
  Endif

End

Public Sub txtimport_Click()

  If Dialog.OpenFile() Then Return
  txtimport.Text = Dialog.Path

End

Public Sub txtsearch_KeyPress()

  modGeneralMain.InputTextKeyOnly()

End

Public Sub btnimport_Click()

  Dim hCSV As CsvFile
  Dim xcoll As Collection
  Dim xdelim As String

  Dim res As Result
  Dim res1 As Result

  If Trim(txtdelim.Text) Then
    xdelim = Trim(txtdelim.Text)
  Else
    xdelim = ";"
  Endif

  If cmbbillmode.Text Then
    If Exist(txtimport.Text) Then
      If Message.Question(("Are you sure ?"), ("No"), ("Yes")) = 2 Then

        Inc Application.Busy
        hCSV = New CsvFile(txtimport.Text, xdelim)
        While hCSV.Eof = False
          xcoll = hCSV.Read()
          If xcoll["fldbillingmode"] = cmbbillmode.Text Then
            res1 = modDatabase.$myConn.Exec("select flditemname from tblstockrate where fldbillingmode=&1 and flditemname=&2", cmbbillmode.Text, Trim(xcoll["flditemname"]))

            If res1.Available Then
              res = modDatabase.$myConn.Edit("tblstockrate", "fldbillingmode=&1 and flditemname=&2", cmbbillmode.Text, Trim(xcoll["flditemname"]))
              If Trim(xcoll["fldcategory"]) Then
                res["fldcategory"] = Trim(xcoll["fldcategory"])
              Endif
              If Trim(xcoll["flddrug"]) Then
                res["flddrug"] = Trim(xcoll["flddrug"])
              Endif
              If Trim(xcoll["flddrugcode"]) Then
                res["flddrugcode"] = Trim(xcoll["flddrugcode"])
              Endif
              If Trim(xcoll["fldpackvol"]) Then
                res["fldpackvol"] = Trim(xcoll["fldpackvol"])
              Endif
              If Trim(xcoll["fldstockid"]) Then
                res["fldstockid"] = Trim(xcoll["fldstockid"])
              Endif
              If Trim(xcoll["fldrate"]) Then
                res["fldrate"] = Trim(xcoll["fldrate"])
              Endif
              If Trim(xcoll["fldwaitday"]) Then
                res["fldwaitday"] = CInt(xcoll["fldwaitday"])
              Endif
              If Trim(xcoll["fldmaxqty"]) Then
                res["fldmaxqty"] = CFloat(xcoll["fldmaxqty"])
              Endif
              If Trim(xcoll["fldclaimtype"]) Then
                res["fldclaimtype"] = Trim(xcoll["fldclaimtype"])
              Endif

              res["flduserid"] = modBasic.$lbluser
              res["fldcomp"] = modBasic.$compID
              res["fldsave"] = True
              res["flduptime"] = Now()
              res["xyz"] = False
              Try res.Update()

            Else
              res = modDatabase.$myConn.Create("tblstockrate")
              res["fldbillingmode"] = cmbbillmode.Text
              res["flditemname"] = Trim(xcoll["flditemname"])

              If Trim(xcoll["fldcategory"]) Then
                res["fldcategory"] = Trim(xcoll["fldcategory"])
              Endif
              If Trim(xcoll["flddrug"]) Then
                res["flddrug"] = Trim(xcoll["flddrug"])
              Endif
              If Trim(xcoll["flddrugcode"]) Then
                res["flddrugcode"] = Trim(xcoll["flddrugcode"])
              Endif
              If Trim(xcoll["fldpackvol"]) Then
                res["fldpackvol"] = Trim(xcoll["fldpackvol"])
              Endif
              If Trim(xcoll["fldstockid"]) Then
                res["fldstockid"] = Trim(xcoll["fldstockid"])
              Endif
              If Trim(xcoll["fldrate"]) Then
                res["fldrate"] = Trim(xcoll["fldrate"])
              Endif
              If Trim(xcoll["fldwaitday"]) Then
                res["fldwaitday"] = CInt(xcoll["fldwaitday"])
              Endif
              If Trim(xcoll["fldmaxqty"]) Then
                res["fldmaxqty"] = CFloat(xcoll["fldmaxqty"])
              Endif
              If Trim(xcoll["fldclaimtype"]) Then
                res["fldclaimtype"] = Trim(xcoll["fldclaimtype"])
              Endif

              res["flduserid"] = modBasic.$lbluser
              res["fldtime"] = Now()
              res["fldcomp"] = modBasic.$compID
              res["fldsave"] = True
              res["flduptime"] = ""
              res["xyz"] = False
              Try res.Update()
            Endif

          Endif
        Wend
        hCSV.Close()
        Dec Application.Busy

        ShowGridData(cmbbillmode.Text)
        Balloon.Info(("Data Import completed"), btnimport)
        Balloon.Delay = modBasic.$BalloonDelay

      Endif
    Endif
  Endif

End

Public Sub btncompare_Click()

  Dim xPath As String

  Inc Application.Busy
  xPath = modRepoMaster.ShowReportStockInsuranceHTML()
  Dec Application.Busy
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub btnexport_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, "FIXED INVENTORY RATE", modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub btncurrent_Click()

  Dim xcomp As String
  Dim xPath As String

  If modHelpVariable.$LogInCategory = "Account" Then
    xcomp = "%"
  Else
    xcomp = modBasic.$compID
  Endif

  Inc Application.Busy
  xPath = modRepoMaster.ShowReportStockCodeInsuranceHTML(cmbbillmode.Text, xcomp)
  Dec Application.Busy
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End
