' Gambas class file

Private $rData As Result
Private $aMyFields As String[]

Public Sub Form_Open()

  modGeneralMain.ArrangeFormCentre(Me)
  cmbdiscmode.List = modNonMedical.FillDiscountCombo()
  txtage.Value = Now()
  ShowGrid()

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Else If Key.Code = Key["R"] And If Key.Control Then
    btnrefresh_Click()
  Else
    modGeneralmain.GoToNextControlTab()
  Endif

End

Private Sub ClearAll()

  txtpatientname.Text = ""
  txtage.Value = ""
  txtaddress.Text = ""
  txtcontact.Text = ""
  txtextcode.Text = ""
  txtfileno.Text = ""
  cmbdiscmode.Text = ""
  txtcomment.Text = ""

End

Public Sub cmbdiscmode_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscmode)
  modFillContainer.RestrictComboToContent(cmbdiscmode)

End

Public Sub btnnepdate_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(txtage.Value))
  If xx Then
    txtage.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnrefresh_GotFocus()

  btnrefresh_Click()

End

Public Sub btnrefresh_Click()

  Dim res As Result

  If txtpatno.Text Then
    res = modDatabase.$myConn.Exec("select fldptnamefir,fldptnamelast,fldptaddvill,fldptaddward,fldptadddist,fldptcontact,fldptbirday,fldptcode,fldadmitfile,fldencrypt,flddiscount,fldcomment from tblpatientinfo where fldpatientval=&1", Trim(txtpatno.Text))                                                                      ''
    If res.Available Then
      If modBasic.$SuperUser = True Then
        txtpatientname.Text = modPassword.DecryptPatData(res["fldptnamefir"], res["fldencrypt"]) & Space(1) & modPassword.DecryptPatData(res["fldptnamelast"], res["fldencrypt"])
        txtcontact.Text = modPassword.DecryptPatData(res["fldptcontact"], res["fldencrypt"])
      Else
        txtpatientname.Text = res["fldptnamefir"] & Space(1) & res["fldptnamelast"]
        txtcontact.Text = res["fldptcontact"]
      Endif
      txtage.Value = res["fldptbirday"]
      If res["fldptaddward"] Then
        txtaddress.Text = res["fldptaddvill"] & "-" & res["fldptaddward"] & ", " & res["fldptadddist"]
      Else
        txtaddress.Text = res["fldptaddvill"] & ", " & res["fldptadddist"]
      Endif
      txtextcode.Text = res["fldptcode"]
      txtfileno.Text = res["fldadmitfile"]
      txtcomment.Text = res["fldcomment"]
      cmbdiscmode.Text = res["flddiscount"]
      cmbdiscmode.SetFocus
    Else
      ClearAll()
    Endif
  Else
    ClearAll()
  Endif
  ShowGrid()

End

Private Sub ShowGrid()

  If txtpatno.Text Then
    $rData = modDatabase.$myConn.Exec("select fldpatientval,fldpatientval,fldpatientval,fldptcode,flddiscount,fldcomment from tblpatientinfo where flddiscount IS NOT NULL and fldpatientval like &1", Trim(txtpatno.Text))
  Else
    $rData = modDatabase.$myConn.Exec("select fldpatientval,fldpatientval,fldpatientval,fldptcode,flddiscount,fldcomment from tblpatientinfo where flddiscount IS NOT NULL")
  Endif
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  With GridView1
    .Columns[0].Width = 100 * modBasic.$AppWidthRatio
    .Columns[1].Width = 300 * modBasic.$AppWidthRatio
    .Columns[2].Width = 100 * modBasic.$AppWidthRatio
    .Columns[3].Width = 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio
    .Columns[5].Width = 1

    .Columns[0].Text = "PatNo"
    .Columns[1].Text = "Name"
    .Columns[2].Text = "FileNo"
    .Columns[3].Text = "FileNo"
    .Columns[4].Text = "Discount"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 1 Then
    GridView1.Data.Text = modPatient.PatientFullNameByPatID($rData[$aMyFields[Column]])
  Else If Column = 1 Then
    GridView1.Data.Text = modPatient.GetPatientFileByPatNo($rData[$aMyFields[Column]])
  Else
    GridView1.Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub GridView1_Click()

  txtpatno.Text = GridView1[GridView1.Row, 0].Text
  btnrefresh_Click()

End

Public Sub btnedit_Click()

  Dim res As Result

  If txtpatno.Text Then
    res = modDatabase.$myConn.Edit("tblpatientinfo", "fldpatientval=&1", Trim(txtpatno.Text))
    res["flddiscount"] = cmbdiscmode.Text
    If Not res["fldptcontact"] Then
      res["fldptcontact"] = Trim(txtcontact.Text)
    Endif
    If Not res["fldptcode"] Then
      res["fldptcode"] = Trim(txtextcode.Text)
    Endif
    If Not res["fldcomment"] Then
      res["fldcomment"] = Trim(txtcomment.Text)
    Endif
    res["xyz"] = False
    res.Update
    Balloon.Info(("Information saved"), btnedit)
    Balloon.Delay = modBasic.$BalloonDelay
    ShowGrid()
  Endif

End

Public Sub btnexport_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, "DISCOUNT LIST", modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))

End

Public Sub btnfile_Click()

  Dim xx As String
  Dim res As Result

  xx = InputBox("Enter Patient File Number", "File Number", "")
  If xx Then
    res = modDatabase.$myConn.Exec("select fldpatientval from tblpatientinfo where fldadmitfile=&1", xx)
    If res.Available Then
      txtpatno.Text = res!fldpatientval
    Endif
  Endif

End

Public Sub btnsearch_Click()

  txtpatno.Text = PatSearch("PatientNo")

End

Public Sub btnblank_Click()

  txtpatno.Text = ""
  ClearAll()
  txtpatno.SetFocus

End

Public Sub txtpatno_KeyPress()

  modGeneralMain.InputUpCaseOnly()

End
