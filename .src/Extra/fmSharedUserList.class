' Gambas class file

Private $sItem As Long
Private $sUser As String[]
Private $UserAll As String[]

Public Sub _new(sItem As Long)

  $sItem = sItem

End

Public Sub Form_Open()

  Me.Center
  Label1.Text = "File Shared To"
  $UserAll = modGeneral.GetUserIDAll()
  FillUserList()

End

Private Sub FillUserList()

  Dim pic1 As Picture
  Dim xx As String

  ListView1.Clear()
  $sUser = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select fldshared as col from tblfileshare where flduserid=&1 and fldperid=&2", modBasic.$lbluser, $sItem))
  pic1 = Picture["icon:/small/identity"]
  If $sUser Then
    For Each xx In $sUser
      ListView1.Add(xx, modGeneral.GetUserFullName(xx), pic1)
    Next
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Endif

End

Public Sub btnadduser_Click()

  Dim xx As String
  Dim res As Result
  Dim xRem As String[]
  Dim xusr As String
  Dim aVar As Variant[]

  xRem = modString.GetRemainingArray($UserAll, $sUser)
  aVar = New Variant[]
  For Each xusr In xRem
    aVar.Add([xusr, modGeneral.GetUserFullName(xusr)])
  Next
  xx = MedicalSelectedUser("File Sharing", aVar)
  If xx Then
    res = modDatabase.$myConn.Create("tblfileshare")
    res["flduserid"] = modBasic.$lbluser
    res["fldshared"] = xx
    res["fldperid"] = $sItem
    res["fldstatus"] = "Shared"
    res.Update
    FillUserList()
  Endif

End

Public Sub ListView1_Menu()

  mnufile.Popup

End

Public Sub mnudelete_Click()

  modDatabase.$myConn.Delete("tblfileshare", "fldshared=&1", ListView1.Key)
  FillUserList()

End
