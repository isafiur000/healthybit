' Gambas class file

Private $ItemList As String[]
Private $rData As Result
Private $aMyFields As String[]
Private $chartLimit As Float[]
Private $ProgressBar1 As ProgressBar
Private $SSQLFields As String[]

Private $ColCount As Integer
Private $newColumn As String[]
Private $RepoStr As String
Private $MapColl As Collection

Private $tblpatlabtest As String
Private $tblpatlabsubtest As String

Public Sub Form_Open()

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Horizontal")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  btnmnuqty.Menu = "mnuqty"
  btnmnufreq.Menu = "mnufreq"

  If MMain.$WebReport = "Multiple" Then
    If modBasic.$HospCode Then
      ' cmblocation.Text = "Hospital"
      cmblocation.Text = modDataRepo.$RepositoryMode
      cmbvalue.Text = modBasic.$HospCode
      pnlocat.Enabled = False
    Else
      cmblocation.List = ["Hospital", "Municipality", "Category", "District", "Province"]
    Endif
    mnuhospsumm.Visible = True
    mnuhospdate.Visible = True
    If MMain.$RepoReportMode = True Then
      mnusearname.Visible = False
    Endif

  Else
    pnlocat.Visible = False
  Endif

  If MMain.$SISHAppMode = "REP" Then
    cmbmethod.Text = "%"
    Panel6.Enabled = False
  Endif

  cmbgender.List = ["Male", "Female", "Other", "%"]
  cmbgender.Text = "%"

  cmbmethod.List = modFixLab.GetTestExamEquipments("Test")
  cmbmethod.Add("%")
  cmbmethod.Text = "%"

  cmbsample.List = modBasic.$LabSpecimenList
  cmbsample.Add("%")
  cmbsample.Text = "%"

  cmbcondition.Text = "%"

  cmbsection.List = modMedicine.GetPathoCategoryList("Test")
  cmbsection.Add("%")
  cmbsection.Text = "%"

  cmbstatus.List = ["Sampled", "Reported", "Verified"]
  cmbstatus.Text = "Reported"

  cmblimit.List = ["%", "Normal", "Abnormal"]
  cmblimit.Text = "%"

  cmbsublimit.List = ["%", "Normal", "Abnormal"]
  cmbsublimit.Text = "%"

  dtfir.Value = Now()
  dtlast.Value = Now()
  rball.Value = True
  rbmetric.Value = True
  modAccount.PasInvoiceSetting(cmbfiscal, True)
  LoadTableNames()

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub cmblocation_Click()

  cmbvalue.Clear()
  If cmblocation.Text Then
    cmbvalue.List = modDataRepo.GetRepoValueListType(cmblocation.Text)
  Endif

End

Private Sub LoadTableNames()

  Dim res As Result

  If cmbfiscal.Text = "Current" Then
    $tblpatlabtest = "tblpatlabtest"
    $tblpatlabsubtest = "tblpatlabsubtest"
  Else
    res = modDatabase.$syConn.Exec("select fldpatlabtest,fldpatlabsubtest from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", cmbfiscal.Text, "Active")
    If res.Available Then
      If res["fldpatlabtest"] Then
        $tblpatlabtest = res["fldpatlabtest"]
      Else
        $tblpatlabtest = "tblpatlabtest"
      Endif
      If res["fldpatlabsubtest"] Then
        $tblpatlabsubtest = res["fldpatlabsubtest"]
      Else
        $tblpatlabsubtest = "tblpatlabsubtest"
      Endif
    Else
      $tblpatlabtest = "tblpatlabtest"
      $tblpatlabsubtest = "tblpatlabsubtest"
    Endif
  Endif

End

Public Sub cmbfiscal_Click()

  LoadTableNames()

End

Private Sub FillListBox()

  Dim xList As String[]

  If $ItemList Then
    If txtcustom.Text Then
      xList = modString.SelectStringArrayToText(txtcustom.Text, $ItemList)
    Else
      xList = $ItemList
    Endif
    If xList Then
      cmbtest.List = xList.Sort()
    Else
      cmbtest.Clear()
    Endif
  Endif

End

Public Sub txtcustom_Change()

  FillListBox()

End

Public Sub btnload_Click()

  Dim xList As String[]

  cmbtest.Clear
  $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text)
  If MMain.$WebReport = "Multiple" Then
    xList = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select distinct(flditem) as col from tblrepomapping where fldcategory=&1", "Laboratory"))
    If xList And If xList.Count Then
      $ItemList = xList
      $MapColl = modDataRepo.GetVariableMappingColl("Laboratory")
    Else
      $ItemList = modControlSub.GetDirectFillresult(modDatabase.$syConn.Exec("select distinct(fldtestid) as col from " & $tblpatlabtest & " where fldtime_sample like &1" & $RepoStr, "%"))
    Endif

  Else
    If cmbsection.Text Then
      If cmbsection.Text = "%" Then
        $ItemList = modControlSub.GetDirectFillresult(modDatabase.$syConn.Exec("select fldtestid as col from tbltest"))
      Else
        $ItemList = modControlSub.GetDirectFillresult(modDatabase.$syConn.Exec("select fldtestid as col from tbltest where fldcategory like &1", cmbsection.Text))
      Endif
    Endif
  Endif
  FillListBox()

End

Public Sub cmbtest_Click()

  If cmbtest.Text Then
    cmbsubtest.List = modFixLab.GetSubTestArray(cmbtest.Text)
  Endif

End

Public Sub cmbtest_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbtest)

End

Public Sub cmbsample_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbsample)

End

Private Function LabUnit() As String

  Dim xx As String

  If rbsi.Value = True Then
    xx = "SI"
  Else
    xx = "Metric"
  Endif
  Return xx

End

Private Function FlagValue(xvalue As String) As Boolean

  Dim xx As Boolean

  If xvalue = "Normal" Then
    xx = False
  Else If xvalue = "Abnormal" Then
    xx = True
  Endif
  Return xx

End

Private Function GetLabTimeStr() As String

  Dim xfldtime As String

  If cmbstatus.Text = "Sampled" Then
    xfldtime = "fldtime_sample"
  Else If cmbstatus.Text = "Reported" Then
    xfldtime = "fldtime_report"
  Else If cmbstatus.Text = "Verified" Then
    xfldtime = "fldtime_verify"
  Else
    xfldtime = "fldtime_sample"
  Endif

  Return xfldtime

End

Public Sub mnuaddcolumn_Click()

  Dim hForm As FmAddNewColumn

  hForm = New FmAddNewColumn(Me.Tag)
  hForm.ShowModal

End

Private Sub GetFieldList()

  Dim xhospfld As String
  Dim xList As String[]

  xList = New String[]
  xhospfld = modDataRepo.HospitalField()
  xList = ["fldid", "fldencounterval", "fldencounterval", modDataRepo.SerialField(), "fldencounterval", "fldtestid", "fldsampleid", "fldsampletype", "fldtime_sample", "fldtime_report", "fldstatus", modDataRepo.SerialField(), "fldtest_type", "fldid", "fldabnormal", "fldgroupid", modDataRepo.SerialField(), "flduptime_report", "fldtime_verify", "flduptime_verify", "flduserid_sample", "flduserid_report", "flduserid_verify"]
  If xhospfld Then
    xList.Add(xhospfld)
  Endif
  $SSQLFields = xList

End

Private Function GetSQLColumns() As String[]

  Dim xFldList As String[]
  Dim i As Integer

  GetFieldList()
  modCustPatient.FillNewCOlumnCollection(Me.Tag)
  $newColumn = modCustPatient.CustomNewColumnsTitle(Me.Tag)
  xFldList = $SSQLFields.Copy()
  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      xFldList.Add("fldencounterval")
    Next
  Endif
  Return xFldList

End

Public Sub mnusearch_Click()

  Dim encid As String
  Dim sql As String
  Dim xFldList As String[]

  encid = GetEncid()
  $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text)
  If encid Then
    xFldList = GetSQLColumns()
    sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where fldencounterval=&1" & $RepoStr
    $rData = modDatabase.$syConn.Exec(sql, encid)
    FillPatientGrid()
  Endif

End

Public Sub mnusearname_Click()

  Dim xname As String[]
  Dim sql As String
  Dim xFldList As String[]

  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text)
  If xname Then
    xFldList = GetSQLColumns()
    sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &1 and lower(fldptnamelast) like &2))" & $RepoStr
    $rData = modDatabase.$syConn.Exec(sql, LCase(xname[0]), LCase(xname[1]))
    Inc Application.Busy
    FillPatientGrid()
    Dec Application.Busy
  Endif

End

Private Function ExecuteQuery(xFldList As String[]) As Result

  Dim sql As String
  Dim sStr As String
  Dim xrefer As String
  Dim xcondi As String
  Dim xabn As String
  Dim xstr As String
  Dim xsql As String

  Dim res As Result
  Dim xfldtime As String
  Dim xtestname As String
  Dim xitem As String

  If rball.Value = True Then
    xtestname = "%"
    xitem = " and fldtestid like &3"
  Else If rbsel.Value = True Then
    If chkcustom.Value = True Then
      xtestname = Trim(txtcustom.Text) & "%"
    Else
      xtestname = cmbtest.Text
    Endif
    If $MapColl And If $MapColl.Count Then
      xitem = " and fldtestid in(select fldvalue from tblrepomapping where flditem=&3)"
    Else
      xitem = " and fldtestid like &3"
    Endif
  Endif

  If xtestname Then
    xfldtime = GetLabTimeStr()
    If cmbsection.Text = "%" Then
      xrefer = ""
    Else
      xrefer = " and fldtestid in(select fldtestid from tbltest where fldcategory like &{10})"
    Endif
    If cmbcondition.Text = "%" Then
      xcondi = ""
    Else
      xcondi = " and lower(fldcondition) like &{11}"
    Endif
    If cmblimit.Text = "%" Then
      xabn = ""
    Else
      xabn = " and fldabnormal=&{12}"
    Endif
    sStr = xrefer & xcondi & xabn

    If Not txtfromage.Value And If Not txttoage.Value And If cmbgender.Text = "%" Then
      xsql = ""

    Else
      If Not txtfromage.Value And If Not txttoage.Value Then
        xsql = " and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where fldptsex like &6))"
      Else
        xstr = modMedReports.GetAgeStringByTable($tblpatlabtest, modDatabase.$syConn)
        xsql = " and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where fldptsex like &6 and fldptbirday like &7 and " & xstr & ">=&8 and " & xstr & "<&9))"
      Endif
    Endif

    $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text)
    If txtsearch.Text Or If chknull.Value Then
      If cmbsubtest.Text Then
        If cmbsublimit.Text = "%" Then
          If chknull.Value Then
            sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & " and fldid in(select fldtestid from " & $tblpatlabsubtest & " where fldsubtest like &{13} and fldreport IS NULL)" & $RepoStr
          Else
            sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & " and fldid in(select fldtestid from " & $tblpatlabsubtest & " where fldsubtest like &{13} and lower(fldreport) like &{14})" & $RepoStr                              ''
          Endif
          res = modDatabase.$syConn.Exec(sql, modDate.StartSqlDate(dtfir.value), modDate.EndSqlDate(dtlast.value), xtestname, LCase(cmbsample.Text), cmbmethod.Text, cmbgender.Text, "%", 365 * txtfromage.Value, 365 * txttoage.Value, cmbsection.Text, LCase(cmbcondition.Text), FlagValue(cmblimit.Text), cmbsubtest.Text, LCase(txtsearch.Text))
        Else
          If chknull.Value Then
            sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & " and fldid in(select fldtestid from " & $tblpatlabsubtest & " where fldsubtest like &{13} and fldreport IS NULL and fldabnormal=&{15})" & $RepoStr
          Else
            sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & " and fldid in(select fldtestid from " & $tblpatlabsubtest & " where fldsubtest like &{13} and lower(fldreport) like &{14} and fldabnormal=&{15})" & $RepoStr                              ''
          Endif
          res = modDatabase.$syConn.Exec(sql, modDate.StartSqlDate(dtfir.value), modDate.EndSqlDate(dtlast.value), xtestname, LCase(cmbsample.Text), cmbmethod.Text, cmbgender.Text, "%", 365 * txtfromage.Value, 365 * txttoage.Value, cmbsection.Text, LCase(cmbcondition.Text), FlagValue(cmblimit.Text), cmbsubtest.Text, LCase(txtsearch.Text), FlagValue(cmbsublimit.Text))
        Endif
      Else
        If chknull.Value Then
          sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & " and fldreportquali IS NULL" & $RepoStr
        Else
          sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & " and lower(fldreportquali) like &{13}" & $RepoStr                              ''
        Endif
        res = modDatabase.$syConn.Exec(sql, modDate.StartSqlDate(dtfir.value), modDate.EndSqlDate(dtlast.value), xtestname, LCase(cmbsample.Text), cmbmethod.Text, cmbgender.Text, "%", 365 * txtfromage.Value, 365 * txttoage.Value, cmbsection.Text, LCase(cmbcondition.Text), FlagValue(cmblimit.Text), LCase(txtsearch.Text))
      Endif
    Else
      sql = "select " & xFldList.Join(",") & " from " & $tblpatlabtest & " where " & xfldtime & ">=&1 and " & xfldtime & "<=&2" & xitem & " and lower(fldsampletype) like &4 and fldmethod like &5" & xsql & sStr & $RepoStr                             ''
      res = modDatabase.$syConn.Exec(sql, modDate.StartSqlDate(dtfir.value), modDate.EndSqlDate(dtlast.value), xtestname, LCase(cmbsample.Text), cmbmethod.Text, cmbgender.Text, "%", 365 * txtfromage.Value, 365 * txttoage.Value, cmbsection.Text, LCase(cmbcondition.Text), FlagValue(cmblimit.Text))
    Endif
  Endif
  Return res

End

Private Function GetGridViewValue(Column As Integer, xVariable As Variant) As Variant

  Dim xxx As Variant
  Dim i As Integer

  If Column = 2 Then
    xxx = modPatient.GetPatientNameByEnc(xVariable, modDatabase.$syConn)
  Else If Column = 3 Then
    xxx = modMedReports.GetPatientPastAgeString($tblpatlabtest, xVariable)
  Else If Column = 4 Then
    xxx = modPatient.GetPatientSex(xVariable, modDatabase.$syConn)
  Else If Column = 5 Then
    If $MapColl And If $MapColl.Count Then
      If $MapColl[xVariable] Then
        xxx = $MapColl[xVariable]
      Else
        xxx = xVariable
      Endif
    Else
      xxx = xVariable
    Endif
  Else If Column = 8 Then
    xxx = modReportVar.GetDateTimeReport(xVariable, gb.GeneralDate)
  Else If Column = 9 Then
    xxx = modReportVar.GetDateTimeReport(xVariable, gb.GeneralDate)
  Else If Column = 11 Then
    If cmbsubtest.Text Then
      If chkquanti.Value = True Then
        xxx = GetSubTestValue(xVariable, cmbsubtest.Text)
      Else
        xxx = modString.TextToHTML(GetSubTestValue(xVariable, cmbsubtest.Text))
      Endif
    Else
      If chksubtest.Value = True Then
        xxx = modString.TextToHTML(modLabTest.GetLabTestValueSubString(xVariable, LabUnit(), True, $tblpatlabtest, $tblpatlabsubtest))
      Else
        If chkquanti.Value = True Then
          xxx = modLabTest.GetLabTestValueSubString(xVariable, LabUnit(), False, $tblpatlabtest, $tblpatlabsubtest)
        Else
          xxx = modString.TextToHTML(modLabTest.GetLabTestValueSubString(xVariable, LabUnit(), False, $tblpatlabtest, $tblpatlabsubtest))
        Endif
      Endif
    Endif
  Else If Column = 14 Then
    xxx = modMisc.GetGridIcon(xVariable)
  Else If Column = 16 Then
    xxx = modLabTest.GetLabTATHours(xVariable, $tblpatlabtest)
  Else If Column = 17 Then
    xxx = modReportVar.GetDateTimeReport(xVariable, gb.GeneralDate)
  Else If Column = 18 Then
    xxx = modReportVar.GetDateTimeReport(xVariable, gb.GeneralDate)
  Else If Column = 19 Then
    xxx = modReportVar.GetDateTimeReport(xVariable, gb.GeneralDate)
  Else If Column = 20 Then
    xxx = modGeneral.GetUserFullName(xVariable)
  Else If Column = 21 Then
    xxx = modGeneral.GetUserFullName(xVariable)
  Else If Column = 22 Then
    xxx = modGeneral.GetUserFullName(xVariable)
  Else If Column = 23 Then
    xxx = modDataRepo.GetHospitalTextLabel(xVariable)
  Else
    xxx = xVariable
  Endif

  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      If Column = $ColCount + i Then
        xxx = modCustPatient.NewColValue(Me.Tag, $newColumn[i], xVariable)
      Endif
    Next
  Endif
  Return xxx

End

Public Sub btnrefresh_Click()

  Dim xFldList As String[]

  TabStrip1.Index = 0
  If chkexcoutlier.Value = True Then
    $chartLimit = InputDoubleVal(("Select Limits for Frequency Chart"), ["Lower Value", "Upper Value"], [0, 0])
  Endif
  Inc Application.Busy
  xFldList = GetSQLColumns()
  $rData = ExecuteQuery(xFldList)

  If chkgrid.Value = True Then
    FillPatientGrid()
  Endif

  If chkchart.Value = True Then
    FillItemChartQTY()
  Endif

  If chkchfreq.Value = True Then
    FillItemFreqChart()
  Endif

  Dec Application.Busy

End

Private Sub FillPatientGrid()

  Dim i As Integer

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  $ColCount = $SSQLFields.Count
  With GridView1
    .Columns[0].Width = 1
    .Columns[1].Width = 125 * modBasic.$AppWidthRatio
    .Columns[2].Width = 175 * modBasic.$AppWidthRatio
    .Columns[3].Width = 75 * modBasic.$AppWidthRatio
    .Columns[4].Width = 75 * modBasic.$AppWidthRatio
    .Columns[5].Width = 250 * modBasic.$AppWidthRatio
    .Columns[6].Width = 100 * modBasic.$AppWidthRatio
    .Columns[7].Width = 100 * modBasic.$AppWidthRatio
    .Columns[8].Width = 150 * modBasic.$AppWidthRatio
    .Columns[9].Width = 150 * modBasic.$AppWidthRatio
    .Columns[10].Width = 75 * modBasic.$AppWidthRatio
    .Columns[11].Width = 275 * modBasic.$AppWidthRatio
    .Columns[12].Width = 1
    .Columns[13].Width = 1
    .Columns[14].Width = 25 * modBasic.$AppWidthRatio
    .Columns[15].Width = 1
    .Columns[16].Width = 75 * modBasic.$AppWidthRatio
    .Columns[17].Width = 150 * modBasic.$AppWidthRatio
    .Columns[18].Width = 150 * modBasic.$AppWidthRatio
    .Columns[19].Width = 150 * modBasic.$AppWidthRatio
    .Columns[20].Width = 150 * modBasic.$AppWidthRatio
    .Columns[21].Width = 150 * modBasic.$AppWidthRatio
    .Columns[22].Width = 150 * modBasic.$AppWidthRatio

    .Columns[1].Text = "EncID"
    .Columns[2].Text = "Name"
    .Columns[3].Text = "Age"
    .Columns[4].Text = "Gender"
    .Columns[5].Text = "TestName"
    .Columns[6].Text = "SampID"
    .Columns[7].Text = "Specimen"
    .Columns[8].Text = "Sampling"
    .Columns[9].Text = "Reporting"
    .Columns[10].Text = "Status"
    .Columns[11].Text = "Observation"
    .Columns[14].Text = "Flag"
    .Columns[16].Text = "TAT(Hr)"
    .Columns[17].Text = "LastReport"
    .Columns[18].Text = "Verify"
    .Columns[19].Text = "LastVerify"
    .Columns[20].Text = "SampledBy"
    .Columns[21].Text = "ReportedBy"
    .Columns[22].Text = "VerifiedBy"

    If $newColumn.Count Then
      For i = 0 To $newColumn.Count - 1
        .Columns[$ColCount + i].Text = $newColumn[i]
        .Columns[$ColCount + i].Width = 150 * modBasic.$AppWidthRatio
      Next
    Endif
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 11 Then
    GridView1.Data.RichText = GetGridViewValue(Column, $rData[$aMyFields[Column]])
    If modBasic.$RichtextResizeRow = "Yes" Then
      GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.RichText, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
    Endif
  Else If Column = 14 Then
    GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
    GridView1.Data.Text = ""
  Else
    If Column > $SSQLFields.Count - 1 Then
      GridView1.Data.RichText = modString.TextToHTML(GetGridViewValue(Column, $rData[$aMyFields[Column]]))
    Else
      GridView1.Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
    Endif
  Endif
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

''-------------------------------------------- Chart ---------------------------------------------
Private Sub FillItemChartQTY()

  Dim xLst As String[]
  Dim sFile As String

  xLst = New String[]
  $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  $ProgressBar1.Visible = True
  $ProgressBar1.Value = 0
  For Each $rData
    If Not modBasic.$HospCode And If MMain.$WebReport = "Multiple" Then
      If $rData["fldabnormal"] = True Then
        xLst.Add($rData["fldhospcode"] & gb.Tab & "Abnormal")
      Else
        If $rData["fldstatus"] = "Sampled" Then
          xLst.Add($rData["fldhospcode"] & gb.Tab & "Sampled")
        Else
          xLst.Add($rData["fldhospcode"] & gb.Tab & "Normal")
        Endif
      Endif
    Else
      If $rData["fldabnormal"] = True Then
        xLst.Add(Format(DateDiff(dtfir.Value, $rData[GetLabTimeStr()], modChart.GetDateIntegerFromSetting()), "0#.#") & gb.Tab & "Abnormal")
      Else
        If $rData["fldstatus"] = "Sampled" Then
          xLst.Add(Format(DateDiff(dtfir.Value, $rData[GetLabTimeStr()], modChart.GetDateIntegerFromSetting()), "0#.#") & gb.Tab & "Sampled")
        Else
          xLst.Add(Format(DateDiff(dtfir.Value, $rData[GetLabTimeStr()], modChart.GetDateIntegerFromSetting()), "0#.#") & gb.Tab & "Normal")
        Endif
      Endif
    Endif
    $ProgressBar1.Value = ($rData.Index + 1) / $rData.Count
    Wait
  Next
  If $ProgressBar1 Then
    $ProgressBar1.Visible = False
  Endif

  sFile = Temp()
  File.Save(sFile, xLst.Join(gb.NewLine))
  mnustatsqty.Tag = sFile
  If modBasic.$ChartExecStat = "PSPP" Then
    modImage.StretchtPictureToBox(PictureBox1, modChart.ProportionChart(sFile, "Test Count"))
  Else
    modImage.StretchtPictureToBox(PictureBox1, modChart.ProportionChart(sFile, "Test Count"))
  Endif

End

Public Sub PictureBox1_Menu()

  mnuqty.Popup

End

Public Sub mnuexpoqty_Click()

  If Dialog.SelectDirectory() Then Return
  PictureBox1.Image.Save(Dialog.Path &/ "TestQTY" & ".png")

End

Public Sub mnustatsqty_Click()

  If modBasic.$ChartExecStat = "PSPP" Then
    modControlSub.OpenBrowser(modPSPP.CreatePSPPStatFIle("crosstab", mnustatsqty.Tag))
  Else
    modControlSub.OpenBrowser(modPSPP.CreatePSPPStatFIle("crosstab", mnustatsqty.Tag))
  Endif

End

''--------------------------------------- Freq Chart --------------------------------------------
Private Sub FillItemFreqChart()

  Dim xLst As String[]
  Dim xval As String

  $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
  $ProgressBar1.Visible = True
  $ProgressBar1.Value = 0
  xLst = New String[]
  For Each $rData
    If $rData["fldtest_type"] = "Quantitative" Then
      xval = modLabTest.GetTestQuantiValueLabID($rData["fldencounterval"], $rData["fldid"], LabUnit(), $tblpatlabtest)
      If chkexcoutlier.Value = True Then
        If $chartLimit Then
          If CFloat(xval) >= $chartLimit[0] And If CFloat(xval) <= $chartLimit[1] Then
            xLst.Add(Format(xval, gb.Fixed))
          Endif
        Else
          xLst.Add(Format(xval, gb.Fixed))
        Endif
      Else
        xLst.Add(Format(xval, gb.Fixed))
      Endif
    Endif
    $ProgressBar1.Value = ($rData.Index + 1) / $rData.Count
    Wait
  Next
  If xLst.Count Then
    MakeFreqIntervalData(cmbtest.Text, xLst, PictureBox2)
  Endif
  If $ProgressBar1 Then
    $ProgressBar1.Visible = False
  Endif

End

Private Sub MakeFreqIntervalData(sItem As String, xLst As String[], pictbox As ImageView)

  Dim sFile As String
  Dim ximg As String

  sFile = Temp()
  File.Save(sFile, xLst.Join(gb.NewLine))
  mnufreqexpo.Tag = sItem
  If modBasic.$ChartExecStat = "PSPP" Then
    ximg = modPSPP.CreatePSPPStatFIle("frequency", sFile)
  Else
    ximg = modChart.FrequencyChart(sFile, sItem & " : Frequency Distribution")
  Endif
  modImage.StretchtPictureToBox(pictbox, ximg)
  mnufreqstat.Tag = sFile

End

Public Sub PictureBox2_Menu()

  mnufreq.Popup

End

Public Sub mnufreqexpo_Click()

  If Dialog.SelectDirectory() Then Return
  PictureBox2.Image.Save(Dialog.Path &/ mnufreqexpo.Tag & ".png")

End

Public Sub mnufreqstat_Click()

  Dim hForm As Fmgnustat

  If modBasic.$ChartExecStat = "PSPP" Then
    modControlSub.OpenBrowser(modPSPP.CreatePSPPStatFIle("statistics", mnufreqstat.Tag))
  Else
    hForm = New Fmgnustat(mnufreqstat.Tag)
    hForm.ShowModal
  Endif

End

''---------------------------------------- Gridview --------------------------
Public Sub GridView1_Menu()

  mnugrid.Popup

End

Public Sub GridView1_DblClick()

  Dim xx As Integer
  Dim yy As Integer

  xx = Mouse.StartX - GridView1.Left
  yy = Mouse.StartY - GridView1.Top

  Balloon.Info(("Current Column is ") & CStr(GridView1.Column + 1), GridView1, xx, yy)
  Balloon.Delay = 1000

End

Public Sub mnuenchart_Click()

  Dim xx As String
  Dim xField As String
  Dim Column As Integer
  Dim res As Result
  Dim xval As Variant
  Dim hFile As CUnivariate
  Dim xFldList As String[]
  Dim sOrder As String[]

  Dim hUniv As FmAnalyzeSett

  hUniv = New FmAnalyzeSett("Univariate", modGridView.GetGridViewColumns(GridView1))
  hUniv.ShowModal

  xFldList = GetSQLColumns()
  If MMain.$IsGUIApp = True Then
    $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
    $ProgressBar1.Visible = True
    $ProgressBar1.Value = 0
  Endif
  Inc Application.Busy
  hFile = New CUnivariate

  Column = modCustPatient.GetUnivariateColumn(1)
  xField = xFldList[Column]
  res = ExecuteQuery([xField])

  If res.Available Then
    For Each res
      xval = GetGridViewValue(Column, res[xField])
      If xval Then
        hFile.Add(xval)
      Endif

      If MMain.$IsGUIApp = True Then
        $ProgressBar1.Value = (res.Index + 1) / res.Count
        Wait
      Endif
    Next
  Endif
  Dec Application.Busy
  If MMain.$IsGUIApp = True Then
    $ProgressBar1.Visible = False
  Endif

  If modSettings.ShowSettingFromFIle("UnivariateAnalysis/DataType") = "Ordinal" Then
    sOrder = ListOrder("Select Order", hFile.DistinctValues())
  Endif
  xx = modPSPP.GetEncChartGridNew(hFile.GetSPSSFile(), sOrder)
  If xx Then
    modControlSub.OpenBrowser(xx)
  Endif

End

Public Sub mnucrosstab_Click()

  Dim xx As String
  Dim Row As Integer
  Dim Column As Integer
  Dim xFieRow As String
  Dim xFieColm As String
  Dim res As Result
  Dim xval As Variant
  Dim yval As Variant

  Dim hFile As CBivariate
  Dim xFldList As String[]
  Dim sOrder As String[]
  Dim hBivar As FmAnalyzeSett

  hBivar = New FmAnalyzeSett("Bivariate", modGridView.GetGridViewColumns(GridView1))
  hBivar.ShowModal

  xFldList = GetSQLColumns()
  If MMain.$IsGUIApp = True Then
    $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
    $ProgressBar1.Visible = True
    $ProgressBar1.Value = 0
  Endif

  Inc Application.Busy
  hFile = New CBivariate
  Row = modCustPatient.GetCrossVarRow(1)
  xFieRow = xFldList[Row]
  Column = modCustPatient.GetCrossVarColumn(1)
  xFieColm = xFldList[Column]
  res = ExecuteQuery([xFieRow, xFieColm])

  If res.Available Then
    For Each res
      xval = GetGridViewValue(Row, res[xFieRow])
      yval = GetGridViewValue(Column, res[xFieColm])
      If xval And If yval Then
        hFile.Add([xval, yval])
      Endif

      If MMain.$IsGUIApp = True Then
        $ProgressBar1.Value = (res.Index + 1) / res.Count
        Wait
      Endif
    Next
  Endif
  Dec Application.Busy
  If MMain.$IsGUIApp = True Then
    $ProgressBar1.Visible = False
  Endif

  If modCustPatient.$CrossOutcomeType = "Ordinal" Then
    sOrder = ListOrder("Select Order", hFile.DistinctValues())
  Endif
  xx = modPSPP.GetCrossTabStatNew(hFile.GetSPSSFile(), hFile.GetGroups(), sOrder)
  If xx Then
    modControlSub.OpenBrowser(xx)
  Endif

End

Public Sub mnuregression_Click()

  Dim xx As String
  Dim res As Result
  Dim xFieldList As String[]

  Dim DepCol As Integer
  Dim Indep1Col As Integer
  Dim Indep2Col As Integer
  Dim Indep3Col As Integer
  Dim Indep4Col As Integer
  Dim Indep5Col As Integer

  Dim xDepField As String
  Dim xIndep1Field As String
  Dim xIndep2Field As String
  Dim xIndep3Field As String
  Dim xIndep4Field As String
  Dim xIndep5Field As String

  Dim Depvalue As Variant
  Dim Indep1Val As Variant
  Dim Indep2Val As Variant
  Dim Indep3Val As Variant
  Dim Indep4Val As Variant
  Dim Indep5Val As Variant

  Dim DepData As Variant[]
  Dim Indep1Data As Variant[]
  Dim Indep2Data As Variant[]
  Dim Indep3Data As Variant[]
  Dim Indep4Data As Variant[]
  Dim Indep5Data As Variant[]

  Dim xFldList As String[]

  xFldList = GetSQLColumns()
  Inc Application.Busy
  xFieldList = New String[]
  DepData = New Variant[]
  Indep1Data = New Variant[]
  Indep2Data = New Variant[]
  Indep3Data = New Variant[]
  Indep4Data = New Variant[]
  Indep5Data = New Variant[]

  DepCol = modCustPatient.GetRegressionDepVal(1)
  xDepField = xFldList[DepCol]
  xFieldList.Add(xDepField)

  If modCustPatient.$RegVar1UseGridVal = "Yes" Or If modCustPatient.$RegVar1Variable Or If modCustPatient.$RegVar1SQLText Then
    Indep1Col = modCustPatient.GetRegressionVar1Val(1)
    xIndep1Field = xFldList[Indep1Col]
    xFieldList.Add(xIndep1Field)
  Endif
  If modCustPatient.$RegVar2UseGridVal = "Yes" Or If modCustPatient.$RegVar2Variable Or If modCustPatient.$RegVar2SQLText Then
    Indep2Col = modCustPatient.GetRegressionVar2Val(1)
    xIndep2Field = xFldList[Indep2Col]
    xFieldList.Add(xIndep2Field)
  Endif
  If modCustPatient.$RegVar3UseGridVal = "Yes" Or If modCustPatient.$RegVar3Variable Or If modCustPatient.$RegVar3SQLText Then
    Indep3Col = modCustPatient.GetRegressionVar3Val(1)
    xIndep3Field = xFldList[Indep3Col]
    xFieldList.Add(xIndep3Field)
  Endif
  If modCustPatient.$RegVar4UseGridVal = "Yes" Or If modCustPatient.$RegVar4Variable Or If modCustPatient.$RegVar4SQLText Then
    Indep4Col = modCustPatient.GetRegressionVar4Val(1)
    xIndep4Field = xFldList[Indep4Col]
    xFieldList.Add(xIndep4Field)
  Endif
  If modCustPatient.$RegVar5UseGridVal = "Yes" Or If modCustPatient.$RegVar5Variable Or If modCustPatient.$RegVar5SQLText Then
    Indep5Col = modCustPatient.GetRegressionVar5Val(1)
    xIndep5Field = xFldList[Indep5Col]
    xFieldList.Add(xIndep5Field)
  Endif

  res = ExecuteQuery(xFieldList)

  If res.Available Then
    For Each res
      Depvalue = GetGridViewValue(DepCol, res[xDepField])
      If xIndep1Field Then
        Indep1Val = GetGridViewValue(Indep1Col, res[xIndep1Field])
      Else
        Indep1Val = "__"
      Endif
      If xIndep2Field Then
        Indep2Val = GetGridViewValue(Indep2Col, res[xIndep2Field])
      Else
        Indep2Val = "__"
      Endif
      If xIndep3Field Then
        Indep3Val = GetGridViewValue(Indep3Col, res[xIndep3Field])
      Else
        Indep3Val = "__"
      Endif
      If xIndep4Field Then
        Indep4Val = GetGridViewValue(Indep4Col, res[xIndep4Field])
      Else
        Indep4Val = "__"
      Endif
      If xIndep5Field Then
        Indep5Val = GetGridViewValue(Indep5Col, res[xIndep5Field])
      Else
        Indep5Val = "__"
      Endif

      If Depvalue And If Indep1Val And If Indep2Val And If Indep3Val And If Indep4Val And If Indep5Val Then
        modCustPatient.AddFormatRegressionDepToList(DepData, Depvalue)
        modCustPatient.AddFormatRegressionVar1ToList(Indep1Data, Indep1Val)
        modCustPatient.AddFormatRegressionVar2ToList(Indep2Data, Indep2Val)
        modCustPatient.AddFormatRegressionVar3ToList(Indep3Data, Indep3Val)
        modCustPatient.AddFormatRegressionVar4ToList(Indep4Data, Indep4Val)
        modCustPatient.AddFormatRegressionVar5ToList(Indep5Data, Indep5Val)
      Endif
    Next
  Endif
  Dec Application.Busy

  xx = modPSPP.RegressionChartGridNew(DepData, Indep1Data, Indep2Data, Indep3Data, Indep4Data, Indep5Data)
  If xx Then
    modControlSub.OpenBrowser(xx)
  Endif

End

Public Sub mnucrotab_Click()

  Dim Row As Integer
  Dim Column As Integer
  Dim xFieRow As String
  Dim xFieColm As String
  Dim res As Result
  Dim xval As Variant
  Dim yval As Variant

  Dim hForm As FmGridCrossTab
  Dim xForm As CCrossTab
  Dim xFldList As String[]
  Dim hGdChr As FmAnalyzeSett

  hGdChr = New FmAnalyzeSett("GridCrossTab", modGridView.GetGridViewColumns(GridView1))
  hGdChr.ShowModal

  xFldList = GetSQLColumns()
  If MMain.$IsGUIApp = True Then
    $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
    $ProgressBar1.Visible = True
    $ProgressBar1.Value = 0
  Endif

  If modCustPatient.$TabRowColumn And If modCustPatient.$TabFieldColumn Then
    xForm = New CCrossTab
    Inc Application.Busy
    Row = CInt(modCustPatient.$TabRowColumn) - 1
    xFieRow = xFldList[Row]
    Column = CInt(modCustPatient.$TabFieldColumn) - 1
    xFieColm = xFldList[Column]
    res = ExecuteQuery([xFieRow, xFieColm])

    If res.Available Then
      For Each res
        xval = GetGridViewValue(Row, res[xFieRow])
        yval = GetGridViewValue(Column, res[xFieColm])
        If xval And If yval Then
          xForm.Add([xval, yval])
        Endif

        If MMain.$IsGUIApp = True Then
          $ProgressBar1.Value = (res.Index + 1) / res.Count
          Wait
        Endif
      Next
    Endif
    Dec Application.Busy

    hForm = New FmGridCrossTab(GridView1.Columns[Row].Text, xForm.GetSPSSFile())
    hForm.ShowModal
    modExternal.$ExecValueColl.Clear()
  Endif

  If MMain.$IsGUIApp = True Then
    $ProgressBar1.Visible = False
  Endif

End

Public Sub mnugridsummary_Click()

  Dim xx As String
  Dim ChapCol As String
  Dim GropCol As String
  Dim xChapList As String[]
  Dim xGropList As String[]

  Dim res As Result
  Dim valCol As String
  Dim xFieldList As String[]

  Dim xFinList As Variant[]
  Dim xrowVar As Variant[]
  Dim xchapval As String
  Dim xgroup As String
  Dim xPath As String
  Dim xFldList As String[]

  Dim hGdSum As FmAnalyzeSett

  hGdSum = New FmAnalyzeSett("GridSummary", modGridView.GetGridViewColumns(GridView1))
  hGdSum.ShowModal

  xFldList = GetSQLColumns()
  Inc Application.Busy
  xFieldList = New String[]
  If modCustPatient.$SumChapterColumn Then
    ChapCol = xFldList[modCustPatient.$SumChapterColumn - 1]
    xFieldList.Add(ChapCol)
  Endif
  GropCol = xFldList[modCustPatient.$SumGroupColumn - 1]
  valCol = xFldList[modCustPatient.$SumValueColumn - 1]
  xFieldList.Add(GropCol)
  xFieldList.Add(valCol)

  xChapList = New String[]
  xGropList = New String[]
  xFinList = New Variant[]
  res = ExecuteQuery(xFieldList)
  If res.Available Then
    For Each res
      xrowVar = New Variant[]
      If modCustPatient.$SumChapterColumn Then
        xchapval = GetGridViewValue(modCustPatient.$SumChapterColumn - 1, res[ChapCol])
        xrowVar.Add(xchapval)
        xChapList.Add(xchapval)
      Endif
      xgroup = GetGridViewValue(modCustPatient.$SumGroupColumn - 1, res[GropCol])
      xrowVar.Add(xgroup)
      xGropList.Add(xgroup)

      xrowVar.Add(GetGridViewValue(modCustPatient.$SumValueColumn - 1, res[valCol]))
      xFinList.Add(xrowVar)
    Next
  Endif
  Dec Application.Busy

  xx = "Date: " & modReportVar.GetDateTimeReport(dtfir.Value, gb.MediumDate) & " To " & modReportVar.GetDateTimeReport(dtlast.Value, gb.MediumDate)
  If modCustPatient.$SumGroupColumn And If modCustPatient.$SumValueColumn Then
    If modCustPatient.$SumChapterColumn Then
      If modCustPatient.$SummaryType = "Summation(Table)" Then
        xPath = modCHTMLReport.SummaryGridChapterTableReport("Report Summary", xx, modString.GetDistinctStringArray(xChapList), modString.GetDistinctStringArray(xGropList), xFinList)
      Else If modCustPatient.$SummaryType = "Count(Table)" Then
        xPath = modCHTMLReport.SummaryGridChapCountTableReport("Report Summary", xx, modString.GetDistinctStringArray(xChapList), modString.GetDistinctStringArray(xGropList), xFinList)
      Else
        xPath = modCHTMLReport.SummaryGridChapterReport("Report Summary", xx, modString.GetDistinctStringArray(xChapList), modString.GetDistinctStringArray(xGropList), xFinList)
      Endif
    Else
      xPath = modCHTMLReport.SummaryGridReport("Report Summary", xx, modString.GetDistinctStringArray(xGropList), xFinList)
    Endif
    modControlSub.DisplayReportExport(xPath)
  Endif

End

Public Sub mnurepo_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count > 0 Then
    If GridView1[GridView1.Row, 10].Text = "Reported" Or If GridView1[GridView1.Row, 10].Text = "Verified" Then
      Inc Application.Busy
      xPath = modCHTMLPatient.ShowPatLabReportbySampleID(GridView1[GridView1.Row, 1].Text, GridView1[GridView1.Row, 6].Text, LabUnit(), cmbfiscal.Text)
      Dec Application.Busy
      modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 1].Text, xPath, "ReportSize")
    Endif
  Endif

End

Public Sub mnuhiderow_Click()

  GridView1.Rows[GridView1.Row].Height = 0

End

''-------------------------------------------- Report ----------------------------------
Public Sub dtnepfir_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtfir.Value))
  If xx Then
    dtfir.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub dtneplast_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlast.Value))
  If xx Then
    dtlast.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnfullrep_Click()

  Dim xHeader As String[]
  Dim xhide As Integer[]
  Dim Column As Integer
  Dim xCollRow As Collection
  Dim xColum As Integer
  Dim xcellval As Variant

  Dim $hGridExportTable As CExportResult
  Dim xparam1 As String
  Dim xparam2 As String
  Dim encColumn As Integer

  Dim xFldList As String[]

  If MMain.$IsGUIApp = True Then
    $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
    $ProgressBar1.Visible = True
    $ProgressBar1.Value = 0
  Endif

  xHeader = New String[]
  xhide = New Integer[]
  For Column = 0 To GridView1.Columns.Count - 1
    xHeader.Add(GridView1.Columns[Column].Text)
    If GridView1.Columns[Column].Width < 5 Then
      xhide.Add(Column)
    Endif
  Next
  xparam1 = "Laboratory Report: " & cmbstatus.Text
  xparam2 = modReportVar.GetDateTimeReport(dtfir.Value, gb.MediumDate) & " To " & modReportVar.GetDateTimeReport(dtlast.Value, gb.MediumDate)
  encColumn = 1
  $hGridExportTable = New CExportResult(Me.Tag, xHeader, xhide, xparam1, xparam2, encColumn)

  Inc Application.Busy
  xFldList = GetSQLColumns()

  For Each $rData
    xCollRow = New Collection
    For xColum = 0 To xFldList.Count - 1
      xcellval = GetGridViewValue(xColum, $rData[xFldList[xColum]])
      If xcellval = "icons/true.svg" Then
        xCollRow.Add("Abnormal", CStr(xColum))
      Else If xcellval = "icons/false.svg" Then
        xCollRow.Add("Normal", CStr(xColum))
      Else
        xCollRow.Add(xcellval, CStr(xColum))
      Endif
    Next
    $hGridExportTable.Add($rData.Index, xCollRow)

    If MMain.$IsGUIApp = True Then
      $ProgressBar1.Value = ($rData.Index + 1) / $rData.Count
      Wait
    Endif
  Next

  Dec Application.Busy
  If MMain.$IsGUIApp = True Then
    $ProgressBar1.Visible = False
  Endif
  modControlSub.DisplayReportExport($hGridExportTable.HTMLPath())

End

Private Sub ShowSUmmaryReport(sField As String)

  Dim xfldtime As String
  Dim xPath As String
  Dim xdate As Date[]

  If cmbstatus.Text = "Sampled" Then
    xfldtime = "fldtime_sample"
  Else If cmbstatus.Text = "Reported" Then
    xfldtime = "fldtime_report"
  Else If cmbstatus.Text = "Verified" Then
    xfldtime = "fldtime_verify"
  Else
    xfldtime = "fldtime_sample"
  Endif

  xdate = DoubleDates("Select Dates", "Laboratory Tests", [dtfir.Value, dtlast.Value])
  If xdate Then
    Inc Application.Busy
    xPath = modCHTMLDate.SummaryStatReport(modDatabase.$syConn, $tblpatlabtest, "fldid", sField, xfldtime, xdate[0], xdate[1], cmblocation.Text, cmbvalue.Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnusection_Click()

  Dim xfldtime As String
  Dim xPath As String
  Dim xdate As Date[]

  If cmbstatus.Text = "Sampled" Then
    xfldtime = "fldtime_sample"
  Else If cmbstatus.Text = "Reported" Then
    xfldtime = "fldtime_report"
  Else If cmbstatus.Text = "Verified" Then
    xfldtime = "fldtime_verify"
  Else
    xfldtime = "fldtime_sample"
  Endif

  xdate = DoubleDates("Select Dates", "Laboratory Tests", [dtfir.Value, dtlast.Value])
  If xdate Then
    Inc Application.Busy
    xPath = modCHTMLDate.SummarySectionStatReport(modDatabase.$syConn, $tblpatlabtest, modDataRepo.SerialField(), "fldtestid", "fldcategory", "tbltest", "fldtestid", xfldtime, xdate[0], xdate[1], cmblocation.Text, cmbvalue.Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnusumtestname_Click()

  ShowSUmmaryReport("fldtestid")

End

Public Sub mnusumspeci_Click()

  ShowSUmmaryReport("fldsampletype")

End

Public Sub mnusumcondi_Click()

  ShowSUmmaryReport("fldcondition")

End

Public Sub mnusumrefer_Click()

  ShowSUmmaryReport("fldrefername")

End

Public Sub mnusumtype_Click()

  ShowSUmmaryReport("fldabnormal")

End

Public Sub mnusumusersample_Click()

  ShowSUmmaryReport("flduserid_sample")

End

Public Sub mnusamploaduser_Click()

  ShowSUmmaryReport("flduserid_start")

End

Public Sub mnusumrepouser_Click()

  ShowSUmmaryReport("flduserid_report")

End

Public Sub mnusumverifuser_Click()

  ShowSUmmaryReport("flduserid_verify")

End

Public Sub mnusumethod_Click()

  ShowSUmmaryReport("fldmethod")

End

Public Sub mnuhospsumm_Click()

  ShowSUmmaryReport("fldhospcode")

End

Private Sub ShowSUmmaryDateWiseReport(sField As String)

  Dim xfldtime As String
  Dim xPath As String
  Dim xdate As Date[]

  If cmbstatus.Text = "Sampled" Then
    xfldtime = "fldtime_sample"
  Else If cmbstatus.Text = "Reported" Then
    xfldtime = "fldtime_report"
  Else If cmbstatus.Text = "Verified" Then
    xfldtime = "fldtime_verify"
  Else
    xfldtime = "fldtime_sample"
  Endif

  xdate = DoubleDates("Select Dates", "Laboratory Tests", [dtfir.Value, dtlast.Value], 1)
  If xdate Then
    Inc Application.Busy
    xPath = modCHTMLDate.SummaryStatDateWiseReport(modDatabase.$syConn, $tblpatlabtest, "fldid", sField, xfldtime, xdate[0], xdate[1], cmblocation.Text, cmbvalue.Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnudatesection_Click()

  Dim xfldtime As String
  Dim xPath As String
  Dim xdate As Date[]

  If cmbstatus.Text = "Sampled" Then
    xfldtime = "fldtime_sample"
  Else If cmbstatus.Text = "Reported" Then
    xfldtime = "fldtime_report"
  Else If cmbstatus.Text = "Verified" Then
    xfldtime = "fldtime_verify"
  Else
    xfldtime = "fldtime_sample"
  Endif

  xdate = DoubleDates("Select Dates", "Laboratory Tests", [dtfir.Value, dtlast.Value], 1)
  If xdate Then
    Inc Application.Busy
    xPath = modCHTMLDate.SummarySectionStatDateWiseReport(modDatabase.$syConn, $tblpatlabtest, modDataRepo.SerialField(), "fldtestid", "fldcategory", "tbltest", "fldtestid", xfldtime, xdate[0], xdate[1], cmblocation.Text, cmbvalue.Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnudtsumtestname_Click()

  ShowSUmmaryDateWiseReport("fldtestid")

End

Public Sub mnudtsumspecimen_Click()

  ShowSUmmaryDateWiseReport("fldsampletype")

End

Public Sub mnudtsumcondition_Click()

  ShowSUmmaryDateWiseReport("fldcondition")

End

Public Sub mnudtsumreferal_Click()

  ShowSUmmaryDateWiseReport("fldrefername")

End

Public Sub mnudtsummethod_Click()

  ShowSUmmaryDateWiseReport("fldmethod")

End

Public Sub mnudtsumobserv_Click()

  ShowSUmmaryDateWiseReport("fldabnormal")

End

Public Sub mnudtsumsampuser_Click()

  ShowSUmmaryDateWiseReport("flduserid_sample")

End

Public Sub mnuloaddate_Click()

  ShowSUmmaryDateWiseReport("flduserid_start")

End

Public Sub mnudtsumrepouser_Click()

  ShowSUmmaryDateWiseReport("flduserid_report")

End

Public Sub mnudtsumverify_Click()

  ShowSUmmaryDateWiseReport("flduserid_verify")

End

Public Sub mnuhospdate_Click()

  ShowSUmmaryDateWiseReport("fldhospcode")

End

Public Sub mnucheck_Click()

  Dim xPath As String
  Dim xdate As Date[]

  xdate = DoubleDates("Select Dates", "Laboratory Tests", [dtfir.Value, dtlast.Value])
  If xdate Then
    Inc Application.Busy
    xPath = GetLaboratoryOutliers(modDatabase.$syConn, xdate[0], xdate[1])
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''----------- Export all -------------
Public Sub mnupatwise_Click()

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim xType As String
  Dim xList As String[]
  Dim Column As Integer
  Dim hdr As String[]
  Dim xFldList As String[]

  Dim xcol As String
  Dim xval As String
  Dim res As Result

  Dim j As Integer
  Dim fldList As String[]

  If cmbtest.Text Then
    fldList = GetSQLColumns()
    xFldList = fldList.Copy(0, 12)

    xType = modFixLab.GetLabTestOptionType(cmbtest.Text)
    If xType = "Clinical Scale" Then
      xlist = modAllExam.GetCLinicalScaleGroups("Test", cmbtest.Text)
    Else If xType = "Left and Right" Then
      xlist = ["LEFT", "RIGHT"]
    Else
      xList = modFixLab.GetSubTestArray(cmbtest.Text)
    Endif

    $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
    $ProgressBar1.Tag = "Const"

    hdr = ["SNo", "EncID", "Name", "Age", "Gender", "TestName", "SampID", "Specimen", "Sampling", "Reporting", "Status", "Observation"]
    If xList Then
      hdr.Insert(xList)
    Endif
    If $newColumn.Count Then
      For j = 0 To $newColumn.Count - 1
        hdr.Add($newColumn[j])
      Next
    Endif

    $BillingReport = New CReportHTML(hdr, "", "")
    $BillingReport.UserData.Add("Laboratory Report : " & cmbtest.Text, "PARAM1")
    $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(dtfir.Value, gb.MediumDate) & " To " & modReportVar.GetDateTimeReport(dtlast.Value, gb.MediumDate), "PARAM2")

    Inc Application.Busy
    res = ExecuteQuery(xFldList)
    If res.Available Then
      For Each res
        With asx
          .Add(res.Index + 1)
          For Column = 1 To xFldList.Count - 1
            .Add(GetGridViewValue(Column, res[xFldList[Column]]))
          Next
          If xList Then
            For Each xcol In xList
              If xType = "Clinical Scale" Or If xType = "Left and Right" Then
                xval = GetSubComponentJSON(res[xFldList[11]], xcol)
              Else
                xval = GetSubTestValue(res[xFldList[11]], xcol)
              Endif
              .Add(xval)
            Next
          Endif

          If $newColumn.Count Then
            For j = 0 To $newColumn.Count - 1
              .Add(modCustPatient.NewColValue(Me.Tag, $newColumn[j], res["fldencounterval"]))
            Next
          Endif
        End With
        $BillingReport.Add(asx)
        asx.Clear()
        $ProgressBar1.Value = (res.Index + 1) / res.Count
        Wait
      Next
    Endif
    Dec Application.Busy

    modControlSub.DisplayReportExport($BillingReport.NewHTMLPath())
  Endif

End

Private Function GetSubComponentJSON(testid As Variant, subtest As String) As String

  Dim res As Result
  Dim xxx As Variant
  Dim xcoll As JSONCollection
  Dim xval As String

  If MMain.$WebEntry = True Then
    res = modDatabase.$syConn.Exec("select fldreportquali from " & $tblpatlabtest & " where fldrepoid=&1", testid)
  Else
    res = modDatabase.$syConn.Exec("select fldreportquali from " & $tblpatlabtest & " where fldid=&1", testid)
  Endif
  If res.Available Then
    If IsNumber(res["fldreportquali"]) Then
    Else

      Try xxx = JSON.Decode(res["fldreportquali"], True)
      If xxx Then
        If xxx Is JSONCollection Then
          xcoll = xxx
          xval = CStr(xcoll[subtest])
        Else
          xval = ""
        Endif
      Else
        xval = ""
      Endif

    Endif
  Endif
  Return xval

End

Private Function GetSubTestValue(testid As Variant, subtest As String) As String

  Dim res As Result
  Dim res1 As Result
  Dim xx As String
  Dim xcaption As String

  xcaption = modFixLab.GetLabTestCaption(testid)
  If modBasic.$SuperUser = False And If xcaption = "$Encryption" Then
    xx = "****"
  Else

    If MMain.$WebEntry = True Then ''remoteoptimized
      res1 = modDatabase.$syConn.Exec("select fldid,fldhospcode from " & $tblpatlabtest & " where fldrepoid=&1", testid)
      If res1.Available Then
        res = modDatabase.$syConn.Exec("select fldreport from " & $tblpatlabsubtest & " where fldtestid=&1 and fldsubtest=&2 and fldhospcode=&3", res1["fldid"], subtest, res1["fldhospcode"])
        If res.Available Then
          If res["fldreport"] Then
            xx = res["fldreport"]
          Else
            xx = ""
          Endif
        Else
          xx = ""
        Endif
      Endif

    Else
      res = modDatabase.$syConn.Exec("select fldreport from " & $tblpatlabsubtest & " where fldtestid=&1 and fldsubtest=&2", testid, subtest)
      If res.Available Then
        If res["fldreport"] Then
          xx = res["fldreport"]
        Else
          xx = ""
        Endif
      Else
        xx = ""
      Endif

    Endif

  Endif
  Return xx

End

Public Sub chkchart_Click()

  TabStrip1.Index = 1

End

Public Sub chkchfreq_Click()

  TabStrip1.Index = 2

End

Private Function GetLaboratoryOutliers(conn As Connection, dt1 As Date, dt2 As Date) As String

  Dim $BillingReport As CReportHTML
  Dim asx As New String[0]
  Dim testlist As String[]
  Dim test As String
  Dim xgiven As Float
  Dim i As Integer

  Dim limval As Float[]
  Dim minval As Float
  Dim maxval As Float
  Dim obsval As Float
  Dim res As Result
  Dim xunit As String

  $BillingReport = New CReportHTML([("SNo"), ("IndexNo"), ("Encounter"), ("PatientName"), ("Age/Sex"), ("Observation"), ("Ref Range"), ("Date")], "", "")
  $BillingReport.UserData.Add("OUTLIERS SUMMARY : " & CStr(xgiven) & " X Ref Range", "PARAM1")
  $BillingReport.UserData.Add(modReportVar.GetDateTimeReport(dt1, gb.MediumDate) & " TO " & modReportVar.GetDateTimeReport(dt2, gb.MediumDate), "PARAM2")

  i = 1
  testlist = modControlSub.GetDirectFillresult(modDatabase.$syConn.Exec("select fldtestid as col from tbltest where fldtype like &1", "Quantitative"))
  For Each test In testlist
    xgiven = modFixLab.GetCritValueTest(test)
    If xgiven Then
      res = conn.Exec("select fldid,fldencounterval,fldtime_sample,fldtestid,fldreportquanti,fldtestunit,fldmethod from " & $tblpatlabtest & " where fldtestid=&1 and fldtime_sample>=&2 and fldtime_sample<=&3 and (fldstatus=&4 or fldstatus=&5)", test, modDate.StartSqlDate(dt1), modDate.EndSqlDate(dt2), "Reported", "Verified")
      If res.Available Then
        $BillingReport.AddChapter(test)

        For Each res
          If res["fldmethod"] Then
            xunit = modLabTest.LabTestUnit(res["fldtestid"], res["fldencounterval"], MMain.$defUnit, res["fldmethod"])
            limval = modLabTest.LabBothLimitValue(res["fldtestid"], res["fldencounterval"], MMain.$defUnit, res["fldmethod"])
          Else
            xunit = modLabTest.LabTestUnit(res["fldtestid"], res["fldencounterval"], MMain.$defUnit)
            limval = modLabTest.LabBothLimitValue(res["fldtestid"], res["fldencounterval"], MMain.$defUnit)
          Endif
          If limval.Count = 2 Then
            minval = limval[0]
            maxval = limval[1]
            obsval = modLabTest.GetLabQuantiValueAll(res["fldencounterval"], res["fldtestid"], res["fldreportquanti"], res["fldtestunit"], res["fldmethod"], MMain.$defUnit)

            If minval <> maxval Then
              If obsval <= minval - (xgiven * (maxval - minval)) Or If obsval >= maxval + (xgiven * (maxval - minval)) Then
                With asx
                  .Add(i)
                  .Add(res["fldid"])
                  .Add(res["fldencounterval"])
                  .Add(modPatient.GetPatientNameByEnc(res["fldencounterval"], conn))
                  .Add(modPatient.GetPatientSex(res["fldencounterval"], conn))
                  .Add(modReportVar.GetLocaleNumberFormat(obsval, 0))
                  .Add(CStr(minval) & " - " & CStr(maxval) & Space(1) & xunit)
                  .Add(modReportVar.GetDateTimeReport(res["fldtime_sample"], gb.GeneralDate))
                End With
                $BillingReport.Add(asx)
                asx.Clear()
                i = i + 1
              Endif
            Endif

          Endif
        Next

      Endif
    Endif
  Next

  Return $BillingReport.NewHTMLPath()

End

Public Sub mnucountuni_Click()

  Dim Column As Integer
  Dim xFieColm As String
  Dim res As Result
  Dim yval As Variant
  Dim xList As String[]

  Dim xVar As Variant[]
  Dim xFldList As String[]
  Dim xPath As String

  Column = ListIndex("Column Index", modGridView.GetGridViewColumns(GridView1))
  If Column + 1 > 0 Then
    xFldList = GetSQLColumns()
    If MMain.$IsGUIApp = True Then
      $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
      $ProgressBar1.Visible = True
      $ProgressBar1.Value = 0
    Endif

    Inc Application.Busy
    xFieColm = xFldList[Column]
    res = ExecuteQuery([xFieColm])
    xList = New String[]
    If res.Available Then
      For Each res
        yval = GetGridViewValue(Column, res[xFieColm])
        If yval Then
          xList.Add(yval)
        Endif

        If MMain.$IsGUIApp = True Then
          $ProgressBar1.Value = (res.Index + 1) / res.Count
          Wait
        Endif
      Next
    Endif
    If xList.Count Then
      xVar = modString.GetUnivariateSummary(xList)
      xPath = modCHTMLReport.CreateHTMLReportFromArray(["Variable", "Count"], xVar, GridView1.Columns[Column].Text, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))
    Endif
    Dec Application.Busy

    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Public Sub mnucolumns_Click()

  If Message.Question(modGridView.GetColumnsListString(GridView1), ("OK"), ("Setting")) = 2 Then
    fmChartSetting.Close
    fmChartSetting.ShowModal
  Endif

End

Public Sub mnumapvar_Click()

  Dim hForm As FmAddRepMap

  If MMain.$SISHAppMode = "REP" Then
    hForm = New FmAddRepMap("Laboratory")
    hForm.ShowModal
  Endif

End

Public Sub mnuexpocolumn_Click()

  Dim hForm As FmCustColumnSet

  hForm = New FmCustColumnSet(Me.Tag)
  hForm.ShowModal

End

Public Sub mnugetimage_Click()

  Dim hForm As FmTestImage

  If GridView1.Rows.Selection.Count > 0 Then
    hForm = New FmTestImage("IMAGE", GridView1[GridView1.Row, 1].Text, GridView1[GridView1.Row, 0].Text, GridView1[GridView1.Row, 5].Text, "Laboratory", "")
    hForm.ShowModal
  Endif

End

Public Sub mnugetdicom_Click()

  Dim hForm As FmTestImage

  If GridView1.Rows.Selection.Count > 0 Then
    hForm = New FmTestImage("DICOM", GridView1[GridView1.Row, 1].Text, GridView1[GridView1.Row, 0].Text, GridView1[GridView1.Row, 5].Text, "Laboratory", "")
    hForm.ShowModal
  Endif

End
