' Gambas class file

Private $rData As Result
Private $aMyFields As String[]
Private $RepoList As String[]

Private $rData1 As Result
Private $aMyFields1 As String[]

Private $tblpatbilling As String
Private $tblpatbilldetail As String
Private $tbltempbilldetail As String

Public Sub Form_Open()

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Vertical")
  cmbsource.List = ["Invoice", "Receipt", "Both"]
  cmbsource.Text = "Both"
  cmblocat.List = ["Consultation", "Emergency", "Patient Ward", "%"]
  cmblocat.Text = "%"
  cmbstate.List = ["Pending", "Completed", "Any"]
  cmbstate.Text = "Pending"
  cmbaccount.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldacledger) as col from tbldiscount where fldbilltype=&1 and fldreference IS NULL", "Credit"))
  ' cmbaccount.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldacledger) as col from tbldiscount where fldbilltype=&1", "Credit"))
  If cmbaccount.Count Then
    cmbaccount.Index = 0
  Endif
  cmbnodiagno.List = ["Disable", "Enable"]
  dtfir.Value = Now()
  dtlast.Value = Now()
  modAccount.PasInvoiceSetting(cmbfiscal, False)
  LoadTableNames()

  BipannaFormats()

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

''===================== Bipanna only ========================
Private Sub BipannaFormats()

  modBasic.SetBipannaAPI()
  cmbbippatask.List = ["Treatment", "Kidney Session", "Billing"]

End

Public Sub cmbbippatask_Click()

  If cmbbippatask.Text = "Treatment" Then
    cmbbippcategory.List = ["1:O.P.D", "2:Radiology Charge", "3:Beds Charge", "4:Medicine Charge", "5:Surgical Charge", "6:Other", "7:Laboratory Charge", "8:Radiation Charge", "9:Heart Valve Change"]
  Else If cmbbippatask.Text = "Kidney Session" Then
    cmbbippcategory.List = ["1:Transplant", "2:Hemodialysis", "3:Peritoneal Dialysis", "4:Medical Treatment", "5:AKI/Medical Treatment", "6:Seropositive Dialysis"]
  Else
    cmbbippcategory.Clear()
  Endif

End

Public Sub cmbbippcategory_Click()

  Dim asx As String[]

  asx = Split(cmbbippcategory.Text, ":")
  If asx.Count Then
    txtcategcode.Value = CInt(asx[0])
  Endif

End

Private Function GetKidenyCost(sType As String) As Float

  Dim xamt As Float

  If sType = "1:Transplant" Then
    xamt = 400000
  Else If sType = "2:Hemodialysis" Then
    xamt = 2500
  Else If sType = "3:Peritoneal Dialysis" Then
    xamt = 501
  Else If sType = "4:Medical Treatment" Then
    xamt = 0
  Else If sType = "5:AKI/Medical Treatment" Then
    xamt = 100000
  Else If sType = "6:Seropositive Dialysis" Then
    xamt = 4000
  Endif

  Return xamt

End

''============================= General ===========================
Public Sub dtnepfir_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtfir.Value))
  If xx Then
    dtfir.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub dtneplast_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlast.Value))
  If xx Then
    dtlast.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Private Sub LoadTableNames()

  Dim res As Result

  If cmbfiscal.Text = "Current" Then
    $tblpatbilling = "tblpatbilling"
    $tblpatbilldetail = "tblpatbilldetail"
    $tbltempbilldetail = "tbltempbilldetail"
  Else
    res = modDatabase.$myConn.Exec("select fldpatbilling,fldpatbilldetail,fldtempbilldetail from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", cmbfiscal.Text, "Active")
    If res.Available Then
      If res["fldpatbilling"] Then
        $tblpatbilling = res["fldpatbilling"]
      Else
        $tblpatbilling = "tblpatbilling"
      Endif
      If res["fldpatbilldetail"] Then
        $tblpatbilldetail = res["fldpatbilldetail"]
      Else
        $tblpatbilldetail = "tblpatbilldetail"
      Endif
      If res["fldtempbilldetail"] Then
        $tbltempbilldetail = res["fldtempbilldetail"]
      Else
        $tbltempbilldetail = "tbltempbilldetail"
      Endif
    Else
      $tblpatbilling = "tblpatbilling"
      $tblpatbilldetail = "tblpatbilldetail"
      $tbltempbilldetail = "tbltempbilldetail"
    Endif
  Endif

End

Public Sub cmbfiscal_Click()

  LoadTableNames()

End

Public Sub chkok_Click()

  modMisc.GetDateRangeSetting(dtfir, dtlast)

  Inc Application.Busy
  FillGridView()
  Dec Application.Busy

End

Private Sub FillGridView()

  Dim xList As String[] = ["fldbillno", "fldbankname", "fldencounterval", "fldencounterval", "fldencounterval", "fldprevdeposit", "fldbilltype", "(flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt) as totamt", "fldtime", "fldtime", "fldencounterval", "fldencounterval"]
  Dim sql1 As String
  Dim sql2 As String
  Dim encid As String
  Dim yregist As String
  Dim xsear As String
  Dim xrefno As String

  If txtencid.Text Then
    encid = Trim(txtencid.Text)
  Else
    encid = "%"
  Endif
  If txtreference.Text Then
    xrefno = db.Subst(" and fldchequeno like &1", Trim(txtreference.Text))
  Else
    xrefno = ""
  Endif

  If cmblocat.Text = "All" Then
    yregist = ""
  Else
    If cmblocat.Text = "OPD" Then
      yregist = db.Subst(" and fldprevdeposit=&1", 1)
    Else If cmblocat.Text = "IPD" Then
      yregist = db.Subst(" and fldprevdeposit>&1", 1)
    Endif
  Endif

  If cmbstate.Text = "Pending" Then
    xsear = " and fldbillno not in(select fldbillno from tblbillupload)"
  Else If cmbstate.Text = "Completed" Then
    xsear = " and fldbillno in(select fldbillno from tblbillupload)"
  Else
    xsear = ""
  Endif

  If cmbsource.Text = "Invoice" Then
    sql1 = "select " & xList.Join(",") & " from " & $tblpatbilldetail & " where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno
    sql2 = "select " & xList.Join(",") & " from tblpatbilldetail where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno
  Else If cmbsource.Text = "Receipt" Then
    sql1 = "select " & xList.Join(",") & " from " & $tbltempbilldetail & " where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno
    sql2 = "select " & xList.Join(",") & " from tbltempbilldetail where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno
  Else
    sql1 = "select " & xList.Join(",") & " from " & $tblpatbilldetail & " where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno & " UNION select " & xList.Join(",") & " from " & $tbltempbilldetail & " where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno
    sql2 = "select " & xList.Join(",") & " from tblpatbilldetail where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno & " UNION select " & xList.Join(",") & " from tbltempbilldetail where fldbankname like &1 and fldencounterval like &2 and fldbilltype like &3" & xsear & " and fldtime>=&4 and fldtime<=&5 and (flditemamt+fldtaxamt-flddiscountamt-fldreceivedamt)>&6" & yregist & xrefno
  Endif

  If cmbfiscal.Text = "Current" Then
    $rData = modDatabase.$myConn.Exec(sql1, cmbaccount.Text, encid, "Credit", modDate.StartSqlDate(dtfir.value), modDate.EndSqlDate(dtlast.value), 0)                  ''
  Else
    $rData = modDatabase.$myConn.Exec(sql1 & " UNION ALL " & sql2, cmbaccount.Text, encid, "Credit", modDate.StartSqlDate(dtfir.value), modDate.EndSqlDate(dtlast.value), 0)                  ''
  Endif
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Width = 150 * modBasic.$AppWidthRatio
    .Columns[1].Width = 125 * modBasic.$AppWidthRatio
    .Columns[2].Width = 125 * modBasic.$AppWidthRatio
    .Columns[3].Width = 200 * modBasic.$AppWidthRatio
    .Columns[4].Width = 100 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio
    .Columns[6].Width = 1
    .Columns[7].Width = 100 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 150 * modBasic.$AppWidthRatio
    .Columns[10].Width = 125 * modBasic.$AppWidthRatio
    .Columns[11].Width = 125 * modBasic.$AppWidthRatio

    .Columns[0].Text = "Invoice"
    .Columns[1].Text = "Account"
    .Columns[2].Text = "Encounter"
    .Columns[3].Text = "Name"
    .Columns[4].Text = "Status"
    .Columns[5].Text = "State"
    .Columns[7].Text = "Credit"
    .Columns[9].Text = "DateTime"
    .Columns[10].Text = "SSU Code"
    .Columns[11].Text = "Indentity"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 3 Then
    GridView1.Data.Text = modPatient.GetPatientNameByEnc($rData[$aMyFields[Column]], modDatabase.$myConn)
  Else If Column = 4 Then
    GridView1.Data.Text = modPatient.CurrentAdmissionStatus($rData[$aMyFields[Column]])
  Else If Column = 5 Then
    GridView1.Data.Text = GetInvoiceState($rData[$aMyFields[Column]]) ''totalamt
  Else If Column = 9 Then
    GridView1.Data.Text = modReportVar.GetDateTimeReport($rData[$aMyFields[Column]], gb.GeneralDate)
  Else If Column = 10 Then
    GridView1.Data.Text = GetSSUCode($rData[$aMyFields[Column]])
  Else If Column = 11 Then
    GridView1.Data.Text = GetSSUIdentity($rData[$aMyFields[Column]])
  Else
    GridView1.Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Private Function GetSSUCode(encid As String) As String

  Dim xpatNo As String
  Dim rsx As Result
  Dim res As Result
  Dim xval As String

  xpatNo = modPatient.GetPatientNoByEnc(encid)
  rsx = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1 and flddisctype=&2", xpatNo, cmbaccount.Text)
  If rsx.Available Then
    xval = rsx["fldserviceid"]
  Else
    res = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1", xpatNo)
    If res.Available And If res.Count = 1 Then
      xval = res["fldserviceid"]
    Else
      xval = modPatient.GetPatientExtCOdebyEnc(encid)
    Endif
  Endif

  Return xval

End

Private Function GetSSUIdentity(encid As String) As String

  Dim xpatNo As String
  Dim rsx As Result
  Dim res As Result
  Dim xval As String

  xpatNo = modPatient.GetPatientNoByEnc(encid)
  rsx = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1 and flddisctype=&2", xpatNo, cmbaccount.Text)
  If rsx.Available Then
    xval = rsx["fldidentify"]
  Else
    res = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1", xpatNo)
    If res.Available And If res.Count = 1 Then
      xval = res["fldidentify"]
    Endif
  Endif

  Return xval

End

Private Function GetInvoiceState(xState As Float) As String

  Dim xval As String

  If xstate = 1 Then
    xval = "OPD"
  Else If xstate > 1 Then
    xval = "IPD"
  Endif

  Return xval

End

Public Sub GridView1_Click()

  Dim rsx As Result
  Dim res As Result
  Dim xpatNo As String

  $RepoList = New String[]
  btnupload.Text = "Upload"
  txttotal.Value = 0
  txttotal.Value = GridView1[GridView1.Row, 7].Text

  txtgridencid.Text = GridView1[GridView1.Row, 2].Text
  xpatNo = modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text)
  rsx = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1 and flddisctype=&2", xpatNo, cmbaccount.Text)
  If rsx.Available Then
    txtssucode.Text = rsx["fldserviceid"]
    txtdiseaseid.Text = rsx["fldidentify"]
  Else
    res = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1", xpatNo)
    If res.Available And If res.Count = 1 Then
      txtssucode.Text = res["fldserviceid"]
      txtdiseaseid.Text = res["fldidentify"]
    Else
      txtssucode.Text = modPatient.GetPatientExtCOdebyEnc(GridView1[GridView1.Row, 2].Text)
    Endif
  Endif

  txtinvoice.Text = GridView1[GridView1.Row, 0].Text
  txtaccount.Text = GridView1[GridView1.Row, 1].Text
  cmbnodiagno.Text = ""

  SHowCreditGrid()

End

Public Sub mnudetails_Click()

  Dim sql As String
  Dim hForm As FRequest
  Dim res As Result
  Dim xsear As String

  If GridView1.Rows.Selection.Count Then
    If cmbstate.Text = "Pending" Then
      xsear = " and fldbillno not in(select fldbillno from tblbillupload)"
    Else If cmbstate.Text = "Completed" Then
      xsear = " and fldbillno in(select fldbillno from tblbillupload)"
    Else
      xsear = ""
    Endif
    If cmbsource.Text = "Invoice" Then
      sql = "select fldencounterval,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldditemamt as tot,fldtime,fldid,fldbillno from " & $tblpatbilling & "  where fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldbankname=&1 and fldencounterval=&2 and fldbilltype like &3 and fldbillno=&4" & xsear & ")"                                                  ''
    Else If cmbsource.Text = "Receipt"
      sql = "select fldencounterval,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldditemamt as tot,fldtime,fldid,fldbillno from " & $tblpatbilling & "  where fldbillno in(select fldbillno from " & $tbltempbilldetail & " where fldbankname=&1 and fldencounterval=&2 and fldbilltype like &3 and fldbillno=&4" & xsear & ")"
    Else
      sql = "select fldencounterval,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldditemamt as tot,fldtime,fldid,fldbillno from " & $tblpatbilling & "  where fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldbankname=&1 and fldencounterval=&2 and fldbilltype like &3 and fldbillno=&4" & xsear & ")" & " UNION ALL " & "select fldencounterval,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldditemamt as tot,fldtime,fldid,fldbillno from " & $tblpatbilling & "  where fldbillno in(select fldbillno from " & $tbltempbilldetail & " where fldbankname=&1 and fldencounterval=&2 and fldbilltype like &3 and fldbillno=&4" & xsear & ")"
    Endif
    res = modDatabase.$syConn.Exec(sql, GridView1[GridView1.Row, 1].Text, GridView1[GridView1.Row, 2].Text, "Credit", GridView1[GridView1.Row, 0].Text)
    If res.Available Then
      hForm = New FRequest(res, GridView1[GridView1.Row, 2].Text, "Billing:SelectedInvoice", False)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnexport_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, "CLAIM CODE REPORT", cmbaccount.Text)

End

''====================== Claim ==========================
Private Sub SHowCreditGrid()

  Dim sql1 As String
  Dim sql2 As String
  Dim xList As String[]
  Dim xtot As Float
  Dim xinvLst As String[]

  Dim xList1 As String[]
  Dim xList2 As String[]

  xList = ["fldid", "CONCAT(flditemtype,'|', flditemname)", "flditemname", "flditemrate", "flditemqty", "fldditemamt", "fldbillno", "fldclaimstate", "fldclaimid"]
  xList1 = xList.Copy()
  xList1.Add(Quote($tblpatbilling))
  xList2 = xList.Copy()
  xList2.Add(Quote("tblpatbilling"))

  If cmbsource.Text = "Invoice" Then
    sql1 = "select " & xList1.Join(",") & " from " & $tblpatbilling & " where fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4)"                                                  ''
    sql2 = "select " & xList2.Join(",") & " from tblpatbilling where fldbillno in(select fldbillno from tblpatbilldetail where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4)"                                                  ''
  Else If cmbsource.Text = "Receipt" Then
    sql1 = "select " & xList1.Join(",") & " from " & $tblpatbilling & " where fldbillno in(select fldbillno from " & $tbltempbilldetail & " where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4)"
    sql2 = "select " & xList2.Join(",") & " from tblpatbilling where fldbillno in(select fldbillno from tbltempbilldetail where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4)"
  Else
    sql1 = "select " & xList1.Join(",") & " from " & $tblpatbilling & " where fldbillno in(select fldbillno from " & $tblpatbilldetail & " where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4) UNION ALL select " & xList1.Join(",") & " from " & $tblpatbilling & "  where fldbillno in(select fldbillno from " & $tbltempbilldetail & " where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4)"
    sql2 = "select " & xList2.Join(",") & " from tblpatbilling where fldbillno in(select fldbillno from tblpatbilldetail where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4) UNION ALL select " & xList2.Join(",") & " from tblpatbilling  where fldbillno in(select fldbillno from tbltempbilldetail where fldbankname=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval=&2) and fldbilltype like &3 and fldbillno=&4)"
  Endif

  If cmbfiscal.Text = "Current" Then
    $rData1 = modDatabase.$syConn.Exec(sql1, txtaccount.Text, modPatient.GetPatientNoByEnc(txtgridencid.Text), "Credit", txtinvoice.Text)
  Else
    $rData1 = modDatabase.$syConn.Exec(sql1 & " UNION ALL " & sql2, txtaccount.Text, modPatient.GetPatientNoByEnc(txtgridencid.Text), "Credit", txtinvoice.Text)
  Endif
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)

  xtot = 0
  xinvLst = New String[]
  For Each $rData1
    xtot = xtot + $rData1["fldditemamt"]
    If xinvLst.Exist($rData1["fldbillno"]) = False Then
      xinvLst.Add($rData1["fldbillno"])
    Endif
  Next
  txtssftotalsel.Value = xtot
  If xinvLst.Count Then
    txtinvoicesel.Text = xinvLst.Join(", ")
  Endif

  With GridView2
    .Columns[0].Width = 1
    .Columns[1].Width = 75 * modBasic.$AppWidthRatio
    .Columns[2].Width = 225 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 50 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 125 * modBasic.$AppWidthRatio
    .Columns[7].Width = 100 * modBasic.$AppWidthRatio
    .Columns[8].Width = 200 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Code"
    .Columns[2].Text = "Particulars"
    .Columns[3].Text = "Rate"
    .Columns[4].Text = "QTY"
    .Columns[5].Text = "Total"
    .Columns[6].Text = "Invoice"
    .Columns[7].Text = "State"
    .Columns[8].Text = "Claim ID"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData1.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 1 Then
    GridView2.Data.Text = GetBillingSSFItemAbbvName($rData1[$aMyFields1[Column]])
  Else If Column = 3 Then
    GridView2.Data.Text = modReportVar.GetLocaleNumberFormat($rData1[$aMyFields1[Column]], -2)
  Else If Column = 4 Then
    GridView2.Data.Text = modReportVar.GetLocaleNumberFormat($rData1[$aMyFields1[Column]], -2)
  Else If Column = 5 Then
    GridView2.Data.Text = modReportVar.GetLocaleNumberFormat($rData1[$aMyFields1[Column]], -2)
  Else
    GridView2.Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Private Function GetBillingSSFItemAbbvName(itemName As String) As String

  Dim asx As String[]
  Dim xxx As String

  asx = Split(itemName, "|")
  If asx.Count Then
    Select asx[0]
      Case "Diagnostic Tests", "Radio Diagnostics", "General Services", "Procedures", "Equipment"
        xxx = modNonMedical.GetBillItemHIAbbv(asx[1], asx[0])
      Case Else
        xxx = "ADJ02"
    End Select
  Else
    xxx = ""
  Endif
  Return xxx

End

''====================== IMAGES ======================
Private Function GetInvoiceReceiptData(sInvoiceList As String[]) As String[]

  Dim xPath As String[]
  Dim xinvoice As String

  xPath = New String[]
  For Each xinvoice In sInvoiceList
    If xinvoice Like "CAS" & "*" Then
      xPath.Add(GetInvoiceData(xinvoice))
    Else If xinvoice Like "CRE" & "*" Then
      xPath.Add(GetInvoiceData(xinvoice))
    Else If xinvoice Like "PHM" & "*" Then
      xPath.Add(GetInvoiceData(xinvoice))
    Else If xinvoice Like "RET" & "*" Then
      xPath.Add(GetInvoiceData(xinvoice))

    Else If xinvoice Like "TMP" & "*" Then
      xPath.Add(GetReceiptData(xinvoice))
    Else If xinvoice Like "TRE" & "*" Then
      xPath.Add(GetReceiptData(xinvoice))
    Else If xinvoice Like "TPM" & "*" Then
      xPath.Add(GetReceiptData(xinvoice))
    Else If xinvoice Like "TPR" & "*" Then
      xPath.Add(GetReceiptData(xinvoice))
    Endif
  Next

  Return xPath

End

Private Function GetInvoiceData(sBillNo As String) As String

  Dim res As Result
  Dim xPath As String
  Dim ShowTax As Boolean
  Dim ShowDisc As Boolean

  res = modDatabase.$myConn.Exec("select fldbillno,fldencounterval,fldtaxamt,flddiscountamt,fldchequeno from " & $tblpatbilldetail & " where fldbillno=&1 and fldchequeno=&2", sBillNo, Trim(txtinvoice.Text))
  If res.Available Then
    If res["fldtaxamt"] = 0 Then
      ShowTax = False
    Else
      ShowTax = True
    Endif
    If res["flddiscountamt"] = 0 Then
      ShowDisc = False
    Else
      ShowDisc = True
    Endif

    xPath = modBILLFormat.GetInvoiceCopyPDFPath(res["fldbillno"], ShowTax, ShowDisc)
  Endif

  Return xPath

End

Private Function GetReceiptData(sBillNo As String) As String

  Dim res As Result
  Dim xPath As String

  res = modDatabase.$myConn.Exec("select fldbillno,fldencounterval,fldtaxamt,flddiscountamt,fldchequeno from " & $tbltempbilldetail & " where fldbillno=&1 and fldchequeno=&2", sBillNo, Trim(txtinvoice.Text))
  If res.Available Then
    xPath = modBILLFormat.GetReceiptCopyPDFPath(res["fldbillno"])
  Endif

  Return xPath

End

Public Sub btnupload_Click()

  Dim xxx As String[]
  Dim xPath As String
  Dim hForm As BipannaDocumAPI
  Dim xout As String
  Dim sColl As Collection

  If GridView1.Rows.Selection.Count Then
    If txtssucode.Text And If txtdiseaseid.Text Then
      xxx = AddReports(GridView1[GridView1.Row, 2].Text, True)
      If xxx And If xxx.Count Then

        If xxx.Count > 1 Then
          xPath = modDevAll.GetPDFUnion(xxx)
        Else
          xPath = xxx[0]
        Endif

        If Exist(xPath) Then
          hForm = New BipannaDocumAPI(txtssucode.Text, CInt(txtdiseaseid.Text), GridView1[GridView1.Row, 8].Text, xPath)
          xout = hForm.GetUploadAPI()
          If xout Then
            Try sColl = JSON.Decode(xout)
            If sColl And If sColl["success"] = True Then
            Else
              Message.Info(xout)
            Endif
          Endif
        Endif

      Endif
    Endif
  Endif

End

''===================== Bipanna ===============
Public Sub btnclaimweb_Click()

End

Public Sub btnclaimlink_Click()

End

Public Sub btngridclaim_Click()

  Dim hForm1 As BipannaTreatAPI
  Dim hForm2 As BippannaBillingAPI
  Dim xout As String
  Dim sColl As Collection

  If txtinvoice.Text And If txttotal.Value > 0 Then
    If txtssucode.Text And If txtdiseaseid.Text Then
      Select cmbbippatask.Text
        Case "Treatment", "Kidney Session"
          If chkeditamt.Value = True Then
            hForm1 = New BipannaTreatAPI(cmbbippatask.Text, txtssucode.Text, CInt(txtdiseaseid.Text), txtcategcode.Value, txtinvoice.Text, txttotal.Value)
          Else
            hForm1 = New BipannaTreatAPI(cmbbippatask.Text, txtssucode.Text, CInt(txtdiseaseid.Text), txtcategcode.Value, txtinvoice.Text)
          Endif
          xout = hForm1.GetUploadAPI()
        Case "Billing"
          hForm2 = New BippannaBillingAPI(txtssucode.Text, CInt(txtdiseaseid.Text), txtinvoice.Text)
          xout = hForm2.GetUploadAPI()
      End Select

      If xout Then
        Try sColl = JSON.Decode(xout)
        If sColl And If sColl["success"] = True Then
          modAccount.InsertClaimInvoice(txtinvoice.Text)
        Else
          Message.Info(xout)
        Endif
      Endif

    Endif
  Endif

End

Private Sub ClearSubInputs()

  txtgridencid.Text = ""
  txtssucode.Text = ""
  txtinvoice.Text = ""
  cmbbippatask.Text = ""
  cmbbippcategory.Text = ""
  txtdiseaseid.Text = ""

End

Public Sub mnuinvupload_Click()

  Dim Row As Integer
  Dim res As Result
  Dim hForm2 As BippannaBillingAPI
  Dim xout As String
  Dim sColl As Collection

  For Row = 0 To GridView1.Rows.Count - 1
    ClearSubInputs()
    sColl = New Collection

    txtgridencid.Text = GridView1[Row, 2].Text
    res = modDatabase.$myConn.Exec("select fldserviceid,fldidentify from tblsociallist where fldpatientval=&1", modPatient.GetPatientNoByEnc(GridView1[Row, 2].Text))
    If res.Available And If res.Count = 1 Then
      txtssucode.Text = res["fldserviceid"]
      txtdiseaseid.Text = res["fldidentify"]
    Endif
    txtinvoice.Text = GridView1[Row, 0].Text
    txtaccount.Text = GridView1[Row, 1].Text

    If txtinvoice.Text Then
      If txtssucode.Text And If txtdiseaseid.Text Then
        hForm2 = New BippannaBillingAPI(txtssucode.Text, CInt(txtdiseaseid.Text), txtinvoice.Text)
        xout = hForm2.GetUploadAPI()

        If xout Then
          Try sColl = JSON.Decode(xout)
          If sColl And If sColl["success"] = True Then
            modAccount.InsertClaimInvoice(txtinvoice.Text)
          Else
            Message.Info(xout)
          Endif
        Endif
      Endif
    Endif
    Wait

  Next

End
