' Gambas class file

Private $DataList As Variant[]
Private $DataJson As Variant[]
Private $sType As String

Public Sub _new(sType As String)

  $sType = sType

End

Public Sub Form_Open()

  Dim xval As String

  Me.Center
  dtsel.Value = Now()

  Inc Application.Busy
  modRepository.ReadRepoConfig()
  If $sType = "Referrals" Then
    xval = modRepository.GetRepositoryJson("tblencounter", "fldreferto", modBasic.$HospCode)
  Else If $sType = "Bookings" Then
    xval = modRepository.GetRepositoryJsonMulti("tblonlinebook", ["fldhospital", "fldconsultdate"], [modBasic.$HospCode, Date()])
  Endif
  $DataJson = JSON.Decode(xval)
  Dec Application.Busy

End

Public Sub btnrefresh_Click()

  GridView1.Clear()
  If $sType = "Referrals" Then
    If chkdate.Value = True Then
      $DataList = modString.SelectVarJSONToDate($DataJson, "fldfollowdate", dtsel.Value)
    Else
      $DataList = $DataJson
    Endif
    GridView1.Rows.Count = $DataList.Count
    GridView1.Columns.Count = 3
    With GridView1
      .Rows.Height = modBasic.$AppGridRowHeight
      .Columns[0].Width = 150 * modBasic.$AppWidthRatio
      .Columns[1].Width = 150 * modBasic.$AppWidthRatio
      .Columns[2].Width = 225 * modBasic.$AppWidthRatio
      .Columns[0].Text = "Date"
      .Columns[1].Text = "PatientNo"
      .Columns[2].Text = "Name"
    End With

  Else If $sType = "Bookings" Then
    $DataList = $DataJson
    GridView1.Rows.Count = $DataList.Count
    GridView1.Columns.Count = 30
  Endif

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  If $sType = "Referrals" Then
    If Column = 0 Then
      GridView1.Data.Text = $DataList[Row]["fldfollowdate"]
    Else If Column = 1 Then
      GridView1.Data.Text = $DataList[Row]["fldpatientval"]
    Else If Column = 2 Then
      GridView1.Data.Text = modPatient.PatientFullNameByPatID($DataList[Row]["fldpatientval"])
    Endif

  Else If $sType = "Bookings" Then
    GridView1.Data.Text = $DataList[Row][Column]
  Endif

End

Public Sub btnimport_Click()

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    If $sType = "Referrals" Then
      modRepository.CopyPatInfoFromRepository(GridView1[GridView1.Row, 1].Text)
    Endif
    Dec Application.Busy
  Endif

End

Public Sub chkdate_Click()

  If chkdate.Value = True Then
    dtsel.Enabled = True
  Else If chkdate.Value = False Then
    dtsel.Enabled = False
  Endif

End

Public Sub Form_Close()

  MMain.InitialAppMode()

End
