' Gambas class file

Private $rData As Result
Private $aMyFields As String[]
Private $sType As String

Public Sub _new(sType As String)

  $sType = sType

End

Public Sub Form_Open()

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Vertical")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  Me.Title = $sType
  Me.Tag = $sType
  modBasic.$FixedDepartment = modGlobalSetting.ShowSettingFromDB("IPClinic/FixedDepartment")
  cmbregtype.List = ["Planned", "Paid", "Cancelled", "Done"]
  lbldate.Value = Date()
  If $sType = "Booking List" Then
    cmbselect.List = modGeneral.RegistrationDeptList()
  Else If $sType = "Registration List" Then
    cmbselect.List = modGeneral.GetDepartForConsultOnly()
  Endif
  cmbselect.Add("%")
  cmbbillmode.List = modBasic.$BillBillingMode
  cmbbillmode.Add("%")
  cmbregtype.Text = "Planned"
  cmbvisitype.List = ["NEW", "OLD", "%"]
  cmbvisitype.Text = "%"
  cmbilled.List = ["Billed", "%"]
  cmbilled.Text = "%"
  cmbcomp.List = modBasic.$AllCompList
  cmbcomp.Text = modBasic.$compID

  If $sType = "Registration List" Then
    lblvisit.Visible = True
    cmbvisitype.Visible = True
    lblbill.Visible = True
    cmbilled.Visible = True
    mnufollow.Visible = True
    Panel2.Visible = True
    If modBasic.$BulkConsulInput = "Enable" Then
      pnlBulk.Visible = True
    Endif
  Endif

  dtfir.Value = Now()
  dtlast.Value = Now()
  cmbselect.Text = "%"
  cmbbillmode.Text = "%"

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub btnconsult_Click()

  Dim xList As Variant[]
  Dim xMedUser As String[]

  If modBasic.$LockConsultant = "LockByQuota" Then
    xList = modConsult.GetUserPostingList(cmbselect.Text, lbldate.Value, cmbbillmode.Text)
  Else
    xList = modBasic.$OPConsulUserList
  Endif
  xMedUser = MedicalSelectedValue(("Select Consultant"), xList)
  If xMedUser And If xMedUser.Count Then
    btnconsult.Tag = xMedUser[0]
    btnconsult.Text = xMedUser[1]
  Else
    btnconsult.Tag = ""
    btnconsult.Text = ""
  Endif

End

Private Function GetTableFIelds() As String[]

  Dim xFldList As String[]

  If $sType = "Registration List" Then
    xFldList = ["fldencounterval", "fldconsulttime", "fldconsulttime", "fldconsultname", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldid", "fldconsulttime", "fldid", "flduserid", "fldcomment", "fldbillingmode", "fldencounterval", "flduserid", "fldencounterval", "fldstatus"]
  Else If $sType = "Booking List" Then
    xFldList = ["fldbookingval", "fldconsultdate", "fldconsultdate", "fldadmitlocat", "fldbookingval", "fldbookingval", "fldptsex", "fldptcontact", "fldbookingval", "fldconsultdate", "fldbookingval", "flduserid", "fldcomment", "fldbillingmode", "fldpatientval", "flduserid", "fldemail", "fldstate"]
  Endif

  Return xFldList

End

Private Sub FillPatDateGrid()

  Dim sql As String
  Dim xFldList As String[]

  xFldList = GetTableFIelds()
  If $sType = "Registration List" Then
    If cmbilled.Text = "Billed" Then
      If cmbvisitype.Text = "%" Or If cmbvisitype.Text = "" Then
        If btnconsult.Tag Then
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and flduserid like &5 and fldbillingmode like &6 and fldencounterval in(select fldencounterval from tblpatbilling where flditemtype=&7 and fldsave=&8) and fldcomp=&9 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, btnconsult.Tag, cmbbillmode.Text, "General Services", True, cmbcomp.Text)
        Else
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblpatbilling where flditemtype=&6 and fldsave=&7) and fldcomp=&8 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, cmbbillmode.Text, "General Services", True, cmbcomp.Text)
        Endif
      Else
        If btnconsult.Tag Then
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and flduserid like &5 and fldbillingmode like &6 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &7) and fldencounterval in(select fldencounterval from tblpatbilling where flditemtype=&8 and fldsave=&9) and fldcomp=&{10} ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, btnconsult.Tag, cmbbillmode.Text, cmbvisitype.Text, "General Services", True, cmbcomp.Text)
        Else
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and fldencounterval in(select fldencounterval from tblpatbilling where flditemtype=&7 and fldsave=&8) and fldcomp=&9 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, cmbbillmode.Text, cmbvisitype.Text, "General Services", True, cmbcomp.Text)
        Endif
      Endif

    Else
      If cmbvisitype.Text = "%" Or If cmbvisitype.Text = "" Then
        If btnconsult.Tag Then
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and flduserid like &5 and fldbillingmode like &6 and fldcomp=&7 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, btnconsult.Tag, cmbbillmode.Text, cmbcomp.Text)
        Else
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and fldbillingmode like &5 and fldcomp=&6 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, cmbbillmode.Text, cmbcomp.Text)
        Endif
      Else
        If btnconsult.Tag Then
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and flduserid like &5 and fldbillingmode like &6 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &7) and fldcomp=&8 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, btnconsult.Tag, cmbbillmode.Text, cmbvisitype.Text, cmbcomp.Text)
        Else
          sql = "select " & xFldList.Join(",") & " from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus=&4 and fldbillingmode like &5 and fldencounterval in(select fldencounterval from tblencounter where fldvisit like &6) and fldcomp=&7 ORDER BY fldconsulttime"                                                                              ''
          $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, cmbbillmode.Text, cmbvisitype.Text, cmbcomp.Text)
        Endif
      Endif

    Endif

  Else If $sType = "Booking List" Then
    If btnconsult.Text Then
      sql = "select " & xFldList.Join(",") & " from tblpatientbook where fldconsultdate>=&1 and fldconsultdate<=&2 and fldadmitlocat like &3 and flduserid like &4 and fldstate=&5 and fldbillingmode like &6 and fldcomp=&7 ORDER BY fldconsultdate"                                                                              ''
      $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, btnconsult.Tag, cmbregtype.Text, cmbbillmode.Text, cmbcomp.Text)
    Else
      sql = "select " & xFldList.Join(",") & " from tblpatientbook where fldconsultdate>=&1 and fldconsultdate<=&2 and fldadmitlocat like &3 and fldstate=&4 and fldbillingmode like &5 and fldcomp=&6 ORDER BY fldconsultdate"                                                                              ''
      $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(lbldate.Value), modDate.EndSqlDate(lbldate.Value), cmbselect.Text, cmbregtype.Text, cmbbillmode.Text, cmbcomp.Text)
    Endif

  Endif

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  RezizeGrid()

End

Private Sub RezizeGrid()

  With GridView1
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = 100 * modBasic.$AppWidthRatio
    .Columns[2].Width = 75 * modBasic.$AppWidthRatio
    .Columns[3].Width = 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 125 * modBasic.$AppWidthRatio
    .Columns[5].Width = 175 * modBasic.$AppWidthRatio
    .Columns[6].Width = 125 * modBasic.$AppWidthRatio
    .Columns[7].Width = 125 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 1
    .Columns[10].Width = 1
    .Columns[11].Width = 150 * modBasic.$AppWidthRatio
    .Columns[12].Width = 150 * modBasic.$AppWidthRatio
    .Columns[13].Width = 1
    .Columns[14].Width = 100 * modBasic.$AppWidthRatio
    .Columns[15].Width = 1
    .Columns[16].Width = 1
    .Columns[17].Width = 75 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Date"
    .Columns[2].Text = "Time"
    .Columns[3].Text = "Department"
    If $sType = "Registration List" Then
      .Columns[4].Text = "EncID"
    Else If $sType = "Booking List" Then
      .Columns[4].Text = "BookID"
    Endif
    .Columns[5].Text = "Name"
    .Columns[6].Text = "Age/Sex"
    .Columns[7].Text = "Contact"
    .Columns[11].Text = "Consultant"
    .Columns[12].Text = "Comment"
    .Columns[14].Text = "FileNo"
    .Columns[17].Text = "Status"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 0 Then
    GridView1.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 1 Then
    GridView1.Data.Text = modReportVar.GetDateTimeReport($rData[$aMyFields[Column]], gb.MediumDate)
  Else If Column = 2 Then
    GridView1.Data.Text = Format($rData[$aMyFields[Column]], gb.ShortTime)

  Else If Column = 5 Then
    If $sType = "Registration List" Then
      GridView1.Data.Text = modPatient.GetPatientNameByEnc($rData[$aMyFields[Column]])
    Else If $sType = "Booking List" Then
      GridView1.Data.Text = modPatient.GetPatFullNameBooking($rData[$aMyFields[Column]])
    Endif

  Else If Column = 6 Then
    If $sType = "Registration List" Then
      GridView1.Data.Text = modPatient.GetPatientAgeString($rData[$aMyFields[Column]], Now()) & "/" & modPatient.GetPatientSex($rData[$aMyFields[Column]])
    Else If $sType = "Booking List" Then
      GridView1.Data.Text = $rData[$aMyFields[Column]]
    Endif

  Else If Column = 7 Then
    If $sType = "Registration List" Then
      GridView1.Data.Text = modPatient.GetPatientContactByEnc($rData[$aMyFields[Column]])
    Else If $sType = "Booking List" Then
      GridView1.Data.Text = $rData[$aMyFields[Column]]
    Endif

  Else If Column = 11 Then
    GridView1.Data.Text = modGeneral.GetUserFullName($rData[$aMyFields[Column]])

  Else If Column = 14 Then
    If $sType = "Registration List" Then
      GridView1.Data.Text = modPatient.GetPatientFileByEnc($rData[$aMyFields[Column]])
    Else If $sType = "Booking List" Then
      GridView1.Data.Text = modPatient.GetPatientFileByPatNo($rData[$aMyFields[Column]])
    Endif

  Else
    GridView1.Data.Text = $rData[$aMyFields[Column]]
  Endif
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

Public Sub GridView1_Menu()

  mnuhide.Popup

End

Public Sub mnuedit_Click()

  Dim hForm1 As FmEditConsult
  Dim row As Integer
  Dim col As Integer
  Dim xx As Variant[]

  If GridView1.Rows.Selection.Count Then
    row = GridView1.Row
    col = GridView1.Column

    xx = New Variant[]
    xx.Add(GridView1[GridView1.Row, 8].Text)
    If $sType = "Registration List" Then
      hForm1 = New FmEditConsult(xx, "tblconsult")
    Else If $sType = "Booking List" Then
      hForm1 = New FmEditConsult(xx, "tblpatientbook")
    Endif
    hForm1.ShowModal
    FillPatDateGrid()

    GridView1.Row = row
    GridView1.Column = col
  Endif

End

Public Sub mnueditall_Click()

  Dim hForm1 As FmEditConsult
  Dim i As Integer
  Dim xx As Variant[]

  xx = New Variant[]
  For i = 0 To GridView1.Rows.Count - 1
    If GridView1[i, 0].Picture = Picture["icons/checked.png"] Then
      xx.Add(GridView1[i, 8].Text)
    Endif
  Next

  If xx.Count Then
    If $sType = "Registration List" Then
      hForm1 = New FmEditConsult(xx, "tblconsult")
    Else If $sType = "Booking List" Then
      hForm1 = New FmEditConsult(xx, "tblpatientbook")
    Endif
    hForm1.ShowModal
  Endif
  FillPatDateGrid()

End

Public Sub mnufollow_Click()

  Dim res As Result
  Dim dt As Date
  Dim row As Integer
  Dim col As Integer

  If GridView1.Rows.Selection.Count Then
    row = GridView1.Row
    col = GridView1.Column
    dt = CTimeConsult("Follow Up", modPatient.GetFollowUpDate(GridView1[GridView1.Row, 4].Text))
    If dt Then
      res = modDatabase.$myConn.Edit("tblencounter", "fldencounterval=&1", GridView1[GridView1.Row, 4].Text)
      res["fldfollowdate"] = dt
      res["xyz"] = False
      res.Update
    Endif
    GridView1.Row = row
    GridView1.Column = col
  Endif

End

Public Sub GridView1_Click()

  If GridView1.Column = 0 Then
    modGridView.CheckUncheckGridNoDB(GridView1, 0)
  Endif

End

''-----------------------------  button and menu ------------------------------------------------
Public Sub btnrefresh_Click()

  FillPatDateGrid()
  GridView1.SetFocus

End

Public Sub btnnew_Click()

  Dim hForm As FmNewConsult

  If $sType = "Registration List" Then
    hForm = New FmNewConsult(txtencid.Text)
    hForm.ShowModal
  Else If $sType = "Booking List" Then
    txtencid.Text = BookingForm()
  Endif
  FillPatDateGrid()
  txtencid.Text = ""

End

Public Sub btnexport_Click()

  modCHTMLReport.ExportGridToHTML(GridView1, $sType, modReportVar.GetDateTimeReport(lbldate.Value, gb.MediumDate))

End

Public Sub mnuselall_Click()

  Dim i As Integer

  For i = 0 To GridView1.Rows.Count - 1
    GridView1[i, 0].Picture = Picture["icons/checked.png"]
  Next

End

Public Sub mnudesel_Click()

  Dim i As Integer

  For i = 0 To GridView1.Rows.Count - 1
    GridView1[i, 0].Picture = Picture["icons/unchecked.png"]
  Next

End

Public Sub btnsearch_Click()

  Dim xx As String

  If $sType = "Registration List" Then
    If modBasic.$AutoEncPrefix Then
      xx = InputBox(("Enter Encounter ID"), $sType, modBasic.$EncIdPrefix)
    Else
      xx = InputBox(("Enter Encounter ID"), $sType, "")
    Endif
  Else If $sType = "Booking List" Then
    xx = InputBox(("Enter Booking ID"), $sType, "")
  Endif
  If xx Then
    SearchData(xx)
    GridView1.SetFocus
  Endif

End

Private Sub SearchData(encid As String)

  Dim sql As String
  Dim xFldList As String[]

  xFldList = GetTableFIelds()
  If $sType = "Registration List" Then
    If btnconsult.Tag Then
      sql = "select " & xFldList.Join(",") & " from tblconsult where fldencounterval=&1"                                                                              ''
      $rData = modDatabase.$myConn.Exec(sql, encid)
    Else
      sql = "select " & xFldList.Join(",") & " from tblconsult where fldencounterval=&1"                                                                              ''
      $rData = modDatabase.$myConn.Exec(sql, encid)
    Endif

  Else If $sType = "Booking List" Then
    If btnconsult.Text Then
      sql = "select " & xFldList.Join(",") & " from tblpatientbook where fldbookingval=&1"                                                                              ''
      $rData = modDatabase.$myConn.Exec(sql, encid)
    Else
      sql = "select " & xFldList.Join(",") & " from tblpatientbook where fldbookingval=&1"                                                                              ''
      $rData = modDatabase.$myConn.Exec(sql, encid)
    Endif

  Endif

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  RezizeGrid()

End

Public Sub Form_KeyRelease()

  If Key.Code = Key["R"] And If Key.Control Then
    btnrefresh_Click()
  Else If Key.Code = Key.F1 Then
    btnnew_Click()
  Endif

End

Public Sub btnrepo_Click()

  Dim xPath As String

  Inc Application.Busy
  xPath = modGENReport.ShowConsultQuota(lbldate.Value, cmbselect.Text, cmbbillmode.Text, cmbcomp.Text, btnconsult.Tag)
  Dec Application.Busy
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub dtnepfir_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(lbldate.Value))
  If xx Then
    lbldate.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btntemplprint_Click()

  Dim i As Integer

  For i = 0 To GridView1.Rows.Count - 1
    If GridView1[i, 0].Picture = Picture["icons/checked.png"] Then
      modPatientSub.PrintRegistExtraReport(GridView1[i, 4].Text)
      If chkmarkdone.Value = True Then
        modPatientSub.UpdateConsultData(GridView1[i, 8].Text, "Done", "", "")
      Endif
    Endif
  Next
  FillPatDateGrid()

End

Public Sub cmbbillmode_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbbillmode)
  modFillContainer.RestrictComboToContent(cmbbillmode)

End

Public Sub cmbselect_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbselect)
  modFillContainer.RestrictComboToContent(cmbselect)

End

Public Sub btnconsult_Change()

  If btnconsult.Text = "" Then
    btnconsult.Tag = ""
  Endif

End

Public Sub btnconsult_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    If btnconsult.Tag Then
    Else
      btnconsult_Click()
    Endif
  Endif

End

Public Sub dtnep1_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtfir.Value))
  If xx Then
    dtfir.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub dtnep2_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlast.Value))
  If xx Then
    dtlast.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnsumregd_Click()

  Dim xPath As String

  If $sType = "Registration List" Then
    Inc Application.Busy
    xPath = modCHTMLPatSummary.ShowRegisterConsultantwiseReport(dtfir.Value, dtlast.Value, cmbselect.Text, cmbbillmode.Text, cmbilled.Text, cmbcomp.Text)
    Dec Application.Busy
  Else If $sType = "Booking List" Then
  Endif
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub btnsumregconsult_Click()

  Dim xPath As String

  If $sType = "Registration List" Then
    Inc Application.Busy
    xPath = modCHTMLPatSummary.ShowRegisterConsultDeptReport(dtfir.Value, dtlast.Value, cmbselect.Text, cmbbillmode.Text, cmbilled.Text, cmbcomp.Text)
    Dec Application.Busy
  Else If $sType = "Booking List" Then
  Endif
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub btnreporegd_Click()

  Dim xPath As String

  If $sType = "Registration List" Then
    Inc Application.Busy
    xPath = modCHTMLPatSummary.ShowRegisterConsultReport(dtfir.Value, dtlast.Value, cmbselect.Text, cmbbillmode.Text, cmbilled.Text, cmbregtype.Text, cmbcomp.Text, btnconsult.Tag)
    Dec Application.Busy
  Else If $sType = "Booking List" Then
    Inc Application.Busy
    xPath = modCHTMLPatSummary.ShowBookingReport(dtfir.Value, dtlast.Value, cmbselect.Text, cmbbillmode.Text, cmbregtype.Text, cmbcomp.Text, btnconsult.Tag)
    Dec Application.Busy
  Endif
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

Public Sub btndocreport_Click()

  Dim xPath As String

  If lbldate.Value And If cmbbillmode.Text And If btnconsult.Tag Then
    Inc Application.Busy
    xPath = modGENReport.ShowDocwiseConsultReport(lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''----------------------------------- extra activities -------------------------------------------------
Public Sub btnsmstotal_Click()

  Dim sText As String
  Dim sphno As String

  If btnconsult.Tag Then
    sphno = modGeneral.GetUserContact(btnconsult.Tag)
  Endif

  If sphno Then
    sText = "Date: " & modReportVar.GetDateTimeReport(lbldate.Value, gb.MediumDate) & " Total Patients: " & CStr(GridView1.Rows.Count)
    If sText Then
      If modBasic.$SMSQueDisable = "No" Then
        modAppSupport.SaveSMSEntry(sphno, sText, "Waiting", "")
      Else
        modAppSupport.SendSMSSingle(sphno, sText)
      Endif
    Endif
  Endif

End

Public Sub mnuinfolabel_Click()

  Dim $hReport As CRegistLabel

  If GridView1.Rows.Selection.Count > 0 Then
    If modNonMedical.AllowRegistSlipWithInvoiceEncid(GridView1[GridView1.Row, 4].Text) = True Then
      $hReport = New CRegistLabel(GridView1[GridView1.Row, 4].Text)
      modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 4].Text, $hReport.RegistLabelPath(), "LabelSize")
    Endif
  Endif

End

Public Sub mnuemail_Click()

  Dim i As Integer
  Dim xx As String[]
  Dim hForm As FmRemoteMail

  If Desktop.NetworkAvailable = True Then
    xx = New String[]
    For i = 0 To GridView1.Rows.Count - 1
      If GridView1[i, 0].Picture = Picture["icons/checked.png"] Then
        If $sType = "Registration List" Then
          xx.Add(modPatient.GetPatientEmail(GridView1[i, 4].Text))
        Else If $sType = "Booking List" Then
          xx.Add(GridView1[i, 16].Text)
        Endif
      Endif
    Next
    hForm = New FmRemoteMail(xx, "", $sType, "")
    hForm.ShowModal
  Endif

End

Public Sub mnusmspat_Click()

  Dim i As Integer
  Dim sText As String
  Dim sphno As String

  For i = 0 To GridView1.Rows.Count - 1
    If GridView1[i, 0].Picture = Picture["icons/checked.png"] Then
      If $sType = "Registration List" Then
        sphno = modPatient.GetPatientContactByEnc(GridView1[i, 4].Text)
      Else If $sType = "Booking List" Then
        sphno = GridView1[i, 7].Text
      Endif
      If sphno Then
        sText = modSettings.ShowSettingFromFIle("Registration/PatientMessage")
        If sText Then
          If $sType = "Registration List" Then
            sText = modReportVar.GetPatientSMSVAr(GridView1[i, 4].Text, sText)
            sText = modReportVar.GetReportLastConsult(GridView1[i, 4].Text, sText)
          Else If $sType = "Booking List" Then
            sText = GetReportVarBooking(GridView1[i, 4].Text, sText)
          Endif
          If modBasic.$SMSQueDisable = "No" Then
            modAppSupport.SaveSMSEntry(sphno, sText, "Waiting", "")
          Else
            modAppSupport.SendSMSSingle(sphno, sText)
          Endif
        Endif
      Endif

      GridView1[i, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub mnusmsphy_Click()

  Dim i As Integer
  Dim sText As String
  Dim sphno As String

  For i = 0 To GridView1.Rows.Count - 1
    If GridView1[i, 0].Picture = Picture["icons/checked.png"] Then
      sphno = modGeneral.GetUserContact(GridView1[i, 15].Text)
      If sphno Then
        sText = modSettings.ShowSettingFromFIle("Registration/PhysicianMessage")
        If sText Then
          If $sType = "Registration List" Then
            sText = modReportVar.GetDoctorSMSVAr(GridView1[i, 4].Text, sText)
            sText = modReportVar.GetReportLastConsult(GridView1[i, 4].Text, sText)
          Else If $sType = "Booking List" Then
            sText = GetReportVarBooking(GridView1[i, 4].Text, sText)
          Endif
          If modBasic.$SMSQueDisable = "No" Then
            modAppSupport.SaveSMSEntry(sphno, sText, "Waiting", "")
          Else
            modAppSupport.SendSMSSingle(sphno, sText)
          Endif
        Endif
      Endif

      GridView1[i, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub btnquotasum_Click()

  Dim bokdone As Integer
  Dim bokplan As Integer
  Dim bokcan As Integer
  Dim quota As Integer
  Dim regd As Integer
  Dim regcan As Integer
  Dim xx As String

  If cmbselect.Text And If lbldate.Value And If cmbbillmode.Text Then
    bokplan = modConsult.GetPatientBooked("Planned", cmbselect.Text, lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    bokdone = modConsult.GetPatientBooked("Done", cmbselect.Text, lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    bokcan = modConsult.GetPatientBooked("Cancelled", cmbselect.Text, lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    quota = modConsult.GetPatientQuota(cmbselect.Text, lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    regd = modConsult.GetPatientRegisteredValid(cmbselect.Text, lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    regcan = modConsult.GetPatientRegisteredCancel(cmbselect.Text, lbldate.Value, cmbbillmode.Text, btnconsult.Tag)
    xx = "<b>" & "Quota Allowed: " & "</b>" & CStr(quota) & "<br>"
    xx = xx & "<b>" & "Booked Waiting: " & "</b>" & CStr(bokplan) & "<br>"
    xx = xx & "<b>" & "Booked Registered: " & "</b>" & CStr(bokdone) & "<br>"
    xx = xx & "<b>" & "Booked Cancelled: " & "</b>" & CStr(bokcan) & "<br>"
    xx = xx & "<b>" & "Registered Valid: " & "</b>" & CStr(regd) & "<br>"
    xx = xx & "<b>" & "Registered Cancelled: " & "</b>" & CStr(regcan)
    Message.Info(xx, ("OK"))
  Endif

End

Public Sub btntxtsearch_Click()

  Dim sql As String
  Dim xname As String[]
  Dim xFldList As String[]

  xFldList = GetTableFIelds()
  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  If xname Then
    If $sType = "Registration List" Then
      If btnconsult.Tag Then
        sql = "select " & xFldList.Join(",") & " from tblconsult where fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &1 and lower(fldptnamelast) like &2))"                                                                              ''
      Else
        sql = "select " & xFldList.Join(",") & " from tblconsult where fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &1 and lower(fldptnamelast) like &2))"                                                                              ''
      Endif
    Else If $sType = "Booking List" Then
      If btnconsult.Text Then
        sql = "select " & xFldList.Join(",") & " from tblpatientbook where lower(fldptnamefir) like &1 and lower(fldptnamelast) like &2"                                                                              ''
      Else
        sql = "select " & xFldList.Join(",") & " from tblpatientbook where lower(fldptnamefir) like &1 and lower(fldptnamelast) like &2"                                                                              ''
      Endif
    Endif
    $rData = modDatabase.$myConn.Exec(sql, LCase(xname[0]), LCase(xname[1]))

    $aMyFields = New String[]
    modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
    RezizeGrid()
  Endif

End

Private Function GetReportVarBooking(bookid As String, $Line As String) As String

  Dim res As Result

  res = modDatabase.$myConn.Exec("select fldpatientval,fldptnamefir,fldptnamelast,fldptsex,fldptaddvill,fldptaddward,fldptadddist,fldptcontact,fldptguardian,fldrelation,fldptbirday,fldptadmindate,fldemail,fldptcode,fldconsultdate,fldadmitlocat,flduserid,fldbillingmode,fldcomment from tblpatientbook where fldbookingval=&1", bookid)
  If res.Available Then
    If (String.InStr($Line, "BookingNo") > 0) Then                                   ''
      $Line = Replace($Line, "{BookingNo}", CStr(bookid))
    Endif
    If (String.InStr($Line, "PatientNo") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientNo}", res["fldpatientval"])
    Endif
    If (String.InStr($Line, "PatientCode") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientCode}", res["fldptcode"])
    Endif
    If (String.InStr($Line, "PatientName") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientName}", modPatient.GetPatFullNameBooking(bookid))
    Endif
    If (String.InStr($Line, "PatientAddress") > 0) Then
      If res["fldptaddward"] Then
        $Line = Replace($Line, "{PatientAddress}", res["fldptaddvill"] & "-" & res["fldptaddward"])
      Else
        $Line = Replace($Line, "{PatientAddress}", res["fldptaddvill"])
      Endif
    Endif
    If (String.InStr($Line, "PatientDistrict") > 0) Then
      $Line = Replace($Line, "{PatientDistrict}", res["fldptadddist"])
    Endif
    If (String.InStr($Line, "PatientGender") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientGender}", res["fldptsex"])
    Endif
    If (String.InStr($Line, "PatientGuardian") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientGuardian}", res["fldptguardian"])
    Endif
    If (String.InStr($Line, "PatientRelation") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientRelation}", res["fldrelation"])
    Endif
    If (String.InStr($Line, "E-Mail") > 0) Then                                   ''
      $Line = Replace($Line, "{E-Mail}", res["fldemail"])
    Endif
    If (String.InStr($Line, "ContactNo") > 0) Then                                   ''
      $Line = Replace($Line, "{ContactNo}", res["fldptcontact"])
    Endif
    If (String.InStr($Line, "PatientAge") > 0) Then
      $Line = Replace($Line, "{PatientAge}", modDate.GetAgeString(res["fldptbirday"], Now()))
    Endif
    If (String.InStr($Line, "Age/Sex") > 0) Then                                   ''
      $Line = Replace($Line, "{Age/Sex}", modDate.GetAgeString(res["fldptbirday"], Now()) & "/" & res["fldptsex"])
    Endif
    If (String.InStr($Line, "PatientDOB") > 0) Then                                   ''
      $Line = Replace($Line, "{PatientDOB}", modReportVar.GetDateTimeReport(res["fldptbirday"], gb.MediumDate))
    Endif

    If (String.InStr($Line, "LastConsultDept") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultDept}", res["fldadmitlocat"])
    Endif
    If (String.InStr($Line, "LastConsultRoom") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultRoom}", modGeneral.GetRoomNoFromDept(res["fldadmitlocat"]))
    Endif
    If (String.InStr($Line, "LastConsultComment") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultComment}", res["fldcomment"])
    Endif
    If (String.InStr($Line, "LastConsultant") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultant}", modGeneral.GetUserFullName(res["flduserid"]))
    Endif
    If (String.InStr($Line, "LastConsultBillMode") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultBillMode}", res["fldbillingmode"])
    Endif
    If (String.InStr($Line, "LastConsultDate") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultDate}", modReportVar.GetDateTimeReport(res["fldconsultdate"], gb.MediumDate))
    Endif
    If (String.InStr($Line, "LastConsultTime") > 0) Then                                   ''
      $Line = Replace($Line, "{LastConsultTime}", modReportVar.GetDateTimeReport(res["fldconsultdate"], gb.MediumTime))
    Endif
  Endif

  Return $Line

End

Public Sub mnuregistration_Click()

  If $sType = "Booking List" Then
    WalletBilling()
  Endif

End

Private Sub WalletBilling()

  Dim Row As Integer
  Dim res1 As Result
  Dim res2 As Result

  Dim res As Result
  Dim xpatno As String
  Dim encid As String
  Dim autobil As Boolean
  Dim idLock As Boolean

  Dim hForm As FmInvPrint
  Dim xtotamt As Float

  For Row = 0 To GridView1.Rows.Count - 1
    If GridView1[Row, 17].Text = "Paid" Then
      res1 = modDatabase.$myConn.Exec("select fldpatientval,fldptnamefir,fldptnamelast,fldptsex,fldptaddvill,fldptaddward,fldptadddist,fldptcontact,fldptguardian,fldrelation,fldptbirday,fldptadmindate,fldemail,fldptcode,fldconsultdate,fldadmitlocat,flduserid,fldcomp,fldstate,flddisctype,fldbillingmode,fldorduserid,fldpayreference,fldcomment,fldremotemail from tblpatientbook where fldbookingval=&1", GridView1[Row, 4].Text)
      If res1.Available Then
        res2 = modDatabase.$myConn.Exec("select fldvendor,fldvendormode,fldstate,fldtransid,fldtransamt,fldtranstoken,fldfeeamt,fldrefund,fldtransdate,fldpayerid,fldpayername,fldpayermobile,fldpayeremail,flduserid,fldtime from tblwebpayment where fldbillno=&1 and fldencounterval=&2 and flditemid=&3", res1["fldpayreference"], GridView1[Row, 4].Text, "Booking")
        xpatno = ""
        encid = ""
        xtotamt = 0

        xtotamt = modBillings.GetAutoRegistCost(res1["fldadmitlocat"], res1["flddisctype"], res1["fldbillingmode"], "New")
        If xtotamt = res2["fldtransamt"] Then
          Inc Application.Busy
          ''Registration
          idLock = modBillLock.LockTableForID("Registration")
          If idLock = True Then
            modDatabase.$myConn.Begin

            ''patient demographics
            If res1["fldpatientval"] Then
              xpatno = res1["fldpatientval"]
            Else
              xpatno = modBillLock.PatientNoValue()
              If xpatno Then
                res = modDatabase.$myConn.Create("tblpatientinfo")
                res["fldpatientval"] = xpatno
                res["fldptnamefir"] = modPassword.EncryptPatData(res1["fldptnamefir"])
                res["fldptnamelast"] = modPassword.EncryptPatData(res1["fldptnamelast"])
                res["fldethniccode"] = ""
                res["fldptcontact"] = modPassword.EncryptPatData(res1["fldptcontact"])
                res["fldemail"] = modPassword.EncryptPatData(res1["fldemail"])
                res["fldptaddvill"] = res1["fldptaddvill"]
                res["fldptaddward"] = res1["fldptaddward"]
                res["fldptadddist"] = res1["fldptadddist"]
                res["fldptsex"] = res1["fldptsex"]
                res["fldptguardian"] = res1["fldptguardian"]
                res["fldrelation"] = res1["fldrelation"]
                res["fldptbirday"] = res1["fldptbirday"]
                res["fldptadmindate"] = Now()
                res["flddiscount"] = ""
                res["fldptcode"] = res1["fldptcode"]
                res["fldadmitfile"] = ""
                res["fldcomment"] = ""
                res["fldencrypt"] = modBasic.$PatInfoEncrypt
                res["fldpassword"] = ""

                res["flduserid"] = modBasic.$lbluser
                res["fldtime"] = Now()
                res["fldupuser"] = ""
                res["flduptime"] = ""
                res["xyz"] = False
                res.Update()
              Endif
            Endif

            ''Encounter
            If xpatno Then
              encid = modBillLock.EncounterIDValue()
              If encid Then
                res = modDatabase.$myConn.Create("tblencounter")
                res["fldencounterval"] = encid
                res["fldpatientval"] = xpatno
                res["fldadmitlocat"] = res1["fldadmitlocat"]
                res["flddisctype"] = res1["flddisctype"]
                res["fldbillingmode"] = res1["fldbillingmode"]
                res["fldadmission"] = "Registered"
                res["fldregdate"] = Now()
                res["fldcomp"] = modBasic.$compID
                res["fldvisit"] = modPatient.GetPatientHMISStattus(xpatno)
                res["fldfollow"] = "New"

                res["fldcurrlocat"] = ""
                res["flddoa"] = ""
                res["flddod"] = ""
                res["fldheight"] = ""
                res["flduserid"] = res1["flduserid"]
                res["fldcashdeposit"] = 0
                res["fldcashcredit"] = 0
                res["fldcharity"] = 0
                res["fldvalidity"] = DateAdd(Now(), gb.Year, 1)
                res["fldfollowdate"] = ""
                res["fldreferto"] = ""

                res["fldregistid"] = modPatient.GetPatientHMISRegVal(xpatno)
                res["fldadmitid"] = ""
                res["xyz"] = False
                res.Update()
              Endif

              ''billing
              autobil = modBillings.InsertRegistrationBilling("Full", encid, res1["fldadmitlocat"], res1["flddisctype"], res1["fldbillingmode"], "New", res1["flduserid"])
              If modGeneral.GetCategoryFromDept(res1["fldadmitlocat"]) = "Consultation" Then
                modPatientSub.AddConsultData(encid, res1["fldadmitlocat"], res1["fldconsultdate"], res1["fldbillingmode"], "Paid Consultation", res1["flduserid"])
              Else
                modPatientSub.AddOPVisitData(encid, res1["fldadmitlocat"], res1["fldconsultdate"], res1["fldbillingmode"], "Paid Consultation")
              Endif

              ''update booking table
              If GridView1[Row, 4].Text Then
                modPatientSub.UpdateBookingTable(GridView1[Row, 4].Text, xpatno, encid)
                modPatientSub.UpdateRemoteUserNo(modPatient.GetPatRemoteMailBooking(GridView1[Row, 4].Text), xpatno)
              Endif

            Else
              modDatabase.$myConn.Rollback
            Endif 'check if patientno is present
            modDatabase.$myConn.Commit

            modBillLock.ReleaseLockTable("Registration")
          Endif
          Dec Application.Busy
          If encid Then
            hForm = New FmInvPrint(encid)
            hForm.ShowModal
          Endif
        Endif

      Endif
    Endif
  Next

End

''------------ JSON import -----------------
Public Sub txtimport_Click()

  If Dialog.OpenFile() Then Return
  txtimport.Text = Dialog.Path

End

Public Sub btnimport_Click()

  Dim xstr As String
  Dim xVar As Variant[]
  Dim aVar As Variant
  Dim sColl As Collection
  Dim xpatno As String
  Dim xbillmode As String
  Dim idLock As Boolean

  If $sType = "Registration List" Then
    If txtimport.Text And If Exist(txtimport.Text) Then
      xstr = File.Load(txtimport.Text)
      If xstr Then
        Try xVar = JSON.Decode(xstr)
        If xVar And If xVar.Count Then

          Inc Application.Busy
          For Each aVar In xVar
            sColl = New Collection
            sColl = aVar
            xbillmode = modNonMedical.GetDiscBindBillMode(sColl["flddisctype"])
            If xbillmode Then
              idLock = modBillLock.LockTableForID("Registration")
              If idLock = True Then

                modDatabase.$myConn.Begin
                If sColl["fldpatientval"] Then
                  If modPatient.SearchPatNo(sColl["fldpatientval"]) = False Then
                    xpatno = RegisterFirstTime(sColl)
                  Else
                    xpatno = sColl["fldpatientval"]
                  Endif
                Else
                  xpatno = RegisterFirstTime(sColl)
                Endif
                SaveRegistrationData(xpatno, sColl, xbillmode)
                modDatabase.$myConn.Commit

                modBillLock.ReleaseLockTable("Registration")
              Endif
            Endif
            sColl.Clear()
          Next
          Dec Application.Busy
          FillPatDateGrid()

        Endif
      Endif
    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  If idLock = True Then
    modBillLock.ReleaseLockTable("Registration")
  Endif
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

Private Function RegisterFirstTime(sColl As Collection) As String

  Dim res As Result
  Dim xpatno As String

  xpatno = modBillLock.PatientNoValue()
  If xpatno Then
    res = modDatabase.$myConn.Create("tblpatientinfo")
    res["fldpatientval"] = xpatno
    res["fldptnamefir"] = sColl["fldptnamefir"]
    res["fldptnamelast"] = sColl["fldptnamelast"]
    res["fldethniccode"] = sColl["fldethniccode"]
    res["fldptcontact"] = sColl["fldptcontact"]
    res["fldemail"] = sColl["fldemail"]
    res["fldptaddvill"] = sColl["fldptaddvill"]
    res["fldptaddward"] = sColl["fldptaddward"]
    res["fldptadddist"] = sColl["fldptadddist"]
    res["fldptsex"] = sColl["fldptsex"]
    res["fldptguardian"] = sColl["fldptguardian"]
    res["fldrelation"] = sColl["fldrelation"]
    res["fldptbirday"] = modDate.GetDateFromJSON(sColl["fldptbirday"])
    res["fldptadmindate"] = Now()
    res["flddiscount"] = ""
    res["fldptcode"] = sColl["fldptcode"]
    res["fldadmitfile"] = ""
    res["fldcomment"] = ""
    res["fldencrypt"] = False
    res["fldpassword"] = ""

    res["flduserid"] = modBasic.$lbluser
    res["fldtime"] = Now()
    res["fldupuser"] = ""
    res["flduptime"] = ""
    res["xyz"] = False
    res.Update()

    Return xpatno
  Endif

End

Private Sub SaveRegistrationData(sPatNo As String, sColl As Collection, sBillMode As String)

  Dim res As Result
  Dim xencounter As String
  Dim xvisit As String
  Dim xconsdate As Date

  If sPatNo Then
    xvisit = modPatient.GetPatientHMISStattus(sPatNo)
    xconsdate = modDate.GetDateFromJSON(sColl["fldconsulttime"])
    xencounter = modBillLock.EncounterIDValue()
    If xencounter Then
      res = modDatabase.$myConn.Create("tblencounter")
      res["fldencounterval"] = xencounter
      res["fldpatientval"] = sPatNo
      res["fldadmitlocat"] = sColl["fldconsultname"]
      res["flddisctype"] = sColl["flddisctype"]
      res["fldbillingmode"] = sBillMode
      res["fldadmission"] = "Registered"
      res["fldregdate"] = Now()
      res["fldcomp"] = modBasic.$compID
      res["fldvisit"] = xvisit
      res["fldfollow"] = sColl["fldfollow"]

      res["fldcurrlocat"] = ""
      res["flddoa"] = ""
      res["flddod"] = ""
      res["fldheight"] = ""
      res["flduserid"] = sColl["flddocid"]
      res["fldcashdeposit"] = 0
      res["fldcashcredit"] = 0
      res["fldcharity"] = 0
      res["fldvalidity"] = DateAdd(Now(), gb.Year, 1)
      res["fldfollowdate"] = ""
      res["fldreferto"] = ""

      res["fldregistid"] = modPatient.GetPatientHMISRegVal(sPatNo)
      res["fldadmitid"] = ""
      res["xyz"] = False
      res.Update()
    Endif
    modPatientSub.AddConsultData(xencounter, sColl["fldconsultname"], xconsdate, sBillMode, "Paid Consultation", sColl["flddocid"])
  Endif

End
