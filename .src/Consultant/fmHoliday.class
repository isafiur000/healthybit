' Gambas class file

Private $sComp As String

Public Sub _new(sComp As String)

  $sComp = sComp

End

Public Sub Form_Open()

  modGeneralMain.ArrangeFormCentre(Me)
  txtvariable.List = modGeneral.GetDepartForConsultOnly()
  txtvariable.Add("%")
  txtvariable.Text = "%"
  cmbmethod.List = ["AllParam", "Consult+Mode", "ConsultOnly", "DepartOnly"]
  cmbbillmode.List = modNonMedical.FillCashModeCombo()
  dtconsult.Value = Now()
  FillUserList()

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub dtnepfir_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtconsult.Value))
  If xx Then
    dtconsult.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Private Sub FillUserList()

  Dim pic1 As Picture
  Dim $rData As Result

  $rData = modDatabase.$myConn.Exec("select flduserid as col1,fldusername as col2 from tbluser where fldopconsult=&1", True)                                         ''
  If $rData.Available Then
    pic1 = Picture["icons/unchecked.png"]
    ListView1.Clear()
    For Each $rData
      ListView1.Add($rData!col1, $rData!col2, pic1)
    Next
  Endif

End

Public Sub ListView1_Click()

  modFillContainer.ShowCheckedListView(ListView1)

End

Public Sub btnset_Click()

  Dim res As Result
  Dim i As Integer

  i = 0
  ListView1.MoveFirst
  While i < (ListView1.Count - 1)
    If ListView1.Item.Picture = Picture["icons/checked.png"] Then
      res = modDatabase.$myConn.Create("tbldepconsult")
      res["flduserid"] = ListView1.Item.Key
      res["flddept"] = Trim(txtvariable.Text)
      res["fldbillingmode"] = cmbbillmode.Text
      res["fldmethod"] = cmbmethod.Text
      res["fldcomp"] = $sComp
      res["fldquota"] = -1
      res["fldselect"] = "Specific"
      res["flddate"] = dtconsult.Value
      res["fldreason"] = "Holiday"
      res["xyz"] = False
      res.Update()
    Endif
    i = i + 1
    ListView1.MoveNext
  Wend
  Balloon.Info(("Information saved"), btnset)
  Balloon.Delay = modBasic.$BalloonDelay

End

Public Sub chkall_Click()

  Dim xx As String

  ListView1.SelectAll()
  For Each xx In ListView1.Selection
    If chkall.Value = True Then
      ListView1[xx].Picture = Picture["icons/checked.png"]
    Else If chkall.Value = False Then
      ListView1[xx].Picture = Picture["icons/unchecked.png"]
    Endif
  Next
  ListView1.UnselectAll()

End
