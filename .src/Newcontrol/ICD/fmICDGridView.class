' Gambas class file

Private $rData As Result
Private $aMyFields As String[]

Private $sValue As String[]

Public Sub Run(sTitle As String) As String[]

  Me.Title = sTitle
  If Me.ShowModal() Then Return $sValue

End

Public Sub Form_Open()

  modGeneralMain.ArrangeFormCentre(Me, "False")
  chkleftmain.Value = modBasic.$SearchBothSide
  modSettings.ShowCheckBox(chkgroup, "ClinicForms/ICDGroups")
  modSettings.ShowCheckBox(chkboth, "ClinicForms/ICDBothCodes")

  $sValue = New String[]
  FillICDGrid()
  txtname.SetFocus

End

Public Sub chkboth_Click()

  modSettings.EnterCheckSetting(chkboth, "ClinicForms/ICDBothCodes")

End

Public Sub chkgroup_Click()

  modSettings.EnterCheckSetting(chkgroup, "ClinicForms/ICDGroups")

End

Public Sub chkleftmain_Click()

  modBasic.$SearchBothSide = chkleftmain.Value
  txtname.SetFocus

End

Public Sub FillICDGrid()

  Dim xstr As String
  Dim xgrp As String

  If chkboth.Value = True Then
    xstr = " and fldoldcode IS NOT NULL"
  Else
    xstr = ""
  Endif
  If chkgroup.Value = True Then
    xgrp = " and fldicdcode NOT LIKE &2"
  Else
    xgrp = ""
  Endif

  If txtcode.Text Then
    $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease where lower(fldicdcode) like &1" & xstr & xgrp, LCase(txtcode.Text) & "%", "%.%")
  Else If txtname.Text Then
    If chkleftmain.Value = True Then
      $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease where lower(fldicdnme) like &1" & xstr & xgrp, "%" & LCase(txtname.Text) & "%", "%.%")
    Else
      $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease where lower(fldicdnme) like &1" & xstr & xgrp, LCase(txtname.Text) & "%", "%.%")
    Endif

  Else
    If chkgroup.Value = True Then
      If chkboth.Value = True Then
        $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease where fldoldcode IS NOT NULL and fldicdcode NOT LIKE &1", "%.%")
      Else
        $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease where fldicdcode NOT LIKE &1", "%.%")
      Endif
    Else
      If chkboth.Value = True Then
        $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease where fldoldcode IS NOT NULL")
      Else
        $rData = modDatabase.$icdConn.Exec("select fldicdnme,fldicdcode,fldoldcode from tblicddisease")
      Endif
    Endif

  Endif
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[1].Width = 100 * modBasic.$AppWidthRatio
    .Columns[2].Width = 1
    .Columns[0].Width = GridView1.Width - 115 * modBasic.$AppWidthRatio

    .Columns[0].Text = "Particulars"
    .Columns[1].Text = "Code"
  End With
  GridView1.Row = 0

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  GridView1.Data.Text = $rData[$aMyFields[Column]]
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

Public Sub txtname_KeyRelease()

  If Key.Code = Key.Down Then
    GridView1.SetFocus
  Endif

End

Public Sub txtname_Change()

  txtcode.Text = ""
  If txtname.Text Then
    FillICDGrid()
  Endif

End

Public Sub txtcode_KeyRelease()

  If Key.Code = Key.Down Then
    GridView1.SetFocus
  Endif

End

Public Sub txtcode_Change()

  txtname.Text = ""
  If txtcode.Text Then
    FillICDGrid()
  Endif

End

Public Sub txtname_Click()

  txtname.Text = ""
  FillICDGrid()

End

Public Sub GridView1_KeyRelease()

  Dim xxx As String[]

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    If GridView1.Rows.Selection.Count Then
      xxx = New String[]
      xxx.Add(GridView1[GridView1.Row, 0].Text)
      xxx.Add(GridView1[GridView1.Row, 1].Text)
      xxx.Add(GridView1[GridView1.Row, 2].Text)
      $sValue = xxx
      Me.Close(True)
    Endif
  Else If Key.Code = Key.Esc Then
    Me.Close
  Endif

End

Public Sub btnok_Click()

  Dim xxx As String[]

  If GridView1.Rows.Selection.Count Then
    xxx = New String[]
    xxx.Add(GridView1[GridView1.Row, 0].Text)
    xxx.Add(GridView1[GridView1.Row, 1].Text)
    xxx.Add(GridView1[GridView1.Row, 2].Text)
    $sValue = xxx
    Me.Close(True)
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Endif

End

Public Sub txtname_KeyPress()

  modGeneralMain.InputTextSearchKeyOnly()

End

Public Sub txtcode_KeyPress()

  modGeneralMain.InputTextSearchKeyOnly()

End
