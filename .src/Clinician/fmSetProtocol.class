' Gambas class file

Private $encid As String
Private $sValue As Long[]

Private $rData1 As Result
Private $aMyFields1 As String[]
Private sIndexLst As Long[]

Public Sub Run(encid As String) As Long[]

  $encid = encid

  $sValue = New Long[]
  If Me.ShowModal() Then Return $sValue

End

Public Sub Form_Open()

  sIndexLst = New Long[]
  rbplan.Value = True
  rbplan_Click()

End

Public Sub rbplan_Click()

  lstcategory.List = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select fldprotocol from tblpatprotocols where fldencounterval=&1 and fldstatus=&2", $encid, "Active"))

End

Public Sub rbnew_Click()

  lstcategory.List = modMedicine.GetMedicineProcolsList()

End

Public Sub lstcategory_Click()

  Dim xx As String[]
  Dim xList As String[]

  xList = New String[]
  xList.Add("All Categories")
  xx = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select distinct(fldcategory) as col from tblproductgroup where fldmedgroup=&1 and (fldcomp=&2 or fldcomp=&3)", lstcategory.Text, modBasic.$compID, "%"))
  If xx Then
    xList.Insert(xx)
  Endif
  cmbdate.List = xList
  cmbdate.Text = "All Categories"
  ShowProtocolList()

End

Public Sub btnshow_Click()

  ShowProtocolList()

End

Public Sub ShowProtocolList()

  Dim sql As String
  Dim xregimen As String

  xregimen = "CONCAT(fldroute, '|', flditem, '|', COALESCE(flddose, ''), '|',COALESCE(flddoseunit, ''), '|', COALESCE(fldfreq, ''), '|', COALESCE(fldday, ''))"
  If cmbdate.Text = "All Categories" Then
    sql = "select fldid,fldid,flditem,fldstart," & xregimen & " as fldregimen,fldroute,fldqty,fldadvice from tblproductgroup where (fldcomp=&1 or fldcomp=&2) and fldmedgroup=&3 ORDER BY fldstart"
  Else
    sql = "select fldid,fldid,flditem,fldstart," & xregimen & " as fldregimen,fldroute,fldqty,fldadvice from tblproductgroup where (fldcomp=&1 or fldcomp=&2) and fldmedgroup=&3 and fldcategory=&4 ORDER BY fldstart"
  Endif
  $rData1 = modDatabase.$myConn.Exec(sql, modBasic.$compID, "%", lstcategory.Text, cmbdate.Text)
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)

  With GridView2
    .Columns[0].Width = 1
    .Columns[1].Width = 25 * modBasic.$AppWidthRatio
    .Columns[2].Width = 1
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 350 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 50 * modBasic.$AppWidthRatio
    .Columns[7].Width = 200 * modBasic.$AppWidthRatio

    .Columns[3].Text = "Start"
    .Columns[4].Text = "Medicine"
    .Columns[5].Text = "Route"
    .Columns[6].Text = "QTY"
    .Columns[7].Text = "Direction"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData1.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 1 Then
    GridView2.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 4 Then
    GridView2.Data.RichText = GetRegimenString($rData1[$aMyFields1[Column]])
    GridView2.Rows[Row].Height = Max(GridView2.Rows[Row].Height, GridView2.Data.Font.RichTextHeight(GridView2.Data.RichText, GridView2.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView2.Rows.Height - GridView2.Font.Height))
  Else
    GridView2.Data.Text = $rData1[$aMyFields1[Column]]
  Endif
  GridView2.Data.WordWrap = True

End

Private Function GetRegimenString(sInput As String) As String

  Dim asx As String[]
  Dim xval As String
  Dim xregimen As String

  If sInput Then
    asx = Split(sInput, "|")
    If asx.Count = 6 Then
      If asx[3] Then
        If CInt(asx[5]) Then
          xregimen = asx[2] & Space(1) & asx[3] & Space(1) & asx[4] & Space(1) & "X " & asx[5] & " Days"
        Else
          xregimen = asx[2] & Space(1) & asx[3] & Space(1) & asx[4] & Space(1) & "X Every Day"
        Endif
        xval = asx[1] & "<br><b>" & xregimen & "</b>"
      Else
        xval = asx[1]
      Endif
    Else
      xval = asx[1]
    Endif
  Endif

  Return xval

End

Public Sub GridView2_Click()

  If GridView2.Column = 1 Then
    modGridView.CheckUncheckGridNoDB(GridView2, 1)
  Endif

End

Public Sub btnsave_Click()

  Dim Row As Integer

  If GridView2.Rows.Selection.Count Then
    For Row = 0 To GridView2.Rows.Count - 1
      If GridView2[Row, 1].Picture = Picture["icons/checked.png"] Then
        If sIndexLst.Exist(GridView2[Row, 0].Text) = False Then
          sIndexLst.Add(GridView2[Row, 0].Text)
          GridView2[Row, 1].Picture = Picture["icons/coll4.png"]
        Endif
      Endif
    Next
  Endif

End

Public Sub btnclose_Click()

  If sIndexLst.Count Then
    $sValue = sIndexLst
    Me.Close(True)
  Else
    Me.Close
  Endif

End
