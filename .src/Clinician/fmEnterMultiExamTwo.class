' Gambas class file

''controls
Private aWebFrame As New Object[50]
Private aWebPanel As New Object[50]
Private aIndexLabel As New Object[50]    ''aLab
Private aNameLabel As New Object[50]       ''aObj
Private aAbnormCheck As New Object[50]       ''aObj2
Private aContLeft As New Object[50]
Private aMidLine As New Object[50]
Private aContRight As New Object[50]

Private aHTMLTextR As New Object[50]          ''aObj11
Private aLineTextR As New Object[50]
Private aUnitTextR As New Object[50]
Private aValueBoxR As New Object[50]
' Private aQuantiBoxR As New Object[50]
' Private aQuantiMaxR As New Object[50]
' Private aQuantiMinR As New Object[50]
Private aClinBoxR As New Object[50]
Private aDateBoxR As New Object[50]
Private aBSDateR As New Object[50]
Private aComboBoxR As New Object[50]
Private aChkLockR As New Object[50]
Private aTextAreaR As New Object[50]
Private aDichoValueR As New Object[50]
Private aGenTextAreaR As New Object[50]
Private aButtonBoxR As New Object[50]
Private aHelpButtonR As New Object[50]          ''aObj3

Private aHTMLTextL As New Object[50]          ''aObj11
Private aLineTextL As New Object[50]
Private aUnitTextL As New Object[50]
Private aValueBoxL As New Object[50]
' Private aQuantiBoxL As New Object[50]
' Private aQuantiMaxL As New Object[50]
' Private aQuantiMinL As New Object[50]
Private aClinBoxL As New Object[50]
Private aDateBoxL As New Object[50]
Private aBSDateL As New Object[50]
Private aComboBoxL As New Object[50]
Private aChkLockL As New Object[50]
Private aTextAreaL As New Object[50]
Private aDichoValueL As New Object[50]
Private aGenTextAreaL As New Object[50]
Private aButtonBoxL As New Object[50]
Private aHelpButtonL As New Object[50]          ''aObj3

Private aBlankBox As New Object[50]
Private aWebSpace As New Object[50]
''other variables
Private $encid As String
Private $sTable As String
Private $idList As String[]
Private $sCategory As String
''Arrays
Private $xCode As String[]
Private $xType As String[]
Private $xOption As String[]
Private $xitem As String[]
Private $xExam As String[]
Private $xOpList As String[]
Private $xSysCons As String[]
Private $xSource As String[]
Private $xHelpList As String[]
Private $xUniqList As Integer[]
Private $xDefaultLst As String[]

Private AppFactor As Float

''----------------------------------------- create controls -----------------------------------------
Public Sub _new(sPrompt As String, encid As String, sTable As String, idList As String[], sCategory As String)

  Dim idx As String
  Dim i As Integer
  Dim ht As String

  Dim rsn As Result
  Dim res As Result

  Dim xcode As String
  Dim xType As String
  Dim xOption As String
  Dim xitem As String
  Dim xexam As String
  Dim xopList As String[]
  Dim xSysCons As String
  Dim xsource As String
  Dim xhelp As String
  Dim xuniq As Integer
  Dim xdefVal As String

  $encid = encid
  $sTable = sTable
  $idList = idList
  $sCategory = sCategory
  lblitem.Text = sPrompt

  AppFactor = modBasic.$AppScaleFactor
  ht = modSettings.ShowSettingFromFIle("MultipleTextBox/Height")
  If ht Then
    Slider1.Value = CInt(ht)
  Else
    Slider1.Value = 3
  Endif

  $xCode = New String[]
  $xType = New String[]
  $xOption = New String[]
  $xitem = New String[]
  $xExam = New String[]
  $xOpList = New String[]
  $xSysCons = New String[]
  $xSource = New String[]
  $xHelpList = New String[]
  $xUniqList = New Integer[]
  $xDefaultLst = New String[]

  For Each idx In $idList
    rsn = modDatabase.$myConn.Exec("select fldheadcode,fldhead,fldtesttype,fldtanswertype,fldsysconst,fldclininfo,fldunique,flddefault from tblstructexam where fldheadcode=&1 and fldtesttype=&2 ORDER BY fldheadid", idx, "Qualitative")
    If rsn.Available Then
      xcode = rsn["fldheadcode"]
      xitem = rsn["fldhead"]
      xType = rsn["fldtesttype"]
      xOption = rsn["fldtanswertype"]
      xSysCons = rsn["fldsysconst"]
      xhelp = rsn["fldclininfo"]
      If rsn["fldunique"] = True Then
        xuniq = 1
      Else
        xuniq = 0
      Endif
      xdefVal = rsn["flddefault"]
      xsource = "Free"

      ''get parameters
      If rsn["fldtanswertype"] = "Sys Constant" And If rsn["fldsysconst"] Then
        If modBasic.$sysExamDualList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select fldexamid,fldtype,fldoption from tblexam where fldsysconst=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldtype"]
            xOption = res["fldoption"]
            xexam = res["fldexamid"]
            If res["fldoption"] = "Clinical Scale" Then
              xopList = modAllExam.GetCLinicalScaleOptions("Exam", xexam)
            Else
              xopList = modAllExam.SelectExamOptionList("Exam", xexam)
            Endif
            xsource = "Exam"
          Endif
        Else If modBasic.$sysTestDualList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select fldtestid,fldtype,fldoption from tbltest where fldsysconst=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldtype"]
            xOption = res["fldoption"]
            xexam = res["fldtestid"]
            If res["fldoption"] = "Clinical Scale" Then
              xopList = modAllExam.GetCLinicalScaleOptions("Test", xexam)
            Else
              xopList = modAllExam.SelectExamOptionList("Test", xexam)
            Endif
            xsource = "Test"
          Endif
        Else If modBasic.$sysRadioList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select fldexamid,fldtype,fldoption from tblradio where fldsysconst=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldtype"]
            xOption = res["fldoption"]
            xexam = res["fldexamid"]
            If res["fldoption"] = "Clinical Scale" Then
              xopList = modAllExam.GetCLinicalScaleOptions("Radio", xexam)
            Else
              xopList = modAllExam.SelectExamOptionList("Radio", xexam)
            Endif
            xsource = "Radio"
          Endif
        Else If modBasic.$DemogList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select flddemoid,fldoption from tbldemographic where flddemoid=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldoption"]
            xOption = res["fldoption"]
            xexam = res["flddemoid"]
            xopList = modAllExam.SelectExamOptionList("Demog", xexam)
            xsource = "Demog"
          Endif
        Endif

      Else If rsn["fldtanswertype"] = "CopyValue" And If rsn["fldsysconst"] Then
        If modBasic.$sysExamDualList.Exist(rsn["fldsysconst"]) = True Then
          xexam = modFixClinic.GetExamIDFromSysConst(rsn["fldsysconst"])
          xsource = "Exam"
        Else If modBasic.$sysTestDualList.Exist(rsn["fldsysconst"]) = True Then
          xexam = modFixLab.GetLabTestIDFromSysConst(rsn["fldsysconst"])
          xsource = "Test"
        Else If modBasic.$sysRadioList.Exist(rsn["fldsysconst"]) = True Then
          xexam = modFixRadio.GetRadioTestIDFromSysConst(rsn["fldsysconst"])
          xsource = "Radio"
        Endif

      Else If rsn["fldtanswertype"] = "Calculated" And If rsn["fldsysconst"] Then
        xexam = "Expression"

      Else
        xopList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select fldanswer from tblstructexamoption where fldheadcode=&1 ORDER BY fldindex", idx))                         ''
        xexam = "Structured"
      Endif

      $xCode.Add(xcode)
      $xitem.Add(xitem)
      If xexam Then
        $xExam.Add(xexam)
      Else
        $xExam.Add("__")
      Endif
      If xType Then
        $xType.Add(xType)
      Else
        $xType.Add("__")
      Endif
      If xOption Then
        $xOption.Add(xOption)
      Else
        $xOption.Add("__")
      Endif
      If xopList And If xopList.Count Then
        $xOpList.Add(xopList.Join("|"))
      Else
        $xOpList.Add("__")
      Endif
      If xSysCons Then
        $xSysCons.Add(xSysCons)
      Else
        $xSysCons.Add("__")
      Endif
      If xsource Then
        $xSource.Add(xsource)
      Else
        $xSource.Add("__")
      Endif
      If xhelp Then
        $xHelpList.Add(xhelp)
      Else
        $xHelpList.Add("Null")
      Endif
      $xUniqList.Add(xuniq)
      If xdefVal Then
        $xDefaultLst.Add(xdefVal)
      Else
        $xDefaultLst.Add("__")
      Endif

    Endif
  Next

  For i = 0 To $xitem.Count - 1
    If i < 49 Then
      ''Create controls
      aWebFrame[i] = New HBox(Frame1)
      aIndexLabel[i] = New Label(aWebFrame[i]) As "IndexLabel"
      aNameLabel[i] = New TextLabel(aWebFrame[i]) As "NameLabel"

      aWebPanel[i] = New HBox(Frame1)
      aAbnormCheck[i] = New CheckBox(aWebPanel[i]) As "CheckBoxgroup"

      aContRight[i] = New HBox(aWebPanel[i])
      aMidLine[i] = New Label(aWebPanel[i])
      aContLeft[i] = New HBox(aWebPanel[i])
      If $xType[i] = "Quantitative" Then
        ' ''Right
        ' aQuantiBoxR[i] = New ValueBox(aContRight[i]) As "QuantiGroupR"
        ' aQuantiMaxR[i] = New ValueBox(aContRight[i]) As "QuantiGroupMaxR"
        ' aQuantiMinR[i] = New ValueBox(aContRight[i]) As "QuantiGroupMinR"
        ' ''Left
        ' aQuantiBoxL[i] = New ValueBox(aContLeft[i]) As "QuantiGroupL"
        ' aQuantiMaxL[i] = New ValueBox(aContLeft[i]) As "QuantiGroupMaxL"
        ' aQuantiMinL[i] = New ValueBox(aContLeft[i]) As "QuantiGroupMinL"
      Else
        Select $xOption[i]
          Case "Sys Constant"
            ''Right
            aGenTextAreaR[i] = New TextPlain(aContRight[i]) As "GenAreaGroupR"
            ''Left
            aGenTextAreaL[i] = New TextPlain(aContLeft[i]) As "GenAreaGroupL"
          Case "Date Time", "BS Date"
            ''Right
            aDateBoxR[i] = New DateBox(aContRight[i]) As "DateGroupR"
            aBSDateR[i] = New ToolButton(aContRight[i]) As "BSButtonR"
            ''Left
            aDateBoxL[i] = New DateBox(aContLeft[i]) As "DateGroupL"
            aBSDateL[i] = New ToolButton(aContLeft[i]) As "BSButtonL"
          Case "User Profile"
            ''Right
            aLineTextR[i] = New TextBox(aContRight[i]) As "TextLineGroupR"
            ''Left
            aLineTextL[i] = New TextBox(aContLeft[i]) As "TextLineGroupL"
          Case "ImageValue"
            ''Right
            aButtonBoxR[i] = New ButtonBox(aContRight[i]) As "ImageBoxGroupR"
            ''Left
            aButtonBoxL[i] = New ButtonBox(aContLeft[i]) As "ImageBoxGroupL"
          Case "Single Selection"
            ''Right
            aComboBoxR[i] = New ComboBox(aContRight[i]) As "ComboGroupR"
            aChkLockR[i] = New CheckBox(aContRight[i]) As "CheckLockR"
            ''Left
            aComboBoxL[i] = New ComboBox(aContLeft[i]) As "ComboGroupL"
            aChkLockL[i] = New CheckBox(aContLeft[i]) As "CheckLockL"
          Case "Dichotomous"
            ''Right
            aDichoValueR[i] = New DichotomousValue(aContRight[i]) As "DichoTextR"
            ''Left
            aDichoValueL[i] = New DichotomousValue(aContLeft[i]) As "DichoTextL"
          Case "Quantitative"
            ''Right
            aValueBoxR[i] = New ValueBox(aContRight[i]) As "ValueGroupR"
            aUnitTextR[i] = New TextBox(aContRight[i]) As "UnitGroupR"
            ''Left
            aValueBoxL[i] = New ValueBox(aContLeft[i]) As "ValueGroupL"
            aUnitTextL[i] = New TextBox(aContLeft[i]) As "UnitGroupL"
          Case "Qualitative"
            ''Right
            aLineTextR[i] = New TextBox(aContRight[i]) As "TextLineGroupR"
            ''Left
            aLineTextL[i] = New TextBox(aContLeft[i]) As "TextLineGroupL"
          Case "Clinical Scale"
            ''Right
            aTextAreaR[i] = New TextArea(aContRight[i]) As "TextAreaGroupR"
            aClinBoxR[i] = New ValueBox(aContRight[i]) As "ClinGroupR"
            ''Left
            aTextAreaL[i] = New TextArea(aContLeft[i]) As "TextAreaGroupL"
            aClinBoxL[i] = New ValueBox(aContLeft[i]) As "ClinGroupL"
          Case "RichText Area"
            ''Right
            aHTMLTextR[i] = New TextHTML(aContRight[i]) As "TextHTMLgroupR"
            ''Left
            aHTMLTextL[i] = New TextHTML(aContLeft[i]) As "TextHTMLgroupL"
          Case Else
            ''Right
            aGenTextAreaR[i] = New TextPlain(aContRight[i]) As "GenAreaGroupR"
            ''Left
            aGenTextAreaL[i] = New TextPlain(aContLeft[i]) As "GenAreaGroupL"
        End Select
      Endif
      aHelpButtonR[i] = New ToolButton(aContRight[i]) As "ButtonBoxgroupR"
      aHelpButtonL[i] = New ToolButton(aContLeft[i]) As "ButtonBoxgroupL"
      aBlankBox[i] = New Label(aWebPanel[i])
      aWebSpace[i] = New Separator(Frame1)
    Endif
  Next
  DIsplayTextForm()

End

''------------------------ General form
Public Sub Form_Open()

  Dim xoption As String

  modGeneralMain.ArrangeFormCentre(Me, "False")
  xoption = modSettings.ShowSettingFromFIle("EntrySetting/AutoDisplayOptions")
  If xoption = "Yes" Then
    chkautoption.Value = True
  Else If xoption = "No" Then
    chkautoption.Value = False
  Endif

End

Public Sub Form_Close()

  modGeneralMain.DisableJavaScript()

End

Private Sub DIsplayTextForm()

  Dim i As Integer

  Label5.Width = 75 * AppFactor
  For i = 0 To $xitem.Count - 1
    If i < 49 Then

      With aWebFrame[i]
        .Height = 25 * AppFactor
        .Width = Frame1.Width
      End With

      ''create index label
      With aIndexLabel[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = i + 1
        .Visible = False
        .Tag = i
      End With

      ''create Name Label
      With aNameLabel[i]
        .Expand = True
        .Height = 25 * AppFactor
        .Text = "<p>" & $xitem[i] & "</p>"
        .Font.Bold = True
        .Tag = i
        .Wrap = True
        If $xHelpList[i] = "Null" Then
          .Tooltip = ""
        Else
          .Tooltip = $xHelpList[i]
        Endif
      End With

      With aWebPanel[i]
        .AutoResize = True
        .Margin = True
        .Width = Frame1.Width
      End With

      ''create abnormal checkbox
      With aAbnormCheck[i]
        .Width = 75 * AppFactor
        .Height = 25 * AppFactor
        .Text = "Flag"
        .Tag = i

        If modBasic.$ClinFlagAbnormExam = "Disable" Then
          .Visible = False
        Else
          .Visible = True
        Endif
      End With

      With aContRight[i]
        .AutoResize = True
        .Expand = True
        .Margin = True
      End With

      With aMidLine[i]
        .Width = 50 * AppFactor
        .Border = Border.Plain
      End With

      With aContLeft[i]
        .AutoResize = True
        .Expand = True
        .Margin = True
      End With

      ''create observation entry
      If $xType[i] = "Quantitative" Then
        ' xlimit = modClinic.GetBothQuantiExamVal($xExam[i], $encid)
        ' ''Right
        ' With aQuantiBoxR[i]
        '   .Width = 100 * AppFactor
        '   .Height = 25 * AppFactor
        '   .Tag = i
        ' End With
        ' 'min value
        ' With aQuantiMinR[i]
        '   .Width = 75 * AppFactor
        '   .Height = 25 * AppFactor
        '   .Enabled = False
        '   .Value = xlimit[0]
        '   .Tag = i
        ' End With
        ' ''max value
        ' With aQuantiMaxR[i]
        '   .Width = 75 * AppFactor
        '   .Height = 25 * AppFactor
        '   .Enabled = False
        '   .Value = xlimit[1]
        '   .Tag = i
        ' End With
        ' ''Left
        ' With aQuantiBoxL[i]
        '   .Width = 100 * AppFactor
        '   .Height = 25 * AppFactor
        '   .Tag = i
        ' End With
        ' 'min value
        ' With aQuantiMinL[i]
        '   .Width = 75 * AppFactor
        '   .Height = 25 * AppFactor
        '   .Enabled = False
        '   .Value = xlimit[0]
        '   .Tag = i
        ' End With
        ' ''max value
        ' With aQuantiMaxL[i]
        '   .Width = 75 * AppFactor
        '   .Height = 25 * AppFactor
        '   .Enabled = False
        '   .Value = xlimit[1]
        '   .Tag = i
        ' End With

      Else
        If $xOption[i] = "Single Selection" Then
          ''Right
          With aComboBoxR[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .List = Split($xOpList[i], "|")
            .Tag = i
          End With
          With aChkLockR[i]
            .Width = 25 * AppFactor
            .Height = 25 * AppFactor
            .Value = False
            .Tag = i
          End With
          ''Left
          With aComboBoxL[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .List = Split($xOpList[i], "|")
            .Tag = i
          End With
          With aChkLockL[i]
            .Width = 25 * AppFactor
            .Height = 25 * AppFactor
            .Value = False
            .Tag = i
          End With

        Else If $xOption[i] = "Dichotomous" Then
          ''Right
          With aDichoValueR[i]
            .Expand = True
            .Height = 25 * AppFactor
            .List = Split($xOpList[i], "|")
            .Tag = i
          End With
          ''Left
          With aDichoValueL[i]
            .Expand = True
            .Height = 25 * AppFactor
            .List = Split($xOpList[i], "|")
            .Tag = i
          End With

        Else If $xOption[i] = "Date Time" Then
          ''Right
          With aDateBoxR[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Mode = DateChooser.DateTime
            .Tag = i
          End With
          With aBSDateR[i]
            .Width = 30 * AppFactor
            .Height = 25 * AppFactor
            .Picture = Picture["icon:/small/calendar"]
            .Tag = i
          End With
          ''Left
          With aDateBoxL[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Mode = DateChooser.DateTime
            .Tag = i
          End With
          With aBSDateL[i]
            .Width = 30 * AppFactor
            .Height = 25 * AppFactor
            .Picture = Picture["icon:/small/calendar"]
            .Tag = i
          End With

        Else If $xOption[i] = "BS Date" Then
          ''Right
          With aDateBoxR[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Mode = DateChooser.DateTime
            .Tag = i
          End With
          With aBSDateR[i]
            .Width = 30 * AppFactor
            .Height = 25 * AppFactor
            .Picture = Picture["icon:/small/calendar"]
            .Tag = i
          End With
          ''Left
          With aDateBoxL[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Mode = DateChooser.DateTime
            .Tag = i
          End With
          With aBSDateL[i]
            .Width = 30 * AppFactor
            .Height = 25 * AppFactor
            .Picture = Picture["icon:/small/calendar"]
            .Tag = i
          End With

        Else If $xOption[i] = "User Profile" Then
          ''Right
          With aLineTextR[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          ''Left
          With aLineTextL[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "ImageValue" Then
          ''Right
          With aButtonBoxR[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Text = ""
            .Tag = i
          End With
          ''Left
          With aButtonBoxL[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Text = ""
            .Tag = i
          End With

        Else If $xOption[i] = "Clinical Scale" Then
          ''Right
          With aTextAreaR[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Wrap = True
            .Tag = i
          End With
          With aClinBoxR[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          ''Left
          With aTextAreaL[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Wrap = True
            .Tag = i
          End With
          With aClinBoxL[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Quantitative" Then
          ''Right
          With aValueBoxR[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          With aUnitTextR[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          ''Left
          With aValueBoxL[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          With aUnitTextL[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Qualitative" Then
          ''Right
          With aLineTextR[i]
            .Width = 250 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          ''Left
          With aLineTextL[i]
            .Width = 250 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "RichText Area" Then
          ''Right
          With aHTMLTextR[i]
            .Expand = True
            .Height = 25 * Slider1.Value * AppFactor
            .DictionaryPath = modBasic.$dictPathList
            .Tag = i
          End With
          ''Left
          With aHTMLTextL[i]
            .Expand = True
            .Height = 25 * Slider1.Value * AppFactor
            .DictionaryPath = modBasic.$dictPathList
            .Tag = i
          End With

        Else
          ''Right
          With aGenTextAreaR[i]
            .Expand = True
            .Height = 25 * Slider1.Value * AppFactor
            .DictionaryPath = modBasic.$dictPathList
            .Tag = i
          End With
          ''Left
          With aGenTextAreaL[i]
            .Expand = True
            .Height = 25 * Slider1.Value * AppFactor
            .DictionaryPath = modBasic.$dictPathList
            .Tag = i
          End With

        Endif
      Endif

      ''create help button
      ''Right
      With aHelpButtonR[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = ""
        .Picture = Picture["icon:/small/info"]
        .Tag = i
        .Tooltip = "[Ctrl+O] to display Options"
      End With
      ''Left
      With aHelpButtonL[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = ""
        .Picture = Picture["icon:/small/info"]
        .Tag = i
        .Tooltip = "[Ctrl+O] to display Options"
      End With

      With aBlankBox[i]
        .Height = 25 * AppFactor
        .Width = 15 * AppFactor
      End With

      With aWebSpace[i]
        .Height = 15 * AppFactor
      End With

    Endif
  Next

  If aHTMLTextR[0] Then
    aHTMLTextR[0].SetFocus
  Else If aLineTextR[0] Then
    aLineTextR[0].SetFocus
  Else If aValueBoxR[0] Then
    aValueBoxR[0].SetFocus
  Else If aDateBoxR[0] Then
    aDateBoxR[0].SetFocus
    ' Else If aQuantiBoxR[0] Then
    '   aQuantiBoxR[0].SetFocus
  Else If aGenTextAreaR[0] Then
    aGenTextAreaR[0].SetFocus
  Endif

End

''Right
Public Sub BSButtonR_Click()

  Dim j As Integer
  Dim xx As String

  j = Last.Tag
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBoxR[j].Value))
  If xx Then
    aDateBoxR[j].Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

''Left
Public Sub BSButtonL_Click()

  Dim j As Integer
  Dim xx As String

  j = Last.Tag
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBoxL[j].Value))
  If xx Then
    aDateBoxL[j].Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnexectext_Click()

  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLTextR[j] Then
    aHTMLTextR[j].RichText = aHTMLTextR[j].RichText & modCloudAI.GetPatCloudAIResponse($encid, aHTMLTextR[j].Text)
  Else If aGenTextAreaR[j] Then
    aGenTextAreaR[j].Text = aGenTextAreaR[j].Text & modCloudAI.GetPatCloudAIResponse($encid, aGenTextAreaR[j].Text)
  Else If aHTMLTextL[j] Then
    aHTMLTextL[j].RichText = aHTMLTextL[j].RichText & modCloudAI.GetPatCloudAIResponse($encid, aHTMLTextL[j].Text)
  Else If aGenTextAreaL[j] Then
    aGenTextAreaL[j].Text = aGenTextAreaL[j].Text & modCloudAI.GetPatCloudAIResponse($encid, aGenTextAreaL[j].Text)
  Endif

End

Public Sub dctexectext_Click()

  Dim xx As String
  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLTextR[j] Then
    xx = GetRichTextArea(aNameLabel[j].Text, aHTMLTextR[j].RichText)
    If xx Then
      aHTMLTextR[j].RichText = xx
    Endif
  Else If aGenTextAreaR[j] Then
    xx = GetTextArea(aNameLabel[j].Text, aGenTextAreaR[j].Text)
    If xx Then
      aGenTextAreaR[j].Text = xx
    Endif
  Else If aHTMLTextL[j] Then
    xx = GetRichTextArea(aNameLabel[j].Text, aHTMLTextL[j].RichText)
    If xx Then
      aHTMLTextL[j].RichText = xx
    Endif
  Else If aGenTextAreaL[j] Then
    xx = GetTextArea(aNameLabel[j].Text, aGenTextAreaL[j].Text)
    If xx Then
      aGenTextAreaL[j].Text = xx
    Endif
  Endif

End

Public Sub btntemplsumm_Click()

  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLTextR[j] Then
    aHTMLTextR[j].RichText = aHTMLTextR[j].RichText & DictionaryVIew(aNameLabel[j].Text)
  Else If aGenTextAreaR[j] Then
    aGenTextAreaR[j].Text = aGenTextAreaR[j].Text & DictionaryVIew(aNameLabel[j].Text)
  Else If aHTMLTextL[j] Then
    aHTMLTextL[j].RichText = aHTMLTextL[j].RichText & DictionaryVIew(aNameLabel[j].Text)
  Else If aGenTextAreaL[j] Then
    aGenTextAreaL[j].Text = aGenTextAreaL[j].Text & DictionaryVIew(aNameLabel[j].Text)
  Endif

End

Public Sub chkautoption_Click()

  modSettings.EnterCheckSetting(chkautoption, "EntrySetting/AutoDisplayOptions")

End

Public Sub btnrefresh_Click()

  modSettings.SaveSettingsToFile("MultipleTextBox/Height", Slider1.Value)
  DIsplayTextForm()

End

Public Sub Form_Resize()

  DIsplayTextForm()

End

Public Sub btnBrChange_Click()

  modGeneralMain.SaveFormArrangement(Me)
  Me.Close()

End

Public Sub btnBrOK_Click()

  FillExamSubExam()
  btnBrOK.Enabled = False
  Balloon.Info(("Information saved"), btnBrOK)
  Balloon.Delay = modBasic.$BalloonDelay

End

' Private Sub SetAbnormCheckBox()
'
'   Dim j As Integer
'
'   j = Last.Tag
'   aAbnormCheck[j].Value = False
'   ''Right
'   If aQuantiBoxR[j].Value Then
'     If aQuantiMinR[j].Value <> aQuantiMaxR[j].Value Then
'       If aQuantiBoxR[j].Value < aQuantiMinR[j].Value Or If aQuantiBoxR[j].Value > aQuantiMaxR[j].Value Then
'         aAbnormCheck[j].Value = True
'       Endif
'     Endif
'   Endif
'   ''Left
'   If aQuantiBoxL[j].Value Then
'     If aQuantiMinL[j].Value <> aQuantiMaxL[j].Value Then
'       If aQuantiBoxL[j].Value < aQuantiMinL[j].Value Or If aQuantiBoxL[j].Value > aQuantiMaxL[j].Value Then
'         aAbnormCheck[j].Value = True
'       Endif
'     Endif
'   Endif
'
'   If aAbnormCheck[j].Value = True Then
'     aAbnormCheck[j].Foreground = Color.Red
'   Else
'     aAbnormCheck[j].Foreground = Color.Default
'   Endif
'
' End
'
' ''Right
' Public Sub QuantiGroupR_Change()
'
'   SetAbnormCheckBox()
'
' End
'
' ''Left
' Public Sub QuantiGroupL_Change()
'
'   SetAbnormCheckBox()
'
' End

Private Function GetJsonTwin(sRight As String, sLeft As String) As String

  Dim xx As String

  xx = modString.GetLefRightJSON(sLeft, sRight)
  Return xx

End

Private Sub FillExamSubExam()

  Dim i As Integer
  Dim xval As Variant
  Dim xOptionTyp As String = "Left/Right Components"

  For i = 0 To $xitem.Count - 1
    If i < 49 Then

      If $xOption[i] = "Single Selection" Then
        If aComboBoxR[i].Text Or If aComboBoxL[i].Text Then
          xval = GetJsonTwin(aComboBoxR[i].Text, aComboBoxL[i].Text)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "Dichotomous" Then
        If aDichoValueR[i].Value Or If aDichoValueL[i].Value Then
          xval = GetJsonTwin(aDichoValueR[i].Value, aDichoValueL[i].Value)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "Date Time" Then
        If aDateBoxR[i].Value Or If aDateBoxL[i].Value Then
          xval = GetJsonTwin(modDate.DateStringForExam(aDateBoxR[i].Value), modDate.DateStringForExam(aDateBoxL[i].Value))
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "BS Date" Then
        If aDateBoxR[i].Value Or If aDateBoxL[i].Value Then
          xval = GetJsonTwin(modDate.ConvertToLocaldate(aDateBoxR[i].Value), modDate.ConvertToLocaldate(aDateBoxL[i].Value))
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "User Profile" Then
        If aLineTextR[i].Text Or If aLineTextL[i].Text Then
          xval = GetJsonTwin(aLineTextR[i].Text, aLineTextL[i].Text)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "ImageValue" Then
        If aButtonBoxR[i].Text Or If aButtonBoxL[i].Text Then
          xval = GetJsonTwin(aButtonBoxR[i].Text, aButtonBoxL[i].Text)
          modClinSub.AddQualiImageData($encid, $idList[i], $xitem[i], xOptionTyp, $sTable, $xSysCons[i], xval, $sCategory)
        Endif
      Else If $xOption[i] = "Quantitative" Then
        If aValueBoxR[i].Value Or If aValueBoxL[i].Value Then
          xval = GetJsonTwin(CStr(aValueBoxR[i].Value) & Space(1) & aUnitTextR[i].Text, CStr(aValueBoxL[i].Value) & Space(1) & aUnitTextL[i].Text)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "Qualitative" Then
        If aLineTextR[i].Text Or If aLineTextL[i].Text Then
          xval = GetJsonTwin(aLineTextR[i].Text, aLineTextL[i].Text)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else If $xOption[i] = "Clinical Scale" Then
        If aTextAreaR[i].Text Or If aTextAreaL[i].Text Then
          xval = GetJsonTwin(CStr(aClinBoxR[i].Value), CStr(aClinBoxL[i].Value))
          modClinSub.AddClinicExam($encid, $idList[i], $xitem[i], xOptionTyp, xval, 0, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory)
        Endif
      Else If $xOption[i] = "RichText Area" Then
        If aHTMLTextR[i].Text Or If aHTMLTextL[i].Text Then
          xval = GetJsonTwin(aHTMLTextR[i].RichText, aHTMLTextL[i].RichText)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Else
        If aGenTextAreaR[i].Text Or If aGenTextAreaL[i].Text Then
          xval = GetJsonTwin(aGenTextAreaR[i].Text, aGenTextAreaL[i].Text)
          modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], xOptionTyp, xval, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i])
        Endif
      Endif

    Endif
  Next

End

''------------------------------------- short cut keys ------------------------------
Public Sub Form_KeyRelease()

  Dim j As Integer

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    '     modGeneralmain.GoToNextControlTab()
  Else If Key.Code = Key.Esc Then
    Me.Close
  Else

    If Application.ActiveControl Then
      If Not Application.ActiveControl.Tag Then
        j = 0
      Else
        j = Application.ActiveControl.Tag
      Endif
      If Key.Code = Key["S"] And If Key.Control Then
        btnBrOK_Click()
      Else If Key.Code = Key["A"] And If Key.Control Then
        If aAbnormCheck[j].Value = False Then
          aAbnormCheck[j].Value = True
        Else If aAbnormCheck[j].Value = True Then
          aAbnormCheck[j].Value = False
        Endif
      Endif
    Endif

  Endif

End

''-----------------------------help options  --------------------------------------
''Right
Public Sub ButtonBoxgroupR_Click()

  Dim j As Integer

  j = Last.Tag
  OpenOptionR(j)

End

''Left
Public Sub ButtonBoxgroupL_Click()

  Dim j As Integer

  j = Last.Tag
  OpenOptionL(j)

End

''Right
Public Sub ComboGroupR_GotFocus()

  Dim j As Integer

  j = Last.Tag
  If modBasic.$TabletModeEnable = "Yes" Then
    If Not aComboBoxR[j].Text Then
      aComboBoxR[j].Popup
    Endif
  Endif

End

''Left
Public Sub ComboGroupL_GotFocus()

  Dim j As Integer

  j = Last.Tag
  If modBasic.$TabletModeEnable = "Yes" Then
    If Not aComboBoxL[j].Text Then
      aComboBoxL[j].Popup
    Endif
  Endif

End

''Right
Public Sub ComboGroupR_MouseWheel()

  Stop Event

End

''Left
Public Sub ComboGroupL_MouseWheel()

  Stop Event

End

''Right
Public Sub ComboGroupR_KeyRelease()

  Dim j As Integer

  j = Last.Tag
  ''enable on chnaging ComboBoxNew to ComboBox
  modFillContainer.AutoFillComboBox(aComboBoxR[j])
  ' modFillContainer.RestrictComboToContent(aComboBoxR[j])

End

''Left
Public Sub ComboGroupL_KeyRelease()

  Dim j As Integer

  j = Last.Tag
  ''enable on chnaging ComboBoxNew to ComboBox
  modFillContainer.AutoFillComboBox(aComboBoxL[j])
  ' modFillContainer.RestrictComboToContent(aComboBoxL[j])

End

''Right
Public Sub CheckLockR_Click()

  Dim i As Integer

  i = Last.Tag
  If aChkLockR[i].Value = True Then
    aComboBoxR[i].Enabled = False
  Else If aChkLockR[i].Value = False Then
    aComboBoxR[i].Enabled = True
  Endif

End

''Left
Public Sub CheckLockL_Click()

  Dim i As Integer

  i = Last.Tag
  If aChkLockL[i].Value = True Then
    aComboBoxL[i].Enabled = False
  Else If aChkLockL[i].Value = False Then
    aComboBoxL[i].Enabled = True
  Endif

End

''Right
Private Sub OpenOptionR(j As Integer)

  Dim sVal As String[]
  Dim sPath As String
  Dim xval As String
  Dim xopt As String[]
  Dim acalc As Variant

  If $xType[j] = "Quantitative" Then
    ' If $xOption[j] = "Calculated" Then
    '   If $xExam[j] = "Expression" Then
    '     acalc = GetCalculateFloatR($xSysCons[j], $encid)
    '   Else If $xExam[j] = "Structured" Then
    '     acalc = GetCalculateFloatR($xSysCons[j], $encid)
    '   Else
    '     xval = modAllExam.GetExamDefaultValue("Exam", $xExam[j])
    '     If xval Then
    '       acalc = GetCalculateFloatR(xval, $encid)
    '     Endif
    '   Endif
    '   If acalc Then
    '     aQuantiBoxR[j].Value = acalc
    '   Else
    '     aQuantiBoxR[j].Value = 0
    '   Endif
    '
    ' Else If $xOption[j] = "CopyValue" Then
    '   acalc = modReportVar.GetLastQuantiParamValue($xSource[j], $xExam[j], $encid)
    '   If acalc Then
    '     aQuantiBoxR[j].Value = acalc
    '   Else
    '     aQuantiBoxR[j].Value = 0
    '   Endif
    '
    ' Else
    '   xflot = GetQuantiValues("Exam", $encid, $xitem[j], 0, 0, aQuantiBoxR[j].Value)
    '   If xflot Then
    '     acalc = xflot[0]
    '     If acalc Then
    '       aQuantiBoxR[j].Value = acalc
    '     Else
    '       aQuantiBoxR[j].Value = 0
    '     Endif
    '   Endif
    '
    ' Endif

  Else
    If $xOpList[j] Then
      xopt = Split($xOpList[j], "|")
    Endif

    If $xOption[j] = "No Selection" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aGenTextAreaR[j].Text = $xDefaultLst[j]
        Endif
      Endif
    Else If $xOption[j] = "RichText Area" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aHTMLTextR[j].RichText = $xDefaultLst[j]
        Endif
      Endif
    Else If $xOption[j] = "Qualitative" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aLineTextR[j].Text = $xDefaultLst[j]
        Endif
      Endif

    Else If $xOption[j] = "Single Selection" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Single Selection", $xitem[j])
        If sVal Then
          aComboBoxR[j].Text = sVal.Join(";")
        Endif
      Endif

    Else If $xOption[j] = "Dichotomous" Then

    Else If $xOption[j] = "Clinical Scale" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Clinical Scale", $xExam[j])
        If sVal Then
          aClinBoxR[j].Value = sVal[0]
          aTextAreaR[j].Text = sVal[1]
        Endif
      Endif

    Else If $xOption[j] = "Date Time" Then
      If $xExam[j] = "Expression" Then
        acalc = GetCalculateVariantR($xSysCons[j], $encid)
        If IsDate(acalc) Then
          aDateBoxR[j].Value = CDate(acalc)
        Endif
      Else If $xExam[j] = "Structured" Then
        acalc = GetCalculateVariantR($xSysCons[j], $encid)
        If IsDate(acalc) Then
          aDateBoxR[j].Value = CDate(acalc)
        Endif
      Else
        aDateBoxR[j].Value = Now()
      Endif

    Else If $xOption[j] = "BS Date" Then
      aDateBoxR[j].Value = Now()

    Else If $xOption[j] = "User Profile" Then
      sVal = MedicalSelectedValue(("Select Physisican User"), modBasic.$OPConsulUserList)
      If sVal Then
        aLineTextR[j].Text = sVal[1]
      Endif

    Else If $xOption[j] = "ImageValue" Then
      sPath = modImage.DisplayVisualData($sCategory, $idList[j], "", $xOption[j])
      sVal = CustomDraw(sPath)
      If sVal Then
        aButtonBoxR[j].Text = sVal[0]
      Endif

    Else If $xOption[j] = "Visual Input" Then
      sPath = modImage.DisplayVisualData($sCategory, $idList[j], "", $xOption[j])
      If sPath Then
        xval = CVisualValue(lblitem.Text, sPath, aGenTextAreaR[j].Text)
        If xval Then
          aGenTextAreaR[j].Text = xval
        Endif
      Endif

    Else If $xOption[j] = "CopyValue" Then
      aGenTextAreaR[j].Text = modReportVar.GetLastQualiParamValue($xSource[j], $xExam[j], $encid)

    Else If $xOption[j] = "Calculated" Then
      If $xExam[j] = "Expression" Then
        aGenTextAreaR[j].Text = GetCalculateVariantR($xSysCons[j], $encid)
      Else If $xExam[j] = "Structured" Then
        aGenTextAreaR[j].Text = GetCalculateVariantR($xSysCons[j], $encid)
      Else
        xval = modAllExam.GetExamDefaultValue("Exam", $xExam[j])
        If xval Then
          aGenTextAreaR[j].Text = GetCalculateVariantR(xval, $encid)
        Else
          aGenTextAreaR[j].Text = ""
        Endif
      Endif

    Endif

  Endif

End

''Left
Private Sub OpenOptionL(j As Integer)

  Dim sVal As String[]
  Dim sPath As String
  Dim xval As String
  Dim xopt As String[]
  Dim acalc As Variant

  If $xType[j] = "Quantitative" Then
    ' If $xOption[j] = "Calculated" Then
    '   If $xExam[j] = "Expression" Then
    '     acalc = GetCalculateFloatL($xSysCons[j], $encid)
    '   Else If $xExam[j] = "Structured" Then
    '     acalc = GetCalculateFloatL($xSysCons[j], $encid)
    '   Else
    '     xval = modAllExam.GetExamDefaultValue("Exam", $xExam[j])
    '     If xval Then
    '       acalc = GetCalculateFloatL(xval, $encid)
    '     Endif
    '   Endif
    '   If acalc Then
    '     aQuantiBoxL[j].Value = acalc
    '   Else
    '     aQuantiBoxL[j].Value = 0
    '   Endif
    '
    ' Else If $xOption[j] = "CopyValue" Then
    '   acalc = modReportVar.GetLastQuantiParamValue($xSource[j], $xExam[j], $encid)
    '   If acalc Then
    '     aQuantiBoxL[j].Value = acalc
    '   Else
    '     aQuantiBoxL[j].Value = 0
    '   Endif
    '
    ' Else
    '   xflot = GetQuantiValues("Exam", $encid, $xitem[j], 0, 0, aQuantiBoxL[j].Value)
    '   If xflot Then
    '     acalc = xflot[0]
    '     If acalc Then
    '       aQuantiBoxL[j].Value = acalc
    '     Else
    '       aQuantiBoxL[j].Value = 0
    '     Endif
    '   Endif
    '
    ' Endif

  Else
    If $xOpList[j] Then
      xopt = Split($xOpList[j], "|")
    Endif

    If $xOption[j] = "No Selection" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aGenTextAreaL[j].Text = $xDefaultLst[j]
        Endif
      Endif
    Else If $xOption[j] = "RichText Area" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aHTMLTextL[j].RichText = $xDefaultLst[j]
        Endif
      Endif
    Else If $xOption[j] = "Qualitative" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aLineTextL[j].Text = $xDefaultLst[j]
        Endif
      Endif

    Else If $xOption[j] = "Single Selection" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Single Selection", $xitem[j])
        If sVal Then
          aComboBoxL[j].Text = sVal.Join(";")
        Endif
      Endif

    Else If $xOption[j] = "Dichotomous" Then

    Else If $xOption[j] = "Clinical Scale" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Clinical Scale", $xExam[j])
        If sVal Then
          aClinBoxL[j].Value = sVal[0]
          aTextAreaL[j].Text = sVal[1]
        Endif
      Endif

    Else If $xOption[j] = "Date Time" Then
      If $xExam[j] = "Expression" Then
        acalc = GetCalculateVariantL($xSysCons[j], $encid)
        If IsDate(acalc) Then
          aDateBoxL[j].Value = CDate(acalc)
        Endif
      Else If $xExam[j] = "Structured" Then
        acalc = GetCalculateVariantL($xSysCons[j], $encid)
        If IsDate(acalc) Then
          aDateBoxL[j].Value = CDate(acalc)
        Endif
      Else
        aDateBoxL[j].Value = Now()
      Endif

    Else If $xOption[j] = "BS Date" Then
      aDateBoxL[j].Value = Now()

    Else If $xOption[j] = "User Profile" Then
      sVal = MedicalSelectedValue(("Select Physisican User"), modBasic.$OPConsulUserList)
      If sVal Then
        aLineTextL[j].Text = sVal[1]
      Endif

    Else If $xOption[j] = "ImageValue" Then
      sPath = modImage.DisplayVisualData($sCategory, $idList[j], "", $xOption[j])
      sVal = CustomDraw(sPath)
      If sVal Then
        aButtonBoxL[j].Text = sVal[0]
      Endif

    Else If $xOption[j] = "Visual Input" Then
      sPath = modImage.DisplayVisualData($sCategory, $idList[j], "", $xOption[j])
      If sPath Then
        xval = CVisualValue(lblitem.Text, sPath, aGenTextAreaL[j].Text)
        If xval Then
          aGenTextAreaL[j].Text = xval
        Endif
      Endif

    Else If $xOption[j] = "CopyValue" Then
      aGenTextAreaL[j].Text = modReportVar.GetLastQualiParamValue($xSource[j], $xExam[j], $encid)

    Else If $xOption[j] = "Calculated" Then
      If $xExam[j] = "Expression" Then
        aGenTextAreaL[j].Text = GetCalculateVariantL($xSysCons[j], $encid)
      Else If $xExam[j] = "Structured" Then
        aGenTextAreaL[j].Text = GetCalculateVariantL($xSysCons[j], $encid)
      Else
        xval = modAllExam.GetExamDefaultValue("Exam", $xExam[j])
        If xval Then
          aGenTextAreaL[j].Text = GetCalculateVariantL(xval, $encid)
        Else
          aGenTextAreaL[j].Text = ""
        Endif
      Endif

    Endif

  Endif

End

''Right
Private Function GetCalculateVariantR(sFormula As String, encid As String) As Variant

  Dim i As Integer
  Dim xval As Variant

  If sFormula Then
    For i = 0 To $xCode.Count - 1
      If aGenTextAreaR[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", aGenTextAreaR[i].Text)
        Endif
      Else If aDateBoxR[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", Str(aDateBoxR[i].Value))
        Endif
        ' Else If aQuantiBoxR[i] Then
        '   If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
        '     sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", CStr(aQuantiBoxR[i].Value))
        '   Endif
      Endif
    Next
    If (String.InStr(sFormula, "$Calc[") > 0) Then
      sFormula = modReportVar.GetCalcValueVariant(sFormula, encid)
    Endif
    xval = sFormula

  Else
    xval = ""
  Endif

  Return xval

End

''Left
Private Function GetCalculateVariantL(sFormula As String, encid As String) As Variant

  Dim i As Integer
  Dim xval As Variant

  If sFormula Then
    For i = 0 To $xCode.Count - 1
      If aGenTextAreaL[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", aGenTextAreaL[i].Text)
        Endif
      Else If aDateBoxL[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", Str(aDateBoxL[i].Value))
        Endif
        ' Else If aQuantiBoxL[i] Then
        '   If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
        '     sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", CStr(aQuantiBoxL[i].Value))
        '   Endif
      Endif
    Next
    If (String.InStr(sFormula, "$Calc[") > 0) Then
      sFormula = modReportVar.GetCalcValueVariant(sFormula, encid)
    Endif
    xval = sFormula

  Else
    xval = ""
  Endif

  Return xval

End

' ''Right
' Private Function GetCalculateFloatR(sFormula As String, encid As String) As Float
'
'   Dim i As Integer
'   Dim xval As Float
'
'   If sFormula Then
'     For i = 0 To $xCode.Count - 1
'       If aGenTextAreaR[i] Then
'         If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
'           sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", aGenTextAreaR[i].Text)
'         Endif
'       Else If aDateBoxR[i] Then
'         If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
'           sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", Str(aDateBoxR[i].Value))
'         Endif
'         ' Else If aQuantiBoxR[i] Then
'         '   If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
'         '     sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", CStr(aQuantiBoxR[i].Value))
'         '   Endif
'       Endif
'     Next
'     If (String.InStr(sFormula, "$Calc[") > 0) Then
'       sFormula = modReportVar.GetCalcValueFloat(sFormula, encid)
'     Endif
'     xval = CFloat(sFormula)
'
'   Else
'     xval = 0
'   Endif
'
'   Return xval
'
' End

''Left
' Private Function GetCalculateFloatL(sFormula As String, encid As String) As Float
'
'   Dim i As Integer
'   Dim xval As Float
'
'   If sFormula Then
'     For i = 0 To $xCode.Count - 1
'       If aGenTextAreaL[i] Then
'         If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
'           sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", aGenTextAreaL[i].Text)
'         Endif
'       Else If aDateBoxL[i] Then
'         If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
'           sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", Str(aDateBoxL[i].Value))
'         Endif
'         ' Else If aQuantiBoxL[i] Then
'         '   If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
'         '     sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", CStr(aQuantiBoxL[i].Value))
'         '   Endif
'       Endif
'     Next
'     If (String.InStr(sFormula, "$Calc[") > 0) Then
'       sFormula = modReportVar.GetCalcValueFloat(sFormula, encid)
'     Endif
'     xval = CFloat(sFormula)
'
'   Else
'     xval = 0
'   Endif
'
'   Return xval
'
' End

''Right
Public Sub ImageBoxGroupR_Click()

  Dim j As Integer

  j = Last.Tag
  Dialog.Filter = ["*.jpg;*.jpeg;*.png;*.bmp", "Picture files"]
  If Dialog.OpenFile() Then Return
  aButtonBoxR[j].Text = Dialog.Path

End

''Left
Public Sub ImageBoxGroupL_Click()

  Dim j As Integer

  j = Last.Tag
  Dialog.Filter = ["*.jpg;*.jpeg;*.png;*.bmp", "Picture files"]
  If Dialog.OpenFile() Then Return
  aButtonBoxL[j].Text = Dialog.Path

End
