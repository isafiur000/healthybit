' Gambas class file

Private $refList As String[]
Private $ExamLst As String[]
Private $UserRestrict As String[]
Private $rData As Result
Private $aMyFields As String[]
Private $ProgressBar1 As ProgressBar
Private $SSQLFields As String[]
Private $ColCount As Integer
Private $newColumn As String[]
Private $RepoStr As String
Private $showList As String

Private $sTable As String
Private $sComp As String

Public Sub _new(sTable As String)

  $sTable = sTable

End

Public Sub Form_Open()

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Vertical")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  If $sTable = "tblconsult" Then
    Me.Title = "Consultation List"
    Me.Tag = "Consultation List"
    If modBasic.$LockToOwnConsultant = "Yes" Then
      btnconsult.Tag = modBasic.$lbluser
      btnconsult.Text = modGeneral.GetUserFullName(btnconsult.Tag)
      btnconsult.Enabled = False
    Endif
    $showList = modBasic.$ClinConsultationList
    dtsort.Value = Now()
  Else If $sTable = "tblopvisit" Then
    Me.Title = "OPD Visit List"
    Me.Tag = "OPD Visit List"
    $showList = modBasic.$ClinOPVisitList
    dtsort.Value = DateAdd(Now(), gb.Day, -1)
    txtrange.Value = 1
  Endif

  If MMain.$WebReport = "Multiple" Then
    xPanelentry.Visible = False
    yPanelEntry.Visible = False
    If modBasic.$HospCode Then
      ' cmblocation.Text = "Hospital"
      cmblocation.Text = modDataRepo.$RepositoryMode
      cmbvalue.Text = modBasic.$HospCode
      Panel3.Enabled = False
    Else
      cmblocation.List = ["Hospital", "Municipality", "Category", "District", "Province"]
    Endif
  Else
    Panel3.Visible = False
  Endif

  Select modHelpVariable.$LogInCategory
    Case "Research"
      mnudata.Enabled = True
      mnuhistoryall.Enabled = True
      mnuarchives.Enabled = True
      mnucustreport.Enabled = True
    Case "Clinician"
      mnudata.Enabled = True
      mnuhistoryall.Enabled = True
      mnuarchives.Enabled = True
      mnucustreport.Enabled = True
      mnuservices.Enabled = True
      mnucustforms.Enabled = True
      mnuformatexams.Enabled = True
      mnugotoform.Enabled = True
  End Select
  cmbunit.List = ["Metric", "SI Unit"]
  cmbunit.Text = "Metric"
  $UserRestrict = modBasic.$ClinicDisableCompo
  $refList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select fldlocation from tblreferlist"))

  If modBasic.$FixedDepartment Then
    cmbdept.Text = modBasic.$FixedDepartment
    If modBasic.$LockToOwnDepart = "Yes" Then
      cmbdept.Enabled = False
    Endif
  Else
    If $sTable = "tblconsult" Then
      cmbdept.List = modGeneral.GetDepartForConsultOnly()
      pnlconsult.Visible = True
    Else If $sTable = "tblopvisit" Then
      cmbdept.List = modGeneral.GetDepartForOPVisitOnly()
      pnlconsult.Visible = False
    Endif
    cmbdept.Add("All")
    cmbdept.Text = modSettings.ShowSettingFromFIle("Clinic/DefaultOPD")
  Endif
  If modBasic.$FixAdviceOPOutcome = "Enable" Then
    btnoutcome.Enabled = False
  Endif

  modSettings.ShowCheckBox(chkshowdepart, "OPDPatientList/ShowParameters")
  modSettings.ShowCheckBox(chkshowstatus, "OPDPatientList/ShowStatusIcons")
  modSettings.ShowCheckBox(chknotice, "OPDPatientList/ShowNotices")

  If modHelpVariable.$LogInCategory = "Clinician" Then
    GetComboItemList()
    xPanelentry.Visible = True
    yPanelEntry.Visible = True
  Endif

  $ExamLst = modMedicine.FillClinicalSubClass("Physician Examinations")
  FillCustomMenu()
  FillCustomFormMenu()
  FillExamMenu()
  modSettings.ShowCheckBox(chkdate, "OPDPatientList/SelectDate")
  dtsort.Enabled = chkdate.Value
  btnepsort.Enabled = chkdate.Value
  rbboth.Value = True
  rbdate.Value = True
  If cmbdept.Text Then
    btnrefresh_Click()
  Endif
  cmbdept.SetFocus

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Public Sub cmblocation_Click()

  cmbvalue.Clear()
  If cmblocation.Text Then
    cmbvalue.List = modDataRepo.GetRepoValueListType(cmblocation.Text)
  Endif

End

Public Sub ToolButton1_Click()

  Dim xcol As String

  xcol = InputColor("Triage", ToolButton1.Background)
  If xcol = CStr(Color.Transparent) Then
    ToolButton1.Background = Color.White
  Else
    If xcol Then
      ToolButton1.Background = CInt(xcol)
    Endif
  Endif

End

Public Sub btnepsort_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtsort.Value))
  If xx Then
    dtsort.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub chkdate_Click()

  dtsort.Enabled = chkdate.Value
  btnepsort.Enabled = chkdate.Value
  If chkdate.Value = False Then
    dtsort.Value = Now()
  Endif
  modSettings.EnterCheckSetting(chkdate, "OPDPatientList/SelectDate")

End

Public Sub Form_KeyRelease()

  If Key.Code = Key["S"] And If Key.Control Then
    btnoutcome_Click()
  Else If Key.Code = Key["D"] And If Key.Control Then
    btnmobilediagno_Click()
  Endif

End

Private Function LabUnitForm() As String

  Dim xx As String

  If cmbunit.Text = "SI Unit" Then
    xx = "SI"
  Else
    xx = "Metric"
  Endif
  Return xx

End

Public Sub btnconsult_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Consultant"), modBasic.$OPConsulUserList)
  If xMedUser And If xMedUser.Count Then
    btnconsult.Tag = xMedUser[0]
    btnconsult.Text = xMedUser[1]
  Else
    btnconsult.Tag = ""
    btnconsult.Text = ""
  Endif

End

Public Sub btnconsult_Change()

  If btnconsult.Text = "" Then
    btnconsult.Tag = ""
  Endif

End

Public Sub btnrefresh_Click()

  If cmbdept.Text Then
    If modBasic.$ClinMultiDeparts = "Enable" Then
      $sComp = modGeneral.GetFixCompFromDept(cmbdept.Text)
    Else
      $sComp = modBasic.$compID
    Endif
    Inc Application.Busy
    FillBedGrid()
    Dec Application.Busy
    modSettings.SaveSettingsToFile("Clinic/DefaultOPD", cmbdept.Text)
    GridView1.SetFocus
  Endif

End

Public Sub txtencid_Change()

  ' FillBedGrid()

End

Public Sub btnrefresh_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    btnrefresh_Click()
  Endif

End

Private Function GetFieldsList()

  Dim xhospfld As String

  xhospfld = modDataRepo.HospitalField()
  If $sTable = "tblconsult" Then
    $SSQLFields = ["fldid", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldflag", "fldencounterval", "flduserid", "fldconsultname", "fldconsulttime", "fldbillingmode", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldnotice"]
  Else If $sTable = "tblopvisit" Then
    $SSQLFields = ["fldid", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldflag", "fldencounterval", "fldencounterval", "fldconsultname", "fldconsulttime", "fldbillingmode", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldencounterval", "fldnotice"]
  Endif
  If xhospfld Then
    $SSQLFields.Add(xhospfld)
  Endif

End

Private Function GetSQLColumns() As String[]

  Dim xFldList As String[]
  Dim i As Integer
  Dim j As Integer

  GetFieldsList()
  modCustPatient.FillNewCOlumnCollection(Me.Tag)
  $newColumn = modCustPatient.CustomNewColumnsTitle(Me.Tag)
  xFldList = $SSQLFields.Copy()
  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      xFldList.Add("fldencounterval")
    Next
  Endif
  For j = 0 To xFldList.Count - 1
    xFldList[j] = $sTable & "." & xFldList[j]
  Next
  Return xFldList

End

Public Sub mnusearchconsult_Click()

  Dim xname As String
  Dim sql As String
  Dim xFldList As String[]
  Dim xpaid As String

  xname = InputBox(("Search Consultant UserID"), "Search", "")
  If xname Then
    cmbdept.Text = "All"
    xFldList = GetSQLColumns()
    If $showList = "Paid" Then
      xpaid = " and fldencounterval in(select fldencounterval from tblpatbilldetail)"
    Else
      xpaid = ""
    Endif
    sql = Subst("select " & xFldList.Join(",") & " from &1", $sTable) & " where fldstatus=&1 and flduserid=&2" & xpaid                      ''
    $rData = modDatabase.$myConn.Exec(sql, "Planned", xname)
    ResizeGrid()
  Endif

End

Public Sub mnusearchname_Click()

  Dim xname As String[]
  Dim sql As String
  Dim xFldList As String[]
  Dim xpaid As String

  xname = InputDoubleText(("Search Patient Name"), ["First Name", "SurName"], ["%", "%"], modBasic.$SurNameList)
  If xname Then
    cmbdept.Text = "All"
    xFldList = GetSQLColumns()
    If $showList = "Paid" Then
      xpaid = " and fldencounterval in(select fldencounterval from tblpatbilldetail)"
    Else
      xpaid = ""
    Endif
    sql = Subst("select " & xFldList.Join(",") & " from &1", $sTable) & " where fldstatus=&1 and fldencounterval in(select fldencounterval from tblencounter where fldpatientval in(select fldpatientval from tblpatientinfo where lower(fldptnamefir) like &2 and lower(fldptnamelast) like &3))" & xpaid                       ''
    $rData = modDatabase.$myConn.Exec(sql, "Planned", LCase(xname[0]), LCase(xname[1]))
    ResizeGrid()
  Endif

End

Private Sub FillBedGrid()

  Dim xFldList As String[]

  xFldList = GetSQLColumns()
  $rData = ExecuteQuery(xFldList)
  ResizeGrid()

End

Private Function ExecuteQuery(xFldList As String[]) As Result

  Dim res As Result
  Dim sql As String
  Dim xencid As String
  Dim xcolor As String
  Dim xorder As String
  Dim xconsult As String
  Dim xunion As String
  Dim xpreun As String
  Dim xpaid As String
  Dim xstate As String
  Dim xforward As String

  If Len(txtencid.Text) Then
    xencid = db.Subst(" and lower(" & $sTable & "." & "fldencounterval) like &1", LCase(Trim(txtencid.Text)))
  Else
    xencid = ""
  Endif

  If btnconsult.Tag Then
    xconsult = db.Subst(" and " & $sTable & "." & "flduserid like &1", btnconsult.Tag)
  Else
    xconsult = ""
  Endif

  If $showList = "Paid" Then
    xpaid = " and " & $sTable & "." & "fldencounterval in(select fldencounterval from tblpatbilldetail)"
  Else
    xpaid = ""
  Endif

  If rbname.Value = True Then
    xpreun = "("
    xunion = " inner join tblencounter on " & $sTable & "." & "fldencounterval=tblencounter.fldencounterval) inner join tblpatientinfo on tblencounter.fldpatientval=tblpatientinfo.fldpatientval"
    xorder = " ORDER BY tblpatientinfo.fldptnamefir"
  Else If rbdate.Value = True Then
    xpreun = ""
    xunion = ""
    xorder = " ORDER BY " & $sTable & "." & "fldconsulttime"
  Else If rbtriage.Value = True Then
    xpreun = ""
    xunion = " inner join tblencounter on " & $sTable & "." & "fldencounterval=tblencounter.fldencounterval"
    xorder = " ORDER BY FIELD(tblencounter.fldheight, '0', '65280', '16776960', '16711680') DESC"
  Endif

  If ToolButton1.Background = Color.White Then
    xcolor = ""
  Else
    If xunion Then
      xcolor = db.Subst(" and tblencounter.fldheight=&1", CStr(ToolButton1.Background))
    Else
      xunion = " inner join tblencounter on " & $sTable & "." & "fldencounterval=tblencounter.fldencounterval"
      xcolor = db.Subst(" and tblencounter.fldheight=&1", CStr(ToolButton1.Background))
    Endif
  Endif

  If xunion Then
    If rbopd.Value = True Then
      xstate = db.Subst(" and tblencounter.fldadmission<>&1", "Admitted")
    Else If rber.Value = True Then
      xstate = db.Subst(" and tblencounter.fldadmission<>&1 and tblencounter.fldadmitlocat in(select flddept from tbldepartment where fldactive=&2)", "Admitted", "Emergency")
    Else If rbipd.Value = True Then
      xstate = db.Subst(" and tblencounter.fldadmission=&1", "Admitted")
    Else
      xstate = ""
    Endif
  Else
    xunion = " inner join tblencounter on " & $sTable & "." & "fldencounterval=tblencounter.fldencounterval"
    If rbopd.Value = True Then
      xstate = db.Subst(" and tblencounter.fldadmission<>&1", "Admitted")
    Else If rber.Value = True Then
      xstate = db.Subst(" and tblencounter.fldadmission<>&1 and tblencounter.fldadmitlocat in(select flddept from tbldepartment where fldactive=&2)", "Admitted", "Emergency")
    Else If rbipd.Value = True Then
      xstate = db.Subst(" and tblencounter.fldadmission=&1", "Admitted")
    Else
      xstate = ""
    Endif
  Endif

  If mnureferred.Value = True Then
    xforward = Subst(" and &1.fldconsultname<>tblencounter.fldadmitlocat", $sTable)
  Else If mnureferred.Value = False Then
    xforward = ""
  Endif

  $RepoStr = modDataRepo.GetWhereStringRepo(cmblocation.Text, cmbvalue.Text, $sTable)
  If chkdate.Value = True Then
    If modBasic.$FixedDepartment Then
      sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & "  where " & $sTable & "." & "fldconsulttime>=&1 and " & $sTable & "." & "fldconsulttime<=&2 and " & $sTable & "." & "fldstatus=&3 and " & $sTable & "." & "fldconsultname=&4" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder                                           ''
      res = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(DateAdd(dtsort.Value, gb.Day, 0 - CInt(txtrange.Value))), modDate.EndSqlDate(dtsort.Value), "Planned", modBasic.$FixedDepartment)
    Else
      If cmbdept.Text = "All" Then
        sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldconsulttime>=&1 and " & $sTable & "." & "fldconsulttime<=&2 and " & $sTable & "." & "fldstatus=&3" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder                                             ''
      Else
        sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldconsulttime>=&1 and " & $sTable & "." & "fldconsulttime<=&2 and " & $sTable & "." & "fldstatus=&3 and " & $sTable & "." & "fldconsultname=&4" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder
      Endif
      res = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(DateAdd(dtsort.Value, gb.Day, 0 - CInt(txtrange.Value))), modDate.EndSqlDate(dtsort.Value), "Planned", cmbdept.Text)
    Endif

  Else
    If modBasic.$SQLDateRange = "Disable" Then
      If modBasic.$FixedDepartment Then
        sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldstatus=&1 and " & $sTable & "." & "fldconsultname=&2" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder                                            ''
        res = modDatabase.$myConn.Exec(sql, "Planned", modBasic.$FixedDepartment)
      Else
        If cmbdept.Text = "All" Then
          sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldstatus=&1" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder                                              ''
        Else
          sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldstatus=&1 and " & $sTable & "." & "fldconsultname=&2" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder
        Endif
        res = modDatabase.$myConn.Exec(sql, "Planned", cmbdept.Text)
      Endif

    Else
      If modBasic.$FixedDepartment Then
        sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & "  where " & $sTable & "." & "fldconsulttime>=&1 and " & $sTable & "." & "fldconsulttime<=&2 and " & $sTable & "." & "fldstatus=&3 and " & $sTable & "." & "fldconsultname=&4" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder                                           ''
        res = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(DateAdd(dtsort.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtsort.Value), "Planned", modBasic.$FixedDepartment)
      Else
        If cmbdept.Text = "All" Then
          sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldconsulttime>=&1 and " & $sTable & "." & "fldconsulttime<=&2 and " & $sTable & "." & "fldstatus=&3" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder                                             ''
        Else
          sql = Subst("select &1 from " & xpreun & "&2", xFldList.Join(","), $sTable) & xunion & " where " & $sTable & "." & "fldconsulttime>=&1 and " & $sTable & "." & "fldconsulttime<=&2 and " & $sTable & "." & "fldstatus=&3 and " & $sTable & "." & "fldconsultname=&4" & xencid & xconsult & xpaid & xcolor & xstate & xforward & $RepoStr & xorder
        Endif
        res = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(DateAdd(dtsort.Value, gb.Day, 0 - 365)), modDate.EndSqlDate(dtsort.Value), "Planned", cmbdept.Text)
      Endif

    Endif
  Endif
  Return res

End

Private Function GetGridViewValue(Column As Integer, xVariable As Variant) As Variant

  Dim xxx As Variant
  Dim i As Integer

  If Column = 1 Then
    xxx = modPatient.GetPatientColor(xVariable)
  Else If Column = 3 Then
    xxx = modPatient.GetPatientNameByEnc(xVariable, modDatabase.$syConn) & "<br>" & "<small>" & modPatient.ShowDiscountCategEnc(xVariable) & "</small>"
  Else If Column = 4 Then
    xxx = modPatient.GetPatientAgeString(xVariable, Now()) & modString.HTMLBlankSpace(1) & modPatient.GetPatientSex(xVariable, modDatabase.$syConn)    ''
  Else If Column = 5 Then
    If IsNull(xVariable) Then
      xxx = "icons/unchecked.png"
    Else
      If xVariable = True Then
        xxx = "icons/checked.png"
      Else If xVariable = False Then
        xxx = "icons/coll5.png"
      Endif
    Endif
  Else If Column = 6 Then
    xxx = modPatient.PatientDiagnoCurrentList(xVariable).Join(gb.NewLine)
  Else If Column = 7 Then
    If chkshowdepart.Value = True Then
      If $sTable = "tblconsult" Then
        xxx = modGeneral.GetUserFullName(xVariable)
      Endif
    Else
      xxx = ""
    Endif
  Else If Column = 9 Then
    If chkshowdepart.Value = True Then
      If chkdate.Value = True Then
        xxx = modReportVar.GetDateTimeReport(xVariable, gb.MediumTime)
      Else
        xxx = modReportVar.GetDateTimeReport(xVariable, gb.MediumDate)
      Endif
    Else
      xxx = ""
    Endif

  Else If Column = 11 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetMedicineClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 12 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetLabClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 13 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetRadioClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 14 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetEquipClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 15 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetFluidsClinStaus(xVariable))
    Else
      xxx = ""
    Endif
  Else If Column = 16 Then
    If chkshowstatus.Value = True Then
      xxx = GetClinStatusIcon(modClinSub.GetDeviceClinStaus(xVariable))
    Else
      xxx = ""
    Endif

  Else
    xxx = xVariable
  Endif

  If $newColumn.Count Then
    For i = 0 To $newColumn.Count - 1
      If Column = $ColCount + i Then
        xxx = modCustPatient.NewColValue(Me.Tag, $newColumn[i], xVariable)
      Endif
    Next
  Endif

  Return xxx

End

Private Sub ResizeGrid()

  Dim i As Integer

  Dim xvismode As String
  Dim noCols As Integer[]
  Dim Column As Integer

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)
  $ColCount = $SSQLFields.Count

  With GridView1
    .Rows.Height = 40 * modBasic.$AppWidthRatio
    .Columns[0].Width = 1
    .Columns[1].Width = 15 * modBasic.$AppWidthRatio
    .Columns[2].Width = 125 * modBasic.$AppWidthRatio
    .Columns[3].Width = 175 * modBasic.$AppWidthRatio
    .Columns[4].Width = 125 * modBasic.$AppWidthRatio
    .Columns[5].Width = 30 * modBasic.$AppWidthRatio
    .Columns[6].Width = 200 * modBasic.$AppWidthRatio
    If chkshowdepart.Value = True Then
      If $sTable = "tblconsult" Then
        .Columns[7].Width = 150 * modBasic.$AppWidthRatio
      Else If $sTable = "tblopvisit" Then
        .Columns[7].Width = 1
      Endif
      If cmbdept.Text = "All" Then
        .Columns[8].Width = 125 * modBasic.$AppWidthRatio
      Else
        .Columns[8].Width = 1
      Endif
      If chkdate.Value = True Then
        .Columns[9].Width = 1
      Else
        .Columns[9].Width = 125 * modBasic.$AppWidthRatio
      Endif
    Else
      .Columns[7].Width = 1
      .Columns[8].Width = 1
      .Columns[9].Width = 1
    Endif
    .Columns[10].Width = 1

    If chkshowstatus.Value = True Then
      .Columns[11].Width = 40 * modBasic.$AppWidthRatio
      .Columns[12].Width = 40 * modBasic.$AppWidthRatio
      .Columns[13].Width = 40 * modBasic.$AppWidthRatio
      .Columns[14].Width = 40 * modBasic.$AppWidthRatio
      .Columns[15].Width = 40 * modBasic.$AppWidthRatio
      .Columns[16].Width = 40 * modBasic.$AppWidthRatio
    Else
      .Columns[11].Width = 1
      .Columns[12].Width = 1
      .Columns[13].Width = 1
      .Columns[14].Width = 1
      .Columns[15].Width = 1
      .Columns[16].Width = 1
    Endif
    If chknotice.Value = True Then
      .Columns[17].Width = 125 * modBasic.$AppWidthRatio
    Else
      .Columns[17].Width = 1
    Endif

    .Columns[2].Text = "EncID"
    .Columns[3].Text = "Name"
    .Columns[4].Text = "Age/Sex"
    .Columns[6].Text = "Diagnosis"
    If chkshowdepart.Value = True Then
      If $sTable = "tblconsult" Then
        .Columns[7].Text = "Consultant"
      Endif
      If cmbdept.Text = "All" Then
        .Columns[8].Text = "Department"
      Endif
      If chkdate.Value = False Then
        .Columns[9].Text = "DateTime"
      Endif
    Endif

    If chkshowstatus.Value = True Then
      .Columns[11].Text = "Drugs"
      .Columns[12].Text = "Labs"
      .Columns[13].Text = "Radio"
      .Columns[14].Text = "Equip"
      .Columns[15].Text = "Fluid"
      .Columns[16].Text = "Device"
    Endif
    If chknotice.Value = True Then
      .Columns[17].Text = "Notice"
    Endif

    If $newColumn.Count Then
      For i = 0 To $newColumn.Count - 1
        .Columns[$ColCount + i].Text = $newColumn[i]
        .Columns[$ColCount + i].Width = 150 * modBasic.$AppWidthRatio
      Next
    Endif
  End With

  xvismode = modSettings.ShowSettingFromFIle("ReportColumnVisibility/VisibilityMode")
  If xvismode = "Yes" Then
    noCols = modCHTMLReport.HideColumnExport()
    For Column = 0 To GridView1.Columns.Count - 1
      If noCols.Exist(Column) = True Then
        GridView1.Columns[Column].Text = ""
        GridView1.Columns[Column].Width = 1
      Endif
    Next
  Endif

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 1 Then
    GridView1.Data.Text = ""
    GridView1.Data.Background = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 3 Then
    GridView1.Data.RichText = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 4 Then
    GridView1.Data.RichText = GetGridViewValue(Column, $rData[$aMyFields[Column]])
  Else If Column = 5 Then
    GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
    GridView1.Data.Alignment = Align.Center
  Else If Column = 11 Then
    If chkshowstatus.Value = True Then
      GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
      GridView1.Data.Alignment = Align.Center
    Endif
  Else If Column = 12 Then
    If chkshowstatus.Value = True Then
      GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
      GridView1.Data.Alignment = Align.Center
    Endif
  Else If Column = 13 Then
    If chkshowstatus.Value = True Then
      GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
      GridView1.Data.Alignment = Align.Center
    Endif
  Else If Column = 14 Then
    If chkshowstatus.Value = True Then
      GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
      GridView1.Data.Alignment = Align.Center
    Endif
  Else If Column = 15 Then
    If chkshowstatus.Value = True Then
      GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
      GridView1.Data.Alignment = Align.Center
    Endif
  Else If Column = 16 Then
    If chkshowstatus.Value = True Then
      GridView1.Data.Picture = Picture[GetGridViewValue(Column, $rData[$aMyFields[Column]])]
      GridView1.Data.Alignment = Align.Center
    Endif

  Else
    If Column > $SSQLFields.Count - 1 Then
      GridView1.Data.RichText = modString.TextToHTML(GetGridViewValue(Column, $rData[$aMyFields[Column]]))
    Else
      GridView1.Data.Text = GetGridViewValue(Column, $rData[$aMyFields[Column]])
    Endif
  Endif
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.RichText, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

Private Function GetClinStatusIcon(sVal As Integer) As String

  Dim xicon As String

  If sVal = 0 Then
    xicon = "icons/null.svg"
  Else If sVal = 1 Then
    xicon = "icons/coll5.png"
  Else If sVal = 2 Then
    xicon = "icons/coll6.png"
  Else If sVal = 3 Then
    xicon = "icons/coll4.png"
  Endif

  Return xicon

End

Public Sub GridView1_Click()

  Dim xData As String
  Dim Row As Integer

  Dim xlst As String[]

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    If GridView1.Column = 5 Then
      If GridView1[GridView1.Row, 5].Picture = Picture["icons/coll5.png"] Then
        modPatientSub.MarkConsultVisitFlag(GridView1[GridView1.Row, 0].Text, $sTable)
      Else If GridView1[GridView1.Row, 5].Picture = Picture["icons/unchecked.png"] Then
        modPatientSub.MarkConsultVisitFlag(GridView1[GridView1.Row, 0].Text, $sTable)
      Else If GridView1[GridView1.Row, 5].Picture = Picture["icons/checked.png"] Then
        modPatientSub.UnMarkConsultVisitFlag(GridView1[GridView1.Row, 0].Text, $sTable)
      Endif
      FillBedGrid()

    Else If GridView1.Column = 17 Then
      xlst = New String[]
      xData = InputCombo("Select Notice", GridView1[GridView1.Row, 2].Text, xlst, GridView1[GridView1.Row, 17].Text, False)
      If xData Then
        If $sTable = "tblconsult" Then
          modPatientSub.UpdateConsultNotice(GridView1[GridView1.Row, 0].Text, xData)
        Else If $sTable = "tblopvisit" Then
          modPatientSub.UpdateOPVisitNotice(GridView1[GridView1.Row, 0].Text, xData)
        Endif
      Endif
      FillBedGrid()

    Else
      If modBasic.$FixAdviceOPOutcome = "Enable" Then
        If modPatPatho.ShowSelectedNotes(GridView1[GridView1.Row, 2].Text, "Initial Planning") Then
          btnoutcome.Enabled = True
        Else
          btnoutcome.Enabled = False
        Endif
      Else
        btnoutcome.Enabled = True
      Endif
      SHowPatIndicators(GridView1[GridView1.Row, 2].Text)
      If modBasic.$ClinDefaultReport Then
        xData = modMisc.GetDefaultReportClinic(GridView1[GridView1.Row, 2].Text)
        If modGeneralMain.$RightAdView Then
          modGeneralMain.$RightAdView.SetHtml(xData)
          modGeneralMain.$RightAdView.Refresh()
        Endif
      Endif

    Endif
    GridView1.Row = Row
  Endif

End

Public Sub GridView1_DblClick()

  Dim xx As Integer
  Dim yy As Integer

  xx = Mouse.StartX - GridView1.Left
  yy = Mouse.StartY - GridView1.Top

  Balloon.Info(("Current Column is ") & CStr(GridView1.Column + 1), GridView1, xx, yy)
  Balloon.Delay = 1000

End

Public Sub mnurepoupload_Click()

  If GridView1.Rows.Selection.Count Then
    If Message.Question("Are you sure to upload this patient data to Data Repository ?", "NO", "YES") = 2 Then
      Inc Application.Busy
      modDataRepo.GetRepoUploadEncounterData(GridView1[GridView1.Row, 2].Text)
      Dec Application.Busy
    Endif
  Endif

Catch
  Dec Application.Busy

End

' ' Public Sub GridView1_Click()
' '
' '   If GridView1.Column = 7 Then
' '     GridView1.Enabled = False
' '     If modHelpVariable.$LogInCategory = "Clinician" Then
' '       OpenPatientForms()
' '     Endif
' '     GridView1.Enabled = True
' '   Endif
' '
' ' End

' ' Public Sub GridView1_KeyRelease()
' '
' '   If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
' '     If modHelpVariable.$LogInCategory = "Clinician" Then
' '       OpenPatientForms()
' '     Endif
' '   Endif
' '
' ' End

Public Sub cmbdept_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdept)
  modFillContainer.RestrictComboToContent(cmbdept)

End

Public Sub btnexpo_Click()

  Dim xHeader As String[]
  Dim xhide As Integer[]
  Dim Column As Integer
  Dim xCollRow As Collection
  Dim xColum As Integer

  Dim $hGridExportTable As CExportResult
  Dim xparam1 As String
  Dim xparam2 As String
  Dim encColumn As Integer

  Dim xFldList As String[]

  If MMain.$IsGUIApp = True Then
    $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
    $ProgressBar1.Visible = True
    $ProgressBar1.Value = 0
  Endif

  xHeader = New String[]
  xhide = New Integer[]
  For Column = 0 To GridView1.Columns.Count - 1
    xHeader.Add(GridView1.Columns[Column].Text)
    If GridView1.Columns[Column].Width < 5 Then
      xhide.Add(Column)
    Endif
  Next
  xparam1 = cmbdept.Text
  xparam2 = modReportVar.GetDateTimeReport(Now(), gb.GeneralDate)
  encColumn = 1
  $hGridExportTable = New CExportResult(Me.Tag, xHeader, xhide, xparam1, xparam2, encColumn)

  Inc Application.Busy
  xFldList = GetSQLColumns()

  For Each $rData
    xCollRow = New Collection
    For xColum = 0 To xFldList.Count - 1
      xCollRow.Add(GetGridViewValue(xColum, $rData[xFldList[xColum]]), CStr(xColum))
    Next
    $hGridExportTable.Add($rData.Index, xCollRow)

    If MMain.$IsGUIApp = True Then
      $ProgressBar1.Value = ($rData.Index + 1) / $rData.Count
      Wait
    Endif
  Next

  Dec Application.Busy
  If MMain.$IsGUIApp = True Then
    $ProgressBar1.Visible = False
  Endif
  modControlSub.DisplayReportExport($hGridExportTable.HTMLPath())

End

''================= REPORTS ==========================
Public Sub mnuaddcolumn_Click()

  Dim hForm As FmAddNewColumn

  hForm = New FmAddNewColumn(Me.Tag)
  hForm.ShowModal

End

''============================== Mobile apps ===========================
Public Sub btnmobilevital_Click()

  Dim hForm As FmVItalMobile

  If GridView1.Rows.Selection.Count Then
    hForm = New FmVItalMobile(GridView1[GridView1.Row, 2].Text)
    hForm.ShowModal
  Endif

End

Public Sub btnoutcome_Click()

  Dim hForm As FmOPOutcome

  If GridView1.Rows.Selection.Count Then
    If modPathoSub.AllowOPOutcomeDiagno(GridView1[GridView1.Row, 2].Text) = True Then
      If $sTable = "tblconsult" Then
        hForm = New FmOPOutcome("Consultation", GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 0].Text)
      Else If $sTable = "tblopvisit" Then
        hForm = New FmOPOutcome("OP Visit", GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 0].Text)
      Endif
      hForm.ShowModal
      FillBedGrid()
      Balloon.Info(("Information updated"), btnoutcome)
      Balloon.Delay = modBasic.$BalloonDelay
      GridView1.SetFocus
    Endif
  Endif

End

Public Sub mnudemographic_Click()

  Dim hForm7 As FmPatdemograph

  If GridView1.Rows.Selection.Count Then
    hForm7 = New FmPatdemograph(GridView1[GridView1.Row, 2].Text, "Clinical")
    hForm7.ShowModal
  Endif

End

Public Sub btnmobilediagno_Click()

  Dim sName As String[]
  Dim Row As Integer

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    If MMain.$Ayurveda = "Yes" Then
      sName = AyurvedicDiagnosis(modAMISRep.$AyurvedicDiagnosis)
    Else
      sName = ICDTree(modDatabase.$icdConn, "Disease", modBasic.$ClinDiagnoChapterGrouped, modBasic.$FixDiagnoGroupOPD, modBasic.$FixDiagnoGroupER, modBasic.$ClinDiagnoSelectGrouped, modBasic.$ClinDiagnoSelectERGroup)
    Endif
    If sName Then
      If sName[1] And If sName[0] Then
        modPatientGeneral.AddPatientFindings("Provisional Diagnosis", GridView1[GridView1.Row, 2].Text, sName[0], sName[1], sName[2])
        FillBedGrid()
      Endif
    Endif
    GridView1.Row = Row
  Endif

End

Public Sub btnobsdiagno_Click()

  Dim xsex As String
  Dim sName As String[]
  Dim Row As Integer

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    xsex = modPatient.GetPatientSex(GridView1[GridView1.Row, 2].Text, modDatabase.$myConn)
    If xsex = "Female" Then
      sName = DiagnoObstetrics(GridView1[GridView1.Row, 2].Text, True)
      FillBedGrid()
    Endif
    GridView1.Row = Row
  Endif

End

Public Sub btnIPform_Click()

  Dim hForm As FmPatCliNew
  Dim hForm1 As FmNursingForm
  Dim xcomm As String
  Dim xval As String

  If GridView1.Rows.Selection.Count Then
    If modGeneralMain.$HideFormList.Exist("Clinician Form") = True Then
      hForm1 = New FmNursingForm(GridView1[GridView1.Row, 2].Text, True)
      modWorkSpace.Add(hForm1)
    Else

      xcomm = GetConsultPrecomment(GridView1[GridView1.Row, 0].Text)
      If xcomm Then
        xval = MessageHtml("Pre Comment", xcomm, ["Proceed"])
      Endif
      If $sTable = "tblconsult" Then
        hForm = New FmPatCliNew(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 0].Text, "Consultation", $sComp, True)
      Else If $sTable = "tblopvisit" Then
        hForm = New FmPatCliNew(GridView1[GridView1.Row, 2].Text, GridView1[GridView1.Row, 0].Text, "OP Visit", $sComp, True)
      Endif
      modWorkSpace.Add(hForm)

    Endif
  Endif

End

Public Sub btnvideo_Click()

  Dim hForm8 As FmPatVideo

  If GridView1.Rows.Selection.Count Then
    hForm8 = New FmPatVideo("VIDEO", GridView1[GridView1.Row, 2].Text, "")
    hForm8.ShowModal
  Endif

End

Public Sub btnlabs_Click()

  Dim hForm10 As FmTestList

  If GridView1.Rows.Selection.Count Then
    If modNonMedical.AllowEntryWithDeposit(GridView1[GridView1.Row, 2].Text, "Test") = True Then
      hForm10 = New FmTestList(GridView1[GridView1.Row, 2].Text, modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
      hForm10.ShowModal
      SHowPatIndicators(GridView1[GridView1.Row, 2].Text)
    Endif
  Endif

End

Public Sub btnradio_Click()

  Dim hForm11 As FmRadioList

  If GridView1.Rows.Selection.Count Then
    If modNonMedical.AllowEntryWithDeposit(GridView1[GridView1.Row, 2].Text, "Radio") = True Then
      hForm11 = New FmRadioList(GridView1[GridView1.Row, 2].Text, modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
      hForm11.ShowModal
      SHowPatIndicators(GridView1[GridView1.Row, 2].Text)
    Endif
  Endif

End

Public Sub btnpharm_Click()

  Dim hForm12 As FmMedOrder

  If GridView1.Rows.Selection.Count Then
    If modNonMedical.AllowEntryWithDeposit(GridView1[GridView1.Row, 2].Text, "Pharmacy") = True Then
      If modBasic.$MedRequestForm = "Separate" Then
      Else
        hForm12 = New FmMedOrder(GridView1[GridView1.Row, 2].Text, "Registered", modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
        hForm12.ShowModal
      Endif
      SHowPatIndicators(GridView1[GridView1.Row, 2].Text)
    Endif
  Endif

End

Public Sub btndosing_Click()

  Dim hForm4 As FmDoseMobile

  If GridView1.Rows.Selection.Count Then
    hForm4 = New FmDoseMobile(GridView1[GridView1.Row, 2].Text)
    hForm4.ShowModal
  Endif

End

Public Sub mnucomplete_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetSelectedPatientValues(GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub btnopdsheet_Click()

  Dim hCls As CReportCustom
  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    If modPathoSub.AllowOPOutcomeDiagno(GridView1[GridView1.Row, 2].Text) = True Then
      If modPatientSub.GetClearanceForExit(GridView1[GridView1.Row, 2].Text) = True Then

        If modSettings.ShowSettingFromFIle("OPD Sheet/Name") Then
          If $sTable = "tblconsult" Then
            hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, "OPD Sheet", "ReportSize", LabUnitForm(), "Consultation|" & CStr(GridView1[GridView1.Row, 0].Text))
          Else If $sTable = "tblopvisit" Then
            hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, "OPD Sheet", "ReportSize", LabUnitForm(), "OPVisit|" & CStr(GridView1[GridView1.Row, 0].Text))
          Endif
          hCls.Preview()
        Else
          Inc Application.Busy
          xPath = modPatReports.ShowOPatSummary(GridView1[GridView1.Row, 2].Text)
          Dec Application.Busy
          modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
        Endif

      Endif
    Endif
  Endif

End

Public Sub btnadvice_Click()

  Dim xboolean As Boolean
  Dim xval As String

  If modBasic.$ClinHistoryInput = "Single" Then
    xboolean = True
  Else
    xboolean = False
  Endif

  If GridView1.Rows.Selection.Count Then
    xval = GetRichTextArea("Clinician Advice", modPatPatho.ShowSelectedNotes(GridView1[GridView1.Row, 2].Text, "Initial Planning"))
    If xval Then
      modPatientGeneral.AddPatientParagraph(GridView1[GridView1.Row, 2].Text, "Notes", "Initial Planning", "", xval, xboolean)
      btnoutcome.Enabled = True
    Endif
  Endif

End

Public Sub btnmobexamall_Click()

  Dim hForm As FmEnterGroupExam

  If GridView1.Rows.Selection.Count Then
    hForm = New FmEnterGroupExam(GridView1[GridView1.Row, 2].Text, "Physician Examinations", "All", $sComp)
    hForm.ShowModal
  Endif

End

Public Sub btnmobexam_Click()

  Dim xClinOpd As String
  Dim hForm As FmEnterGroupExam
  Dim hForm1 As FmWardHistory
  Dim hForm2 As FmExamAttach

  If GridView1.Rows.Selection.Count Then
    xClinOpd = modGlobalSetting.ShowSettingFromDBAny("ClinicForms/OPDExaminations", $sComp)
    If xClinOpd Then
      Select xClinOpd
        Case "Neurology Form"
          hForm2 = New FmExamAttach(GridView1[GridView1.Row, 2].Text, "Neurology", "Physician Examinations", True)
          modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm2)
        Case "Refraction Form"
          hForm2 = New FmExamAttach(GridView1[GridView1.Row, 2].Text, "Optometry", "Physician Examinations", True)
          modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm2)
        Case "ANC Visit Form"
          hForm2 = New FmExamAttach(GridView1[GridView1.Row, 2].Text, "ANC Visit", "Physician Examinations", True)
          modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm2)
        Case Else
          hForm1 = New FmWardHistory(xClinOpd, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
          modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm1)
      End Select
    Else
      hForm = New FmEnterGroupExam(GridView1[GridView1.Row, 2].Text, "Physician Examinations", "Group", $sComp)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnmobprogress_Click()

  Dim hForm As FmBloodReq

  If GridView1.Rows.Selection.Count Then
    hForm = New FmBloodReq(GridView1[GridView1.Row, 2].Text, modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
    hForm.ShowModal
  Endif

End

Public Sub btnmobequip_Click()

  Dim hForm6 As FmEquipment

  If GridView1.Rows.Selection.Count Then
    If modNonMedical.AllowEntryWithDeposit(GridView1[GridView1.Row, 2].Text, "Equipment") = True Then
      hForm6 = New FmEquipment(GridView1[GridView1.Row, 2].Text, modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
      hForm6.ShowModal
      SHowPatIndicators(GridView1[GridView1.Row, 2].Text)
    Endif
  Endif

End

Public Sub btnmobevent_Click()

  Dim hForm9 As FmDeviceUse

  If GridView1.Rows.Selection.Count Then
    hForm9 = New FmDeviceUse(GridView1[GridView1.Row, 2].Text, "Devices")
    hForm9.ShowModal
    SHowPatIndicators(GridView1[GridView1.Row, 2].Text)
  Endif

End

Public Sub btnmobimage_Click()

  Dim hForm8 As FmPatImage

  If GridView1.Rows.Selection.Count Then
    hForm8 = New FmPatImage("IMAGE", GridView1[GridView1.Row, 2].Text, "")
    hForm8.ShowModal
  Endif

End

Public Sub btnmobpacs_Click()

  Dim hForm As FmPacsFind
  Dim hForm1 As FmWebKitNormal

  If GridView1.Rows.Selection.Count Then
    If modBasic.$RadioPACSForm = "Embedded" Then
      hForm1 = New FmWebKitNormal("", GridView1[GridView1.Row, 2].Text, "PACS")
      modWorkSpace.Add(hForm1)
    Else
      hForm = New FmPacsFind(GridView1[GridView1.Row, 2].Text, "Visit")
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnmobivfl_Click()

  Dim hForm18 As FmIVInfusion

  If GridView1.Rows.Selection.Count Then
    hForm18 = New FmIVInfusion(GridView1[GridView1.Row, 2].Text)
    hForm18.ShowModal
  Endif

End

Public Sub btnmobminor_Click()

  Dim hForm5 As FmMiniProcedure

  If GridView1.Rows.Selection.Count Then
    If modNonMedical.AllowEntryWithDeposit(GridView1[GridView1.Row, 2].Text, "Procedure") = True Then
      hForm5 = New FmMiniProcedure(GridView1[GridView1.Row, 2].Text, modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
      hForm5.ShowModal
    Endif
  Endif

End

Public Sub btnmobbill_Click()

  Dim hForm14 As FmMiniService
  Dim xmode As String

  If GridView1.Rows.Selection.Count Then
    xmode = modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID)
    hForm14 = New FmMiniService(GridView1[GridView1.Row, 2].Text, xmode, xmode, xmode)
    hForm14.ShowModal
  Endif

End

Public Sub btndraw_Click()

  Dim sPath As String
  Dim xxx As String[]
  Dim xval As String

  If GridView1.Rows.Selection.Count Then
    xxx = CustomDraw()
    If xxx Then
      sPath = xxx[0]
      If sPath Then
        xval = modImage.SaveClinicScreenDraw(GridView1[GridView1.Row, 2].Text, xxx[1], sPath)
      Endif
    Endif
  Endif

End

Public Sub btntriage_Click()

  Dim xcol As String
  Dim Row As Integer

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    xcol = InputColor("Triage", GridView1[GridView1.Row, 0].Background)
    If xcol Then
      modPatient.SetPatientColor(GridView1[GridView1.Row, 2].Text, xcol)
      GridView1[GridView1.Row, 0].Background = xcol
    Endif
    GridView1.Row = Row
  Endif

End

''''------------------------------- custom report menu ---------------------------------------------------
Private Sub FillCustomMenu()

  Dim xform1 As String
  Dim xform2 As String
  Dim xform3 As String
  Dim xform4 As String
  Dim xform5 As String
  Dim xform6 As String
  Dim xform7 As String
  Dim xform8 As String
  Dim xform9 As String
  Dim xform10 As String

  xform1 = modSettings.ShowSettingFromFIle("CustomReport1/Name")
  xform2 = modSettings.ShowSettingFromFIle("CustomReport2/Name")
  xform3 = modSettings.ShowSettingFromFIle("CustomReport3/Name")
  xform4 = modSettings.ShowSettingFromFIle("CustomReport4/Name")
  xform5 = modSettings.ShowSettingFromFIle("CustomReport5/Name")
  xform6 = modSettings.ShowSettingFromFIle("CustomReport6/Name")
  xform7 = modSettings.ShowSettingFromFIle("CustomReport7/Name")
  xform8 = modSettings.ShowSettingFromFIle("CustomReport8/Name")
  xform9 = modSettings.ShowSettingFromFIle("CustomReport9/Name")
  xform10 = modSettings.ShowSettingFromFIle("CustomReport10/Name")

  If xform1 Then
    mnucust1.Caption = xform1
    mnucust1.Tag = "CustomReport1"
    mnucust1.Enabled = True
  Endif

  If xform2 Then
    mnucust2.Caption = xform2
    mnucust2.Tag = "CustomReport2"
    mnucust2.Enabled = True
  Endif

  If xform3 Then
    mnucust3.Caption = xform3
    mnucust3.Tag = "CustomReport3"
    mnucust3.Enabled = True
  Endif

  If xform4 Then
    mnucust4.Caption = xform4
    mnucust4.Tag = "CustomReport4"
    mnucust4.Enabled = True
  Endif

  If xform5 Then
    mnucust5.Caption = xform5
    mnucust5.Tag = "CustomReport5"
    mnucust5.Enabled = True
  Endif

  If xform6 Then
    mnucust6.Caption = xform6
    mnucust6.Tag = "CustomReport6"
    mnucust6.Enabled = True
  Endif

  If xform7 Then
    mnucust7.Caption = xform7
    mnucust7.Tag = "CustomReport7"
    mnucust7.Enabled = True
  Endif

  If xform8 Then
    mnucust8.Text = xform8
    mnucust8.Tag = "CustomReport8"
    mnucust8.Enabled = True
  Endif

  If xform9 Then
    mnucust9.Caption = xform9
    mnucust9.Tag = "CustomReport9"
    mnucust9.Enabled = True
  Endif

  If xform10 Then
    mnucust10.Caption = xform10
    mnucust10.Tag = "CustomReport10"
    mnucust10.Enabled = True
  Endif

End

Public Sub mnucust1_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust1.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust2_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust2.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust3_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust3.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust4_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust4.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust5_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust5.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust6_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust6.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust7_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust7.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust8_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust8.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust9_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust9.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust10_Click()

  Dim hCls As CReportCustom

  If GridView1.Rows.Selection.Count Then
    hCls = New CReportCustom(GridView1[GridView1.Row, 2].Text, mnucust10.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

''========================= chart =====================================
Public Sub mnuessenexam_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, "Essential Examinations", LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Private Sub FillCustomFormMenu()

  Dim xList As String[]

  xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldtitle) as col from tbldepartchart where (fldcomp=&1 or fldcomp=&2)", modBasic.$compID, "%"))

  If xList.Count > 0 Then
    mnucustform1.Caption = xList[0]
    mnucustform1.Tag = xList[0]
    mnucustform1.Enabled = True
  Endif

  If xList.Count > 1 Then
    mnucustform2.Caption = xList[1]
    mnucustform2.Tag = xList[1]
    mnucustform2.Enabled = True
  Endif

  If xList.Count > 2 Then
    mnucustform3.Caption = xList[2]
    mnucustform3.Tag = xList[2]
    mnucustform3.Enabled = True
  Endif

  If xList.Count > 3 Then
    mnucustform4.Caption = xList[3]
    mnucustform4.Tag = xList[3]
    mnucustform4.Enabled = True
  Endif

  If xList.Count > 4 Then
    mnucustform5.Caption = xList[4]
    mnucustform5.Tag = xList[4]
    mnucustform5.Enabled = True
  Endif

  If xList.Count > 5 Then
    mnucustform6.Caption = xList[5]
    mnucustform6.Tag = xList[5]
    mnucustform6.Enabled = True
  Endif

  If xList.Count > 6 Then
    mnucustform7.Caption = xList[6]
    mnucustform7.Tag = xList[6]
    mnucustform7.Enabled = True
  Endif

  If xList.Count > 7 Then
    mnucustform8.Caption = xList[7]
    mnucustform8.Tag = xList[7]
    mnucustform8.Enabled = True
  Endif

  If xList.Count > 8 Then
    mnucustform9.Caption = xList[8]
    mnucustform9.Tag = xList[8]
    mnucustform9.Enabled = True
  Endif

  If xList.Count > 9 Then
    mnucustform10.Caption = xList[9]
    mnucustform10.Tag = xList[9]
    mnucustform10.Enabled = True
  Endif

End

Public Sub mnucustform1_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform1.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform2_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform2.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform3_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform3.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform4_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform4.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform5_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform5.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform6_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform6.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform7_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform7.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform8_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform8.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform9_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform9.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform10_Click()

  Dim hForm As FmMultiChart

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMultiChart(GridView1[GridView1.Row, 2].Text, mnucustform10.Tag, LabUnitForm())
    modWorkSpace.Add(hForm)
  Endif

End

''========================= Indicators ================

Private Sub SHowPatIndicators(encid As String)

  Dim xlab As Boolean
  Dim xradio As Boolean
  Dim xpharm As Boolean
  Dim xequip As Boolean
  Dim xevent As Boolean

  xlab = modClinSub.GetLabTestPending(encid)
  If xlab = True Then
    btnlabs.Foreground = Color.Red
  Else
    btnlabs.Foreground = Color.Default
  Endif

  xradio = modClinSub.GetRadioTestPending(encid)
  If xradio = True Then
    btnradio.Foreground = Color.Red
  Else
    btnradio.Foreground = Color.Default
  Endif

  xpharm = modClinSub.GetPharmacyPending(encid)
  If xpharm = True Then
    btnpharm.Foreground = Color.Red
  Else
    btnpharm.Foreground = Color.Default
  Endif

  xequip = modClinSub.GetEquipmentPending(encid)
  If xequip = True Then
    btnmobequip.Foreground = Color.Red
  Else
    btnmobequip.Foreground = Color.Default
  Endif

  xevent = modClinSub.GetDevicePending(encid)
  If xevent = True Then
    btnmobevent.Foreground = Color.Red
  Else
    btnmobevent.Foreground = Color.Default
  Endif

End

Public Sub mnucurarchive_Click()

  Dim xxx As String[]

  If GridView1.Rows.Selection.Count Then
    xxx = AddReports(GridView1[GridView1.Row, 2].Text, False)
  Endif

End

Public Sub mnulabview_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modCHTMLPatient.ShowPatientLaboratoryReport(GridView1[GridView1.Row, 2].Text, LabUnitForm())
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnucurvisitsumm_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modPatReportAll.GetOPDSummaryReportAllComp(GridView1[GridView1.Row, 2].Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnuallhistory_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modPatReports.ShowPatientHistoryReport(GridView1[GridView1.Row, 2].Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnuplanningall_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modPatReports.ShowPatientNoteReport(GridView1[GridView1.Row, 2].Text, "Outpatient Notes")
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnuexamview_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modCHTMLPatient.ShowPatientExaminationgReport(GridView1[GridView1.Row, 2].Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnuvitalexam_Click()

  Dim hForm As FmVitalTable

  If GridView1.Rows.Selection.Count Then
    hForm = New FmVitalTable(GridView1[GridView1.Row, 2].Text)
    hForm.ShowModal()
  Endif

End

Public Sub mnuradioview_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modCHTMLPatient.ShowPatRadioReportbyEncID(GridView1[GridView1.Row, 2].Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnumedview_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modCHTMLPatient.ShowNursingDosing(GridView1[GridView1.Row, 2].Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Public Sub mnuexpense_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count Then
    Inc Application.Busy
    xPath = modCHTMLInvoice.ShowTotalExpensebyPatient(modDatabase.$syConn, GridView1[GridView1.Row, 2].Text, "Complete")
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(GridView1[GridView1.Row, 2].Text, xPath, "ReportSize")
  Endif

End

Private Sub GetComboItemList()

  If $UserRestrict.Exist("Initial Planning") = False Then
    btnadvice.Enabled = True
  Endif
  If $UserRestrict.Exist("Provisional Diagnosis") = False Then
    btnmobilediagno.Enabled = True
    btnobsdiagno.Enabled = True
  Endif
  If $UserRestrict.Exist("Demographics") = False Then
    mnudemographic.Enabled = True
  Endif
  If $UserRestrict.Exist("Consultation Plan") = False Then
    mnureqconsult.Enabled = True
  Endif
  If $UserRestrict.Exist("Essential Examinations") = False Then
    btnmobilevital.Enabled = True
    btntriage.Enabled = True
  Endif
  If $UserRestrict.Exist("Medicine Dosing") = False Then
    btndosing.Enabled = True
  Endif
  If $UserRestrict.Exist("IV Infusion") = False Then
    btnmobivfl.Enabled = True
  Endif
  If $UserRestrict.Exist("General Services") = False Then
    btnmobbill.Enabled = True
  Endif
  If $UserRestrict.Exist("Minor Procedure") = False Then
    btnmobminor.Enabled = True
  Endif
  If $UserRestrict.Exist("Equipments Used") = False Then
    btnmobequip.Enabled = True
  Endif
  If $UserRestrict.Exist("General Images") = False Then
    btnmobimage.Enabled = True
    btndraw.Enabled = True
  Endif
  If $UserRestrict.Exist("Video Data") = False Then
    btnvideo.Enabled = True
  Endif
  If $UserRestrict.Exist("PACS Images") = False Then
    btnmobpacs.Enabled = True
  Endif
  If $UserRestrict.Exist("Devices Used") = False Then
    btnmobevent.Enabled = True
  Endif
  If $UserRestrict.Exist("Clinical Findings") = False Then
    btnmobexam.Enabled = True
    btnmobexamall.Enabled = True
  Endif
  If $UserRestrict.Exist("Products Request") = False Then
    btnmobprogress.Enabled = True
  Endif

  If $UserRestrict.Exist("Laboratory Request") = False Then
    btnlabs.Enabled = True
  Endif
  If $UserRestrict.Exist("Radiology Request") = False Then
    btnradio.Enabled = True
  Endif
  If $UserRestrict.Exist("Pharmacy Request") = False Then
    btnpharm.Enabled = True
  Endif

End

''===================== Structured exams==========================
Private Sub FillExamMenu()

  If $ExamLst.Count > 0 Then
    mnurec1.Text = $ExamLst[0]
    mnurec1.Enabled = True
  Endif

  If $ExamLst.Count > 1 Then
    mnurec2.Text = $ExamLst[1]
    mnurec2.Enabled = True
  Endif

  If $ExamLst.Count > 2 Then
    mnurec3.Text = $ExamLst[2]
    mnurec3.Enabled = True
  Endif

  If $ExamLst.Count > 3 Then
    mnurec4.Text = $ExamLst[3]
    mnurec4.Enabled = True
  Endif

  If $ExamLst.Count > 4 Then
    mnurec5.Text = $ExamLst[4]
    mnurec5.Enabled = True
  Endif

  If $ExamLst.Count > 5 Then
    mnurec6.Text = $ExamLst[5]
    mnurec6.Enabled = True
  Endif

  If $ExamLst.Count > 6 Then
    mnurec7.Text = $ExamLst[6]
    mnurec7.Enabled = True
  Endif

  If $ExamLst.Count > 7 Then
    mnurec8.Text = $ExamLst[7]
    mnurec8.Enabled = True
  Endif

  If $ExamLst.Count > 8 Then
    mnurec9.Text = $ExamLst[8]
    mnurec9.Enabled = True
  Endif

  If $ExamLst.Count > 9 Then
    mnurec10.Text = $ExamLst[9]
    mnurec10.Enabled = True
  Endif

End

Public Sub mnurec1_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec1.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec2_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec2.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec3_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec3.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec4_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec4.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec5_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec5.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec6_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec6.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec7_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec7.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec8_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec8.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec9_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec9.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec10_Click()

  Dim hForm As FmWardHistory

  If GridView1.Rows.Selection.Count Then
    hForm = New FmWardHistory(mnurec10.Text, GridView1[GridView1.Row, 2].Text, "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnustruct_Click()

  Dim hForm As FmExamReporting

  If GridView1.Rows.Selection.Count Then
    hForm = New FmExamReporting(GridView1[GridView1.Row, 2].Text, True)
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub btnpersonal_Click()

  Dim xPath As String

  Inc Application.Busy
  If chkdate.Value Then
    xPath = modCHTMLPatSummary.GetDoctorClearConsultReport($sTable, modBasic.$lbluser, cmbdept.Text, dtsort.Value)
  Else
    xPath = modCHTMLPatSummary.GetDoctorClearConsultReport($sTable, modBasic.$lbluser, cmbdept.Text)
  Endif
  Dec Application.Busy
  modControlSub.OpenHTMLPreview("", xPath, "ReportSize")

End

''------------------------- Services ---------------
Public Sub mnugenviolence_Click()

  Dim hForm As FmGenViolence

  If GridView1.Rows.Selection.Count Then
    hForm = New FmGenViolence(GridView1[GridView1.Row, 2].Text)
    hForm.ShowModal
  Endif

End

Public Sub mnumaternal_Click()

  Dim hForm As FmMaternalMobile
  Dim xsex As String

  If GridView1.Rows.Selection.Count Then
    xsex = modPatient.GetPatientSex(GridView1[GridView1.Row, 2].Text, modDatabase.$myConn)
    If xsex = "Female" Then
      hForm = New FmMaternalMobile(GridView1[GridView1.Row, 2].Text)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub mnuvaccination_Click()

  Dim hForm As FmVaccine

  If GridView1.Rows.Selection.Count Then
    hForm = New FmVaccine(GridView1[GridView1.Row, 2].Text)
    hForm.ShowModal
  Endif

End

Public Sub mnureqconsult_Click()

  Dim hForm As FmMiniConsult

  If GridView1.Rows.Selection.Count Then
    hForm = New FmMiniConsult(GridView1[GridView1.Row, 2].Text, modNonMedical.DefaultBillingScheme(GridView1[GridView1.Row, 2].Text, modBasic.$compID))
    hForm.ShowModal
  Endif

End

Public Sub mnuscanner_Click()

  Dim hForm As FmScanForm

  If GridView1.Rows.Selection.Count Then
    hForm = New FmScanForm(GridView1[GridView1.Row, 2].Text, "Scanned Images", "")
    hForm.ShowModal
  Endif

End

Private Function GetConsultPrecomment(sIndex As Long) As String

  Dim res As Result
  Dim xx As String

  res = modDatabase.$myConn.Exec(Subst("select fldpresummary from &1", $sTable) & " where fldid=&1", sIndex)
  If res.Available Then
    xx = res["fldpresummary"]
  Else
    xx = ""
  Endif
  Return xx

End

Public Sub mnuviewcomment_Click()

  Dim Row As Integer
  Dim xval As String

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    xval = MessageHtml("Pre Comment", GetConsultPrecomment(GridView1[GridView1.Row, 0].Text), ["OK"])
    GridView1.Row = Row
  Endif

End

Public Sub mnuconsultant_Click()

  Dim xMedUser As String[]
  Dim xuser As String
  Dim Row As Integer

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    xMedUser = MedicalSelectedValue(("Select Consultant"), modBasic.$OPConsulUserList)
    If xMedUser And If xMedUser.Count Then
      xuser = xMedUser[0]
    Endif

    If xuser And If GridView1[GridView1.Row, 2].Text Then
      If Not GridView1[GridView1.Row, 7].Text Then
        If $sTable = "tblconsult" Then
          modPatientSub.UpdateConsultConsultant(GridView1[GridView1.Row, 0].Text, xuser)
          FillBedGrid()
        Else If $sTable = "tblopvisit" Then
          modPatientSub.UpdateAttendingConsultant(GridView1[GridView1.Row, 2].Text, xuser)
          FillBedGrid()
        Endif
      Endif
    Endif
    GridView1.Row = Row
  Endif

End

Public Sub mnucountuni_Click()

  Dim Column As Integer
  Dim xFieColm As String
  Dim res As Result
  Dim yval As Variant

  Dim xColl As Collection
  Dim xFldList As String[]
  Dim xPath As String

  Column = ListIndex("Column Index", modGridView.GetGridViewColumns(GridView1))
  If Column + 1 > 0 Then
    xFldList = GetSQLColumns()
    If MMain.$IsGUIApp = True Then
      $ProgressBar1 = modAppSupport.FindWorkProgressBar(modHelpVariable.$LogInCategory)
      $ProgressBar1.Visible = True
      $ProgressBar1.Value = 0
    Endif

    Inc Application.Busy
    xFieColm = xFldList[Column]
    res = ExecuteQuery([xFieColm])
    xColl = New Collection
    If res.Available Then
      For Each res
        yval = GetGridViewValue(Column, res[xFieColm])
        If yval Then
          If xColl.Exist(CStr(yval)) Then
            xColl[CStr(yval)] = xColl[CStr(yval)] + 1
          Else
            xColl[CStr(yval)] = 1
          Endif
        Endif

        If MMain.$IsGUIApp = True Then
          $ProgressBar1.Value = (res.Index + 1) / res.Count
          Wait
        Endif
      Next
    Endif
    If xColl.Count Then
      xPath = modCHTMLReport.CreateHTMLReportFromCollection(["Variable", "Count"], xColl, GridView1.Columns[Column].Text, modReportVar.GetDateTimeReport(Now(), gb.GeneralDate))
    Endif
    Dec Application.Busy

    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

''------------ History ---------------
Public Sub mnuhistory_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetVisitHistoryResult(modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuvisiremote_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoVisitHistoryResult(modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuexamlocal_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetPatHistoryLocalResult("Examination", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnuexamrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoHistoryLocalResult("Examination", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnulabhist_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetPatHistoryLocalResult("Laboratory", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnulabviewrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoHistoryLocalResult("Laboratory", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnuarchlab_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetArchiveReportResult("Diagnostic Tests", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuarchlabrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoArchiveReportResult("Diagnostic Tests", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuradiohist_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetPatHistoryLocalResult("Radiology", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnuradioviewrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoHistoryLocalResult("Radiology", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnuarchradio_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetArchiveReportResult("Radio Diagnostics", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuarchradiorepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoArchiveReportResult("Radio Diagnostics", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnumedhist_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetPatHistoryLocalResult("Medicines", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnumedviewrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoHistoryLocalResult("Medicines", GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnugenhistory_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetSelectHistoryResult(GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnugenhistrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoSelectHistoryResult(GridView1[GridView1.Row, 2].Text, LabUnitForm())
  Endif

End

Public Sub mnuarchgenerl_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetArchiveReportResult("General Reports", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuarchgenerlrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoArchiveReportResult("General Reports", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuscannedimg_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetArchiveReportResult("Scanned Images", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnuscannedimgrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoArchiveReportResult("Scanned Images", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnupastdocs_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetArchiveReportResult("Past Documents", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnupastdocsrepo_Click()

  If GridView1.Rows.Selection.Count Then
    modPatReports.GetRepoArchiveReportResult("Past Documents", modPatient.GetPatientNoByEnc(GridView1[GridView1.Row, 2].Text))
  Endif

End

Public Sub mnupacshist_Click()

  Dim hForm As FmPacsFind

  If GridView1.Rows.Selection.Count Then
    hForm = New FmPacsFind(GridView1[GridView1.Row, 2].Text, "History")
    hForm.ShowModal
  Endif

End

Public Sub mnuexpocolumn_Click()

  Dim hForm As FmCustColumnSet

  hForm = New FmCustColumnSet(Me.Tag)
  hForm.ShowModal

End

Public Sub chkshowdepart_Click()

  modSettings.EnterCheckSetting(chkshowdepart, "OPDPatientList/ShowParameters")

End

Public Sub chkshowstatus_Click()

  modSettings.EnterCheckSetting(chkshowstatus, "OPDPatientList/ShowStatusIcons")

End

Public Sub chknotice_Click()

  modSettings.EnterCheckSetting(chknotice, "OPDPatientList/ShowNotices")

End

Public Sub mnugotooptometry_Click()

  Dim hForm As FmExamAttach

  If GridView1.Rows.Selection.Count Then
    hForm = New FmExamAttach(GridView1[GridView1.Row, 2].Text, "Optometry", "Physician Examinations", True)
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnugotoneuro_Click()

  Dim hForm As FmExamAttach

  If GridView1.Rows.Selection.Count Then
    hForm = New FmExamAttach(GridView1[GridView1.Row, 2].Text, "Neurology", "Physician Examinations", True)
    modWorkSpace.Add(hForm)
  Endif

End

''------------ forms
Public Sub mnugodelivery_Click()

  Dim hForm As FmDeliveryNew

  If GridView1.Rows.Selection.Count Then
    hForm = New FmDeliveryNew(GridView1[GridView1.Row, 2].Text, True)
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnugotoexam_Click()

  Dim hForm As FmExamReporting

  If GridView1.Rows.Selection.Count Then
    hForm = New FmExamReporting(GridView1[GridView1.Row, 2].Text, True)
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnunurseform_Click()

  Dim hForm As FmNursingForm

  If GridView1.Rows.Selection.Count Then
    hForm = New FmNursingForm(GridView1[GridView1.Row, 2].Text, True)
    modWorkSpace.Add(hForm)
  Endif

End
