' Gambas class file

Private $encid As String
Private $status As String
Private $DiscPackage As String
Private $Dept As String
Private $doa As Date
Private $xFinClear As Boolean
Private $PatientNum As String
Private $xNHISCode As String
Private $Ready As Boolean
Private $NarcoDoctor As String
Private $NarcoRegd As String
Private $medForm As FmMedPrescribe

Private $PatAge As Float
Private $PatSex As String
Private $PatWeight As Float
Private $PatHeight As Float

Private $rDataM As Result
Private $aMyFieldsM As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]
Private $rData2 As Result
Private $aMyFields2 As String[]
Private $rData3 As Result
Private $aMyFields3 As String[]
Private $rData5 As Result
Private $aMyFields5 As String[]
Private $NumForm As FmQuantiEntry
Private $LastEncid As String

Private $HideErr As Boolean
Private $HideDos As Boolean
Private $ShowReview As String
Private $AlphaList As String[]
Private $LedgerAC As String
Private $xBillType As String
Private $sBillMode As String
Private $sClaimState As String
Private $LabelType As String
Private xYear As Integer
Private $ClinicianLst As String[]
Private hOwnStockForm As FmWardStock

Private $HiCappingVar As Collection

Public Sub _new(encid As String, sStatus As String, DiscPackage As String)

  $encid = encid
  $status = sStatus
  $DiscPackage = DiscPackage

End

Public Sub Form_Open()

  Dim mfglist As String
  Dim xbirthDate As Date
  Dim xoption As String

  modGeneralMain.ArrangeFormCentre(Me, "False")
  Select $status
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $Dept = "IPD"
    Case Else
      $Dept = "OPD"
  End Select
  hOwnStockForm = New FmWardStock($encid, $status, $DiscPackage, pnlwardstock)
  hOwnStockForm.SetOwnDepartment($Dept)
  $medForm = New FmMedPrescribe($encid, $status, $DiscPackage, pnlcpoe)

  cmbdisctype.List = modBasic.$BillDiscountCash
  If cmbdisctype.List.Count = 0 Then
    cmbdisctype.Add($DiscPackage)
  Endif
  cmbdisctype.Text = $DiscPackage

  If modSettings.ShowSettingFromFIle("ClinicForms/ShowInjectionSubRoutes") = "Disable" Then
    cmbroute.List = modMedicine.AllComboRoute()
  Else
    cmbroute.List = modMedicine.InpatientRoute(False)
  Endif
  cmbfreq.List = modMedicine.FrequencyCombo()
  cmbcurrent.List = ["Continue", "On Hold", "Removed", "All Active"]
  cmbstatus.List = ["Continue", "Completed", "Discontinue", "On Hold", "Change", "ReWrite", "Cancelled", "Wasted"]
  $ClinicianLst = modGeneral.GetClinicianCodeList()
  modStockSub.DisplayDefaultDispensingMode(rbrand, rbgeneric)
  modSettings.ShowCheckBox(chkout, "OutOfStock/Dispensing")

  xoption = modSettings.ShowSettingFromFIle("RemoteNotification/PharmacyRequest")
  If xoption = "Yes" Then
    chknotice.Value = True
  Else If xoption = "No" Then
    chknotice.Value = False
  Endif

  mfglist = modSettings.ShowSettingFromFIle("PharmacyForm/AdviceList")
  If mfglist Then
    If Exist(mfglist) Then
      txtdirection.List = modString.GetStringArrayFromFile(mfglist)
    Endif
  Endif

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  $PatSex = modPatient.GetPatientSex($encid)
  xbirthDate = modPatient.GetPatientBirthDay($encid)
  txtgender.Text = modDate.GetAgeString(xbirthDate, Now()) & "/" & $PatSex
  xYear = DateDiff(xbirthDate, Now(), gb.Year)
  $doa = modPatient.GetRecordDate($encid)
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $xNHISCode = modPatient.GetPatientExtCOdebyEnc($encid)

  $PatAge = xYear
  $PatHeight = modClinic.GetPatientHeightinCm($encid)
  $PatWeight = modClinic.GetBodyWeight($encid)

  ShowBillingParam($DiscPackage)
  If $status = "Admitted" Then
    $LabelType = "Inpatient"
  Else
    $LabelType = "Outpatient"
  Endif

  If $status = "Registered" Then
    $LastEncid = modPatient.GetSecondLastEncidPatient($encid)
  Else
    $LastEncid = $encid
  Endif
  $xFinClear = modNonMedical.GetFinanceClearance($encid)
  SetNarcoticsPrescriber()

  $ShowReview = modBasic.$MedErrorEnable
  If Not $ShowReview Then
    $ShowReview = "Notification"
  Endif
  If modPharmacy.DisableEncounterForReview($encid) = True Then
    $ShowReview = "None"
  Endif

  If modBasic.$BillPharmReturnPunching = "Disable" Then
    mnureturn.Visible = False
  Endif

  $AlphaList = New String[]
  dtdose.Value = Now()
  GetDoseFormatType()

  rbcurrent.Value = True
  cmbcurrent.Text = "Continue"
  ShowRunningMedicine(cmbcurrent.Text)

  If $xFinClear = True Then
    btngroup.Enabled = False
    btnrepeat.Enabled = False
    chksave.Enabled = False
    pnlwardstock.Enabled = False
  Endif
  ShowBasicParamStatus()
  $Ready = True

End

Public Sub chknotice_Click()

  modSettings.EnterCheckSetting(chknotice, "RemoteNotification/PharmacyRequest")

End

Private Sub SetNarcoticsPrescriber()

  Dim res As Result

  If modBasic.$MedNarcoPrescriber = "User" Then
    res = modDatabase.$myConn.Exec("select fldusername,fldusercode from tbluser where flduserid=&1 and (fldopconsult=&2 or fldipconsult=&2) and fldstatus=&3 and fldusercode like &4", modBasic.$lbluser, True, "Active", "%")
    If res.Available Then
      $NarcoDoctor = res["fldusername"]
      $NarcoRegd = res["fldusercode"]
    Endif
  Endif

End

Private Sub ShowBasicParamStatus()

  Dim xmsg As String

  If $ShowReview = "None" Then
  Else

    xmsg = ""
    If Not $PatHeight Then
      $PatHeight = modSysCons.GetPatientEmptyHeight($PatAge, $PatSex)
      If $PatHeight Then
        xmsg = "Patient's height not set. Using " & $PatHeight & " cm for now" & gb.NewLine
      Endif
    Endif
    If Not $PatWeight Then
      If $PatHeight Then
        $PatWeight = modSysCons.GetPatientEmptyWeight($PatHeight, $PatSex)
        If $PatWeight Then
          xmsg = xmsg & "Patient's weight not set. Using " & $PatWeight & " Kg for now"
        Endif
      Endif
    Endif

    If xmsg Then
      Message.Warning(xmsg, ("OK"))
    Endif

  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Else If Key.Code = Key.F1 Then
    TabPanel1.Index = 0
    ShowRunningMedicine(cmbcurrent.Text)
  Else If Key.Code = Key.F2 Then
    TabPanel1.Index = 1
    modSettings.ShowCheckBox(chkout, "OutOfStock/Dispensing")
    FillDosingGrid()
    BlankDosingBox()
    txtstart.SetFocus
  Else If Key.Code = Key.F3 Then

  Else If Key.Code = Key.F4 Then
    TabPanel1.Index = 3
    btndoserefresh_Click()
  Else If Key.Code = Key.F5 Then
    TabPanel1.Index = 4
    ShowPatProtocols()
  Else
    modGeneralmain.GoToNextControlTab()
  Endif

End

Public Sub TabPanel1_Click()

  If TabPanel1.Index = 0 Then
    ShowRunningMedicine(cmbcurrent.Text)
  Else If TabPanel1.Index = 1 Then
    modSettings.ShowCheckBox(chkout, "OutOfStock/Dispensing")
    FillDosingGrid()
    BlankDosingBox()
    txtstart.SetFocus
  Else If TabPanel1.Index = 2 Then
    hOwnStockForm.RearrangeGrid()
    hOwnStockForm.RefreshList()
  Else If TabPanel1.Index = 3 Then
    ''cpoe
  Else If TabPanel1.Index = 4 Then
    ShowPatProtocols()
  Else If TabPanel1.Index = 5 Then
    ShowOldEntry()
    ShowReturnGrid()
  Else If TabPanel1.Index = 5 Then
    btndoserefresh_Click()
  Endif

End

Private Sub BlankDosingBox()

  cmbroute.Text = ""
  cmbmedicine.Text = ""
  cmbfreq.Text = ""
  txtdose.Value = 0
  txtday.Value = 0
  txtday.Tag = ""
  txtqty.Value = 0
  txtqty.Tag = ""
  txtdirection.Text = ""
  $HideErr = False
  $HideDos = False
  lbldose.Text = ""
  lblregimen.Text = ""
  MessageView1.Close()

End

Private Sub ShowKeyPad()

  If modBasic.$TabletModeEnable = "Yes" Then
    pnlquanti.Visible = True
  Else
    pnlquanti.Visible = False
  Endif

End

Private Sub ShowBillingParam(sDisctype As String)

  Dim hForm As CPackageParams

  $HiCappingVar = New Collection
  hForm = New CPackageParams($encid, sDisctype)
  $sBillMode = hForm.GetBillingMode()
  $LedgerAC = hForm.GetLedgerAC()
  $xBillType = hForm.GetBillType()
  $sClaimState = hForm.GetClaimState()

End

Private Sub GetHImedicineCappingVar()

  Dim hForm As CimisAPICap

  If cmbdisctype.Text = modBasic.$HIPackage Or If cmbdisctype.Text = modBasic.$HIPackageER Then
    If modBasic.$IMISValidateURL Then

      If modClaim.GetChronicClaimStatus($encid) = True Then
        If $HiCappingVar.Count Then
          $HiCappingVar.Clear()
        Endif
      Else
        If Not $HiCappingVar.Count Then
          Inc Application.Busy
          hForm = New CimisAPICap($xNHISCode)
          $HiCappingVar = hForm.GetMedicineLimits()
          Dec Application.Busy
        Endif
      Endif

    Endif
  Endif

End

''------------------------------ Request ---------------------------------
Private Sub SendNotification(sRoute As String, sItem As String, xqty As Float)

  Dim xtarg As String

  Select sRoute
    Case "msurg"
      xtarg = modBasic.$BillTargetSurgical
    Case "suture"
      xtarg = modBasic.$BillTargetSutures
    Case "ortho"
      xtarg = modBasic.$BillTargetOrthopedics
    Case "extra"
      xtarg = modBasic.$BillTargetExtras
    Case Else
      xtarg = modBasic.$BillTargetMedicine
  End Select

  If chknotice.Value = True Then
    If xtarg Then
      modControl.SendCompIDNotofication(xtarg, "Pharmacy Order from " & modBasic.$compID, "<b>" & txtpatientname.Text & "</b> Encounter ID : " & $encid & " Particulars : <b>" & sItem & "</b> QTY : " & CStr(xqty))
    Endif
  Endif

End

Public Sub chkout_Click()

  modSettings.EnterCheckSetting(chkout, "OutOfStock/Dispensing")

End

Public Sub rbgeneric_Click()

  modSettings.SaveSettingsToFile("BrandOrGeneric/Dispensing", "Generic")

End

Public Sub rbrand_Click()

  modSettings.SaveSettingsToFile("BrandOrGeneric/Dispensing", "Brand")

End

Private Function GetBrandGenerricType() As String

  Dim brandOrGeneric As String

  If rbrand.Value = True Then
    brandOrGeneric = "Brand"
  Else
    brandOrGeneric = "Generic"
  Endif
  Return brandOrGeneric

End

Public Sub btnrepeat_Click()

  Dim sColl As Collection
  Dim xLst As Long[]

  sColl = GetSetRegimen($encid)
  If sColl And If sColl.Count Then
    For Each xLst In sColl
      If sColl.Key = "New Regimen" Then
        AddNewRegimen(xLst)
      Else If sColl.Key = "Past Regimen" Then
        AddPastRegimens(xLst)
      Endif
    Next
    GetReviewMultiMessage()
  Endif

End

Private Sub AddNewRegimen(itmList As Long[])

  Dim idx As Long
  Dim res As Result
  Dim txprescriber As String
  Dim txpresno As String

  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean
  Dim ygo As Boolean

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  If modMisc.AllowDiagnoBilling($encid) = True Then
    If itmList And If itmList.Count Then

      For Each idx In itmList
        res = modDatabase.$myConn.Exec("select fldroute,fldbrandid,flddose,fldfreq,fldday,fldqty,fldusage from tblmedregimen where fldid=&1", idx)
        If res.Available Then
          itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["fldroute"])

          xgo = False
          If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
            CPharmFix = New CFixRatePharmacy(itemtype, res["fldbrandid"], $sBillMode)
            xfixrate = CPharmFix.GetFixRate()
            xfixname = CPharmFix.GetFixItem()
            If xfixname Then
              xgo = True
            Else
              xgo = False
            Endif
          Else
            xgo = True
          Endif
          ygo = False
          If modBasic.$ClinicDisableMedicines.Exist(res["fldbrandid"]) = True Then
            ygo = False
          Else
            ygo = True
          Endif
          If xgo = True And If ygo = True Then
            itemmode = $sBillMode
            xtax = modNonMedical.ShowTaxValues(itemtype, res["fldbrandid"])
            xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, res["fldbrandid"], itemmode)
            Select res["fldroute"]
              Case "suture", "msurg", "ortho"
                modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["fldqty"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
              Case "extra"
                modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["fldqty"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
              Case Else
                If modMedConstant.GetNarcoticType(res["fldbrandid"]) = "Yes" Then
                  txprescriber = $NarcoDoctor
                  txpresno = $NarcoRegd
                  If Not txpresno Then
                    xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
                    If xnarcotic Then
                      txprescriber = xnarcotic[1]
                      txpresno = xnarcotic[0]
                    Endif
                  Endif
                  If txprescriber And If txpresno Then
                    modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["flddose"], res["fldfreq"], res["fldday"], res["fldqty"], $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
                  Endif
                Else
                  modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["fldbrandid"], res["flddose"], res["fldfreq"], res["fldday"], res["fldqty"], $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldusage"], False, xcurVal)
                Endif
            End Select
            SendNotification(res["fldroute"], res["fldbrandid"], res["fldqty"])
          Endif

        Endif
      Next

      BlankDosingBox()
      FillDosingGrid()
    Endif
  Else
    Message.Warning("Diagnosis not provided", ("OK"))
  Endif

End

Private Sub AddPastRegimens(itmList As Long[])

  Dim idx As Long
  Dim res As Result
  Dim txprescriber As String
  Dim txpresno As String

  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean
  Dim ygo As Boolean

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  If modMisc.AllowDiagnoBilling($encid) = True Then
    If itmList And If itmList.Count Then

      For Each idx In itmList
        res = modDatabase.$myConn.Exec("select fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flddirection from tblpatdosing where fldid=&1", idx)
        If res.Available Then
          itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["fldroute"])

          xgo = False
          If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
            CPharmFix = New CFixRatePharmacy(itemtype, res["flditem"], $sBillMode)
            xfixrate = CPharmFix.GetFixRate()
            xfixname = CPharmFix.GetFixItem()
            If xfixname Then
              xgo = True
            Else
              xgo = False
            Endif
          Else
            xgo = True
          Endif
          ygo = False
          If modBasic.$ClinicDisableMedicines.Exist(res["flditem"]) = True Then
            ygo = False
          Else
            ygo = True
          Endif
          If xgo = True And If ygo = True Then
            itemmode = $sBillMode
            xtax = modNonMedical.ShowTaxValues(itemtype, res["flditem"])
            xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, res["flditem"], itemmode)
            Select res["fldroute"]
              Case "suture", "msurg", "ortho"
                modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqtydisp"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
              Case "extra"
                modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqtydisp"], $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
              Case Else
                If modMedConstant.GetNarcoticType(res["flditem"]) = "Yes" Then
                  txprescriber = $NarcoDoctor
                  txpresno = $NarcoRegd
                  If Not txpresno Then
                    xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
                    If xnarcotic Then
                      txprescriber = xnarcotic[1]
                      txpresno = xnarcotic[0]
                    Endif
                  Endif
                  If txprescriber And If txpresno Then
                    modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["flddose"], res["fldfreq"], res["flddays"], res["fldqtydisp"], $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
                  Endif
                Else
                  modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["flddose"], res["fldfreq"], res["flddays"], res["fldqtydisp"], $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["flddirection"], False, xcurVal)
                Endif
            End Select
            SendNotification(res["fldroute"], res["flditem"], res["fldqtydisp"])
          Endif

        Endif
      Next

      BlankDosingBox()
      FillDosingGrid()
    Endif
  Else
    Message.Warning("Diagnosis not provided", ("OK"))
  Endif

End

Public Sub cmbdisctype_Click()

  If cmbdisctype.Text Then
    ShowBillingParam(cmbdisctype.Text)
    hOwnStockForm.$DiscPackage = cmbdisctype.Text
    hOwnStockForm.UpdateBillingParam()

    $medForm.AlterScheme(cmbdisctype.Text)
  Endif

End

Public Sub cmbdisctype_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdisctype)
  modFillContainer.RestrictComboToContent(cmbdisctype)

End

Public Sub cmbroute_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbroute)
  modFillContainer.RestrictComboToContent(cmbroute)

End

Private Sub RegimenBoxSetting(sBool As Boolean)

  txtdose.Enabled = sBool
  cmbfreq.Enabled = sBool
  txtday.Enabled = sBool

End

Public Sub cmbroute_Click()

  cmbmedicine.Clear
  cmbmedicine.Text = ""
  RegimenBoxSetting(True)

End

Private Function GetPharmTarget(sRoute As String) As String

  Dim xtarg As String

  Select sRoute
    Case "msurg"
      xtarg = modBasic.$BillTargetSurgical
    Case "suture"
      xtarg = modBasic.$BillTargetSutures
    Case "ortho"
      xtarg = modBasic.$BillTargetOrthopedics
    Case "extra"
      xtarg = modBasic.$BillTargetExtras
    Case Else
      xtarg = modBasic.$BillTargetMedicine
  End Select

  Return xtarg

End

Public Sub cmbmedicine_GotFocus()

  Dim res As Result
  Dim res1 As Result
  Dim xlist1 As String[]
  Dim xlist As String[]
  Dim aList As String[]
  Dim aList1 As String[]

  If Not cmbroute.Text Then
    cmbroute.SetFocus
  Else If cmbroute.Text Then
    If Not cmbmedicine.Text Then

      txtdose.Tag = "Auto"
      txtdose.Parent.Tag = "Auto"

      If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
        If modBasic.$ClinLockPharmStock = "Enable" Then
          res = modStock.FillMedicinesDispensingComboResult(cmbroute.Text, GetBrandGenerricType(), GetPharmTarget(cmbroute.Text), $sBillMode)
        Else
          res = modStock.FillMedicinesPrescribingComboResult(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
        Endif
        xlist = modControlSub.GetDirectFillresult(res)
        If chkout.Value = True Then
          res1 = modStock.ItemListForPurchaseBillMode(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
          xlist1 = modControlSub.GetDirectFillresult(res1)
          cmbmedicine.Text = GridViewMark("Select Particulars", xlist, xlist1, Panel7, GridView1.Height + cmbmedicine.Height)
        Else
          cmbmedicine.Text = GridViewNew("Select Particulars", modControlSub.GetDirectFillresult(res), False, Panel7, GridView1.Height + cmbmedicine.Height)
        Endif

      Else
        If modBasic.$ClinLockPharmStock = "Enable" Then
          res = modStock.FillMedicinesDispensingComboResult(cmbroute.Text, GetBrandGenerricType(), GetPharmTarget(cmbroute.Text), $sBillMode)
        Else
          res = modStock.FillMedicinesPrescribingComboResult(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
        Endif
        If chkout.Value = True Then
          res1 = modStock.ItemListForPurchaseBillMode(cmbroute.Text, GetBrandGenerricType(), $sBillMode)
          xlist = modControlSub.GetDirectFillresult(res)
          xlist1 = modControlSub.GetDirectFillresult(res1)
          If modBasic.$ClinicDisableMedicines And If modBasic.$ClinicDisableMedicines.Count Then
            aList = modString.GetRemainingArray(xlist, modBasic.$ClinicDisableMedicines)
            aList1 = modString.GetRemainingArray(xlist1, modBasic.$ClinicDisableMedicines)
            cmbmedicine.Text = GridViewMark("Select Particulars", aList, aList1, Panel7, GridView1.Height + cmbmedicine.Height)
          Else
            cmbmedicine.Text = GridViewMark("Select Particulars", xlist, xlist1, Panel7, GridView1.Height + cmbmedicine.Height)
          Endif

        Else
          If modBasic.$ClinCategoryGrid = "Yes" Then
            xlist1 = modControlSub.GetDirectFillresult(res)
            If xlist1 Then
              xlist = modMedConstant.GetStockIDWithCategory(xlist1)
              If xlist Then
                If modBasic.$ClinicDisableMedicines And If modBasic.$ClinicDisableMedicines.Count Then
                  aList = modString.GetRemainingArray(xlist, modBasic.$ClinicDisableMedicines)
                  cmbmedicine.Text = GridViewGroup("Select Medicine", aList, False, Panel7, GridView1.Height + cmbmedicine.Height)
                Else
                  cmbmedicine.Text = GridViewGroup("Select Medicine", xlist, False, Panel7, GridView1.Height + cmbmedicine.Height)
                Endif
              Endif
            Endif
          Else
            xlist = modControlSub.GetDirectFillresult(res)
            If modBasic.$ClinicDisableMedicines And If modBasic.$ClinicDisableMedicines.Count Then
              aList = modString.GetRemainingArray(xlist, modBasic.$ClinicDisableMedicines)
              cmbmedicine.Text = GridViewNew("Select Particulars", aList, False, Panel7, GridView1.Height + cmbmedicine.Height)
            Else
              cmbmedicine.Text = GridViewNew("Select Particulars", xlist, False, Panel7, GridView1.Height + cmbmedicine.Height)
            Endif
          Endif

        Endif
      Endif

      If Not cmbmedicine.Text Then
        txtdose.SetFocus
      Endif

    Endif
  Endif

End

Public Sub txtdose_GotFocus()

  Dim cForm As CRecommendDosing

  If cmbmedicine.Text Then
    If modStockSub.GetComboStockControl(cmbroute.Text, cmbmedicine.Text, rbgeneric, rbrand, modDatabase.$medConn) = False Then
      cmbmedicine.Text = ""
      Balloon.Warning(("Item not listed"), cmbmedicine)
      Balloon.Delay = modBasic.$BalloonDelay
      cmbroute.SetFocus
    Else

      If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
        RegimenBoxSetting(False)
        txtqty.SetFocus
        txtqty.SelectAll

      Else
        If rbrand.Value = True Then
          cmbmedicine.Text = modMedConstant.ConvertBrandToGeneric(cmbroute.Text, cmbmedicine.Text)
        Endif
        RegimenBoxSetting(True)
        lbldose.Text = modMedConstant.GetDrugDosingUnit(cmbmedicine.Text)

        If modBasic.$MedDoseRecommend = "No" Then
        Else
          cForm = New CRecommendDosing($encid, xYear, cmbmedicine.Text)
          txtdose.Value = cForm.UnitDose()
          cmbfreq.Text = cForm.Frequency()
          lblregimen.Text = cForm.Regimen()
        Endif

        If $HideDos = False Then
          $HideDos = True
          CheckLastDispensing(cmbmedicine.Text)
        Endif

        ClearNumPad()
        ShowKeyPad()
        If modBasic.$TabletModeEnable = "Yes" Then
          $NumForm = New FmQuantiEntry(txtdose, pnlquanti)
        Endif

        txtdose.SelectAll
      Endif

    Endif
  Endif

End

Private Sub CheckLastDispensing(xmedicine As String)

  Dim cForm As CLastDispensing
  Dim xdate As Date
  Dim xdays As Integer

  cForm = New CLastDispensing(xmedicine, $PatientNum, $xNHISCode, cmbdisctype.Text)
  txttotalqty.Value = cForm.GetLastQty()
  xdate = cForm.GetLastDate()
  xdays = cForm.GetLastDays()

  If xdate Then
    txtlastdispdate.Text = modReportVar.GetDateTimeReport(xdate, gb.MediumDate)
    If DateDiff(xdate, Now(), gb.Month) <= 3 Then
      txtlastdispdate.Foreground = Color.Red
    Endif

    If xdays Then
      If DateAdd(xdate, gb.Day, xdays) > Now() Then
        Message.Warning("Dispensed for " & xdays & " Days On " & modReportVar.GetDateTimeReport(xdate, gb.GeneralDate), ("OK"))
      Endif
    Endif
  Endif

End

Public Sub txtdose_KeyRelease()

  Dim hForm As FmDiseaseDose
  Dim xx As String
  Dim brandOrGeneric As String

  txtdose.Tag = ""
  txtdose.Parent.Tag = ""

  If Key.Code = Key.Right Then
    If cmbroute.Text And If cmbmedicine.Text Then
      If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
      Else
        If rbrand.Value = True Then
          brandOrGeneric = "Brand"
        Else
          brandOrGeneric = "Generic"
        Endif
        xx = CAlternative(cmbroute.Text, cmbmedicine.Text, brandOrGeneric)
        If xx Then
          cmbmedicine.Text = xx
        Endif

      Endif
    Endif
  Else If Key.Code = Key.Down Then
    If modBasic.$MedDiseaseDose Then
      If modBasic.$MedDiseaseDose = "None" Then
      Else
        hForm = New FmDiseaseDose(modBasic.$MedDiseaseDose, $encid, cmbroute.Text, cmbmedicine.Text, txtdose, cmbfreq, txtday)
        hForm.ShowModal
      Endif
    Endif
  Endif

End

Public Sub cmbfreq_GotFocus()

  If modBasic.$TabletModeEnable = "Yes" Then
    If Not cmbfreq.Text Then
      cmbfreq.Popup
    Endif
  Endif

End

Public Sub cmbfreq_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbfreq)
  modFillContainer.RestrictComboToContent(cmbfreq)
  If Key.Code = Key.Down Then
    $HideErr = True
  Endif

End

Public Sub cmbfreq_Click()

  $HideErr = False

End

Public Sub cmbfreq_LostFocus()

  Dim opt As String[]
  Dim Row As Integer
  Dim xval As String
  Dim xcount As String
  Dim cForm As CMedError

  If $HideErr = False Then
    If txtdose.Value And If cmbfreq.Text Then

      Select cmbroute.Text
        Case "suture", "msurg", "ortho", "extra", "topical"
          ''do nothing
        Case Else
          If $ShowReview = "None" Then
          Else
            opt = New String[]
            For Row = 0 To GridView1.Rows.Count - 1
              Select GridView1[Row, 2].Text
                Case "suture", "msurg", "ortho", "extra", "topical"
                Case Else
                  xval = modMedConstant.GetDrugFromStockID(GridView1[Row, 3].Text)
                  If opt.Count = 0 Then
                    opt.Add(xval)
                  Else
                    If opt.Exist(xval) = False Then
                      opt.Add(xval)
                    Endif
                  Endif
              End Select
            Next
            $HideErr = True
            cForm = New CMedError
            Inc Application.Busy
            xcount = cForm.ShowMedicationReviewPunching($encid, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, opt)
            Dec Application.Busy
            If xcount Then
              MessageView1.Close()
              MessageView1.Open(xcount, Picture["icon:/small/info"])
            Endif
          Endif
      End Select

    Endif
  Endif

End

Public Sub txtday_GotFocus()

  ClearNumPad()
  ShowKeyPad()
  If modBasic.$TabletModeEnable = "Yes" Then
    $NumForm = New FmQuantiEntry(txtday, pnlquanti)
  Endif
  txtday.SelectAll

End

Public Sub txtqty_GotFocus()

  Dim xday As Integer

  ClearNumPad()
  ShowKeyPad()
  If modBasic.$TabletModeEnable = "Yes" Then
    $NumForm = New FmQuantiEntry(txtqty, pnlquanti)
  Endif

  If txtdose.Value And If cmbfreq.Text Then
    If txtday.Value Then
      xday = txtday.Value
    Else
      If modBasic.$ClinIPDVarDays = "Enable" And If $status = "Admitted" Then
        xday = 1
      Endif
    Endif

    If Not xday Then
      txtday.SetFocus
    Else
      txtqty.Value = Ceil(modMedConstant.GetQuantityDosing(cmbmedicine.Text, txtdose.Value, cmbfreq.Text, xday, modBasic.$SalesQTYPack))
    Endif
  Endif
  txtqty.SelectAll

End

Public Sub chksave_Click()

  If cmbroute.Text And If cmbmedicine.Text And If txtqty.Value Then
    If modMisc.AllowDiagnoBilling($encid) = True Then
      EnterDosingRecord()
      ClearNumPad()
      pnlquanti.Visible = False
      cmbroute.SetFocus
    Else
      Message.Warning("Diagnosis not provided", ("OK"))
      cmbroute.SetFocus
    Endif
  Endif '

End

Public Sub chksave_GotFocus()

  chksave_Click()

End

Public Sub chksave_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    chksave_Click()
  Endif

End

Private Sub EnterDosingRecord()

  Dim txprescriber As String
  Dim txpresno As String

  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  ' Dim xvarfix As Variant[]
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif
  If cmbroute.Text And If cmbmedicine.Text Then

    itemtype = modNonMedical.GetBillItemCategoryFromCombo(cmbroute.Text)
    CPharmFix = New CFixRatePharmacy(itemtype, cmbmedicine.Text, $sBillMode)
    xfixrate = CPharmFix.GetFixRate()
    xfixname = CPharmFix.GetFixItem()
    itemmode = $sBillMode
    xtax = modNonMedical.ShowTaxValues(itemtype, cmbmedicine.Text)
    xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, cmbmedicine.Text, itemmode)
    If cmbroute.Text = "suture" Or If cmbroute.Text = "msurg" Or If cmbroute.Text = "ortho" Or If cmbroute.Text = "extra" Then
      modPharmSub.InsertNonMedDosingEntry(itemtype, $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtqty.Value, $status, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), False, xcurVal)

    Else
      If modMedConstant.GetNarcoticType(cmbmedicine.Text) = "Yes" Then
        txprescriber = $NarcoDoctor
        txpresno = $NarcoRegd
        If Not txpresno Then
          xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
          If xnarcotic Then
            txprescriber = xnarcotic[1]
            txpresno = xnarcotic[0]
          Endif
        Endif
        If txprescriber And If txpresno Then
          ' modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, txtday.Value, txtqty.Value, $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), False, xcurVal)                     '
          modPharmSub.InsertDosingMedicine($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, txtday.Value, txtqty.Value, $status, txprescriber, txpresno, txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), "", 0, "", 0, xcurVal)
        Endif
      Else
        ' modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, txtday.Value, txtqty.Value, $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), False, xcurVal)                     '
        modPharmSub.InsertDosingMedicine($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, cmbroute.Text, cmbmedicine.Text, txtdose.Value, cmbfreq.Text, txtday.Value, txtqty.Value, $status, "", "", txtstart.Value, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, Trim(txtdirection.Text), "", 0, "", 0, xcurVal)
      Endif
    Endif

    SendNotification(cmbroute.Text, cmbmedicine.Text, txtqty.Value)
    BlankDosingBox()
    FillDosingGrid()
  Endif

End

Public Sub btngroup_Click()

  Dim xList As Long[]
  Dim xIndex As Long

  Dim res As Result
  Dim txprescriber As String
  Dim txpresno As String
  Dim xdose As Float
  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  ' Dim xvarfix As Variant[]
  Dim itemmode As String
  Dim xcurVal As String
  Dim xnarcotic As String[]
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean
  Dim ygo As Boolean

  If chknextplan.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  If modMisc.AllowDiagnoBilling($encid) = True Then

    xList = GetSetProtocol($encid)
    If xList And If xList.Count Then
      For Each xIndex In xList
        res = modDatabase.$myConn.Exec("select fldroute,flditem,flddose,flddoseunit,fldfreq,fldday,fldqty,fldstart,fldadvice from tblproductgroup where fldid=&1 and (fldcomp=&2 or fldcomp=&3)", xIndex, modBasic.$compID, "%")
        If res.Available Then
          itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["fldroute"])

          xgo = False
          If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
            CPharmFix = New CFixRatePharmacy(itemtype, res["flditem"], $sBillMode)
            xfixrate = CPharmFix.GetFixRate()
            xfixname = CPharmFix.GetFixItem()
            If xfixname Then
              xgo = True
            Else
              xgo = False
            Endif
          Else
            xgo = True
          Endif
          ygo = False
          If modBasic.$ClinicDisableMedicines.Exist(res["flditem"]) = True Then
            ygo = False
          Else
            ygo = True
          Endif
          If xgo = True And If ygo = True Then
            itemmode = $sBillMode
            xtax = modNonMedical.ShowTaxValues(itemtype, res["flditem"])
            xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, itemtype, res["flditem"], itemmode)
            Select res["fldroute"]
              Case "suture", "msurg", "ortho"
                modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqty"], $status, res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
                SendNotification(res["fldroute"], res["flditem"], res["fldqty"])
              Case "extra"
                modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], res["fldqty"], $status, res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
                SendNotification(res["fldroute"], res["flditem"], res["fldqty"])
              Case Else
                xdose = modMedDosing.GetDoseInMg(res["flddose"], res["flddoseunit"], $encid)
                If xdose Then
                  If modMedConstant.GetNarcoticType(res["flditem"]) = "Yes" Then
                    txprescriber = $NarcoDoctor
                    txpresno = $NarcoRegd
                    If Not txpresno Then
                      xnarcotic = DualGridValue(("Select Narcotic Prescriber"), $ClinicianLst, False)
                      If xnarcotic Then
                        txprescriber = xnarcotic[1]
                        txpresno = xnarcotic[0]
                      Endif
                    Endif
                    If txprescriber And If txpresno Then
                      modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], xdose, res["fldfreq"], res["fldday"], res["fldqty"], $status, txprescriber, txpresno, res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
                    Endif
                  Else
                    modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, res["fldroute"], res["flditem"], xdose, res["fldfreq"], res["fldday"], res["fldqty"], $status, "", "", res["fldstart"], xtax, xdisc, xfixname, xfixrate, "Request", $Dept, res["fldadvice"], False, xcurVal)
                  Endif
                  SendNotification(res["fldroute"], res["flditem"], res["fldqty"])
                Endif
            End Select
          Endif

        Endif
      Next
      FillDosingGrid()
      GetReviewMultiMessage()
    Endif

  Else
    Message.Warning("Diagnosis not provided", ("OK"))
  Endif

End

Private Sub FillDosingGrid()

  Dim sql As String

  If rblabel.Value = True Then
    sql = "select fldid,fldstarttime,fldroute,flditem,fldid,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime,fldcurval,flddirection,flddosecount,fldmixing,flddose from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and (fldcurval=&5 or fldcurval=&6 or fldcurval=&7)"
  Else
    sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime,fldcurval,flddirection,flddosecount,fldmixing,flddose from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and (fldcurval=&5 or fldcurval=&6 or fldcurval=&7)"                                                   ''
  Endif
  $rDataM = modDatabase.$myConn.Exec(sql, $encid, False, $status, "Request", "Continue", "Reserve", "Planned")
  $aMyFieldsM = New String[]
  modGridView.ReadSmallData(GridView1, $rDataM, $aMyFieldsM)

  With GridView1
    .Columns[0].Width = 1
    .Columns[1].Width = 100 * modBasic.$AppWidthRatio
    .Columns[2].Width = 75 * modBasic.$AppWidthRatio
    .Columns[3].Width = 250 * modBasic.$AppWidthRatio
    .Columns[4].Width = 75 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 50 * modBasic.$AppWidthRatio
    .Columns[7].Width = 50 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 25 * modBasic.$AppWidthRatio
    .Columns[10].Width = 1
    .Columns[11].Width = 1
    .Columns[12].Width = 75 * modBasic.$AppWidthRatio
    .Columns[13].Width = 200 * modBasic.$AppWidthRatio
    .Columns[14].Width = 50 * modBasic.$AppWidthRatio
    .Columns[15].Width = 200 * modBasic.$AppWidthRatio
    .Columns[16].Width = 1 ''dose

    .Columns[1].Text = "Start"
    .Columns[2].Text = "Route"
    .Columns[3].Text = "Particulars"
    .Columns[4].Text = "Dose"
    .Columns[5].Text = "Freq"
    .Columns[6].Text = "Day"
    .Columns[7].Text = "QTY"
    .Columns[12].Text = "Status"
    .Columns[13].Text = "Direction"
    .Columns[14].Text = "N"
    .Columns[15].Text = "Compounding"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rDataM.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 1 Then
    GridView1.Data.Text = modReportVar.GetDateTimeReport($rDataM[$aMyFieldsM[Column]], gb.GeneralDate)
  Else If Column = 4 Then
    If rblabel.Value = True Then
      GridView1.Data.Text = modPharmacy.GetMedicineDoseInFormat($rDataM[$aMyFieldsM[Column]], "Label")
    Else
      GridView1.Data.Text = $rDataM[$aMyFieldsM[Column]]
    Endif
  Else If Column = 9 Then
    GridView1.Data.Picture = Picture["icon:/tiny/cancel"]
    GridView1.Data.Text = ""
  Else
    GridView1.Data.Text = $rDataM[$aMyFieldsM[Column]]
  Endif
  GridView1.Rows[Row].Height = Max(GridView1.Rows[Row].Height, GridView1.Data.Font.RichTextHeight(GridView1.Data.Text, GridView1.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView1.Rows.Height - GridView1.Font.Height))
  GridView1.Data.WordWrap = True

End

Public Sub GridView1_Click()

  Dim xval As Float
  Dim yval As String
  Dim Column As Integer
  Dim Row As Integer
  Dim res As Result
  Dim xdate As Date

  Row = GridView1.Row
  Column = GridView1.Column
  If GridView1.Column = 1 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      xdate = GetDateValue(GridView1[GridView1.Row, 3].Text, ("Alter Starting Date"), GridView1[GridView1.Row, 11].Text)
      If xdate Then
        modPharmSub.UpdateStartBefDispensing(GridView1[GridView1.Row, 0].Text, xdate)
        FillDosingGrid()
      Endif
    Endif

  Else If GridView1.Column = 4 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      If GridView1[GridView1.Row, 16].Text Then
        xval = InputValue(GridView1[GridView1.Row, 3].Text, ("Alter Unit Dose"), GridView1[GridView1.Row, 16].Text)
      Else
        xval = InputValue(GridView1[GridView1.Row, 3].Text, ("Alter Unit Dose"), 0)
      Endif
      If xval Then
        modPharmSub.UpdateDoseBefDispensing(GridView1[GridView1.Row, 0].Text, xval)
        FillDosingGrid()
      Endif
    Endif

  Else If GridView1.Column = 5 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      yval = InputCombo(GridView1[GridView1.Row, 3].Text, ("Alter Frequency"), modMedicine.FrequencyCombo(), GridView1[GridView1.Row, 5].Text, True)
      If yval Then
        modPharmSub.UpdateFreqBefDispensing(GridView1[GridView1.Row, 0].Text, yval)
        FillDosingGrid()
      Endif
    Endif

  Else If GridView1.Column = 6 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      xval = InputValue(GridView1[GridView1.Row, 3].Text, ("Alter Duration"), GridView1[GridView1.Row, 6].Text)
      If modBasic.$ClinIPDVarDays = "Enable" And If $status = "Admitted" Then
        modPharmSub.UpdateDaysBefDispensing(GridView1[GridView1.Row, 0].Text, xval)
        FillDosingGrid()
      Else
        If xval Then
          modPharmSub.UpdateDaysBefDispensing(GridView1[GridView1.Row, 0].Text, xval)
          FillDosingGrid()
        Endif
      Endif
    Endif

  Else If GridView1.Column = 7 Then
    xval = InputValue(GridView1[GridView1.Row, 3].Text, ("Alter Quantity"), GridView1[GridView1.Row, 7].Text)
    If xval Then
      modPharmSub.UpdateQTYBefDispensing(GridView1[GridView1.Row, 0].Text, xval)
      FillDosingGrid()
    Endif

  Else If GridView1.Column = 9 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView1[GridView1.Row, 0].Text, False)
      If modGeneral.AllowClinicalEdit(res["flduserid_order"]) = True Then
        modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView1[GridView1.Row, 0].Text, False)
      Else
        res["fldcurval"] = "Cancelled"
        res["flduserid_order"] = modBasic.$lbluser
        res["xyz"] = False
        res.Update
      Endif
      FillDosingGrid()
    Endif

  Else If GridView1.Column = 13 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      yval = InputBox(GridView1[GridView1.Row, 3].Text, ("Alter Direction"), GridView1[GridView1.Row, 13].Text)
      If yval Then
        modPharmSub.UpdateAdviceBefDispensing(GridView1[GridView1.Row, 0].Text, yval)
        FillDosingGrid()
      Endif
    Endif

  Else If GridView1.Column = 14 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      If GridView1[GridView1.Row, 14].Text Then
        xval = InputValue(GridView1[GridView1.Row, 3].Text, ("Alter Maximum Dose Count"), GridView1[GridView1.Row, 14].Text)
      Else
        xval = InputValue(GridView1[GridView1.Row, 3].Text, ("Alter Maximum Dose Count"), 0)
      Endif
      If xval Then
        modPharmSub.UpdateMaxCountBeffDispensing(GridView1[GridView1.Row, 0].Text, xval)
        FillDosingGrid()
      Endif
    Endif

  Else If GridView1.Column = 15 Then
    If modGeneral.AllowClinicalEdit(GridView1[GridView1.Row, 8].Text) = True Then
      yval = InputBox(GridView1[GridView1.Row, 3].Text, ("Alter Compounding Direction"), GridView1[GridView1.Row, 15].Text)
      If yval Then
        modPharmSub.UpdateMixtureBefDispensing(GridView1[GridView1.Row, 0].Text, yval)
        FillDosingGrid()
      Endif
    Endif

  Else
    modGridView.CheckUncheckGridWithDB(modDatabase.$myConn, GridView1, 8, "fldlabel", "fldid", "tblpatdosing", GridView1[GridView1.Row, 0].Text)
  Endif
  GridView1.Row = Row
  GridView1.Column = Column

End

Private Sub ClearNumPad()

  txtdose.Tag = ""
  txtday.Tag = ""
  txtqty.Tag = ""
  Try $NumForm.Close

End

Public Sub GridView1_Menu()

  mnuhide.Popup

End

Public Sub mnulabeling_Click()

  Dim Row As Integer
  Dim hClabel As CLabelSize

  If GridView1.Rows.Selection.Count > 0 Then
    Row = GridView1.Row
    hClabel = New CLabelSize(GridView1[GridView1.Row, 0].Text, $LabelType)
    modPrint.PrintPopUp(CStr(GridView1[GridView1.Row, 0].Text), hClabel.LabelPath(), "LabelSize")
    GridView1.Row = Row
  Endif

End

Public Sub mnutaper_Click()

  Dim Row As Integer
  Dim hForm As Fmtaperdose

  If GridView1.Rows.Selection.Count > 0 Then
    Row = GridView1.Row
    If GridView1[GridView1.Row, 5].Text = "Tapering" Then
      hForm = New Fmtaperdose(GridView1[GridView1.Row, 0].Text)
      hForm.ShowModal
    Endif
    GridView1.Row = Row
  Endif

End

Public Sub btndispown_Click()

  If GridView1.Rows.Selection.Count > 0 Then
    If Message.Question(("Dispense from LOCAL Stock. Are you sure ?"), ("No"), ("Yes")) = 2 Then
      SaveOwnDispensing(GridView1[GridView1.Row, 0].Text, "Continue")
      FillDosingGrid()
    Endif
  Endif

End

Private Sub SaveOwnDispensing(sID As Long, sStatus As String)

  Dim sql1 As String
  Dim res1 As Result
  Dim hForm As CPharmOwn

  sql1 = "select fldid,fldtime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,fldlabel,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid=&1 and fldsave_order=&2 and fldcurval=&3 and fldencounterval=&4"                                                   ''
  res1 = modDatabase.$myConn.Exec(sql1, sID, False, "Continue", $encid)
  If res1.Available = True Then
    hForm = New CPharmOwn($encid, $sBillMode, res1)
    If $sClaimState = "Consultation" Or If $sClaimState = "Patient Ward" Then
      GetHImedicineCappingVar()
    Endif
    hForm.SetCappingLimit($HiCappingVar)
    hForm.DispenseItem(sStatus, btndispown)
  Endif

End

Public Sub mnusave_Click()

  If GridView1.Rows.Selection.Count > 0 Then
    If Message.Question(("Bring from OUTSIDE. Are you sure ?"), ("No"), ("Yes")) = 2 Then
      modPharmSub.UpdateDispensing(GridView1[GridView1.Row, 0].Text, True)
      FillDosingGrid()
    Endif
  Endif

End

Public Sub mnuonline_Click()

  Dim Row As Integer

  If GridView1.Rows.Selection.Count > 0 Then
    Row = GridView1.Row
    modPharmSub.DisableDispOnline(GridView1[GridView1.Row, 0].Text)
    FillDosingGrid()
    GridView1.Row = Row
    Message.Info(("Request sent"), ("OK"))
  Endif

End

Public Sub mnucontinue_Click()

  Dim Row As Integer

  If GridView1.Rows.Selection.Count > 0 Then
    Row = GridView1.Row
    modPharmSub.ContinueDispReq(GridView1[GridView1.Row, 0].Text)
    FillDosingGrid()
    GridView1.Row = Row
    Message.Info(("Request Continued"), ("OK"))
  Endif

End

Public Sub mnureview_Click()

  Dim opt As String[]
  Dim Row As Integer
  Dim xval As String
  Dim cForm As CMedError
  Dim xPath As String

  If GridView1.Rows.Selection.Count > 0 Then
    If GridView1.Rows.Count > 0 Then
      opt = New String[]
      For Row = 0 To GridView1.Rows.Count - 1
        If GridView1[Row, 2].Text = "suture" Or If GridView1[Row, 2].Text = "msurg" Or If GridView1[Row, 2].Text = "ortho" Or If GridView1[Row, 2].Text = "extra" Or If GridView1[Row, 2].Text = "topical" Then
        Else
          xval = modMedConstant.GetDrugFromStockID(GridView1[Row, 3].Text)
          If opt.Count = 0 Then
            opt.Add(xval)
          Else
            If opt.Exist(xval) = False Then
              opt.Add(xval)
            Endif
          Endif

        Endif
      Next
      cForm = New CMedError
      Inc Application.Busy
      xPath = cForm.ShowMedicationReviewSingleDosIDReport(GridView1[GridView1.Row, 0].Text, opt)
      Dec Application.Busy
      modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
    Endif
  Endif

End

Public Sub mnudisplabel_Click()

  Dim xPath As String

  If GridView1.Rows.Selection.Count > 0 Then
    Inc Application.Busy
    xPath = modCHTMLPatient.ShowSingleCounselingReport(GridView1[GridView1.Row, 0].Text)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview("", xPath, "ReportSize")
  Endif

End

Private Sub GetReviewMultiMessage()

  Dim opt As Long[]
  Dim Row As Integer
  Dim cForm As CMedError
  Dim xmsg As String

  If GridView1.Rows.Count Then
    opt = New Long[]
    For Row = 0 To GridView1.Rows.Count - 1
      Select GridView1[Row, 2].Text
        Case "suture", "msurg", "ortho", "extra", "topical"
        Case Else
          opt.Add(GridView1[Row, 0].Text)
      End Select
    Next
    cForm = New CMedError
    Inc Application.Busy
    xmsg = cForm.ShowMedicationReviewMultipleDosIDMessage($encid, opt)
    Dec Application.Busy
    If xmsg Then
      MessageView1.Close()
      MessageView1.Open(xmsg, Picture["icon:/small/info"])
    Endif
  Endif

End

Public Sub btnreview_Click()

  Dim opt As Long[]
  Dim Row As Integer
  Dim cForm As CMedError
  Dim xPath As String

  If GridView1.Rows.Count Then
    opt = New Long[]
    For Row = 0 To GridView1.Rows.Count - 1
      Select GridView1[Row, 2].Text
        Case "suture", "msurg", "ortho", "extra", "topical"
        Case Else
          opt.Add(GridView1[Row, 0].Text)
      End Select
    Next
    cForm = New CMedError
    Inc Application.Busy
    xPath = cForm.ShowMedicationReviewMultipleDosIDReport($encid, opt)
    Dec Application.Busy
    modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")
  Endif

End

Public Sub btnaireview_Click()

  Dim opt As Long[]
  Dim Row As Integer
  Dim xdata As String
  Dim xans As String

  If GridView1.Rows.Count > 0 Then
    opt = New Long[]
    For Row = 0 To GridView1.Rows.Count - 1
      If GridView1[Row, 2].Text = "suture" Or If GridView1[Row, 2].Text = "msurg" Or If GridView1[Row, 2].Text = "ortho" Or If GridView1[Row, 2].Text = "extra" Or If GridView1[Row, 2].Text = "topical" Then
      Else
        opt.Add(GridView1[Row, 0].Text)
      Endif
    Next

    If opt.Count Then
      xdata = modPharmacy.ShowMedicationListDosID($encid, opt).Join(gb.NewLine)
      xans = modCloudAI.GetComboCloudAIResponse(xdata, modBasic.$CloudAIDrugQuery)
      If xans Then
        xans = MessageHtml("Cloud AI Response", modString.TextToHTML(xans), [("Useless"), ("Neutral"), ("Useful")])
      Endif
    Endif

  Endif

End

Public Sub btnshow_Click()

  Dim xPath As String

  Inc Application.Busy
  xPath = modCHTMLPatient.ShowMedicationOrder($encid)
  Dec Application.Busy
  modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")

End

''====================================Runnung medicines =================================
Private Sub GetDoseFormatType()

  Dim def As String

  def = modSettings.ShowSettingFromFIle("DoseFormat/Dispensing")
  If def Then
    If def = "Label" Then
      rblabel.Value = True
    Else
      rbvalue.Value = True
    Endif
  Else
    rbvalue.Value = True
  Endif

End

Public Sub rbvalue_Click()

  modSettings.SaveSettingsToFile("DoseFormat/Dispensing", "Value")
  RefreshGridsLabel()

End

Public Sub rblabel_Click()

  modSettings.SaveSettingsToFile("DoseFormat/Dispensing", "Label")
  RefreshGridsLabel()

End

Public Sub rballdates_Click()

  RefreshGridsLabel()

End

Public Sub rbcurrent_Click()

  RefreshGridsLabel()

End

Private Sub RefreshGridsLabel()

  If $Ready = True Then
    If TabPanel1.Index = 0 Then
      If rballdates.Value = True Then
        ShowAllMedicines()
      Else If rbcurrent.Value = True Then
        ShowRunningMedicine(cmbcurrent.Text)
      Endif
    Else If TabPanel1.Index = 1 Then
      FillDosingGrid()
    Endif
  Endif

End

Public Sub btncurrefresh_Click()

  If rballdates.Value = True Then
    ShowAllMedicines()
  Else If rbcurrent.Value = True Then
    ShowRunningMedicine(cmbcurrent.Text)
  Endif

End

Private Sub ShowAllMedicines()

  Dim sql1 As String
  Dim sql2 As String
  Dim xFields1 As String[]
  Dim xFields2 As String[]
  Dim aFields As String[]

  If rblabel.Value = True Then
    aFields = ["t.fldcheck", "t.fldsave_order", "MIN(t.fldstarttime)", "t.fldroute", "t.flditem", "t.fldid", "fldfreq", "SUM(t.flddays)", "t.fldcurval", "t.flddisctype", "t.fldendtime", "t.fldbilltype", "SUM(fldtotal)", "t.fldbillingmode"]
    xFields1 = ["fldid as fldcheck", "fldsave_order", "fldstarttime", "fldroute", "flditem", "fldid", "fldfreq", "flddays", "fldcurval", "flddisctype", "fldendtime", "fldbilltype", "(fldqtydisp-fldqtyret) as fldtotal", "fldbillingmode"]
    xFields1 = ["fldid as fldcheck", "fldsave_order", "fldstarttime", "fldroute", "flditem", "fldid", "fldfreq", "REPLACE(flddays, 0, 1) as flddays", "fldcurval", "flddisctype", "fldendtime", "fldbilltype", "(fldqtydisp-fldqtyret) as fldtotal", "fldbillingmode"]
  Else
    aFields = ["t.fldcheck", "t.fldsave_order", "MIN(t.fldstarttime)", "t.fldroute", "t.flditem", "t.flddose", "t.fldfreq", "SUM(t.flddays)", "t.fldcurval", "t.flddisctype", "t.fldendtime", "t.fldbilltype", "SUM(fldtotal)", "t.fldbillingmode"]
    xFields1 = ["fldid as fldcheck", "fldsave_order", "fldstarttime", "fldroute", "flditem", "flddose", "fldfreq", "flddays", "fldcurval", "flddisctype", "fldendtime", "fldbilltype", "(fldqtydisp-fldqtyret) as fldtotal", "fldbillingmode"]
    xFields2 = ["fldid as fldcheck", "fldsave_order", "fldstarttime", "fldroute", "flditem", "flddose", "fldfreq", "REPLACE(flddays, 0, 1) as flddays", "fldcurval", "flddisctype", "fldendtime", "fldbilltype", "(fldqtydisp-fldqtyret) as fldtotal", "fldbillingmode"]
  Endif
  If rblabel.Value = True Then
    sql1 = "select " & xFields1.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays>&4"
    sql2 = "select " & xFields2.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays=&4"
  Else
    sql1 = "select " & xFields1.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays>&4"                    ''
    sql2 = "select " & xFields2.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3 and flddays=&4"
  Endif
  $rData2 = modDatabase.$myConn.Exec("select " & aFields.Join(",") & " from (" & sql1 & " UNION ALL " & sql2 & ") as t GROUP BY flditem,flddose,fldfreq", $encid, True, "Medicines", 0)

  $aMyFields2 = New String[]
  modGridView.ReadSmallData(grdmedicine, $rData2, $aMyFields2)
  ResizeGrid()

End

Private Sub ShowRunningMedicine(xCurrent As String)

  Dim sql As String
  Dim asx As String[] = ["Completed", "Discontinue", "Change", "ReWrite", "Cancelled", "Wasted"]
  Dim i As Integer
  Dim xFields As String[]

  For i = 0 To asx.Count - 1
    asx[i] = "'" & asx[i] & "'"
  Next

  If rblabel.Value = True Then
    xFields = ["fldid", "fldsave_order", "fldstarttime", "fldroute", "flditem", "fldid", "fldfreq", "flddays", "fldcurval", "fldid", "fldstarttime", "fldstatus", "fldqtydisp-fldqtyret", "flduserid_order"]
  Else
    xFields = ["fldid", "fldsave_order", "fldstarttime", "fldroute", "flditem", "flddose", "fldfreq", "flddays", "fldcurval", "fldid", "fldstarttime", "fldstatus", "fldqtydisp-fldqtyret", "flduserid_order"]
  Endif
  Select xCurrent
    Case "Continue", "On Hold"
      If rblabel.Value = True Then
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldcurval=&5 and fldqtydisp>fldqtyret ORDER BY fldid DESC"
      Else
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and fldstarttime<=&2 and DATE_ADD(fldstarttime, INTERVAL flddays DAY)>=&3 and flditemtype=&4 and fldcurval=&5 and fldqtydisp>fldqtyret ORDER BY fldid DESC"                    ''
      Endif
      $rData2 = modDatabase.$myConn.Exec(sql, $encid, Now(), DateAdd(Now(), gb.Hour, -3), "Medicines", xCurrent)

    Case "Removed"
      If rblabel.Value = True Then
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and flditemtype=&2 and fldcurval in(" & asx.Join(",") & ") and fldqtydisp>fldqtyret ORDER BY fldid DESC"
      Else
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and flditemtype=&2 and fldcurval in(" & asx.Join(",") & ") and fldqtydisp>fldqtyret ORDER BY fldid DESC"                    ''
      Endif
      $rData2 = modDatabase.$myConn.Exec(sql, $encid, "Medicines")

    Case "All Active"
      If rblabel.Value = True Then
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and flditemtype=&2 and fldcurval=&3 and fldqtydisp>fldqtyret ORDER BY fldid DESC"
      Else
        sql = "select " & xFields.Join(",") & " from tblpatdosing where fldencounterval=&1 and flditemtype=&2 and fldcurval=&3 and fldqtydisp>fldqtyret ORDER BY fldid DESC"                    ''
      Endif
      $rData2 = modDatabase.$myConn.Exec(sql, $encid, "Medicines", "Continue")

  End Select
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(grdmedicine, $rData2, $aMyFields2)
  ResizeGrid()

End

Private Sub ResizeGrid()

  With grdmedicine
    .Columns[0].Width = 1
    .Columns[1].Width = 25 * modBasic.$AppWidthRatio
    .Columns[2].Width = 150 * modBasic.$AppWidthRatio
    .Columns[3].Width = 75 * modBasic.$AppWidthRatio
    .Columns[4].Width = 275 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 50 * modBasic.$AppWidthRatio
    .Columns[7].Width = 50 * modBasic.$AppWidthRatio
    .Columns[8].Width = 100 * modBasic.$AppWidthRatio
    If rballdates.Value = True Then
      .Columns[9].Width = 1
      .Columns[10].Width = 1
      .Columns[11].Width = 1
      .Columns[12].Width = 75 * modBasic.$AppWidthRatio
      .Columns[13].Width = 1
    Else
      .Columns[9].Width = 50 * modBasic.$AppWidthRatio
      .Columns[10].Width = 1
      .Columns[11].Width = 1
      .Columns[12].Width = 75 * modBasic.$AppWidthRatio
      .Columns[13].Width = 125 * modBasic.$AppWidthRatio
    Endif

    .Columns[2].Text = "StartDate"
    .Columns[3].Text = "Route"
    .Columns[4].Text = "Medicine"
    .Columns[5].Text = "Dose"
    .Columns[6].Text = "Freq"
    .Columns[7].Text = "Days"
    .Columns[8].Text = "Status"
    If rballdates.Value = True Then
    Else
      .Columns[9].Text = "N"
      .Columns[13].Text = "Order"
    Endif
    .Columns[12].Text = "QTY"
  End With

End

Public Sub grdmedicine_Data(Row As Integer, Column As Integer)

  $rData2.MoveTo(Row)
  modGeneralMain.GridViewDecoration(grdmedicine, Row)
  If Column = 1 Then
    If rballdates.Value = True Then
      grdmedicine.Data.Text = ""
    Else
      grdmedicine.Data.Picture = Picture[GetMedStatus($rData2[$aMyFields2[Column]])]
      grdmedicine.Data.Text = ""
    Endif
  Else If Column = 2 Then
    grdmedicine.Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else If Column = 5 Then
    If rblabel.Value = True Then
      If $rData2[$aMyFields2[Column]] Then
        grdmedicine.Data.Text = modPharmacy.GetMedicineDoseInFormat($rData2[$aMyFields2[Column]], "Label")
      Endif
    Else
      grdmedicine.Data.Text = $rData2[$aMyFields2[Column]]
    Endif
  Else If Column = 9 Then
    If rballdates.Value = True Then
      grdmedicine.Data.Text = $rData2[$aMyFields2[Column]]
    Else
      grdmedicine.Data.Text = modPharmacy.TotalDoseCount($rData2[$aMyFields2[Column]])
    Endif
  Else If Column = 13 Then
    If rballdates.Value = True Then
      grdmedicine.Data.Text = $rData2[$aMyFields2[Column]]
    Else
      grdmedicine.Data.Text = modGeneral.GetUserFullName($rData2[$aMyFields2[Column]])
    Endif
  Else
    grdmedicine.Data.Text = $rData2[$aMyFields2[Column]]
  Endif
  grdmedicine.Rows[Row].Height = Max(grdmedicine.Rows[Row].Height, grdmedicine.Data.Font.RichTextHeight(grdmedicine.Data.Text, grdmedicine.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (grdmedicine.Rows.Height - grdmedicine.Font.Height))
  grdmedicine.Data.WordWrap = True

End

Private Function GetMedStatus(sBool As Boolean) As String

  Dim xx As String

  If sBool = False Then
    xx = "icons/coll5.png"
  Else
    xx = ""
  Endif
  Return xx

End

Public Sub grdmedicine_Menu()

  mnufirst.Popup

End

Public Sub mnuadddays_Click()

  Dim xval As Float

  If rbcurrent.Value = True Then
    xval = InputValue(grdmedicine[grdmedicine.Row, 4].Text, "Increase duration (days) by", 0)
    If xval Then
      modPharmSub.AddNewDaysAfterDispensing(grdmedicine[grdmedicine.Row, 0].Text, xval)
      ShowRunningMedicine(cmbcurrent.Text)
    Endif
  Endif

End

Public Sub mnusplit_Click()

  Dim hForm As FmSplitDose

  If rbcurrent.Value = True Then
    hForm = New FmSplitDose($encid, grdmedicine[grdmedicine.Row, 0].Text)
    hForm.ShowModal
    ShowRunningMedicine(cmbcurrent.Text)
  Endif

End

Public Sub btnstatus_Click()

  Dim res As Result

  If grdmedicine.Rows.Selection.Count Then
    If rbcurrent.Value = True Then
      If cmbcurrent.Text = "Continue" Or If cmbcurrent.Text = "On Hold" Then

        If cmbstatus.Text Then
          res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldcurval=&2", grdmedicine[grdmedicine.Row, 0].Text, cmbcurrent.Text)
          res["fldcurval"] = cmbstatus.Text
          res["xyz"] = False
          res.Update()
          ShowRunningMedicine(cmbcurrent.Text)
          cmbstatus.Text = ""
          Balloon.Info(("Information saved"), btnstatus)
          Balloon.Delay = modBasic.$BalloonDelay
        Endif

      Endif
    Endif
  Endif

End

Public Sub btnaiadvice_Click()

  Dim xList As String[]
  Dim xans As String

  xList = New String[]
  For Each $rData2
    xList.Add($rData2["fldroute"] & Space(1) & modMedConstant.GetCodeFromStockID($rData2["flditem"]) & Space(2) & $rData2["flddose"] & " " & modMedConstant.GetMedicineDoseUnit($rData2["flditem"]) & " X " & $rData2["fldfreq"] & " X " & $rData2["flddays"] & " day(s)")
  Next

  If xList.Count Then
    xans = modCloudAI.GetComboCloudAIResponse(xList.Join(gb.NewLine), modBasic.$CloudAIDrugQuery)
    If xans Then
      xans = MessageHtml("Cloud AI Response", modString.TextToHTML(xans), [("Useless"), ("Neutral"), ("Useful")])
    Endif
  Endif

End

''================================Dosing History ===============================
Public Sub btndoserefresh_Click()

  If chkalldate.Value = True Then
    ListBox1.List = modPharmacy.GetMedicinesUsed($encid)
  Else
    ListBox1.List = modPharmacy.GetMedicinesUsed($encid, dtdose.Value)
  Endif

End

Public Sub ListBox1_Click()

  If ListBox1.Text Then
    If chkalldate.Value = True Then
      $rData1 = modDatabase.$myConn.Exec("select tblnurdosing.fldtime,tblpatdosing.fldid,tblnurdosing.fldvalue,tblnurdosing.fldunit,tblnurdosing.flduserid from tblnurdosing inner join tblpatdosing on tblnurdosing.flddoseno=tblpatdosing.fldid where tblnurdosing.fldencounterval=&1 and tblpatdosing.fldencounterval=&1 and tblpatdosing.flditem=&2", $encid, ListBox1.Text)
    Else
      $rData1 = modDatabase.$myConn.Exec("select tblnurdosing.fldtime,tblpatdosing.fldid,tblnurdosing.fldvalue,tblnurdosing.fldunit,tblnurdosing.flduserid from tblnurdosing inner join tblpatdosing on tblnurdosing.flddoseno=tblpatdosing.fldid where tblnurdosing.fldencounterval=&1 and tblpatdosing.fldencounterval=&1 and tblpatdosing.flditem=&2 and tblnurdosing.fldtime>=&3 and tblnurdosing.fldtime<=&4", $encid, ListBox1.Text, modDate.StartSqlDate(dtdose.Value), modDate.EndSqlDate(dtdose.Value))                    ''
    Endif
    $aMyFields1 = New String[]
    modGridView.ReadSmallData(GridView2, $rData1, $aMyFields1)

    With GridView2
      .Columns[0].Width = 150 * modBasic.$AppWidthRatio
      .Columns[1].Width = 175 * modBasic.$AppWidthRatio
      .Columns[2].Width = 50 * modBasic.$AppWidthRatio
      .Columns[3].Width = 75 * modBasic.$AppWidthRatio
      .Columns[4].Width = 75 * modBasic.$AppWidthRatio

      .Columns[0].Text = "DateTime"
      .Columns[1].Text = "Regimen"
      .Columns[2].Text = "Dose"
      .Columns[3].Text = "Unit"
      .Columns[4].Text = "User"
    End With
  Endif

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData1.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 0 Then
    GridView2.Data.Text = modReportVar.GetDateTimeReport($rData1[$aMyFields1[Column]], gb.GeneralDate)
  Else If Column = 1 Then
    GridView2.Data.Text = modPharmacy.GetDoseRegimenString($rData1[$aMyFields1[Column]], True)
    GridView2.Rows[Row].Height = Max(GridView2.Rows[Row].Height, GridView2.Data.Font.RichTextHeight(GridView2.Data.Text, GridView2.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView2.Rows.Height - GridView2.Font.Height))
    GridView2.Data.WordWrap = True
  Else
    GridView2.Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

''============================ saved entry ============================
Private Sub ShowOldEntry()

  Dim sql As String

  sql = "select fldid,fldtime,flditemtype,flditemno,flditemname,flditemrate,flditemqty,flddiscper,fldditemamt,fldcomp,fldparent,flddisctype,fldbilltype,fldbillno,fldextracol from tblpatbilling where fldencounterval=&1 and fldsave=&2 and (flditemtype=&3 or flditemtype=&4 or flditemtype=&5) and flditemqty>&6 and fldretqty=&6"                         ''
  $rData5 = modDatabase.$myConn.Exec(sql, $encid, True, "Medicines", "Surgicals", "Extra Items", 0)
  $aMyFields5 = New String[]
  modGridView.ReadSmallData(GridView5, $rData5, $aMyFields5)

  With GridView5
    .Columns[1].Text = "DateTime"
    .Columns[4].Text = "Particulars"
    .Columns[5].Text = "Rate"
    .Columns[6].Text = "QTY"
    .Columns[7].Text = "Disc %"
    .Columns[8].Text = "Total"
    .Columns[9].Text = "Comp"
    .Columns[10].Text = "Dosing"
    .Columns[11].Text = "Package"
    .Columns[12].Text = "Mode"
    .Columns[13].Text = "Invoice"
    .Columns[14].Text = "AdvRec"

    .Columns[0].Width = 1
    .Columns[1].Width = 150 * modBasic.$AppWidthRatio
    .Columns[2].Width = 1
    .Columns[3].Width = 1
    .Columns[4].Width = 300 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 50 * modBasic.$AppWidthRatio
    .Columns[7].Width = 50 * modBasic.$AppWidthRatio
    .Columns[8].Width = 75 * modBasic.$AppWidthRatio
    .Columns[9].Width = 100 * modBasic.$AppWidthRatio
    .Columns[10].Width = 75 * modBasic.$AppWidthRatio
    .Columns[11].Width = 100 * modBasic.$AppWidthRatio
    .Columns[12].Width = 75 * modBasic.$AppWidthRatio
    .Columns[13].Width = 125 * modBasic.$AppWidthRatio
    .Columns[14].Width = 125 * modBasic.$AppWidthRatio
  End With

End

Public Sub GridView5_Data(Row As Integer, Column As Integer)

  $rData5.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView5, Row)
  If Column = 1 Then
    GridView5.Data.Text = modReportVar.GetDateTimeReport($rData5[$aMyFields5[Column]], gb.GeneralDate)
  Else If Column = 10 Then
    GridView5.Data.Text = modPharmacy.TotalDoseCount($rData5[$aMyFields5[Column]])
  Else
    GridView5.Data.Text = $rData5[$aMyFields5[Column]]
  Endif

End

Public Sub btnadvreceipt_Click()

  Dim xbillNo As String
  Dim sql As String
  Dim res As Result
  Dim res1 As Result

  Inc Application.Busy
  sql = "select fldid from tblpatbilling where fldencounterval=&1 and fldsave=&2 and (flditemtype=&3 or flditemtype=&4 or flditemtype=&5) and flditemqty>&6 and fldretqty=&6 and fldbillno IS NULL and fldextracol IS NULL"                         ''
  res = modDatabase.$myConn.Exec(sql, $encid, True, "Medicines", "Surgicals", "Extra Items", 0)
  If res.Available Then
    modDatabase.$myConn.Begin
    xbillNo = modBillLock.AdvanceReceiptString("Advance Receipt")
    If xbillNo Then
      For Each res
        res1 = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1", res["fldid"])
        res1["fldextracol"] = xbillNo
        res1.Update
      Next
    Endif
    modDatabase.$myConn.Commit
  Endif
  Dec Application.Busy
  ShowOldEntry()

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

Public Sub mnureturn_Click()

  Dim sql As String
  Dim res As Result

  Dim xbatch As Integer
  Dim qty As Float
  Dim stockno As Long
  Dim xnew As Boolean
  Dim xcshcrd As Float
  Dim xitem As String

  If GridView5.Rows.Selection.Count Then
    If GridView5[GridView5.Row, 13].Text Then
      Message.Warning("Invoice already generated", ("OK"))
    Else
      If GridView5[GridView5.Row, 14].Text And GridView5[GridView5.Row, 9].Text = modBasic.$compID Then

        sql = "select fldid,fldencounterval,flditemno,flditemtype,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldparent,fldextracol,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatbilling where fldid=&1 and fldsave=&2 and flditemqty>&3 and fldretqty=&3"                         ''
        res = modDatabase.$myConn.Exec(sql, GridView5[GridView5.Row, 0].Text, True, 0)
        If res.Available Then
          If txtreason.Text Then
            If txtretqty.Value <= res["flditemqty"] Then

              xitem = ""
              xitem = modStock.GetStockNameFromStockno(res["flditemno"])
              If xitem Then
                xbatch = modStock.GetBatchFromStockNo(res["flditemno"])
                xnew = modStock.NewStock(xitem, xbatch, modBasic.$compID)
                stockno = modStock.GetItemStockNo(xitem, xbatch, modBasic.$compID)
              Endif
              If stockno Then
                If xnew = True Then
                  AddNewEntry(stockno, xitem, res["flditemno"])
                Endif
                qty = 0 - txtretqty.Value
                If res["fldcashincredit"] Then
                  xcshcrd = res["fldcashincredit"]
                Else
                  xcshcrd = 0
                Endif
                modBillings.InsertBlankBillItemNewApp(res["fldencounterval"], res["fldbilltype"], res["fldbillingmode"], res["flddisctype"], res["fldacledger"], res["flditemtype"], stockno, res["flditemname"], res["flditemrate"], qty, res["fldtaxper"], res["flddiscper"], xcshcrd, "Punched", res["fldid"], False, False, "", "", "", txtreason.Text, res["fldextracol"])
                ShowReturnGrid()
              Endif

            Endif
          Endif
        Else
          Message.Warning("Not allowed", ("OK"))
        Endif

      Else
        Message.Warning("Incorrect Location", ("OK"))
      Endif
    Endif
  Endif

End

Private Sub AddNewEntry(StockNo As Long, StockName As String, xOrigin As Long)

  Dim res As Result
  Dim res1 As Result

  res1 = modDatabase.$myConn.Exec("select fldbatch,fldexpiry,fldcost,fldsellpr,fldmrp,fldcategory from tblentry where fldstockno=&1", xOrigin)
  res = modDatabase.$myConn.Create("tblentry")
  res["fldstockno"] = StockNo
  res["fldstockid"] = StockName
  res["fldbatch"] = res1["fldbatch"]
  res["fldexpiry"] = res1["fldexpiry"]
  res["fldqty"] = 0
  res["fldstatus"] = modStock.ItemSaleStatus(StockName, modBasic.$compID)
  res["fldcost"] = res1["fldcost"]
  res["fldsellpr"] = res1["fldsellpr"]
  res["fldmrp"] = res1["fldmrp"]
  res["fldsav"] = True
  res["fldcategory"] = res1["fldcategory"]
  res["fldcomp"] = modBasic.$compID
  res["fldcode"] = 0
  res["xyz"] = True
  res.Update()

End

Private Sub ShowReturnGrid()

  Dim sql As String
  Dim res As Result
  Dim Column As Integer
  Dim fld As ResultField

  sql = "select fldid,fldordtime,flditemtype,flditemno,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldditemamt as tot,fldorduserid,fldbilltype,flddisctype,fldacledger from tblpatbilling where fldencounterval=&1 and fldretbill like &2 and fldsave=&3 and fldprint=&4 and fldordcomp=&5 and fldstatus=&6 and flditemqty<&7 and (flditemtype=&8 or flditemtype=&9 or flditemtype=&{10})"
  res = modDatabase.$myConn.Exec(sql, $encid, "ARC%", False, False, modBasic.$compID, "Punched", 0, "Medicines", "Surgicals", "Extra Items")

  GridView4.Clear
  GridView4.Columns.Count = res.Fields.Count
  GridView4.Rows.Count = res.Count

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView4, res.Index, Column)
      If Column = 1 Then
        GridView4[res.Index, Column].Text = modReportVar.GetDateTimeReport(res[fld.Name], gb.GeneralDate)
      Else
        GridView4[res.Index, Column].Text = res[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  GridView4.Row = 0

  With GridView4
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Category"
    .Columns[3].Text = "Code"
    .Columns[4].Text = "Particulars"
    .Columns[5].Text = "Rate"
    .Columns[6].Text = "QTY"
    .Columns[7].Text = "Tax %"
    .Columns[8].Text = "Disc %"
    .Columns[9].Text = "Total"
    .Columns[10].Text = "User"
    .Columns[11].Text = "Mode"
    .Columns[12].Text = "Package"
    .Columns[13].Text = "Account"

    .Columns[0].Width = 1
    .Columns[1].Width = 150 * modBasic.$AppWidthRatio
    .Columns[2].Width = 125 * modBasic.$AppWidthRatio
    .Columns[3].Width = 40 * modBasic.$AppWidthRatio
    .Columns[4].Width = 300 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 50 * modBasic.$AppWidthRatio
    .Columns[7].Width = 50 * modBasic.$AppWidthRatio
    .Columns[8].Width = 50 * modBasic.$AppWidthRatio
    .Columns[9].Width = 100 * modBasic.$AppWidthRatio
    .Columns[10].Width = 100 * modBasic.$AppWidthRatio
    .Columns[11].Width = 75 * modBasic.$AppWidthRatio
    .Columns[12].Width = 125 * modBasic.$AppWidthRatio
    .Columns[13].Width = 125 * modBasic.$AppWidthRatio
  End With

End

Public Sub GridView4_Menu()

  mnuretall.Popup

End

Public Sub mnuretdelete_Click()

  If GridView4.Rows.Selection.Count Then
    modDatabase.$myConn.Delete("tblpatbilling", "fldid=&1", GridView4[GridView4.Row, 0].Text)
    ShowReturnGrid()
  Endif

End

Public Sub btnsaveretn_Click()

  If GridView4.Rows.Selection.Count Then
    If Message.Question(GridView4[GridView4.Row, 4].Text & " will be discontinued. Are you sure ?", ("OK"), ("Yes")) = 2 Then
      PharmacyReturn(GridView4[GridView4.Row, 0].Text)
      ShowOldEntry()
      ShowReturnGrid()
    Endif
  Endif

End

Private Sub PharmacyReturn(xIndex As Long)

  Dim sql As String
  Dim res As Result
  Dim res1 As Result
  Dim res2 As Result
  Dim res3 As Result
  Dim qtynew As Float
  Dim xgo As Boolean
  Dim aqty As Integer

  sql = "select fldid,flditemtype,flditemno,flditemname,flditemrate,flditemqty,fldtaxper,flddiscper,fldparent,fldencounterval from tblpatbilling where fldencounterval=&1 and fldretbill like &2 and fldsave=&3 and fldprint=&4 and fldordcomp=&5 and fldstatus=&6 and flditemqty<&7 and fldid=&8"
  res = modDatabase.$myConn.Exec(sql, $encid, "ARC%", False, False, modBasic.$compID, "Punched", 0, xIndex)
  If res.Available = True Then
    Inc Application.Busy
    If modBasic.$BillVerifyReturn = "Enable" Then
      res3 = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1", res["fldid"])
      res3["fldstatus"] = "Waiting"
      res3.Update()
    Else

      ''update tblpatdosing
      qtynew = 0 - res["flditemqty"]
      xgo = False

      If qtynew Then
        modDatabase.$myConn.Begin
        res1 = modDatabase.$myConn.Exec("select fldid,fldqtydisp,fldqtyret from tblpatdosing where fldid in(select fldparent from tblpatbilling where fldid=&1 and flditemname=&2 and fldencounterval=&3)", res["fldparent"], res["flditemname"], $encid)
        If qtynew <= (res1["fldqtydisp"] - res1["fldqtyret"]) Then
          res2 = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1", res1["fldid"])
          res2["fldqtyret"] = res2["fldqtyret"] + qtynew
          res2["flduptime"] = Now()
          res2["xyz"] = False
          res2.Update()
          xgo = True
          qtynew = 0
        Endif

        If xgo = True Then
          aqty = qtynew - res["flditemqty"]
          'add QTY to tblentry
          modStockSub.AddToExistEntry(res["flditemno"], aqty, modBasic.$compID)
          ''update parent record with return qty
          modBillings.UpdateReturnBillQTY(res["fldparent"], res["fldencounterval"], res["flditemname"], (0 - aqty))
          ''update current record
          res3 = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1", res["fldid"])
          res3["fldstatus"] = "Done"
          res3["fldsave"] = True
          res3["flduserid"] = modBasic.$lbluser
          res3["fldtime"] = Now()
          res3["fldcomp"] = modBasic.$compID
          res3["xyz"] = False
          res3.Update()
        Endif
        modDatabase.$myConn.Commit
      Endif

    Endif
    Dec Application.Busy
  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

''======================= Protocols =======================
Public Sub btnaddprotocol_Click()

  Dim xx As String
  Dim xList As String[]
  Dim res As Result

  xList = modMedicine.GetMedicineProcolsList()
  If xList And If xList.Count Then
    xx = InputCombo("Select Protocol to Assign", "Drug Protocols", xList, "", True)
    If xx Then
      res = modDatabase.$myConn.Create("tblpatprotocols")
      res["fldencounterval"] = $encid
      res["fldpatientval"] = $PatientNum
      res["fldprotocol"] = xx
      res["fldstatus"] = "Active"
      res["fldusage"] = ""
      res["fldfuture"] = chknewvisit.Value
      res["flduserid"] = modBasic.$lbluser
      res["fldtime"] = Now()
      res["fldcomp"] = modBasic.$compID
      res["fldsave"] = True
      res["xyz"] = False
      res.Update
      ShowPatProtocols()
    Endif
  Endif

End

Private Sub ShowPatProtocols()

  Dim sql1 As String
  Dim sql2 As String

  sql1 = "select fldid,fldtime,fldprotocol,fldstatus,fldfuture,flduserid,fldusage from tblpatprotocols where fldencounterval=&1 and (fldstatus=&2 or fldstatus=&3)"
  sql2 = "select fldid,fldtime,fldprotocol,fldstatus,fldfuture,flduserid,fldusage from tblpatprotocols where fldpatientval=&4 and (fldstatus=&2 or fldstatus=&3) and fldfuture=&5"
  $rData3 = modDatabase.$myConn.Exec(sql1 & " UNION " & sql2, $encid, "Active", "Inactive", $PatientNum, True)
  $aMyFields3 = New String[]
  modGridView.ReadSmallData(GridView3, $rData3, $aMyFields3)

  With GridView3
    .Columns[0].Width = 1
    .Columns[1].Width = 150 * modBasic.$AppWidthRatio
    .Columns[2].Width = 250 * modBasic.$AppWidthRatio
    .Columns[3].Width = 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 25 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio
    .Columns[6].Width = 300 * modBasic.$AppWidthRatio

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Protocols"
    .Columns[3].Text = "Status"
    .Columns[5].Text = "Prescriber"
    .Columns[6].Text = "Direction"
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer)

  $rData3.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView3, Row)
  If Column = 1 Then
    GridView3.Data.Text = modReportVar.GetDateTimeReport($rData3[$aMyFields3[Column]], gb.GeneralDate)
  Else If Column = 4 Then
    GridView3.Data.Picture = Picture[modMisc.SetGridCheckIcon($rData3[$aMyFields3[Column]])]
    GridView3.Data.Text = ""
  Else
    GridView3.Data.Text = $rData3[$aMyFields3[Column]]
  Endif

End

Public Sub GridView3_Click()

  Dim Row As Integer
  Dim xx As String
  Dim res As Result

  If GridView3.Rows.Selection.Count Then
    Row = GridView3.Row
    If GridView3.Column = 3 Then
      xx = InputCombo("Alter Status of " & GridView3[GridView3.Row, 2].Text, "Alter Status", ["Active", "Inactive"], GridView3[GridView3.Row, 3].Text, True)
      If xx Then
        res = modDatabase.$myConn.Edit("tblpatprotocols", "fldid=&1 and fldencounterval=&2", GridView3[GridView3.Row, 0].Text, $encid)
        res["fldstatus"] = xx
        res.Update
        ShowPatProtocols()
      Endif
    Else If GridView3.Column = 6 Then
      xx = InputBox("Alter Directions for " & GridView3[GridView3.Row, 2].Text, "Alter Directions", GridView3[GridView3.Row, 6].Text)
      If xx Then
        res = modDatabase.$myConn.Edit("tblpatprotocols", "fldid=&1 and fldencounterval=&2", GridView3[GridView3.Row, 0].Text, $encid)
        res["fldusage"] = xx
        res.Update
        ShowPatProtocols()
      Endif
    Endif
    GridView3.Row = Row
  Endif

End

Public Sub btnprotdel_Click()

  Dim res As Result

  If GridView3.Rows.Selection.Count Then
    If Message.Question("Are you sure ?", ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatprotocols", "fldid=&1 and fldencounterval=&2", GridView3[GridView3.Row, 0].Text, $encid)
      If modGeneral.AllowClinicalEdit(res["flduserid"]) = True Then
        modDatabase.$myConn.Delete("tblpatprotocols", "fldid=&1 and fldencounterval=&2", GridView3[GridView3.Row, 0].Text, $encid)
      Else
        res["fldstatus"] = "Cancelled"
        res.Update
      Endif
      ShowPatProtocols()
    Endif
  Endif

End
