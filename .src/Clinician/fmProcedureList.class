' Gambas class file

Private $rData2 As Result
Private $aMyFields2 As String[]
Private $rData As Result
Private $aMyFields As String[]

Private $counterLst As String[]

Private $tblpatbilling As String
Private $tblpatlabtest As String
Private $tblpatlabsubtest As String

Public Sub Form_Open()

  Dim xoption As String
  Dim xx As String

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Horizontal")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  Panel4.Width = Panel1.Width - (Panel2.Width + Panel7.Width)

  cmbcategory.List = ["Major", "Intermediate", "Any"]
  cmbcategory.Text = "Any"
  LoadProcedureList()
  cmbsection.List = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where flditemtype=&1", "Procedures"))
  cmbsection.Add("All Sections")
  cmbsection.Text = "All Sections"
  cmbsourcedept.List = modGeneral.GetDepartmentAllList("%")
  $counterLst = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select fldsection as col from tblsurgerysection"))
  cmbprocteam.List = $counterLst
  cmbaddprocteam.List = $counterLst
  cmbaddprocteam.Text = "%"

  modAccount.PasInvoiceSetting(cmbfiscal, False)
  LoadTableNames()

  xoption = modSettings.ShowSettingFromFIle("EntrySetting/Procedure_DateSelect")
  If xoption = "Yes" Then
    chklist.Value = True
  Else If xoption = "No" Then
    chklist.Value = False
  Endif
  DateSelectionSett()

  xx = modSettings.ShowSettingFromFIle("Procedure/InputFormat")
  If xx = "Invoice" Then
    rbinvoice.Value = True
  Else If xx = "Saved" Then
    rbindoor.Value = True
  Else
    rbencounter.Value = True
  Endif
  dtlisted.Value = Now()
  dtbillplan.Value = Now()
  dtprocedure.Value = Now()
  rbpending.Value = True

End

Public Sub Form_Resize()

  modGeneralMain.ShowSelectedFormMenu(Me)

End

Public Sub Form_KeyRelease()

  If Key.Code = Key["R"] And If Key.Control Then
    btnnewrefresh_Click()
  Else If Key.Code = Key["A"] And If Key.Control Then
    ' AddSampling()
  Else If Key.Code = Key["X"] And If Key.Control Then
    Me.Close()
  Else If Key.Code = Key["B"] And If Key.Control Then
    Me.Close
    Wait
    modWorkSpace.Add(fmProcedureList)
  Endif

End

Public Sub Form_Close()

  modSettings.SaveSettingsToFile("Laboratory/DefaultDepartment", cmbcategory.Text)
  modGeneralMain.RecordFormExit(Me)

End

Private Sub LoadTableNames()

  Dim res As Result

  If cmbfiscal.Text = "Current" Then
    $tblpatbilling = "tblpatbilling"
    $tblpatlabtest = "tblpatlabtest"
    $tblpatlabsubtest = "tblpatlabsubtest"
  Else
    res = modDatabase.$myConn.Exec("select fldpatbilling,fldpatbilldetail,fldtempbilldetail,fldpatlabtest,fldpatlabsubtest from tblfisclosing where fldindex=&1 and (fldstate=&2 or fldstate IS NULL)", cmbfiscal.Text, "Active")
    If res.Available Then
      If res["fldpatbilling"] Then
        $tblpatbilling = res["fldpatbilling"]
      Else
        $tblpatbilling = "tblpatbilling"
      Endif
      If res["fldpatlabtest"] Then
        $tblpatlabtest = res["fldpatlabtest"]
      Else
        $tblpatlabtest = "tblpatlabtest"
      Endif
      If res["fldpatlabsubtest"] Then
        $tblpatlabsubtest = res["fldpatlabsubtest"]
      Else
        $tblpatlabsubtest = "tblpatlabsubtest"
      Endif
    Else
      $tblpatbilling = "tblpatbilling"
      $tblpatlabtest = "tblpatlabtest"
      $tblpatlabsubtest = "tblpatlabsubtest"
    Endif
  Endif

End

Private Sub LoadProcedureList()

  Dim aList As String[]

  If cmbcategory.Text = "Any" Then
    aList = modNonMedical.NonStockBillActiveItemArray("Procedures", "%")
  Else
    aList = modNonMedical.NonStockBillActiveItemArray("Procedures", "%", cmbcategory.Text)
  Endif
  aList.Add("%")

  cmbprocedure.List = aList
  cmbprocedure.Text = "%"

End

Public Sub cmbcategory_Click()

  LoadProcedureList()

End

Public Sub btnaddcounter_Click()

  Dim hForm As FmAddVariableGrid

  hform = New FmAddVariableGrid("fldsection", "tblsurgerysection")
  hform.ShowModal
  $counterLst = modControlSub.GetDirectFillresultNoNull(modDatabase.$myConn.Exec("select fldsection as col from tblsurgerysection"))
  cmbprocteam.List = $counterLst
  cmbaddprocteam.List = $counterLst

End

Public Sub cmbfiscal_Click()

  LoadTableNames()

End

Public Sub rbencounter_Click()

  modSettings.SaveSettingsToFile("Procedure/InputFormat", "Encounter")

End

Public Sub rbinvoice_Click()

  modSettings.SaveSettingsToFile("Procedure/InputFormat", "Invoice")

End

Public Sub rbindoor_Click()

  modSettings.SaveSettingsToFile("Procedure/InputFormat", "Saved")

End

Public Sub chklist_Click()

  modSettings.EnterCheckSetting(chklist, "EntrySetting/Procedure_DateSelect")
  DateSelectionSett()

End

Private Sub DateSelectionSett()

  If chklist.Value = True Then
    Panel13.Enabled = True
  Else
    Panel13.Enabled = False
  Endif

End

Public Sub dtneplist_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtlisted.Value))
  If xx Then
    dtlisted.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub dtnepbilllan_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtbillplan.Value))
  If xx Then
    dtbillplan.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnpayto_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$IPConsultUserList)
  If xMedUser And If xMedUser.Count Then
    btnpayto.Tag = xMedUser[0]
    btnpayto.Text = xMedUser[1]
  Else
    btnpayto.Tag = ""
    btnpayto.Text = ""
  Endif

End

Public Sub btnpayto_Change()

  If btnpayto.Text = "" Then
    btnpayto.Tag = ""
  Endif

End

Public Sub btnnewrefresh_Click()

  Inc Application.Busy
  If rbencounter.Value = True Then
    FillSamplingEncounters()
  Else If rbinvoice.Value = True Then
    FillSamplingInvoices()
  Else If rbindoor.Value = True Then
    FillSamplingSaved()
  Endif
  Dec Application.Busy
  GridView2.SetFocus

End

Private Sub FillSamplingEncounters()

  Dim sql As String
  Dim xsource As String
  Dim aTarg As String
  Dim bTarg As String
  Dim xsection As String

  If cmbsection.Text = "All Sections" Then
    xsection = ""
  Else
    xsection = db.Subst(" and flditemname in(select flditemname from tblservicecost where fldreport=&1 and flditemtype=&2)", cmbsection.Text, "Procedures")
  Endif
  If cmbcategory.Text = "Any" Then
    aTarg = "Major"
    bTarg = "Intermediate"
  Else
    aTarg = cmbcategory.Text
    bTarg = cmbcategory.Text
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    sql = "select fldid,fldencounterval,fldencounterval,flditemname,fldordcomp,fldencounterval,fldencounterval,fldtarget from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemqty>fldretqty and fldbillno IS NOT NULL" & xsource & xsection                                               ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Procedures", "Waiting", True, aTarg, bTarg, modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)))
  Else
    sql = "select fldid,fldencounterval,fldencounterval,flditemname,fldordcomp,fldencounterval,fldencounterval,fldtarget from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemqty>fldretqty and fldbillno IS NOT NULL" & xsource & xsection                                                ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Procedures", "Waiting", True, aTarg, bTarg)
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()

End

Private Sub FillSamplingInvoices()

  Dim sql As String
  Dim xsource As String
  Dim aTarg As String
  Dim bTarg As String
  Dim xsection As String

  If cmbsection.Text = "All Sections" Then
    xsection = ""
  Else
    xsection = db.Subst(" and flditemname in(select flditemname from tblservicecost where fldreport=&1 and flditemtype=&2)", cmbsection.Text, "Procedures")
  Endif
  If cmbcategory.Text = "Any" Then
    aTarg = "Major"
    bTarg = "Intermediate"
  Else
    aTarg = cmbcategory.Text
    bTarg = cmbcategory.Text
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    sql = "select fldid,fldbillno,fldencounterval,flditemname,fldordcomp,fldencounterval,fldencounterval,fldtarget from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemqty>fldretqty and fldprint=&8" & xsource & xsection                                                ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Procedures", "Waiting", True, aTarg, bTarg, modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), True)
  Else
    sql = "select fldid,fldbillno,fldencounterval,flditemname,fldordcomp,fldencounterval,fldencounterval,fldtarget from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemqty>fldretqty and fldprint=&6" & xsource & xsection                                             ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Procedures", "Waiting", True, aTarg, bTarg, True)
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()

End

Private Sub FillSamplingSaved()

  Dim sql As String
  Dim xsource As String
  Dim aTarg As String
  Dim bTarg As String
  Dim xsection As String

  If cmbsection.Text = "All Sections" Then
    xsection = ""
  Else
    xsection = db.Subst(" and flditemname in(select flditemname from tblservicecost where fldreport=&1 and flditemtype=&2)", cmbsection.Text, "Procedures")
  Endif
  If cmbcategory.Text = "Any" Then
    aTarg = "Major"
    bTarg = "Intermediate"
  Else
    aTarg = cmbcategory.Text
    bTarg = cmbcategory.Text
  Endif
  If cmbsourcedept.Text Then
    xsource = db.Subst(" and fldcurrlocat like &1", cmbsourcedept.Text)
  Else
    xsource = ""
  Endif

  If chklist.Value = True Then
    sql = "select fldid,fldencounterval,fldencounterval,flditemname,fldordcomp,fldencounterval,fldencounterval,fldtarget from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and fldtime>=&6 and fldtime<=&7 and flditemqty>fldretqty and fldprint=&8" & xsource & xsection                                               ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Procedures", "Waiting", True, aTarg, bTarg, modDate.StartSqlDate(dtlisted.Value), modDate.EndSqlDate(DateAdd(dtlisted.Value, gb.Day, txtrange.Value)), False)
  Else
    sql = "select fldid,fldencounterval,fldencounterval,flditemname,fldordcomp,fldencounterval,fldencounterval,fldtarget from " & $tblpatbilling & " where flditemtype=&1 and fldsample=&2 and fldsave=&3 and (fldtarget=&4 or fldtarget=&5) and flditemqty>fldretqty and fldprint=&6" & xsource & xsection                                                ''
    $rData2 = modDatabase.$myConn.Exec(sql, "Procedures", "Waiting", True, aTarg, bTarg, False)
  Endif
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)
  SHowPatientGrid()

End

Private Sub SHowPatientGrid()

  With GridView2
    .Columns[0].Width = 1
    .Columns[1].Width = 125 * modBasic.$AppWidthRatio
    .Columns[2].Width = 10 * modBasic.$AppWidthRatio
    .Columns[3].Width = 250 * modBasic.$AppWidthRatio
    .Columns[4].Width = 75 * modBasic.$AppWidthRatio
    .Columns[5].Width = 125 * modBasic.$AppWidthRatio
    .Columns[6].Width = 100 * modBasic.$AppWidthRatio
    .Columns[7].Width = 75 * modBasic.$AppWidthRatio

    If rbencounter.Value = True Then
      .Columns[1].Text = "EncID"
    Else If rbinvoice.Value = True Then
      .Columns[1].Text = "Invoice"
    Else If rbindoor.Value = True Then
      .Columns[1].Text = "EncID"
    Endif
    .Columns[3].Text = "Procedure"
    .Columns[4].Text = "Sender"
    .Columns[5].Text = "EncID"
    .Columns[6].Text = "Location"
    .Columns[7].Text = "Type"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData2.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 2 Then
    GridView2.Data.Text = ""
    GridView2.Data.Background = modPatient.GetPatientColor($rData2[$aMyFields2[Column]])
  Else If Column = 6 Then
    GridView2.Data.Text = modPatient.GetPatientLocation($rData2[$aMyFields2[Column]])
  Else
    GridView2.Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End

Public Sub btnaddin_Click()

  AddProcedureData()

End

Private Sub AddProcedureData()

  Dim res2 As Result

  If GridView2.Rows.Selection.Count > 0 Then
    res2 = modDatabase.$myConn.Edit($tblpatbilling, "fldid=&1 and (flditemqty-fldretqty)>&2", GridView2[GridView2.Row, 0].Text, 0)
    If res2.Available Then

      Inc Application.Busy
      modDatabase.$myConn.Begin
      modPatientGeneral.AddProcedureData(res2["fldencounterval"], res2["fldid"], "Procedures", res2["flditemname"], "Planned", res2["fldbillingmode"], dtbillplan.Value, cmbprocteam.Text, "")
      res2["fldsample"] = "Sampled"
      res2["xyz"] = False
      res2.Update()
      modDatabase.$myConn.Commit
      Dec Application.Busy

      If rbencounter.Value = True Then
        FillSamplingEncounters()
      Else If rbinvoice.Value = True Then
        FillSamplingInvoices()
      Else If rbindoor.Value = True Then
        FillSamplingSaved()
      Endif
      ShowPlanProcedures()

    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

''=================================== Planned Procedures ==================================
Public Sub btnepsort_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtprocedure.Value))
  If xx Then
    dtprocedure.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnrefresh_Click()

  ShowPlanProcedures()

End

Private Sub ShowPlanProcedures()

  Dim sql As String
  Dim xencid As String
  Dim xsection As String

  If cmbaddprocteam.Text Then
    If cmbaddprocteam.Text = "%" Then
      xsection = ""
    Else
      xsection = " and fldstatus like &6"
    Endif
  Else
    xsection = ""
  Endif

  If txtsearch.Text Then
    xencid = Subst(" and fldencounterval=&1", Trim(txtsearch.Text))
  Else
    xencid = ""
  Endif

  If rbpending.Value = True Then
    sql = "select fldid,fldencounterval,fldnewdate,fldnewdate,fldstatus,flditem,flduserid,fldencounterval,fldencounterval,fldencounterval,fldencounterval,fldreportquali from tblpatgeneral where fldnewdate>=&1 and fldnewdate<=&2 and fldinput=&3 and flditem like &4 and fldreportquali<>&5" & xsection & xencid & " ORDER BY fldnewdate"                                                                           ''
  Else If rbreported.Value = True Then
    sql = "select fldid,fldencounterval,fldnewdate,fldnewdate,fldstatus,flditem,flduserid,fldencounterval,fldencounterval,fldencounterval,fldencounterval,fldreportquali from tblpatgeneral where fldnewdate>=&1 and fldnewdate<=&2 and fldinput=&3 and flditem like &4 and fldreportquali=&5" & xsection & xencid & " ORDER BY fldnewdate"
  Endif
  $rData = modDatabase.$myConn.Exec(sql, modDate.StartSqlDate(dtprocedure.Value), modDate.EndSqlDate(dtprocedure.Value), "Procedures", cmbprocedure.Text, "Done", cmbaddprocteam.Text)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Width = 1
    .Columns[1].Width = 25 * modBasic.$AppWidthRatio ''triage
    .Columns[2].Width = 1 ''datetime
    .Columns[3].Width = 75 * modBasic.$AppWidthRatio ''Time
    .Columns[4].Width = 125 * modBasic.$AppWidthRatio  ''section
    .Columns[5].Width = 200 * modBasic.$AppWidthRatio ''Procedure
    .Columns[6].Width = 125 * modBasic.$AppWidthRatio  ''surgeon

    .Columns[7].Width = 125 * modBasic.$AppWidthRatio ''encid
    .Columns[8].Width = 200 * modBasic.$AppWidthRatio  ''name
    .Columns[9].Width = 150 * modBasic.$AppWidthRatio  ''age/sex
    .Columns[10].Width = 125 * modBasic.$AppWidthRatio  ''contact
    .Columns[11].Width = 75 * modBasic.$AppWidthRatio ''Time

    .Columns[3].Text = "Time"
    .Columns[4].Text = "Section"
    .Columns[5].Text = "Procedure"
    .Columns[6].Text = "Surgeon"
    .Columns[7].Text = "EncID"
    .Columns[8].Text = "Name"
    .Columns[9].Text = "Age/Sex"
    .Columns[10].Text = "Contact"
    .Columns[11].Text = "Status"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  If Column = 1 Then
    GridView1.Data.Text = ""
    GridView1.Data.Background = modPatient.GetPatientColor($rData[$aMyFields[Column]])
  Else If Column = 3 Then
    GridView1.Data.Text = Time($rData[$aMyFields[Column]])
  Else If Column = 6 Then
    GridView1.Data.Text = modGeneral.GetUserFullName($rData[$aMyFields[Column]])
  Else If Column = 8 Then
    GridView1.Data.Text = modPatient.GetPatientNameByEnc($rData[$aMyFields[Column]])
  Else If Column = 9 Then
    GridView1.Data.Text = modPatient.GetPatientAgeString($rData[$aMyFields[Column]], Now()) & "/" & modPatient.GetPatientSex($rData[$aMyFields[Column]])
  Else If Column = 10 Then
  Else
    GridView1.Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub GridView1_Menu()

  mnuhide.Popup()

End

Public Sub mnueditdate_Click()

  Dim res As Result
  Dim Row As Integer
  Dim xdate As Date

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    xdate = GetDateValue("Select Procedure Plan Date", GridView1[GridView1.Row, 7].Text, GridView1[GridView1.Row, 2].Text)
    If xdate Then
      res = modDatabase.$myConn.Edit("tblpatgeneral", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldnewdate"] = xdate
      res["xyz"] = False
      res.Update
      ShowPlanProcedures()
    Endif
    GridView1.Row = Row
  Endif

End

Public Sub mnueditsection_Click()

  Dim res As Result
  Dim Row As Integer
  Dim xval As String

  If GridView1.Rows.Selection.Count Then
    Row = GridView1.Row
    xval = InputCombo("Select Procedure Section", GridView1[GridView1.Row, 7].Text, $counterLst, GridView1[GridView1.Row, 4].Text, True)
    If xval Then
      res = modDatabase.$myConn.Edit("tblpatgeneral", "fldid=&1", GridView1[GridView1.Row, 0].Text)
      res["fldstatus"] = xval
      res["xyz"] = False
      res.Update
      ShowPlanProcedures()
    Endif
    GridView1.Row = Row
  Endif

End

Public Sub btnform_Click()

  Dim hForm As FmPatProcedure

  If GridView1.Rows.Selection.Count Then
    hForm = New FmPatProcedure(GridView1[GridView1.Row, 7].Text, GridView1[GridView1.Row, 0].Text, True)
    modWorkSpace.Add(hForm)
  Endif

End
