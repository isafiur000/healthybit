' Gambas class file

Public $DiscPackage As String

Private $encid As String
Private $PatientNum As String
Private $status As String
Private $Dept As String

Private $LedgerAC As String
Private $xBillType As String
Private $sBillMode As String
Private $sClaimState As String

Private $rData As Result
Private $aMyFields As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]

Private $xNHISCode As String
Private $HiCappingVar As Collection

Public Sub _new(encid As String, sStatus As String, DiscPackage As String)

  $encid = encid
  $status = sStatus
  $DiscPackage = DiscPackage

End

Public Sub Form_Open()

  Select $status
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $Dept = "IPD"
    Case Else
      $Dept = "OPD"
  End Select

  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $xNHISCode = modPatient.GetPatientExtCOdebyEnc($encid)
  cmbdisctype.List = modBasic.$BillDiscountCash
  If cmbdisctype.List.Count = 0 Then
    cmbdisctype.Add($DiscPackage)
  Endif
  cmbdisctype.Text = $DiscPackage
  ShowBillingParam($DiscPackage)
  ShowUsedGridViewList()
  rbroute.Value = True
  rbroute_Click()

End

Public Sub cmbdisctype_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdisctype)
  modFillContainer.RestrictComboToContent(cmbdisctype)

End

Public Sub cmbdisctype_Click()

  If cmbdisctype.Text Then
    ShowBillingParam(cmbdisctype.Text)
    cmbgroup_Click()
  Endif

End

Public Sub SetOwnDepartment(sIndex As String)

  $Dept = sIndex
  ShowUsedGridViewList()

End

Public Sub UpdateBillingParam()

  ShowBillingParam($DiscPackage)

End

Public Sub RearrangeGrid()

  ResizeGrid()

End

Private Sub ShowBillingParam(sDisctype As String)

  Dim hForm As CPackageParams

  $HiCappingVar = New Collection
  hForm = New CPackageParams($encid, sDisctype)
  $sBillMode = hForm.GetBillingMode()
  $LedgerAC = hForm.GetLedgerAC()
  $xBillType = hForm.GetBillType()
  $sClaimState = hForm.GetClaimState()

End

Private Sub GetHImedicineCappingVar()

  Dim hForm As CimisAPICap

  If cmbdisctype.Text = modBasic.$HIPackage Or If cmbdisctype.Text = modBasic.$HIPackageER Then
    If modBasic.$IMISValidateURL Then

      If modClaim.GetChronicClaimStatus($encid) = True Then
        If $HiCappingVar.Count Then
          $HiCappingVar.Clear()
        Endif
      Else
        If Not $HiCappingVar.Count Then
          Inc Application.Busy
          hForm = New CimisAPICap($xNHISCode)
          $HiCappingVar = hForm.GetMedicineLimits()
          Dec Application.Busy
        Endif
      Endif

    Endif
  Endif

End

Public Sub RefreshList()

  LoadCategories()

End

Private Function GetPlannedProtocols() As String[]

  Dim sql1 As String
  Dim sql2 As String
  Dim xList As String[]

  sql1 = "select distinct(fldprotocol) as col from tblpatprotocols where fldencounterval=&1 and fldstatus=&2"
  sql2 = "select distinct(fldprotocol) as col from tblpatprotocols where fldpatientval=&3 and fldstatus=&2 and fldfuture=&4"
  xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec(sql1 & " UNION " & sql2, $encid, "Active", $PatientNum, True))
  Return xList

End

Private Sub LoadCategories()

  If rbroute.Value = True Then
    chkall.Value = False
    chkall.Enabled = False
    If chknewall.Value = True Then
      cmbgroup.List = modMedicine.ComboRoute()
    Else
      cmbgroup.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldroute) as col from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldcurval=&3", $encid, False, "Continue"))
    Endif
    btnselect.Text = "+1"

  Else If rbprot.Value = True Then
    chkall.Enabled = True
    If chknewall.Value = True Then
      cmbgroup.List = modMedicine.GetMedicineProcolsList()
    Else
      cmbgroup.List = GetPlannedProtocols()
    Endif
    btnselect.Text = ""

  Endif
  ShowUsedGridViewList()

End

Public Sub rbroute_Click()

  LoadCategories()

End

Public Sub rbprot_Click()

  LoadCategories()

End

Public Sub chknewall_Click()

  LoadCategories()

End

Public Sub cmbgroup_Click()

  If cmbgroup.Text Then
    If rbroute.Value = True Then
      ShowCurrStockGrid(cmbgroup.Text, "%")
    Else If rbprot.Value = True Then
      ShowProtocolStockGrid(cmbgroup.Text, "%")
    Endif
    txtsearch.SetFocus
  Endif

End

Public Sub txtsearch_Change()

  Dim xText As String

  If chkleftmain.Value = True Then
    xText = "%" & LCase(txtsearch.Text) & "%"
  Else
    xText = LCase(txtsearch.Text) & "%"
  Endif

  If cmbgroup.Text Then
    If rbroute.Value = True Then
      ShowCurrStockGrid(cmbgroup.Text, xText)
    Else If rbprot.Value = True Then
      ShowProtocolStockGrid(cmbgroup.Text, xText)
    Endif
  Endif

End

Private Sub ShowCurrStockGrid(sRoute As String, sSearch As String)

  Dim xType As String
  Dim xList As String[]

  If chknewall.Value = True Then
    xType = modNonMedical.GetBillItemCategoryFromCombo(sRoute)
    Select xType
      Case "Medicines"
        $rData = modDatabase.$syConn.Exec("select t1.fldbrandid,t1.fldbrandid,t1.fldbrandid,t2.fldroute from tblmedbrand as t1 inner join tbldrug as t2 on t1.flddrug=t2.flddrug where t1.fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and t2.fldroute=&3 and lower(t1.fldbrandid) like &4 ORDER BY t1.fldbrandid ASC", 0, modBasic.$compID, sRoute, sSearch)                                ''
      Case "Surgicals"
        $rData = modDatabase.$syConn.Exec("select t1.fldbrandid,t1.fldbrandid,t1.fldbrandid,t2.fldsurgcateg from tblsurgbrand as t1 inner join tblsurgicals as t2 on t1.fldsurgid=t2.fldsurgid where t1.fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and t2.fldsurgcateg=&3 and lower(t1.fldbrandid) like &4 ORDER BY t1.fldbrandid ASC", 0, modBasic.$compID, sRoute, sSearch)
      Case "Extra Items"
        xList = ["fldbrandid", "fldbrandid", "fldbrandid"]
        xList.Add(Quote("extra"))
        $rData = modDatabase.$syConn.Exec("select " & xList.Join(",") & " from tblextrabrand where fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and lower(fldbrandid) like &3 ORDER BY fldbrandid ASC", 0, modBasic.$compID, sSearch)
    End Select

  Else
    $rData = modDatabase.$syConn.Exec("select flditem,flditem,flditem,fldroute from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldcurval=&3 and fldroute=&4 and lower(flditem) like &5 ORDER BY flditem ASC", $encid, False, "Continue", sRoute, sSearch)
  Endif
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView3, $rData, $aMyFields)

  With GridView3
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = GridView3.Width
    .Columns[2].Width = 50 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "Stock"
  End With

End

Private Sub ShowProtocolStockGrid(sPack As String, sSearch As String)

  $rData = modDatabase.$myConn.Exec("select fldid,flditem,fldqty,fldroute from tblproductgroup where fldmedgroup=&1 and (fldcomp=&2 or fldcomp=&3) and flditem like &4", sPack, modBasic.$compID, "%", sSearch)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView3, $rData, $aMyFields)
  With GridView3
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = 300 * modBasic.$AppWidthRatio
    .Columns[2].Width = 50 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "QTY"
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView3, Row)
  If Column = 0 Then
    GridView3.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 1 Then
    GridView3.Data.Text = $rData[$aMyFields[Column]]
    GridView3.Rows[Row].Height = Max(GridView3.Rows[Row].Height, GridView3.Data.Font.RichTextHeight(GridView3.Data.Text, GridView3.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView3.Rows.Height - GridView3.Font.Height))
    GridView3.Data.WordWrap = True
  Else If Column = 2 Then
    If rbroute.Value = True Then
      GridView3.Data.Text = modStock.TotalQTYbyBrand($rData[$aMyFields[Column]], modBasic.$compID)
    Else
      GridView3.Data.Text = $rData[$aMyFields[Column]]
    Endif
  Else
    GridView3.Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub GridView3_Click()

  If GridView3.Column = 0 Then
    modGridView.CheckUncheckGridNoDB(GridView3, 0)
  Else
    txtdose.Value = 0
    txtqty.Value = 0
    If modBasic.$ClinFractQuantity = "Enable" Then
      txtbreakitem.Text = GridView3[GridView3.Row, 1].Text
      SHowBreakPanel(GridView3[GridView3.Row, 1].Text)
    Endif
  Endif

End

Private Sub SHowBreakPanel(sItem As String)

  Dim xbreak As String

  If rbroute.Value = True Then
    Select cmbgroup.Text
      Case "oral", "liquid", "fluid", "injection", "resp", "topical", "eye/ear", "anal/vaginal"
        xbreak = modMedConstant.GetAllowTabBreak(sItem)
        If xbreak = "Yes" Then
          pnldose.Visible = True
          lblunit.Text = modMedConstant.GetDrugDosingUnit(sItem)
        Else
          pnldose.Visible = False
        Endif
      Case Else
        pnldose.Visible = False
    End Select
  Else
    pnldose.Visible = False
  Endif

End

Public Sub txtdose_Change()

  Dim xstr As Float
  Dim xpack As Float

  If txtdose.Value Then
    xstr = modMedConstant.GetDrugInitialStrength(txtbreakitem.Text)
    xpack = modMedConstant.GetPackVolValue(txtbreakitem.Text)
    If xstr And If xpack Then
      txtqty.Value = txtdose.Value / (xstr * xpack)
    Endif
  Endif

End

Public Sub btnselbreak_Click()

  If cmbgroup.Text Then
    If txtqty.Value Then
      EntryUseOwndata(cmbgroup.Text, txtbreakitem.Text, txtqty.Value)
      txtdose.Value = 0
      txtqty.Value = 0
      ShowUsedGridViewList()
    Endif
  Endif

End

Public Sub chkall_Click()

  Dim Row As Integer

  For Row = 0 To GridView3.Rows.Count - 1
    If GridView3[Row, 0].Picture = Picture["icons/unchecked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/checked.png"]
    Else If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub btnselect_Click()

  Dim Row As Integer
  Dim sType As String
  Dim xqty As Float

  If GridView3.Rows.Count Then
    For Row = 0 To GridView3.Rows.Count - 1
      If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then
        sType = modNonMedical.GetBillItemCategoryFromCombo(GridView3[Row, 3].Text)
        xqty = 0
        If rbroute.Value = True Then
          xqty = 1
        Else If rbprot.Value = True Then
          xqty = GridView3[Row, 2].Text
        Endif
        If xqty Then
          EntryUseOwndata(sType, GridView3[Row, 1].Text, xqty)
        Endif
        GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
      Endif
    Next

    ShowUsedGridViewList()
  Endif

End

Private Sub EntryUseOwndata(sType As String, sItem As String, sQty As Float)

  Dim xroute As String
  Dim xtax As Float
  Dim xdisc As Float
  Dim xdose As Float
  Dim xfixrate As Float
  Dim xfixname As String

  Dim itemmode As String
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean

  xgo = False
  If modBasic.$BillPharmFixedModes.Exist($sBillMode) = True Then
    CPharmFix = New CFixRatePharmacy(sType, sItem, $sBillMode)
    xfixrate = CPharmFix.GetFixRate()
    xfixname = CPharmFix.GetFixItem()
    If xfixname Then
      xgo = True
    Else
      xgo = False
    Endif
  Else
    xgo = True
  Endif
  If xgo = True Then
    itemmode = $sBillMode
    xtax = modNonMedical.ShowTaxValues(sType, sItem)
    xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdisctype.Text, sType, sItem, itemmode)
    xroute = modMedicine.GetRouteFromItem(sItem, sType)

    If sType = "Medicines" Then
      xdose = sQty * modMedConstant.GetPackVolValue(sItem) * modMedConstant.GetDrugInitialStrength(sItem)
      If $Dept = "OPD" Then
        modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, xroute, sItem, xdose, "stat", 1, sQty, $status, "", "", 0, xtax, xdisc, xfixname, xfixrate, "UseOwn", $Dept, "", False)
      Else
        modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, xroute, sItem, xdose, "SOS", 1, sQty, $status, "", "", 0, xtax, xdisc, xfixname, xfixrate, "UseOwn", $Dept, "", False)
      Endif
    Else
      modPharmSub.InsertNonMedDosingEntry(sType, $encid, $xBillType, $sBillMode, cmbdisctype.Text, $LedgerAC, xroute, sItem, sQty, $status, 0, xtax, xdisc, xfixname, xfixrate, "UseOwn", $Dept, "", False)
    Endif
  Endif

End

Private Sub ShowUsedGridViewList()

  Dim sql As String

  If rbroute.Value = True And If chknewall.Value = False Then
    Select $Dept
      Case "OPD", "IPD"
        sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and (fldorder=&4 or fldorder=&5) and fldcurval=&6"
      Case Else
        sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and (fldorder=&4 or fldorder=&5) and fldcurval=&6 and flddispmode=&7"
    End Select
    $rData1 = modDatabase.$myConn.Exec(sql, $encid, False, $status, "UseOwn", "Request", "Continue", $Dept)

  Else
    Select $Dept
      Case "OPD", "IPD"
        sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and fldcurval=&5"
      Case Else
        sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and fldcurval=&5 and flddispmode=&6"
    End Select
    $rData1 = modDatabase.$myConn.Exec(sql, $encid, False, $status, "UseOwn", "Continue", $Dept)

  Endif
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView4, $rData1, $aMyFields1)
  ResizeGrid()

End

Private Sub ResizeGrid()

  With GridView4
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 1
    .Columns[3].Width = GridView4.Width - 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 1
    .Columns[5].Width = 1
    .Columns[6].Width = 1
    .Columns[7].Width = 35 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 35 * modBasic.$AppWidthRatio
    .Columns[10].Width = 1
    .Columns[11].Width = 1

    .Columns[3].Text = "Particulars"
    .Columns[7].Text = "QTY"
  End With

End

Public Sub GridView4_Data(Row As Integer, Column As Integer)

  $rData1.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView4, Row)
  If Column = 9 Then
    GridView4.Data.Picture = Picture["icon:/tiny/cancel"]
    GridView4.Data.Text = ""
  Else If Column = 3 Then
    GridView4.Data.Text = $rData1[$aMyFields1[Column]]
    GridView4.Rows[Row].Height = Max(GridView4.Rows[Row].Height, GridView4.Data.Font.RichTextHeight(GridView4.Data.Text, GridView4.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView4.Rows.Height - GridView4.Font.Height))
    GridView4.Data.WordWrap = True
  Else
    GridView4.Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub GridView4_Click()

  Dim xval As Float
  Dim Row As Integer
  Dim res As Result

  If GridView4.Column = 7 Then
    Row = GridView4.Row
    xval = InputValue(GridView4[GridView4.Row, 3].Text, ("Change Value"), GridView4[GridView4.Row, 7].Text)
    modPharmSub.UpdateQTYBefDispensing(GridView4[GridView4.Row, 0].Text, xval)
    ShowUsedGridViewList()
    GridView4.Row = Row

  Else If GridView4.Column = 9 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView4[GridView4.Row, 0].Text, False)
      If modGeneral.AllowClinicalEdit(res["flduserid_order"]) = True Then
        modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView4[GridView4.Row, 0].Text, False)
      Else
        res["fldcurval"] = "Cancelled"
        res["flduserid_order"] = modBasic.$lbluser
        res["xyz"] = False
        res.Update
      Endif
      ShowUsedGridViewList()
    Endif

  Endif

End

Public Sub btnsave_Click()

  Dim Row As Integer
  Dim xstatus As String

  If chkcomplete.Value = True Then
    xstatus = "Completed"
  Else
    xstatus = "Continue"
  Endif

  If GridView4.Rows.Count Then
    If chksaveall.Value = True Then
      For Row = 0 To GridView4.Rows.Count - 1
        SaveOwnDispensing(GridView4[Row, 0].Text, xstatus)
      Next
    Else
      If GridView4.Rows.Selection.Count Then
        SaveOwnDispensing(GridView4[GridView4.Row, 0].Text, xstatus)
      Endif
    Endif

    ShowUsedGridViewList()
  Endif

End

Private Sub SaveOwnDispensing(sID As Long, sStatus As String)

  Dim sql1 As String
  Dim res1 As Result
  Dim hForm As CPharmOwn

  sql1 = "select fldid,fldtime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,fldlabel,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid=&1 and fldencounterval=&2"                                                   ''
  res1 = modDatabase.$myConn.Exec(sql1, sID, $encid)
  If res1.Available = True Then
    hForm = New CPharmOwn($encid, $sBillMode, res1)
    If $sClaimState = "Consultation" Or If $sClaimState = "Patient Ward" Then
      GetHImedicineCappingVar()
    Endif
    hForm.SetCappingLimit($HiCappingVar)
    hForm.DispenseItem(sStatus, btnsave)
  Endif

End
