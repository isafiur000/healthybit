' Gambas class file

Private $encid As String
Private AppFactor As Float
Private $sVitalsVar As Variant[]

Private aWebFrame As New Object[50]
Private aIndexLabel As New Object[50]
Private aNameLabel As New Object[50]
Private aCheckAbn As New Object[50]
Private aQuantiBox As New Object[50]
Private aMinBox As New Object[50]
Private aMaxBox As New Object[50]
Private aQualiBox As New Object[50]
Private aComboBox As New Object[50]
Private aDichoValue As New Object[50]
Private aBlankBox As New Object[50]
Private aHelpButton As New Object[50]

Public Sub _new(encid As String)

  $encid = encid

End

Public Sub Form_Open()

  txtname.Text = modPatient.GetPatientNameByEnc($encid)
  $sVitalsVar = modPathoSub.GetAllEssentialExams($encid)
  AppFactor = modBasic.$AppScaleFactor
  ' Frame1.Height = ($sVitalsVar.Count * 40 + 50) * AppFactor
  GetControlParams()

End

Private Sub GetControlParams()

  Dim i As Integer
  Dim xlimit As Float[]

  For i = 0 To $sVitalsVar.Count - 1
    aWebFrame[i] = New HBox(Frame1)
    aIndexLabel[i] = New Label(aWebFrame[i])
    aNameLabel[i] = New Label(aWebFrame[i])
    aCheckAbn[i] = New CheckBox(aWebFrame[i])
    If $sVitalsVar[i]["DataType"] = "Quantitative" Then
      aQuantiBox[i] = New ValueBox(aWebFrame[i]) As "QuantiGroup"
      aMinBox[i] = New ValueBox(aWebFrame[i])
      aMaxBox[i] = New ValueBox(aWebFrame[i])
    Else
      Select $sVitalsVar[i]["OptionType"]
        Case "Single Selection"
          aComboBox[i] = New ComboBox(aWebFrame[i])
        Case "Dichotomous"
          aDichoValue[i] = New DichotomousValue(aWebFrame[i])
        Case "Clinical Scale"
          aQualiBox[i] = New TextBox(aWebFrame[i])
          aQuantiBox[i] = New ValueBox(aWebFrame[i])
          aHelpButton[i] = New Button(aWebFrame[i]) As "ButtonBoxgroup"
        Case Else
          aQualiBox[i] = New TextBox(aWebFrame[i])
      End Select
    Endif
    aBlankBox[i] = New Label(aWebFrame[i])

    ''create controls
    With aWebFrame[i]
      .Height = 30 * AppFactor
      .Width = Frame1.Width - 5
    End With

    ''create index label
    With aIndexLabel[i]
      .Width = 25 * AppFactor
      .Height = 30 * AppFactor
      .Text = i + 1
      .Visible = False
      .Tag = $sVitalsVar[i]["SysConstant"]
    End With
    ''create Name Label
    With aNameLabel[i]
      .Width = 225 * AppFactor
      .Height = 30 * AppFactor
      .Text = $sVitalsVar[i]["ExamName"]
      .Tag = i
    End With

    ''Value entry
    If $sVitalsVar[i]["DataType"] = "Quantitative" Then
      xlimit = modClinic.GetBothQuantiExamVal($sVitalsVar[i]["ExamName"], $encid)
      With aCheckAbn[i]
        .Width = 75 * AppFactor
        .Height = 30 * AppFactor
        .Text = "Abn"
        .Enabled = False
        .Tag = i
      End With
      With aQuantiBox[i]
        .Expand = True
        .Height = 30 * AppFactor
        .Tag = i
      End With
      With aMinBox[i]
        .Width = 75 * AppFactor
        .Height = 30 * AppFactor
        If xlimit Then
          .Value = xlimit[0]
        Endif
        .Enabled = False
        .Tag = i
      End With
      With aMaxBox[i]
        .Width = 75 * AppFactor
        .Height = 30 * AppFactor
        If xlimit Then
          .Value = xlimit[1]
        Endif
        .Enabled = False
        .Tag = i
      End With

    Else
      With aCheckAbn[i]
        .Width = 50 * AppFactor
        .Height = 30 * AppFactor
        .Tag = i
      End With

      Select $sVitalsVar[i]["OptionType"]
        Case "Single Selection"
          With aComboBox[i]
            .Expand = True
            .Height = 30 * AppFactor
            .ReadOnly = False
            .List = Split($sVitalsVar[i]["OptionList"], ";")
            .Tag = i
          End With

        Case "Dichotomous"
          With aDichoValue[i]
            .Expand = True
            .Height = 30 * AppFactor
            .List = Split($sVitalsVar[i]["OptionList"], ";")
            .Tag = i
          End With

        Case "Clinical Scale"
          With aQualiBox[i]
            .Expand = True
            .Height = 30 * AppFactor
            .Tag = i
          End With
          With aQuantiBox[i]
            .Width = 45 * AppFactor
            .Height = 30 * AppFactor
            .Tag = i
          End With
          With aHelpButton[i]
            .Width = 30 * AppFactor
            .Height = 30 * AppFactor
            .Tag = i
            .Text = ""
            .Picture = Picture["icon:/small/info"]
          End With

        Case Else
          With aQualiBox[i]
            .Expand = True
            .Height = 30 * AppFactor
            .Tag = i
          End With

      End Select
    Endif
    With aBlankBox[i]
      .Width = 25 * AppFactor
      .Height = 30 * AppFactor
    End With
  Next

End

Public Sub ButtonBoxgroup_Click()

  Dim i As Integer
  Dim sVal As String[]
  Dim xopt As String[]

  i = Last.Tag
  If $sVitalsVar[i]["OptionList"] Then
    xopt = Split($sVitalsVar[i]["OptionList"], ";")
    If $sVitalsVar[i]["OptionType"] = "Clinical Scale" Then
      sVal = SubChoose(xopt, "Clinical Scale", $sVitalsVar[i]["ExamName"])
      If sVal Then
        aQuantiBox[i].Value = sVal[0]
        aQualiBox[i].Text = sVal[1]
      Endif
    Endif
  Endif

End

Public Sub QuantiGroup_Change()

  Dim j As Integer

  j = Last.Tag
  If aQuantiBox[j].Text Then
    If aQuantiBox[j].Value Then
      If aMinBox[j].Value <> aMaxBox[j].Value Then
        If aQuantiBox[j].Value < aMinBox[j].Value Or If aQuantiBox[j].Value > aMaxBox[j].Value Then
          aCheckAbn[j].Value = True
        Else
          aCheckAbn[j].Value = False
        Endif
      Else
        aCheckAbn[j].Value = False
      Endif
    Else
      aCheckAbn[j].Value = False
    Endif
  Endif

  If aCheckAbn[j].Value = True Then
    aCheckAbn[j].Foreground = Color.Red
  Else
    aCheckAbn[j].Foreground = Color.Default
  Endif

End

Public Sub btnsaveall_Click()

  Dim i As Integer

  For i = 0 To $sVitalsVar.Count - 1
    If i < 49 Then
      If $sVitalsVar[i]["DataType"] = "Quantitative" Then
        If aQuantiBox[i].Value Then
          modClinSub.AddQuantiData($encid, "", $sVitalsVar[i]["ExamName"], $sVitalsVar[i]["OptionType"], aQuantiBox[i].Value, aCheckAbn[i].Value, "Essential Examinations", $sVitalsVar[i]["SysConstant"])
          aQuantiBox[i].Value = 0
          aQuantiBox[i].ReadOnly = True
        Endif

      Else
        If $sVitalsVar[i]["OptionType"] = "Single Selection" Then
          If aComboBox[i].Text Then
            modClinSub.AddQualiData($encid, "", $sVitalsVar[i]["ExamName"], $sVitalsVar[i]["OptionType"], aComboBox[i].Text, aCheckAbn[i].Value, "Essential Examinations", $sVitalsVar[i]["SysConstant"])
            aComboBox[i].Text = ""
          Endif
        Else If $sVitalsVar[i]["OptionType"] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            modClinSub.AddQualiData($encid, "", $sVitalsVar[i]["ExamName"], $sVitalsVar[i]["OptionType"], aDichoValue[i].Value, aCheckAbn[i].Value, "Essential Examinations", $sVitalsVar[i]["SysConstant"])
          Endif
        Else If $sVitalsVar[i]["OptionType"] = "Clinical Scale" Then
          If aQualiBox[i].Text Then
            modClinSub.AddClinicExam($encid, "", $sVitalsVar[i]["ExamName"], $sVitalsVar[i]["OptionType"], aQualiBox[i].Text, aQuantiBox[i].Value, aCheckAbn[i].Value, "Essential Examinations", $sVitalsVar[i]["SysConstant"], "Regular")     ''
            aQualiBox[i].Text = ""
            aQuantiBox[i].Value = 0
            aQuantiBox[i].ReadOnly = True
          Endif
        Else
          If aQualiBox[i].Text Then
            modClinSub.AddQualiData($encid, "", $sVitalsVar[i]["ExamName"], $sVitalsVar[i]["OptionType"], aQualiBox[i].Text, aCheckAbn[i].Value, "Essential Examinations", $sVitalsVar[i]["SysConstant"])
            aQualiBox[i].Text = ""
            aQualiBox[i].ReadOnly = True
          Endif
        Endif

      Endif
    Endif
  Next
  Balloon.Info(("Information saved"), btnsaveall)
  Balloon.Delay = modBasic.$BalloonDelay

End

Public Sub btnclose_Click()

  Me.Close()

End

Public Sub btncolor_Click()

  Dim xcol As String

  xcol = InputColor("Triage", txtcolor.Background)
  If xcol Then
    txtcolor.Background = CInt(xcol)
    modPatient.SetPatientColor($encid, xcol)
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key["S"] And If Key.Control Then
    btnsaveall_Click()
  Else If Key.Code = Key["T"] And If Key.Control Then
    btncolor_Click()
  Else
    modGeneralmain.GoToNextControlTab()
  Endif

End
