' Gambas class file

Private aPanel As New Object[50]
Private aObj As New Object[50]
Private aObk As New Object[50]
Private aObjx As New Object[50]
Private aObj1 As New Object[50]
Private aObHBox As New Object[50]
Private aObVal As New Object[50]
Private aObBox As New Object[50]
Private aObButt As New Object[50]

Private bPanel As New Object[50]
Private bObj As New Object[50]
Private bObk As New Object[50]
Private bObjx As New Object[50]
Private bObj1 As New Object[50]

Private $encid As String
Private $sTitle As String
Private $xParamVar As Variant[]

Private $xalllow As Boolean
Private $labarr As String[]
Private $examarr As String[]
Private $unt As String
Private AppFactor As Float
Private $UserRestrict As String[]
Private $PatientNum As String

Private $examColl As Collection
Private $labColl As Collection

Public Sub _new(encid As String, sTitle As String, unt As String)

  $encid = encid
  $sTitle = sTitle

  $unt = unt
  Me.Title = "ENCID: " & $encid

End

Public Sub Form_Open()

  Dim xstatus As String

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Vertical")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  txtgender.Text = modPatient.GetPatientSex($encid)
  xstatus = modPatient.CurrentAdmissionStatus($encid)
  $xalllow = modPatient.EnableClinicForm(xstatus)
  $UserRestrict = modBasic.$ClinicDisableCompo

  modBasic.LoadClinicalChartSetting()
  AppFactor = modBasic.$AppScaleFactor
  GetVariables()

  rboneday.Value = True
  Slider1.Value = 10
  rbtable.Value = True
  SetOptions()
  Panel6.Visible = True
  ListContainer1.Visible = False

End

Public Sub Form_Close()

  modGeneralMain.RecordFormExit(Me)

End

Private Sub GetVariables()

  Dim res As Result
  Dim sColl As Collection

  Dim aColl As Collection

  $xParamVar = New Variant[]
  If $sTitle = "Essential Examinations" Then
    For Each aColl In modTableCache.$ExaminationCompVar
      If aColl["fldcategory"] = "Essential Examinations" Then
        sColl = New Collection
        sColl.Add("Examination", "Category")
        sColl.Add(aColl["fldexamid"], "Examination")
        sColl.Add("", "Component")
        sColl.Add(aColl["fldsysconst"], "Constant")
        sColl.Add(aColl["fldtanswertype"], "Option")
        $xParamVar.Add(sColl)
      Endif
    Next

  Else
    res = modDatabase.$myConn.Exec("select fldcategory,fldexam,fldsubexam,fldsysconst,fldoption from tbldepartchart where fldtitle=&1 and (fldcomp=&2 or fldcomp=&3) ORDER BY fldexamorder", $sTitle, modBasic.$compID, "%")
    If res.Available Then
      For Each res
        sColl = New Collection
        sColl.Add(res["fldcategory"], "Category")
        sColl.Add(res["fldexam"], "Examination")
        sColl.Add(res["fldsubexam"], "Component")
        sColl.Add(res["fldsysconst"], "Constant")
        sColl.Add(res["fldoption"], "Option")
        $xParamVar.Add(sColl)
      Next
    Endif

  Endif

End

Public Sub rbchart_Click()

  SetOptions()

End

Public Sub rbtable_Click()

  SetOptions()

End

Private Sub SetOptions()

  If rbchart.Value = True Then
    rballday.Visible = True
    rballvisit.Visible = True
    rboneday.Text = "24 Hours"
    rbtwoday.Text = "48 Hours"
    rbthreeday.Text = "72 Hours"
    rbweek.Text = "1 Week"
    Panel6.Visible = False
    ListContainer1.Visible = True
  Else If rbtable.Value = True Then
    rballday.Visible = False
    rballvisit.Visible = False
    rboneday.Text = "Minute"
    rbtwoday.Text = "Hourly"
    rbthreeday.Text = "Daily"
    rbweek.Text = "Monthly"
    Panel6.Visible = True
    ListContainer1.Visible = False
  Endif

End

Public Sub btnrefresh_Click()

  If rbchart.Value = True Then
    LoadControls()
  Else If rbtable.Value = True Then
    LoadTablesExam()
  Endif

End

Private Sub LoadTablesExam()

  Dim xfir As Date
  Dim xlast As Date

  Dim i As Integer
  Dim j As Integer

  GridView2.Clear()
  GridView2.Rows.Count = $xParamVar.Count
  If rboneday.Value = True Then
    xfir = modDate.StartSqlTenMinute(DateAdd(Now(), gb.Minute, -240))
    xlast = modDate.StartSqlTenMinute(DateAdd(Now(), gb.Minute, 10))
    GridView2.Columns.Count = (DateDiff(xfir, xlast, gb.Minute) / 10) + 1
  Else If rbtwoday.Value = True Then
    xfir = modDate.StartSqlHour(DateAdd(Now(), gb.Hour, -24))
    xlast = modDate.StartSqlHour(DateAdd(Now(), gb.Hour, 1))
    GridView2.Columns.Count = DateDiff(xfir, xlast, gb.Hour) + 1
  Else If rbthreeday.Value = True Then
    xfir = modDate.StartSqlDate(DateAdd(Now(), gb.Day, -24))
    xlast = modDate.StartSqlDate(DateAdd(Now(), gb.Day, 1))
    GridView2.Columns.Count = DateDiff(xfir, xlast, gb.Day) + 1
  Else If rbweek.Value = True Then
    xfir = modDate.StartSqlMonth(DateAdd(Now(), gb.Month, -24))
    xlast = modDate.StartSqlMonth(DateAdd(Now(), gb.Month, 1))
    GridView2.Columns.Count = DateDiff(xfir, xlast, gb.Month) + 1
  Endif

  With GridView2
    .Rows.Height = modBasic.$AppGridRowHeight
    For j = 0 To GridView2.Columns.Count - 1
      If j = 0 Then
        .Columns[j].Width = 150 * modBasic.$AppWidthRatio
        .Columns[j].Text = "Examination"
      Else
        .Columns[j].Width = 64 * modBasic.$AppWidthRatio
        If rboneday.Value = True Then
          .Columns[j].Text = modReportVar.GetDateTimeReport(DateAdd(xfir, gb.Minute, j * 10), gb.ShortTime)
        Else If rbtwoday.Value = True Then
          .Columns[j].Text = modReportVar.GetDateTimeReport(DateAdd(xfir, gb.Hour, j), gb.ShortTime)
        Else If rbthreeday.Value = True Then
          .Columns[j].Text = modDate.GetDateOnlyInFormatForAll(DateAdd(xfir, gb.Day, j), modBasic.$DateFormat, "DateOnly")
        Else If rbweek.Value = True Then
          .Columns[j].Text = modDate.GetDateOnlyInFormatForAll(DateAdd(xfir, gb.Month, j), modBasic.$DateFormat, "YearMonth")
        Endif
      Endif
    Next
  End With

  For i = 0 To $xParamVar.Count - 1
    For j = 0 To GridView2.Columns.Count - 1
      If j = 0 Then
        GridView2[i, j].Text = $xParamVar[i]["Examination"]
      Else

        If $xParamVar[i]["Category"] = "Examination" Then
          If rboneday.Value = True Then
            GridView2[i, j].Text = GetExamValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Minute, j * 10))
          Else If rbtwoday.Value = True Then
            GridView2[i, j].Text = GetExamValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Hour, j))
          Else If rbthreeday.Value = True Then
            GridView2[i, j].Text = GetExamValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Day, j))
          Else If rbweek.Value = True Then
            GridView2[i, j].Text = GetExamValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Month, j))
          Endif
        Else If $xParamVar[i]["Category"] = "Laboratory" Then
          If rboneday.Value = True Then
            GridView2[i, j].Text = GetLabValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Minute, j * 10))
          Else If rbtwoday.Value = True Then
            GridView2[i, j].Text = GetLabValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Hour, j))
          Else If rbthreeday.Value = True Then
            GridView2[i, j].Text = GetLabValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Day, j))
          Else If rbweek.Value = True Then
            GridView2[i, j].Text = GetLabValueByDate($PatientNum, $xParamVar[i], DateAdd(xfir, gb.Month, j))
          Endif
        Endif

      Endif
    Next
  Next

  GridView2.Scroll(GridView2.X + GridView2.Width, GridView2.Y)

End

Private Function GetLabValueByDate(patNo As String, xColl As Collection, xDate As Date) As String

  Dim res As Result
  Dim xx As String
  Dim xfir As Date
  Dim xlast As Date

  If rboneday.Value = True Then
    xfir = modDate.StartSqlTenMinute(xDate)
    xlast = modDate.EndSqlTenMinute(xDate)
  Else If rbtwoday.Value = True Then
    xfir = modDate.StartSqlHour(xDate)
    xlast = modDate.EndSqlHour(xDate)
  Else If rbthreeday.Value = True Then
    xfir = modDate.StartSqlDate(xDate)
    xlast = modDate.EndSqlDate(xDate)
  Else If rbweek.Value = True Then
    xfir = modDate.StartSqlMonth(xDate)
    xlast = modDate.EndSqlMonth(xDate)
  Endif

  If xColl["Component"] Then
    res = modDatabase.$myConn.Exec("select tblpatlabsubtest.fldreport as fldreport from (tblpatlabsubtest inner join tblpatlabtest on (tblpatlabtest.fldid=tblpatlabsubtest.fldtestid and tblpatlabtest.fldencounterval=tblpatlabsubtest.fldencounterval)) inner join tblencounter on tblpatlabtest.fldencounterval=tblencounter.fldencounterval  where tblencounter.fldpatientval=&1 and tblpatlabtest.fldsave_report=&2 and tblpatlabtest.fldtestid=&3 and tblpatlabsubtest.fldsubtest=&4 and tblpatlabtest.fldtime_sample>=&5 and tblpatlabtest.fldtime_sample<=&6 ORDER BY tblpatlabtest.fldtime_sample", patNo, True, xColl["Examination"], xColl["Component"], xfir, xlast)         ''
    If res.Available Then
      res.MoveLast
      If res["fldreport"] Then
        xx = res["fldreport"]
      Else
        xx = ""
      Endif
    Else
      xx = ""
    Endif

  Else
    res = modDatabase.$myConn.Exec("select tblpatlabtest.fldreportquali as fldreportquali,tblpatlabtest.fldreportquanti as fldreportquanti from tblpatlabtest inner join tblencounter on tblpatlabtest.fldencounterval=tblencounter.fldencounterval  where tblencounter.fldpatientval=&1 and tblpatlabtest.fldsave_report=&2 and tblpatlabtest.fldtestid=&3 and tblpatlabtest.fldtime_sample>=&4 and tblpatlabtest.fldtime_sample<=&5 ORDER BY tblpatlabtest.fldtime_sample", patNo, True, xColl["Examination"], xfir, xlast)
    If res.Available Then
      res.MoveLast
      If res["fldreportquanti"] Then
        xx = CStr(res["fldreportquanti"])
      Else
        xx = res["fldreportquali"]
      Endif
    Else
      xx = ""
    Endif

  Endif
  Return xx

End

Private Function GetExamValueByDate(patNo As String, xColl As Collection, xDate As Date) As String

  Dim res As Result
  Dim xx As String
  Dim xfir As Date
  Dim xlast As Date

  If rboneday.Value = True Then
    xfir = modDate.StartSqlTenMinute(xDate)
    xlast = modDate.EndSqlTenMinute(xDate)
  Else If rbtwoday.Value = True Then
    xfir = modDate.StartSqlHour(xDate)
    xlast = modDate.EndSqlHour(xDate)
  Else If rbthreeday.Value = True Then
    xfir = modDate.StartSqlDate(xDate)
    xlast = modDate.EndSqlDate(xDate)
  Else If rbweek.Value = True Then
    xfir = modDate.StartSqlMonth(xDate)
    xlast = modDate.EndSqlMonth(xDate)
  Endif

  If xColl["Component"] Then
    res = modDatabase.$myConn.Exec("select tblpatientsubexam.fldreport as fldreport from (tblpatientsubexam inner join tblpatientexam  on (tblpatientexam.fldid=tblpatientsubexam.fldheadid and tblpatientexam.fldencounterval=tblpatientsubexam.fldencounterval)) inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval  where tblencounter.fldpatientval=&1 and tblpatientexam.fldsave=&2 and tblpatientexam.fldhead=&3 and tblpatientsubexam.fldsubtexam=&4 and tblpatientexam.fldtime>=&5 and tblpatientexam.fldtime<=&6 ORDER BY tblpatientexam.fldtime", patNo, True, xColl["Examination"], xColl["Component"], xfir, xlast)
    If res.Available Then
      res.MoveLast
      If res["fldreport"] Then
        xx = res["fldreport"]
      Else
        xx = ""
      Endif
    Else
      xx = ""
    Endif

  Else
    res = modDatabase.$myConn.Exec("select tblpatientexam.fldrepquali as fldrepquali,tblpatientexam.fldrepquanti as fldrepquanti from tblpatientexam inner join tblencounter on tblpatientexam.fldencounterval=tblencounter.fldencounterval  where tblencounter.fldpatientval=&1 and tblpatientexam.fldsave=&2 and tblpatientexam.fldhead=&3 and tblpatientexam.fldtime>=&4 and tblpatientexam.fldtime<=&5 ORDER BY tblpatientexam.fldtime", patNo, True, xColl["Examination"], xfir, xlast)
    If res.Available Then
      res.MoveLast
      If res["fldrepquanti"] Then
        xx = CStr(res["fldrepquanti"])
      Else
        xx = res["fldrepquali"]
      Endif
    Else
      xx = ""
    Endif

  Endif

  Return xx

End

''====================== Chart ==========================
Private Sub LoadControls()

  Dim i As Integer
  Dim j As Integer
  Dim sColl As Collection

  If ListContainer1.Children.Count Then
    ListContainer1.Children.Clear()
  Endif

  $labarr = New String[]
  $examarr = New String[]
  If $sTitle = "Essential Examinations" Then
    $examarr = modString.GetListFromCompareVariant(modTableCache.$ExaminationCompVar, "fldexamid", "fldcategory", "Essential Examinations", True)
  Else
    For Each sColl In $xParamVar
      If sColl["Category"] = "Examination" Then
        $examarr.Add(sColl["Examination"])
      Else If sColl["Category"] = "Laboratory" Then
        $labarr.Add(sColl["Examination"])
      Endif
    Next
  Endif

  If $examarr Then
    For i = 0 To $examarr.Count - 1
      If i < 49 Then

        aPanel[i] = New VBox(ListContainer1)
        aObHBox[i] = New HBox(aPanel[i])
        aObj1[i] = New TextLabel(aObHBox[i]) As "TextLabelGroup"
        If modFixClinic.GetExaminationType($examarr[i]) = "Quantitative" Then
          If $xalllow = True Then
            aObVal[i] = New ValueBox(aObHBox[i])
            aObButt[i] = New ToolButton(aObHBox[i]) As "SaveButton"
            If $UserRestrict Then
              If $UserRestrict.Exist("Essential Examinations") Then
                aObButt[i].Enabled = False
              Endif
            Endif
          Endif

          aObjx[i] = New ScrollView(aPanel[i]) As "ScrollGroup"
          aObj[i] = New PictureBox(aObjx[i]) As "PictureBoxgroup"
        Else
          If $xalllow = True Then
            aObBox[i] = New ComboBox(aObHBox[i])
            aObButt[i] = New ToolButton(aObHBox[i]) As "SaveButton"
            If $UserRestrict Then
              If $UserRestrict.Exist("Essential Examinations") Then
                aObButt[i].Enabled = False
              Endif
            Endif
          Endif

          aObk[i] = New ListBox(aPanel[i]) As "ListGroup"
        Endif

      Endif
    Next
  Endif

  If $labarr Then
    For j = 0 To $labarr.Count - 1
      If j < 49 Then

        bPanel[i] = New VBox(ListContainer1)
        bObj1[j] = New TextLabel(bPanel[i]) As "TextLabelGroup"
        If modFixLab.GetLabTestType($labarr[j]) = "Quantitative" Then
          bObjx[j] = New ScrollView(bPanel[i]) As "ScrollGroup"
          bObj[j] = New PictureBox(bObjx[j]) As "PictureBoxgroup"
        Else
          bObk[j] = New ListBox(bPanel[i]) As "ListGroup"
        Endif

      Endif
    Next
  Endif
  FillCHartItems(Slider1.Value * 10)

End

Private Sub FillCHartItems(sHt As Integer)

  Dim i As Integer
  Dim j As Integer
  Dim sPath As String

  $examColl = New Collection
  $labColl = New Collection

  ''examination
  If $examarr Then
    For i = 0 To $examarr.Count - 1
      If i < 49 Then

        With aPanel[i]
          .Height = (30 + sHt) * AppFactor
        End With

        With aObHBox[i]
          .Height = 30 * AppFactor
          .Tag = modFixClinic.SysConstFromGetExamID($examarr[i])
        End With

        With aObj1[i]
          .Left = 0
          .Expand = True
          .Height = 25 * AppFactor
          .Top = 0
          .Text = "<b>" & $examarr[i] & "</b>"
          .Tag = i
        End With

        'get info and draw
        If modFixClinic.GetExaminationType($examarr[i]) = "Quantitative" Then
          If $xalllow = True Then
            With aObVal[i]
              .Left = 250 * AppFactor
              .Width = 75 * AppFactor
              .Height = 25 * AppFactor
              .Top = 0
              .Tag = i
            End With
            With aObButt[i]
              .Left = 300 * AppFactor
              .Width = 50 * AppFactor
              .Height = 25 * AppFactor
              .Top = 0
              .Picture = Picture["icon:/small/apply"]
              .Tag = i
            End With
          Endif

          With aObjx[i]
            .Height = sHt * AppFactor
            .Left = 0
            .Tag = i
          End With
          With aObj[i]
            .Background = Color.White
            .Expand = True
            .AutoResize = True
            .Height = (sHt - 20) * AppFactor
            .Left = 0
            .Top = 0
            .Tag = i
          End With
          sPath = ""
          If rballvisit.Value = True Then
            sPath = modClinSub.FillQuantiExamChartHistory(aObj[i].Height, $encid, $PatientNum, $examarr[i], ChartHourVal())
          Else
            sPath = modClinSub.FillQuantiExamChart(aObj[i].Height, $encid, $examarr[i], ChartHourVal())
          Endif
          If sPath Then
            aObj[i].Picture = Picture.Load(sPath)
            $examColl.Add(sPath, $examarr[i])
          Endif

        Else
          If $xalllow = True Then
            With aObBox[i]
              .Left = 250 * AppFactor
              .Width = 150 * AppFactor
              .Height = 25 * AppFactor
              .Top = 0
              .List = modAllExam.SelectExamOptionList("Exam", $examarr[i])
              .Tag = i
            End With
            With aObButt[i]
              .Left = 300 * AppFactor
              .Width = 50 * AppFactor
              .Height = 25 * AppFactor
              .Top = 0
              .Picture = Picture["icon:/small/apply"]
              .Tag = i
            End With
          Endif

          With aObk[i]
            .Height = sHt * AppFactor
            .Left = 0
            .Width = (Panel1.Width - 75) * AppFactor
            .List = modClinic.UniExamValueList($encid, $examarr[i])
            .Tag = i
          End With

        Endif

      Endif
    Next
  Endif

  ''for lab tests
  If $labarr Then
    For j = 0 To $labarr.Count - 1
      If j < 49 Then

        With bPanel[i]
          .Height = (30 + sHt) * AppFactor
        End With

        With bObj1[j]
          .Left = 0
          .Width = 300 * AppFactor
          .Height = 25 * AppFactor
          .Text = "<b>" & $labarr[j] & "</b>"
          .Tag = j
        End With

        'get info and draw
        If modFixLab.GetLabTestType($labarr[j]) = "Quantitative" Then
          With bObjx[j]
            .Height = sHt * AppFactor
            .Left = 0
            .Tag = j
          End With
          With bObj[j]
            .Expand = True
            .AutoResize = True
            .Height = (sHt - 20) * AppFactor
            .Left = 0
            .Top = 0
            .Tag = j
          End With
          sPath = ""
          If rballvisit.Value = True Then
            sPath = modLabSub.FillQuantiTestChartHistory(bObj[j].Height, $encid, $PatientNum, $labarr[j], $unt, ChartHourVal())
          Else
            sPath = modLabSub.FillQuantiTestChart(bObj[j].Height, $encid, $labarr[j], $unt, ChartHourVal())
          Endif
          If sPath Then
            bObj[i].Picture = Picture.Load(sPath)
            $labColl.Add(sPath, $labarr[j])
          Endif

        Else
          With bObk[j]
            .Height = sHt * AppFactor
            .Left = 0
            .Width = (Panel1.Width - 75) * AppFactor
            .List = modLabTest.UniLabValueList($encid, $labarr[j])
            .Tag = j
          End With

        Endif

      Endif
    Next
  Endif

End

Private Function ChartHourVal() As Integer

  Dim xx As Integer

  If rboneday.Value = True Then
    xx = 24
  Else If rbtwoday.Value = True Then
    xx = 48
  Else If rbthreeday.Value = True Then
    xx = 72
  Else If rbweek.Value = True Then
    xx = 168
  Else
    xx = 0
  Endif

  Return xx

End

Public Sub SaveButton_Click()

  Dim i As Integer
  Dim sPath As String

  i = Last.Tag

  If aObVal[i] And If aObVal[i].Value Then
    modClinSub.AddQuantiData($encid, "", $examarr[i], "", aObVal[i].Value, False, "Essential Examinations", aObHBox[i].Tag)

    sPath = ""
    $examColl.Remove($examarr[i])
    sPath = modClinSub.FillQuantiExamChart(aObj[i].Height, $encid, $examarr[i], ChartHourVal())
    If sPath Then
      aObj[i].Picture = Picture.Load(sPath)
      $examColl.Add(sPath, $examarr[i])
    Endif
    aObVal[i].Value = 0
    Balloon.Info(("Information saved"), aObButt[i])
    Balloon.Delay = modBasic.$BalloonDelay

  Else If aObBox[i] And If aObBox[i].Text Then
    modClinSub.AddQualiData($encid, "", $examarr[i], "", aObBox[i].Text, False, "Essential Examinations", aObHBox[i].Tag)

    aObk[i].List = modClinic.UniExamValueList($encid, $examarr[i])
    aObBox[i].Text = ""
    Balloon.Info(("Information saved"), aObButt[i])
    Balloon.Delay = modBasic.$BalloonDelay

  Endif

End

Public Sub Form_Resize()

  ' ListContainer1.Left = 0
  ' ListContainer1.Top = 40 * AppFactor
  ' ListContainer1.Width = Panel1.Width - (50 * AppFactor)

End

Public Sub mnuexpo_Click()

  Dim xPath As String

  Inc Application.Busy
  xPath = modCHTMLPatient.ExportMultiExamTestToHTML($encid, $examColl, $labColl)
  Dec Application.Busy
  modControlSub.OpenHTMLPreview($encid, xPath, "ReportSize")

End
