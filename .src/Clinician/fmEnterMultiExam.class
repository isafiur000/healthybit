' Gambas class file

''controls
Private aWebRowAll As New Object[50]
Private aWideRowAll As New Object[50]
Private aWebFrame As New Object[50]
Private aWebPanel As New Object[50]
Private aIndexLabel As New Object[50]    ''aLab
Private aNameLabel As New Object[50]       ''aObj
Private aAbnormCheck As New Object[50]       ''aObj2
Private aHTMLText As New Object[50]          ''aObj11
Private aLineText As New Object[50]
Private aUnitText As New Object[50]
Private aNullCheck As New Object[50]
Private aValueBox As New Object[50]
Private aQuantiBox As New Object[50]
Private aQuantiMax As New Object[50]
Private aQuantiMin As New Object[50]
Private aClinBox As New Object[50]
Private aDateBox As New Object[50]
Private aBSDate As New Object[50]
Private aComboBox As New Object[50]
Private aChkLock As New Object[50]
Private aTextArea As New Object[50]
Private aDichoValue As New Object[50]
Private aLeftRightValue As New Object[50]
Private aLeftRightText As New Object[50]
Private aLeftRight As New Object[50]
Private aGridView As New Object[50]         ''aObg11
Private aListBox As New Object[50]
Private aGenTextArea As New Object[50]
Private aButtonBox As New Object[50]
Private aHelpButton As New Object[50]          ''aObj3
Private aBlankBox As New Object[50]
Private aWebSpace As New Object[50]
''other variables
Private $encid As String
Private $sTable As String
Private $idList As String[]
Private $sCategory As String
Private $sExpand As Boolean
''Arrays
Private $xCode As String[]
Private $xType As String[]
Private $xOption As String[]
Private $xitem As String[]
Private $xExam As String[]
Private $xOpList As String[]
Private $xSysCons As String[]
Private $xSource As String[]
Private $xHelpList As String[]
Private $xUniqList As Integer[]
Private $xDefaultLst As String[]

Private AppFactor As Float

''----------------------------------------- create controls -----------------------------------------
Public Sub _new(sPrompt As String, encid As String, sTable As String, idList As String[], sCategory As String, sExpand As Boolean)

  $encid = encid
  $sTable = sTable
  $idList = idList
  $sCategory = sCategory
  lblitem.Text = sPrompt
  $sExpand = sExpand

  If $sExpand = True Then
    Me.Expand = True
    btnBrChange.Visible = False
  Else
    Me.Height = 560
    Me.Width = 888
  Endif

End

''------------------------ General form
Public Sub Form_Open()

  Dim ht As String
  Dim xoption As String

  ' modGeneralMain.ArrangeFormCentre(Me, "False")
  AppFactor = modBasic.$AppScaleFactor
  ht = modSettings.ShowSettingFromFIle("MultipleTextBox/Height")
  If ht Then
    Slider1.Value = CInt(ht)
  Else
    Slider1.Value = 3
  Endif

  xoption = modSettings.ShowSettingFromFIle("EntrySetting/AutoDisplayOptions")
  If xoption = "Yes" Then
    chkautoption.Value = True
  Else If xoption = "No" Then
    chkautoption.Value = False
  Endif
  SetVariables()

End

Public Sub Form_Close()

  modGeneralMain.DisableJavaScript()

End

Private Sub SetVariables()

  Dim idx As String
  Dim rsn As Result
  Dim res As Result

  Dim xcode As String
  Dim xType As String
  Dim xOption As String
  Dim xitem As String
  Dim xexam As String
  Dim xopList As String[]
  Dim xSysCons As String
  Dim xsource As String
  Dim xhelp As String
  Dim xuniq As Integer
  Dim xdefVal As String

  $xCode = New String[]
  $xType = New String[]
  $xOption = New String[]
  $xitem = New String[]
  $xExam = New String[]
  $xOpList = New String[]
  $xSysCons = New String[]
  $xSource = New String[]
  $xHelpList = New String[]
  $xUniqList = New Integer[]
  $xDefaultLst = New String[]

  For Each idx In $idList
    rsn = modDatabase.$myConn.Exec("select fldheadcode,fldhead,fldtesttype,fldtanswertype,fldsysconst,fldclininfo,fldunique,flddefault from tblstructexam where fldheadcode=&1 ORDER BY fldheadid", idx)
    If rsn.Available Then
      xcode = rsn["fldheadcode"]
      xitem = rsn["fldhead"]
      xType = rsn["fldtesttype"]
      xOption = rsn["fldtanswertype"]
      xSysCons = rsn["fldsysconst"]
      xhelp = rsn["fldclininfo"]
      If rsn["fldunique"] = True Then
        xuniq = 1
      Else
        xuniq = 0
      Endif
      xdefVal = rsn["flddefault"]
      xsource = "Free"

      ''get parameters
      If rsn["fldtanswertype"] = "Sys Constant" And If rsn["fldsysconst"] Then
        If modBasic.$sysExamDualList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select fldexamid,fldtype,fldoption from tblexam where fldsysconst=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldtype"]
            xOption = res["fldoption"]
            xexam = res["fldexamid"]
            If res["fldoption"] = "Clinical Scale" Then
              xopList = modAllExam.GetCLinicalScaleOptions("Exam", xexam)
            Else
              xopList = modAllExam.SelectExamOptionList("Exam", xexam)
            Endif
            xsource = "Exam"
          Endif
        Else If modBasic.$sysTestDualList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select fldtestid,fldtype,fldoption from tbltest where fldsysconst=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldtype"]
            xOption = res["fldoption"]
            xexam = res["fldtestid"]
            If res["fldoption"] = "Clinical Scale" Then
              xopList = modAllExam.GetCLinicalScaleOptions("Test", xexam)
            Else
              xopList = modAllExam.SelectExamOptionList("Test", xexam)
            Endif
            xsource = "Test"
          Endif
        Else If modBasic.$sysRadioList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select fldexamid,fldtype,fldoption from tblradio where fldsysconst=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldtype"]
            xOption = res["fldoption"]
            xexam = res["fldexamid"]
            If res["fldoption"] = "Clinical Scale" Then
              xopList = modAllExam.GetCLinicalScaleOptions("Radio", xexam)
            Else
              xopList = modAllExam.SelectExamOptionList("Radio", xexam)
            Endif
            xsource = "Radio"
          Endif
        Else If modBasic.$DemogList.Exist(rsn["fldsysconst"]) = True Then
          res = modDatabase.$myConn.Exec("select flddemoid,fldoption from tbldemographic where flddemoid=&1", rsn["fldsysconst"])
          If res.Available Then
            xType = res["fldoption"]
            xOption = res["fldoption"]
            xexam = res["flddemoid"]
            xopList = modAllExam.SelectExamOptionList("Demog", xexam)
            xsource = "Demog"
          Endif
        Endif

      Else If rsn["fldtanswertype"] = "CopyValue" And If rsn["fldsysconst"] Then
        If modBasic.$sysExamDualList.Exist(rsn["fldsysconst"]) = True Then
          xexam = modFixClinic.GetExamIDFromSysConst(rsn["fldsysconst"])
          xsource = "Exam"
        Else If modBasic.$sysTestDualList.Exist(rsn["fldsysconst"]) = True Then
          xexam = modFixLab.GetLabTestIDFromSysConst(rsn["fldsysconst"])
          xsource = "Test"
        Else If modBasic.$sysRadioList.Exist(rsn["fldsysconst"]) = True Then
          xexam = modFixRadio.GetRadioTestIDFromSysConst(rsn["fldsysconst"])
          xsource = "Radio"
        Endif

      Else If rsn["fldtanswertype"] = "Calculated" And If rsn["fldsysconst"] Then
        xexam = "Expression"

      Else
        xopList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select fldanswer from tblstructexamoption where fldheadcode=&1 ORDER BY fldindex", idx))                         ''
        xexam = "Structured"
      Endif

      $xCode.Add(xcode)
      $xitem.Add(xitem)
      If xexam Then
        $xExam.Add(xexam)
      Else
        $xExam.Add("__")
      Endif
      If xType Then
        $xType.Add(xType)
      Else
        $xType.Add("__")
      Endif
      If xOption Then
        $xOption.Add(xOption)
      Else
        $xOption.Add("__")
      Endif
      If xopList And If xopList.Count Then
        $xOpList.Add(xopList.Join("|"))
      Else
        $xOpList.Add("__")
      Endif
      If xSysCons Then
        $xSysCons.Add(xSysCons)
      Else
        $xSysCons.Add("__")
      Endif
      If xsource Then
        $xSource.Add(xsource)
      Else
        $xSource.Add("__")
      Endif
      If xhelp Then
        $xHelpList.Add(xhelp)
      Else
        $xHelpList.Add("Null")
      Endif
      $xUniqList.Add(xuniq)
      If xdefVal Then
        $xDefaultLst.Add(xdefVal)
      Else
        $xDefaultLst.Add("__")
      Endif

    Endif
  Next
  CreateControls()

End

Private Sub CreateControls()

  Dim i As Integer

  For i = 0 To $xitem.Count - 1
    If i < 49 Then
      ''Create controls
      aWebRowAll[i] = New HBox(Frame1)
      aWebFrame[i] = New HBox(aWebRowAll[i])
      aIndexLabel[i] = New Label(aWebFrame[i]) As "IndexLabel"
      aNameLabel[i] = New TextLabel(aWebFrame[i]) As "NameLabel"

      If $xType[i] = "Quantitative" Then
        aWebPanel[i] = New HBox(aWebRowAll[i])
        aAbnormCheck[i] = New CheckBox(aWebPanel[i]) As "CheckBoxgroup"
        aQuantiBox[i] = New ValueBox(aWebPanel[i]) As "QuantiGroup"
        aQuantiMax[i] = New ValueBox(aWebPanel[i]) As "QuantiGroupMax"
        aQuantiMin[i] = New ValueBox(aWebPanel[i]) As "QuantiGroupMin"
        aHelpButton[i] = New ToolButton(aWebPanel[i]) As "ButtonBoxgroup"
        aBlankBox[i] = New Label(aWebPanel[i])
        aWideRowAll[i] = New HBox(Frame1)
        aWebSpace[i] = New Separator(Frame1)

      Else
        Select $xOption[i]
          Case "Sys Constant", "Multiple Selection", "Clinical Scale", "Date Time", "BS Date", "User Profile", "ImageValue", "Single Selection", "Dichotomous", "Left Right Qualitative", "Left Right Quantitative", "Quantitative", "Qualitative"
            aWebPanel[i] = New HBox(aWebRowAll[i])
            aAbnormCheck[i] = New CheckBox(aWebPanel[i]) As "CheckBoxgroup"
            Select $xOption[i]
              Case "Sys Constant"
                aGenTextArea[i] = New TextPlain(aWebPanel[i]) As "GenAreaGroup"
              Case "Multiple Selection"
                aListBox[i] = New ListBox(aWebPanel[i]) As "ListBoxgroup"
              Case "Clinical Scale"
                aTextArea[i] = New TextArea(aWebPanel[i]) As "TextAreaGroup"
                aClinBox[i] = New ValueBox(aWebPanel[i]) As "ClinGroup"
              Case "Date Time", "BS Date"
                aDateBox[i] = New DateBox(aWebPanel[i]) As "DateGroup"
                aBSDate[i] = New ToolButton(aWebPanel[i]) As "BSButton"
              Case "User Profile"
                aLineText[i] = New TextBox(aWebPanel[i]) As "TextLineGroup"
              Case "ImageValue"
                aButtonBox[i] = New ButtonBox(aWebPanel[i]) As "ImageBoxGroup"
              Case "Single Selection"
                aComboBox[i] = New ComboBox(aWebPanel[i]) As "ComboGroup"
                aChkLock[i] = New CheckBox(aWebPanel[i]) As "CheckLock"
              Case "Dichotomous"
                aDichoValue[i] = New DichotomousValue(aWebPanel[i]) As "DichoText"
              Case "Left Right Qualitative"
                aLeftRightText[i] = New LeftRightQuali(aWebPanel[i]) As "LeftRightText"
              Case "Left Right Quantitative"
                aLeftRightValue[i] = New LeftRightQuanti(aWebPanel[i]) As "LeftRightValue"
              Case "Quantitative"
                aValueBox[i] = New ValueBox(aWebPanel[i]) As "ValueGroup"
                aUnitText[i] = New TextBox(aWebPanel[i]) As "UnitGroup"
                aNullCheck[i] = New CheckBox(aWebPanel[i]) As "NullCheckBox"
              Case "Qualitative"
                aLineText[i] = New TextBox(aWebPanel[i]) As "TextLineGroup"
            End Select
            aHelpButton[i] = New ToolButton(aWebPanel[i]) As "ButtonBoxgroup"
            aBlankBox[i] = New Label(aWebPanel[i])
            aWideRowAll[i] = New HBox(Frame1)
            aWebSpace[i] = New Separator(Frame1)

          Case Else
            aWebPanel[i] = New HBox(aWebRowAll[i])
            aWideRowAll[i] = New HBox(Frame1)
            aAbnormCheck[i] = New CheckBox(aWideRowAll[i]) As "CheckBoxgroup"
            Select $xOption[i]
              Case "Text Table"
                aGridView[i] = New GridView(aWideRowAll[i]) As "GridViewgroup"
              Case "Left and Right"
                aLeftRight[i] = New LeftRightTextArea(aWideRowAll[i]) As "LeftRightGroup"
              Case "RichText Area"
                aHTMLText[i] = New TextHTML(aWideRowAll[i]) As "TextHTMLgroup"
              Case Else
                aGenTextArea[i] = New TextPlain(aWideRowAll[i]) As "GenAreaGroup"
            End Select
            aHelpButton[i] = New ToolButton(aWideRowAll[i]) As "ButtonBoxgroup"
            aBlankBox[i] = New Label(aWideRowAll[i])
            aWebSpace[i] = New Separator(Frame1)

        End Select
      Endif

    Endif
  Next
  DIsplayTextForm()

End

Private Sub DIsplayTextForm()

  Dim i As Integer
  Dim xlimit As Float[]

  For i = 0 To $xitem.Count - 1
    If i < 49 Then

      Select $xOption[i]
        Case "Multiple Selection", "Clinical Scale"
          With aWebRowAll[i]
            .Height = 25 * Slider1.Value * AppFactor
            .Width = Frame1.Width
          End With
        Case Else
          With aWebRowAll[i]
            .Height = 25 * AppFactor
            .Width = Frame1.Width
          End With
      End Select

      If $xType[i] = "Quantitative" Then
        With aWideRowAll[i]
          .Visible = False
        End With
      Else
        Select $xOption[i]
          Case "Sys Constant", "Multiple Selection", "Clinical Scale", "Date Time", "BS Date", "User Profile", "ImageValue", "Single Selection", "Dichotomous", "Left Right Qualitative", "Left Right Quantitative", "Quantitative", "Qualitative"
            With aWideRowAll[i]
              .Visible = False
            End With
          Case "Text Table", "RichText Area"
            With aWideRowAll[i]
              .Height = ((25 * Slider1.Value) + 50) * AppFactor
            End With
          Case Else
            With aWideRowAll[i]
              .Height = (25 * Slider1.Value) * AppFactor
            End With
        End Select
      Endif

      With aWebFrame[i]
        .Height = 25 * AppFactor
        .Expand = True
      End With

      ''create index label
      With aIndexLabel[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = i + 1
        .Tag = i
      End With

      ''create Name Label
      With aNameLabel[i]
        .Expand = True
        .Height = 25 * AppFactor
        .Text = "<p>" & $xitem[i] & "</p>"
        .Font.Bold = True
        .Tag = i
        .Wrap = True
        If $xHelpList[i] = "Null" Then
          .Tooltip = ""
        Else
          .Tooltip = $xHelpList[i]
        Endif
      End With

      If $xType[i] = "Quantitative" Then
        With aWebPanel[i]
          .Height = 25 * AppFactor
          .Width = Frame1.Width / 2
        End With
      Else
        Select $xOption[i]
          Case "Sys Constant", "Date Time", "BS Date", "User Profile", "ImageValue", "Single Selection", "Dichotomous", "Left Right Qualitative", "Left Right Quantitative", "Quantitative", "Qualitative"
            With aWebPanel[i]
              .Height = 25 * AppFactor
              .Width = Frame1.Width / 2
            End With
          Case "Multiple Selection", "Clinical Scale"
            With aWebPanel[i]
              .Height = 25 * Slider1.Value * AppFactor
              .Width = Frame1.Width / 2
            End With
          Case Else
            With aWebPanel[i]
              .Visible = False
            End With
        End Select
      Endif

      If $xType[i] = "Quantitative" Then
        xlimit = modClinic.GetBothQuantiExamVal($xExam[i], $encid)
        ''create abnormal checkbox
        With aAbnormCheck[i]
          .Width = 75 * AppFactor
          .Height = 25 * AppFactor
          .Text = "Flag"
          .Tag = i
          If modBasic.$ClinFlagAbnormExam = "Disable" Then
            .Visible = False
          Else
            .Visible = True
          Endif
        End With

        With aQuantiBox[i]
          .Width = 100 * AppFactor
          .Height = 25 * AppFactor
          .Tag = i
        End With
        'min value
        With aQuantiMin[i]
          .Width = 50 * AppFactor
          .Height = 25 * AppFactor
          .Enabled = False
          .Value = xlimit[0]
          .Tag = i
        End With
        ''max value
        With aQuantiMax[i]
          .Width = 50 * AppFactor
          .Height = 25 * AppFactor
          .Enabled = False
          .Value = xlimit[1]
          .Tag = i
        End With

      Else ''qualitative
        With aAbnormCheck[i]
          .Width = 75 * AppFactor
          .Height = 25 * AppFactor
          .Text = "Flag"
          .Tag = i
          If modBasic.$ClinFlagAbnormExam = "Disable" Then
            .Visible = False
          Else
            .Visible = True
          Endif
        End With

        If $xOption[i] = "Multiple Selection" Then
          With aListBox[i]
            .Expand = True
            .Height = 25 * Slider1.Value * AppFactor
            .Mode = Select.Multiple
            .ScrollBar = Scroll.Both
            .Tag = i
          End With

        Else If $xOption[i] = "Clinical Scale" Then
          With aTextArea[i]
            .Expand = True
            .Height = 25 * Slider1.Value * AppFactor
            .Wrap = True
            .Tag = i
          End With
          With aClinBox[i]
            .Width = 75 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Single Selection" Then
          With aComboBox[i]
            .Expand = True
            .Height = 25 * AppFactor
            .List = Split($xOpList[i], "|")
            .Tag = i
          End With
          With aChkLock[i]
            .Width = 25 * AppFactor
            .Height = 25 * AppFactor
            .Value = False
            .Tag = i
          End With

        Else If $xOption[i] = "Dichotomous" Then
          With aDichoValue[i]
            .Expand = True
            .Height = 25 * AppFactor
            .List = Split($xOpList[i], "|")
            .Tag = i
          End With

        Else If $xOption[i] = "Left Right Qualitative" Then
          With aLeftRightText[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Left Right Quantitative" Then
          With aLeftRightValue[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Date Time" Then
          With aDateBox[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Mode = DateChooser.DateTime
            .Tag = i
          End With
          With aBSDate[i]
            .Width = 30 * AppFactor
            .Height = 25 * AppFactor
            .Picture = Picture["icon:/small/calendar"]
            .Tag = i
          End With

        Else If $xOption[i] = "BS Date" Then
          With aDateBox[i]
            .Width = 200 * AppFactor
            .Height = 25 * AppFactor
            .Mode = DateChooser.DateTime
            .Tag = i
          End With
          With aBSDate[i]
            .Width = 30 * AppFactor
            .Height = 25 * AppFactor
            .Picture = Picture["icon:/small/calendar"]
            .Tag = i
          End With

        Else If $xOption[i] = "User Profile" Then
          With aLineText[i]
            .X = (365 + 25) * AppFactor
            .Y = (i * 25 * Slider1.Value + 15) * AppFactor
            .Width = 250 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "ImageValue" Then
          With aButtonBox[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Text = ""
            .Tag = i
          End With

        Else If $xOption[i] = "Quantitative" Then
          With aValueBox[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          With aUnitText[i]
            .Width = 100 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
          End With
          With aNullCheck[i]
            .Width = 75 * AppFactor
            .Height = 25 * AppFactor
            .Tag = i
            .Value = False
            .Text = "Null"
          End With

        Else If $xOption[i] = "Qualitative" Then
          With aLineText[i]
            .Expand = True
            .Height = 25 * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Left and Right" Then
          With aLeftRight[i]
            .Expand = True
            .Height = (25 * Slider1.Value) * AppFactor
            .Tag = i
          End With

        Else If $xOption[i] = "Text Table" Then
          DisplayAgegrid(Split($xOpList[i], "|"), "", aGridView[i])
          With aGridView[i]
            .Expand = True
            .Height = ((25 * Slider1.Value) + 50) * AppFactor
            .ScrollBar = Scroll.Both
            .AutoResize = True
            .Tag = i
          End With

        Else If $xOption[i] = "RichText Area" Then
          With aHTMLText[i]
            .Expand = True
            .Height = ((25 * Slider1.Value) + 50) * AppFactor
            .DictionaryPath = modBasic.$dictPathList
            .Tag = i
          End With

        Else
          With aGenTextArea[i]
            .Expand = True
            .Height = (25 * Slider1.Value) * AppFactor
            .DictionaryPath = modBasic.$dictPathList
            .Tag = i
          End With

        Endif
      Endif

      ''create help button
      With aHelpButton[i]
        .Width = 25 * AppFactor
        .Height = 25 * AppFactor
        .Text = ""
        .Picture = Picture["icon:/small/info"]
        .Tag = i
        .Tooltip = "[Ctrl+O] to display Options"
      End With

      With aBlankBox[i]
        .Height = 25 * AppFactor
        .Width = 15 * AppFactor
      End With

      With aWebSpace[i]
        .Height = 15 * AppFactor
      End With

    Endif
  Next

  If aHTMLText[0] Then
    aHTMLText[0].SetFocus
  Else If aLineText[0] Then
    aLineText[0].SetFocus
  Else If aValueBox[0] Then
    aValueBox[0].SetFocus
  Else If aDateBox[0] Then
    aDateBox[0].SetFocus
  Else If aQuantiBox[0] Then
    aQuantiBox[0].SetFocus
  Else If aGenTextArea[0] Then
    aGenTextArea[0].SetFocus
  Endif

End

Public Sub BSButton_Click()

  Dim j As Integer
  Dim xx As String

  j = Last.Tag
  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(aDateBox[j].Value))
  If xx Then
    aDateBox[j].Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub btnexectext_Click()

  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & modCloudAI.GetPatCloudAIResponse($encid, aHTMLText[j].Text)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & modCloudAI.GetPatCloudAIResponse($encid, aGenTextArea[j].Text)
  Endif

End

Public Sub dctexectext_Click()

  Dim xx As String
  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLText[j] Then
    xx = GetRichTextArea(aNameLabel[j].Text, aHTMLText[j].RichText)
    If xx Then
      aHTMLText[j].RichText = xx
    Endif
  Else If aGenTextArea[j] Then
    xx = GetTextArea(aNameLabel[j].Text, aGenTextArea[j].Text)
    If xx Then
      aGenTextArea[j].Text = xx
    Endif
  Endif

End

Public Sub btntemplsumm_Click()

  Dim j As Integer

  Try j = Application.ActiveControl.Tag
  If aHTMLText[j] Then
    aHTMLText[j].RichText = aHTMLText[j].RichText & DictionaryVIew(aNameLabel[j].Text)
  Else If aGenTextArea[j] Then
    aGenTextArea[j].Text = aGenTextArea[j].Text & DictionaryVIew(aNameLabel[j].Text)
  Endif

End

Public Sub chkautoption_Click()

  modSettings.EnterCheckSetting(chkautoption, "EntrySetting/AutoDisplayOptions")

End

Public Sub btnrefresh_Click()

  modSettings.SaveSettingsToFile("MultipleTextBox/Height", Slider1.Value)
  DIsplayTextForm()

End

Public Sub btnBrChange_Click()

  modGeneralMain.SaveFormArrangement(Me)
  Me.Close()

End

Public Sub btnBrOK_Click()

  FillExamSubExam()
  btnBrOK.Enabled = False
  Balloon.Info(("Information saved"), btnBrOK)
  Balloon.Delay = modBasic.$BalloonDelay

End

Public Sub QuantiGroup_Change()

  Dim j As Integer

  j = Last.Tag
  If aQuantiBox[j].Value Then
    If aQuantiMin[j].Value <> aQuantiMax[j].Value Then
      If aQuantiBox[j].Value < aQuantiMin[j].Value Or If aQuantiBox[j].Value > aQuantiMax[j].Value Then
        aAbnormCheck[j].Value = True
      Else
        aAbnormCheck[j].Value = False
      Endif
    Else
      aAbnormCheck[j].Value = False
    Endif
  Else
    aAbnormCheck[j].Value = False
  Endif

  If aAbnormCheck[j].Value = True Then
    aAbnormCheck[j].Foreground = Color.Red
  Else
    aAbnormCheck[j].Foreground = Color.Default
  Endif

End

Private Sub FillExamSubExam()

  Dim i As Integer
  Dim xval As String
  Dim xhash As String

  xhash = $encid & ":" & $sTable & ":" & modMisc.GetWebIndexStr(modString.GetDateString(Now()))
  For i = 0 To $xitem.Count - 1
    If i < 49 Then
      If $xType[i] = "Quantitative" Then
        If aQuantiBox[i].Value Then
          modClinSub.AddQuantiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aQuantiBox[i].Value, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
        Endif
      Else
        If $xOption[i] = "Multiple Selection" Then
          If aListBox[i].Count Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aListBox[i].List.Join(gb.NewLine), aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Text Table" Then
          xval = GetTableData(Split($xOpList[i], "|"), aGridView[i])
          If xval Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], modString.GetTableFormatFromText(xval), aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Single Selection" Then
          If aComboBox[i].Text Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aComboBox[i].Text, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Dichotomous" Then
          If aDichoValue[i].Value Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aDichoValue[i].Value, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Left and Right" Then
          If aLeftRight[i].DataText Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aLeftRight[i].DataText, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Left Right Qualitative" Then
          If aLeftRightText[i].DataText Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aLeftRightText[i].DataText, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Left Right Quantitative" Then
          If aLeftRightValue[i].DataValue Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aLeftRightValue[i].DataValue, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Date Time" Then
          If aDateBox[i].Value Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], modDate.DateStringForExam(aDateBox[i].Value), aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "BS Date" Then
          If aDateBox[i].Value Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], modDate.ConvertToLocaldate(aDateBox[i].Value), aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "User Profile" Then
          If aLineText[i].Text Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aLineText[i].Text, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "ImageValue" Then
          If aButtonBox[i].Text Then
            modClinSub.AddQualiImageData($encid, $idList[i], $xitem[i], $xOption[i], $sTable, $xSysCons[i], aButtonBox[i].Text, $sCategory, xhash)
          Endif
        Else If $xOption[i] = "Quantitative" Then
          If aValueBox[i].Value Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], CStr(aValueBox[i].Value) & Space(1) & aUnitText[i].Text, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Qualitative" Then
          If aLineText[i].Text Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aLineText[i].Text, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else If $xOption[i] = "Clinical Scale" Then
          If aTextArea[i].Text Then
            modClinSub.AddClinicExam($encid, $idList[i], $xitem[i], $xOption[i], aTextArea[i].Text, aClinBox[i].Value, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, xhash)
          Endif
        Else If $xOption[i] = "RichText Area" Then
          If aHTMLText[i].Text Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aHTMLText[i].RichText, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Else
          If aGenTextArea[i].Text Then
            modClinSub.AddQualiDataUniq($encid, $idList[i], $xitem[i], $xOption[i], aGenTextArea[i].Text, aAbnormCheck[i].Value, $sTable, $xSysCons[i], $sCategory, $xUniqList[i], xhash)
          Endif
        Endif
      Endif
    Endif
  Next

End

''------------------------------------- short cut keys ------------------------------
Public Sub Form_KeyRelease()

  Dim i As Integer
  Dim j As Integer

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    '     modGeneralmain.GoToNextControlTab()
  Else If Key.Code = Key.Esc Then
    Me.Close
  Else

    If Application.ActiveControl Then
      If Not Application.ActiveControl.Tag Then
        j = 0
      Else
        j = Application.ActiveControl.Tag
      Endif
      If Key.Code = Key["O"] And If Key.Control Then
        OpenOption(j)
      Else If Key.Code = Key["S"] And If Key.Control Then
        btnBrOK_Click()
      Else If Key.Code = Key["A"] And If Key.Control Then
        If aAbnormCheck[j].Value = False Then
          aAbnormCheck[j].Value = True
        Else If aAbnormCheck[j].Value = True Then
          aAbnormCheck[j].Value = False
        Endif
      Endif
    Endif

    If Key.Code = Key.F1 Then
      i = 1
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F2 Then
      i = 2
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F3 Then
      i = 3
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F4 Then
      i = 4
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F5 Then
      i = 5
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F6 Then
      i = 6
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F7 Then
      i = 7
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F8 Then
      i = 8
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F9 Then
      i = 9
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F10 Then
      i = 10
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F11 Then
      i = 11
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Else If Key.Code = Key.F12 Then
      i = 12
      If aGenTextArea[i - 1] Then
        ScrollView1.EnsureVisible(aGenTextArea[i - 1].x, aGenTextArea[i - 1].y, aGenTextArea[i - 1].Width, aGenTextArea[i - 1].Height)
        OpenAutoOptions(i)
        aGenTextArea[i - 1].SetFocus
      Endif
    Endif

  Endif

End

''-----------------------------help options  --------------------------------------
Public Sub ButtonBoxgroup_Click()

  Dim j As Integer

  j = Last.Tag
  OpenOption(j)

End

Public Sub ComboGroup_GotFocus()

  Dim j As Integer

  j = Last.Tag
  If modBasic.$TabletModeEnable = "Yes" Then
    If Not aComboBox[j].Text Then
      aComboBox[j].Popup
    Endif
  Endif

End

Public Sub ComboGroup_MouseWheel()

  Stop Event

End

Public Sub ComboGroup_KeyRelease()

  Dim j As Integer

  j = Last.Tag
  ''enable on chnaging ComboBoxNew to ComboBox
  modFillContainer.AutoFillComboBox(aComboBox[j])
  ' modFillContainer.RestrictComboToContent(aComboBox[j])

End

Public Sub CheckLock_Click()

  Dim i As Integer

  i = Last.Tag
  If aChkLock[i].Value = True Then
    aComboBox[i].Enabled = False
  Else If aChkLock[i].Value = False Then
    aComboBox[i].Enabled = True
  Endif

End

Private Sub OpenAutoOptions(j As Integer)

  If chkautoption.Value = True Then
    OpenOption(j - 1)
  Endif

End

Private Sub OpenOption(j As Integer)

  Dim sVal As String[]
  Dim sPath As String
  Dim xval As String
  Dim xopt As String[]
  Dim xflot As Variant[]
  Dim acalc As Variant

  If $xType[j] = "Quantitative" Then
    If $xOption[j] = "Calculated" Then
      If $xExam[j] = "Expression" Then
        acalc = GetCalculateFloat($xSysCons[j], $encid)
      Else If $xExam[j] = "Structured" Then
        acalc = GetCalculateFloat($xSysCons[j], $encid)
      Else
        xval = modAllExam.GetExamDefaultValue("Exam", $xExam[j])
        If xval Then
          acalc = GetCalculateFloat(xval, $encid)
        Endif
      Endif
      If acalc Then
        aQuantiBox[j].Value = acalc
      Else
        aQuantiBox[j].Value = 0
      Endif

    Else If $xOption[j] = "CopyValue" Then
      acalc = modReportVar.GetLastQuantiParamValue($xSource[j], $xExam[j], $encid)
      If acalc Then
        aQuantiBox[j].Value = acalc
      Else
        aQuantiBox[j].Value = 0
      Endif

    Else
      xflot = GetQuantiValues("Exam", $encid, $xitem[j], 0, 0, aQuantiBox[j].Value)
      If xflot Then
        acalc = xflot[0]
        If acalc Then
          aQuantiBox[j].Value = acalc
        Else
          aQuantiBox[j].Value = 0
        Endif
      Endif

    Endif

  Else
    If $xOpList[j] Then
      xopt = Split($xOpList[j], "|")
    Endif

    If $xOption[j] = "No Selection" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aGenTextArea[j].Text = $xDefaultLst[j]
        Endif
      Endif
    Else If $xOption[j] = "RichText Area" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aHTMLText[j].RichText = $xDefaultLst[j]
        Endif
      Endif
    Else If $xOption[j] = "Qualitative" Then
      If $xDefaultLst[j] Then
        If $xDefaultLst[j] = "__" Then
        Else
          aLineText[j].Text = $xDefaultLst[j]
        Endif
      Endif

    Else If $xOption[j] = "Single Selection" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Single Selection", $xitem[j])
        If sVal Then
          aComboBox[j].Text = sVal.Join(";")
        Endif
      Endif

    Else If $xOption[j] = "Dichotomous" Then

    Else If $xOption[j] = "Multiple Selection" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Multiple Selection", $xitem[j])
        If sVal Then
          aListBox[j].List = sVal
        Endif
      Endif

    Else If $xOption[j] = "Text Table" Then
      If xopt.Count Then
        xval = TableEntry(xopt, $xitem[j], "")
        If xval Then
          DisplayAgegrid(Split($xOpList[j], "|"), xval, aGridView[j])
        Endif
      Endif

    Else If $xOption[j] = "Clinical Scale" Then
      If xopt.Count Then
        sVal = SubChoose(xopt, "Clinical Scale", $xExam[j])
        If sVal Then
          aClinBox[j].Value = sVal[0]
          aTextArea[j].Text = sVal[1]
        Endif
      Endif

    Else If $xOption[j] = "Date Time" Then
      If $xExam[j] = "Expression" Then
        acalc = GetCalculateVariant($xSysCons[j], $encid)
        If IsDate(acalc) Then
          aDateBox[j].Value = CDate(acalc)
        Endif
      Else If $xExam[j] = "Structured" Then
        acalc = GetCalculateVariant($xSysCons[j], $encid)
        If IsDate(acalc) Then
          aDateBox[j].Value = CDate(acalc)
        Endif
      Else
        aDateBox[j].Value = Now()
      Endif

    Else If $xOption[j] = "BS Date" Then
      aDateBox[j].Value = Now()

    Else If $xOption[j] = "User Profile" Then
      sVal = MedicalSelectedValue(("Select Physisican User"), modBasic.$OPConsulUserList)
      If sVal Then
        aLineText[j].Text = sVal[1]
      Endif

    Else If $xOption[j] = "ImageValue" Then
      sPath = modImage.DisplayVisualData($sCategory, $idList[j], "", $xOption[j])
      sVal = CustomDraw(sPath)
      If sVal Then
        aButtonBox[j].Text = sVal[0]
      Endif

    Else If $xOption[j] = "Visual Input" Then
      sPath = modImage.DisplayVisualData($sCategory, $idList[j], "", $xOption[j])
      If sPath Then
        xval = CVisualValue(lblitem.Text, sPath, aGenTextArea[j].Text)
        If xval Then
          aGenTextArea[j].Text = xval
        Endif
      Endif

    Else If $xOption[j] = "CopyValue" Then
      aGenTextArea[j].Text = modReportVar.GetLastQualiParamValue($xSource[j], $xExam[j], $encid)

    Else If $xOption[j] = "Calculated" Then
      If $xExam[j] = "Expression" Then
        aGenTextArea[j].Text = GetCalculateVariant($xSysCons[j], $encid)
      Else If $xExam[j] = "Structured" Then
        aGenTextArea[j].Text = GetCalculateVariant($xSysCons[j], $encid)
      Else
        xval = modAllExam.GetExamDefaultValue("Exam", $xExam[j])
        If xval Then
          aGenTextArea[j].Text = GetCalculateVariant(xval, $encid)
        Else
          aGenTextArea[j].Text = ""
        Endif
      Endif

    Endif

  Endif

End

''======================= For GridView (copied from TextTable)=================
Private Sub DisplayAgegrid(sColumns As String[], sTable As String, GridView1 As GridView)

  Dim $ageFile As String[]
  Dim sline As String
  Dim sCol As String[]
  Dim Row As Integer
  Dim Column As Integer

  GridView1.Clear
  GridView1.Columns.Count = sColumns.Count
  GridView1.Rows.Count = Split(sTable, gb.NewLine).Count - 1

  Row = 0
  $ageFile = Split(sTable, gb.NewLine)
  For Each sline In $ageFile
    sCol = Split(sline, "|")
    If sline = $ageFile[0] Then
    Else
      For Column = 0 To sCol.Count - 1
        GridView1[Row - 1, Column].Text = sCol[Column]
      Next
    Endif
    Row = Row + 1
  Next

  For Column = 0 To sColumns.Count - 1
    GridView1.Columns[Column].Text = sColumns[Column]
    Try GridView1.Columns.Width = CInt(Floor(Frame1.Width / sCol.Count))
  Next

End

Private Function GetTableData(sColumns As String[], GridView1 As GridView) As String

  Dim Row As Integer
  Dim Column As Integer
  Dim sCol As String[]
  Dim sRow As String[]
  Dim xval As String

  sRow = New String[]
  sRow.Add(sColumns.Join("|"))
  For Row = 0 To GridView1.Rows.Count - 1
    sCol = New String[]
    For Column = 0 To GridView1.Columns.Count - 1
      sCol.Add(GridView1[Row, Column].Text)
    Next
    sRow.Add(sCol.Join("|"))
  Next
  xval = sRow.Join(gb.NewLine)
  Return xval

End

Private Function GetCalculateVariant(sFormula As String, encid As String) As Variant

  Dim i As Integer
  Dim xval As Variant

  If sFormula Then
    For i = 0 To $xCode.Count - 1
      If aGenTextArea[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", aGenTextArea[i].Text)
        Endif
      Else If aDateBox[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", Str(aDateBox[i].Value))
        Endif
      Else If aQuantiBox[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", CStr(aQuantiBox[i].Value))
        Endif
      Endif
    Next
    If (String.InStr(sFormula, "$Calc[") > 0) Then
      sFormula = modReportVar.GetCalcValueVariant(sFormula, encid)
    Endif
    xval = sFormula

  Else
    xval = ""
  Endif

  Return xval

End

Private Function GetCalculateFloat(sFormula As String, encid As String) As Float

  Dim i As Integer
  Dim xval As Float

  If sFormula Then
    For i = 0 To $xCode.Count - 1
      If aGenTextArea[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", aGenTextArea[i].Text)
        Endif
      Else If aDateBox[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", Str(aDateBox[i].Value))
        Endif
      Else If aQuantiBox[i] Then
        If (String.InStr(sFormula, $xCode[i]) > 0) Then                                   ''
          sFormula = Replace(sFormula, "{$Struct_Exam:" & $xCode[i] & "$}", CStr(aQuantiBox[i].Value))
        Endif
      Endif
    Next
    If (String.InStr(sFormula, "$Calc[") > 0) Then
      sFormula = modReportVar.GetCalcValueFloat(sFormula, encid)
    Endif
    xval = CFloat(sFormula)

  Else
    xval = 0
  Endif

  Return xval

End

Public Sub ImageBoxGroup_Click()

  Dim j As Integer

  j = Last.Tag
  Dialog.Filter = ["*.jpg;*.jpeg;*.png;*.bmp", "Picture files"]
  If Dialog.OpenFile() Then Return
  aButtonBox[j].Text = Dialog.Path

End
