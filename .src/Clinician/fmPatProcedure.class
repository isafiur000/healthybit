' Gambas class file

Private $ProcIndex As Long
Private $BillIndex As Long
Private $focus As Boolean
Private $ProcBill As Long
Private $UserRestrict As String[]

Private $sTatus As String
Private $dtRegist As Date
Private $PatientNum As String
Private $AlphaList As String[]
Private $sLevel As String
Private $PositionList As String[]

Private $ExamLst As String[]
Private $RuleChartLst As String[]

Private $rData As Result
Private $aMyFields As String[]

Private hOwnStockForm As FmWardStock
Private hPtForm As FmClinHistory
Private hDigForm As FmDiagnosticTab
Private hPtArchive As FmClinArchive

Private $billReference As String
Private $billModeTest As String
Private $billModeRadio As String
Private $billModePharmacy As String
Private $billModeProcedure As String
Private $billModeEquipment As String
Private $billModeService As String
Private $billModeOthers As String

Private $PharmMode As String
Private $LedgerAC As String
Private $xBillType As String

Private $LabMode As String

Public Sub _new(encid As String, sIndex As Long, billIndex As Long, Focus As Boolean)

  txtencid.Text = encid
  $ProcIndex = sIndex
  $BillIndex = billIndex
  $focus = Focus

End

Public Sub Form_Open()

  modGeneralMain.ArrangeEmbedForms(Me, Panel1, "Vertical")
  Me.Icon = Picture[modGeneralMain.$strLogo]
  cmbpatheightunit.List = ["cm", "inch", "foot"]
  $UserRestrict = modBasic.$ClinicDisableCompo

  dtplan.Value = Now()
  cmblabdepart.List = modMedicine.GetPathoCategoryList("Test")
  $ExamLst = modMedicine.FillClinicalSubClass("Physician Examinations")
  $UserRestrict = modBasic.$ClinicDisableCompo
  $AlphaList = New String[]
  If modBasic.$PayableSettingVerify = "Enable" Then
    $sLevel = "Waiting"
  Else
    $sLevel = "Active"
  Endif

  If modBasic.$PayableLockEntry = "Yes" Then
    btnpayto.Enabled = False
  Endif
  If modBasic.$ReferralLockEntry = "Yes" Then
    btnrefer.Enabled = False
  Endif
  If modBasic.$ShareProcedureAccess = "Yes" Then
    btnaddperson.Visible = True
    ' mnudelsurguser.Visible = True
  Else
    btnaddperson.Visible = False
    ' mnudelsurguser.Visible = False
  Endif

  FillCustomFormMenu()
  FillCustomMenu()
  FillStructExamMenu()

  txtcomment.DictionaryPath = modBasic.$dictPathList
  txtproccomment.DictionaryPath = modBasic.$dictPathList

  If txtencid.Text Then
    GetEncounterValue()
  Else
    modGeneralMain.SetEncIDPrefix(txtencid)
    txtencid.SetFocus
  Endif

End

Public Sub Form_Close()

  If txtencid.Text Then
    modPatientSub.ReleaseLockEncounter(Trim(txtencid.Text), modHelpVariable.$LogInCategory)
  Endif
  modGeneralMain.RecordFormExit(Me)

End

Public Sub Form_Activate()

  Me.Icon = Picture["icons/coll4.png"]
  If $focus = True Then
    txtencid.SetFocus
  Endif

End

Public Sub Form_Deactivate()

  Me.Icon = Picture[modGeneralMain.$strLogo]

End

Public Sub txtencid_KeyPress()

  If Key.Code = Key.Down Then
    If Not txtencid.Text Then
      txtencid.Text = PatSearch("Encounter")
      txtencid.SetFocus
    Else
      If modBasic.$AutoEncSuffix = "Yes" Then
        txtencid.Text = txtencid.Text & modBasic.$HospCode
      Endif
    Endif
  Else
    modGeneralMain.InputUpCaseOnly()
  Endif

End

''-------------------------------------- patient profile ----------------------------------------------
Public Sub mnulastenc_Click()

  txtencid.Text = modSettings.ShowLogValues("LastValue/Encounter")

End

Public Sub mnupatlock_Click()

  If txtencid.Text Then
    modPatientSub.LockPatientActivity(Me.Name, Trim(txtencid.Text))
  Endif

End

Public Sub txtencid_LostFocus()

  GetEncounterValue()

End

Private Sub GetEncounterValue()

  Dim res As Result
  Dim xallow As Boolean
  Dim yallow As Boolean
  Dim xpaid As Float

  If Not txtpatientname.Text Then
    If Not txtencid.Text Then Return
    If modBasic.$EncIdPrefix And If txtencid.Text = modBasic.$EncIdPrefix Then
      txtencid.SetFocus
      Return
    Endif

    ' If modPatientSub.LockEncounterDesk(Trim(txtencid.Text)) = False Then
    '   txtencid.Text = ""
    '   Balloon.Warning(("Encounter Locked"), txtencid)
    '   Balloon.Delay = modBasic.$BalloonDelay
    '   txtencid.SetFocus
    ' Endif

    dtdob.Value = ""
    If txtencid.Text Then
      Me.Title = "ENC: " & txtencid.Text
      If txtencid.Text = modBasic.$EncIdPrefix Then
      Else
        modSettings.SaveValuesToLog("LastValue/Encounter", Trim(txtencid.Text))
      Endif
      res = modDatabase.$myConn.Exec("select fldpatientval,flduserid from tblencounter where fldencounterval=&1", Trim(txtencid.Text))
      If res.Available = False Then
        modLinkDB.CheckEncDataRemote(Trim(txtencid.Text))
        txtencid.SetFocus
      Else
        If modBasic.$LockToOwnConsultant = "Yes" Then
          If res["flduserid"] = modBasic.$lbluser Then
            xallow = True
          Else
            xallow = False
          Endif
        Else
          xallow = True
        Endif
        If modBasic.$ClinPatientForms = "Paid" Then
          xpaid = modNonMedical.TotalPaidAmountbyPatient(modDatabase.$myConn, Trim(txtencid.Text))
          If xpaid > 0 Then
            yallow = True
          Else
            yallow = False
          Endif
        Else
          yallow = True
        Endif

        If xallow = True And If yallow = True Then
          txtpatientname.Text = modPatient.GetPatientNameByEnc(Trim(txtencid.Text))
          If txtpatientname.Text Then
            Panel6.Enabled = True
            txtgender.Text = modPatient.GetPatientSex(Trim(txtencid.Text))
            txtpatientaddress.Text = modPatient.GetPatientAddressByEnc(Trim(txtencid.Text))
            dtdob.Value = modPatient.GetPatientBirthDay(Trim(txtencid.Text))
            modDateSub.GetAgeControlFromDate(dtdob.Value, txtpatage, cmbpatageunit)

            $PatientNum = modPatient.GetPatientNoByEnc(Trim(txtencid.Text))
            $sTatus = modPatient.CurrentAdmissionStatus(Trim(txtencid.Text))
            txtnow.Text = $sTatus
            txtbedno.Text = modPatient.GetLocationSetting(Trim(txtencid.Text), $sTatus)
            $dtRegist = modPatient.GetRecordDate(Trim(txtencid.Text))
            txtpatdoa.Text = modReportVar.GetDateTimeReport($dtRegist, gb.GeneralDate)
            txtpatweight.Value = modClinic.GetBodyWeight(Trim(txtencid.Text))
            btnipconsult.Tag = modPatient.GetAttendingConsultant(Trim(txtencid.Text))
            btnipconsult.Text = modGeneral.GetUserFullName(btnipconsult.Tag)
            modClinSub.GetPatientHeight(Trim(txtencid.Text), txtpatheight, cmbpatheightunit)
            modAppSupport.RecordPatientActivity("Patient Data", Me.Name, "EncounterID", Trim(txtencid.Text))
            txtcolor.Background = modPatient.GetPatientColor(Trim(txtencid.Text))
            Wait
            If modPatientSub.AllowEncIDHistory(Trim(txtencid.Text), modDatabase.$myConn) = True Then
              BlockDCButton()
              BasicInfoPatient()
              txtencid.ReadOnly = True
              SHowALgorithmList()
              modImage.ShowPhotoSplash("Patient", modPatient.GetPatientNoByEnc(Trim(txtencid.Text)))

              $focus = False
            Else
              Me.Enabled = False
            Endif
          Else
            Balloon.Warning(("Encounter ID not found"), txtencid)
            Balloon.Delay = modBasic.$BalloonDelay
            txtencid.SetFocus
          Endif
        Else
          Message.Warning("Not authorized", ("OK"))
        Endif
      Endif
    Endif
  Endif

End

Private Sub BlockDCButton()

  Dim xx As Boolean

  xx = modPatient.EnableClinicForm(txtnow.Text)
  tlbtnaddbed.Enabled = xx
  tlbtnadwt.Enabled = xx
  dtdob.Enabled = xx
  btnpic.Enabled = xx
  btnipconsult.Enabled = xx

End

Public Sub txtpatweight_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    tlbtnadwt_Click()
  Endif

End

Public Sub cmbpatheightunit_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    btnaddheit_Click()
  Else
    modFillContainer.AutoFillComboBox(cmbpatheightunit)
    modFillContainer.RestrictComboToContent(cmbpatheightunit)
  Endif

End

Public Sub txtpatweight_GotFocus()

  If modBasic.$TabletModeEnable = "Yes" Then
    txtpatweight.Enabled = False
    txtpatweight.Value = InputValue(("Set Patient Body Weight"), txtencid.Text, txtpatweight.Value)
    txtpatweight.Enabled = True
  Endif

End

Public Sub txtpatheight_GotFocus()

  If modBasic.$TabletModeEnable = "Yes" Then
    txtpatheight.Enabled = False
    txtpatheight.Value = InputValue(("Set Patient Body Height"), txtencid.Text, txtpatheight.Value)
    txtpatheight.Enabled = True
  Endif

End

Public Sub tlbtnadwt_Click()

  If txtencid.Text Then
    If txtpatweight.Value Then
      modClinSub.AddGeneralParametersQuanti(Trim(txtencid.Text), "Body Weight", txtpatweight.Value)
      tlbtnadwt.Enabled = False
      Balloon.Info(("Information saved"), tlbtnadwt)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

Public Sub btnaddheit_Click()

  If txtencid.Text Then
    If txtpatheight.Value Then
      If cmbpatheightunit.Text Then
        modClinSub.UpdatePatientHeight(Trim(txtencid.Text), txtpatheight.Value, cmbpatheightunit.Text)
        btnaddheit.Enabled = False
        Balloon.Info(("Information updated"), btnaddheit)
        Balloon.Delay = modBasic.$BalloonDelay
      Endif
    Endif
  Endif

End

Public Sub dtdob_Click()

  If txtencid.Text Then
    If dtdob.Value Then
      modPatientSub.UpdatePatDOB(Trim(txtencid.Text), dtdob.Value)
      modDateSub.GetAgeControlFromDate(dtdob.Value, txtpatage, cmbpatageunit)
      Balloon.Info(("Information updated"), dtdob)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

Public Sub cmbpatageunit_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbpatageunit)
  modFillContainer.RestrictComboToContent(cmbpatageunit)

End

Public Sub btnipconsult_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Consultant"), modBasic.$IPConsultUserList)
  If xMedUser And If xMedUser.Count Then
    btnipconsult.Tag = xMedUser[0]
    btnipconsult.Text = xMedUser[1]
  Else
    btnipconsult.Tag = ""
    btnipconsult.Text = ""
  Endif
  If btnipconsult.Tag And If txtencid.Text Then
    modPatientSub.UpdateAttendingConsultant(Trim(txtencid.Text), btnipconsult.Tag)
    Balloon.Info(("Information saved"), btnipconsult)
    Balloon.Delay = modBasic.$BalloonDelay
  Endif

End

Public Sub btnipconsult_Change()

  If btnipconsult.Text = "" Then
    btnipconsult.Tag = ""
  Endif

End

Public Sub btnwebcam_Click()

  If txtencid.Text Then
    GetEncounterValue()
  Else
    txtencid.Text = modDevice.ChooseBarCodeSource()
    txtencid.SetFocus
    txtencid.Pos = Len(txtencid.Text)
  Endif

End

Public Sub tlbtnaddbed_Click()

  Dim hForm As FmBedManage

  If txtencid.Text Then
    If txtnow.Text = "Admitted" Then
      hForm = New FmBedManage(Trim(txtencid.Text), txtbedno)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub tlbtnpayment_Click()

  If txtencid.Text Then
    modNonMedical.CurrentPayStatusMsg(Trim(txtencid.Text))
  Endif

End

Public Sub btnpic_Click()

  Dim hForm As FmPersonImage

  If txtencid.Text Then
    hForm = New FmPersonImage("Patient", modPatient.GetPatientNoByEnc(Trim(txtencid.Text)), False)
    hForm.ShowModal
  Endif

End

Public Sub btnprofile_Click()

  Dim hForm As FmMinProfile

  hForm = New FmMinProfile(Trim(txtencid.Text))
  hForm.ShowModal()

End

Public Sub btnsms_Click()

  Dim xval As String

  If btnipconsult.Tag Then
    xval = modDevice.SendSMSToInpatDoc(Trim(txtencid.Text), modGeneral.GetUserContact(btnipconsult.Tag))
    If xval Then
      Balloon.Info(xval, btnsms)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

''--------------------------------------- General --------------------------------------
Private Sub BasicInfoPatient()

  If txtencid.Text Then
    modRepository.$RepoDataStatus = False
    modAppSupport.RecordPatientActivity("Patient Data", Me.Name, "EncounterID", Trim(txtencid.Text))
    GetDefaultBillingmodes()
    InitializeProcedures()

    hDigForm = New FmDiagnosticTab(Trim(txtencid.Text), pnlabexams)
    hPtForm = New FmClinHistory($PatientNum, "PatientID", pnlhistory)
    hOwnStockForm = New FmWardStock(Trim(txtencid.Text), $sTatus, $billModePharmacy, pnluseown)
    hPtArchive = New FmClinArchive($PatientNum, pnlarchivbe)

    ButtonControl()
    cmbdisctype.List = modBasic.$BillDiscountCash
    If cmbdisctype.List.Count = 0 Then
      cmbdisctype.Add($billModeProcedure)
    Endif
    cmbdisctype.Text = $billModeProcedure
    ShowFInalProcedures()
  Endif

End

Private Sub GetDefaultBillingmodes()

  Dim xpackage As String
  Dim resx As Result

  $billReference = modNonMedical.GetFixedReference(Trim(txtencid.Text))
  Select $sTatus
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $billModeTest = modNonMedical.GetAutoIPBillingPack("Test", Trim(txtencid.Text))
      $billModeRadio = modNonMedical.GetAutoIPBillingPack("Radio", Trim(txtencid.Text))
      $billModePharmacy = modNonMedical.GetAutoIPBillingPack("Pharmacy", Trim(txtencid.Text))
      $billModeEquipment = modNonMedical.GetAutoIPBillingPack("Equipment", Trim(txtencid.Text))
      $billModeProcedure = modNonMedical.GetAutoIPBillingPack("Procedure", Trim(txtencid.Text))
      $billModeService = modNonMedical.GetAutoIPBillingPack("Service", Trim(txtencid.Text))
      $billModeOthers = modNonMedical.GetAutoIPBillingPack("Others", Trim(txtencid.Text))
    Case Else
      xpackage = modNonMedical.DefaultBillingScheme(Trim(txtencid.Text), modBasic.$compID)
      $billModeTest = xpackage
      $billModeRadio = xpackage
      $billModePharmacy = xpackage
      $billModeEquipment = xpackage
      $billModeProcedure = xpackage
      $billModeService = xpackage
      $billModeOthers = xpackage
  End Select

  resx = modDatabase.$myConn.Exec("select fldmode,fldbillingmode,fldacledger,fldbilltype,fldreference,fldlimit,fldlockstate from tbldiscount where fldtype=&1", $billModePharmacy)
  If resx.Available Then
    ''billingmode
    If resx["fldbillingmode"] Then
      $PharmMode = resx["fldbillingmode"]
    Else
      $PharmMode = modPatient.GetPatBillingMode(Trim(txtencid.Text))
    Endif
    ''ledger A/C
    $LedgerAC = resx["fldacledger"]
    ''BillType
    $xBillType = resx["fldbilltype"]
    If Not $xBillType Then
      $xBillType = "Cash"
    Endif
  Endif

End

Private Sub ButtonControl()

  Dim xx As Boolean

  xx = modPatient.EnableClinicForm(txtnow.Text)

  If $UserRestrict Then
    UserAccessRestrict()
  Endif

End

Private Sub UserAccessRestrict()

  If $UserRestrict.Exist("Bed Assignment") Then
    tlbtnaddbed.Enabled = False
  Endif
  If $UserRestrict.Exist("Body Weight") Then
    tlbtnadwt.Enabled = False
  Endif
  If $UserRestrict.Exist("Body Height") Then
    btnaddheit.Enabled = False
  Endif

End

''''------------------------------- custom report menu ---------------------------------------------------
Private Sub FillCustomMenu()

  Dim xform1 As String
  Dim xform2 As String
  Dim xform3 As String
  Dim xform4 As String
  Dim xform5 As String
  Dim xform6 As String
  Dim xform7 As String
  Dim xform8 As String
  Dim xform9 As String
  Dim xform10 As String

  xform1 = modSettings.ShowSettingFromFIle("CustomReport1/Name")
  xform2 = modSettings.ShowSettingFromFIle("CustomReport2/Name")
  xform3 = modSettings.ShowSettingFromFIle("CustomReport3/Name")
  xform4 = modSettings.ShowSettingFromFIle("CustomReport4/Name")
  xform5 = modSettings.ShowSettingFromFIle("CustomReport5/Name")
  xform6 = modSettings.ShowSettingFromFIle("CustomReport6/Name")
  xform7 = modSettings.ShowSettingFromFIle("CustomReport7/Name")
  xform8 = modSettings.ShowSettingFromFIle("CustomReport8/Name")
  xform9 = modSettings.ShowSettingFromFIle("CustomReport9/Name")
  xform10 = modSettings.ShowSettingFromFIle("CustomReport10/Name")

  If xform1 Then
    mnucust1.Caption = xform1
    mnucust1.Tag = "CustomReport1"
    mnucust1.Enabled = True
  Endif

  If xform2 Then
    mnucust2.Caption = xform2
    mnucust2.Tag = "CustomReport2"
    mnucust2.Enabled = True
  Endif

  If xform3 Then
    mnucust3.Caption = xform3
    mnucust3.Tag = "CustomReport3"
    mnucust3.Enabled = True
  Endif

  If xform4 Then
    mnucust4.Caption = xform4
    mnucust4.Tag = "CustomReport4"
    mnucust4.Enabled = True
  Endif

  If xform5 Then
    mnucust5.Caption = xform5
    mnucust5.Tag = "CustomReport5"
    mnucust5.Enabled = True
  Endif

  If xform6 Then
    mnucust6.Caption = xform6
    mnucust6.Tag = "CustomReport6"
    mnucust6.Enabled = True
  Endif

  If xform7 Then
    mnucust7.Caption = xform7
    mnucust7.Tag = "CustomReport7"
    mnucust7.Enabled = True
  Endif

  If xform8 Then
    mnucust8.Text = xform8
    mnucust8.Tag = "CustomReport8"
    mnucust8.Enabled = True
  Endif

  If xform9 Then
    mnucust9.Caption = xform9
    mnucust9.Tag = "CustomReport9"
    mnucust9.Enabled = True
  Endif

  If xform10 Then
    mnucust10.Caption = xform10
    mnucust10.Tag = "CustomReport10"
    mnucust10.Enabled = True
  Endif

End

Public Sub mnucust1_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust1.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust2_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust2.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust3_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust3.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust4_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust4.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust5_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust5.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust6_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust6.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust7_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust7.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust8_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust8.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust9_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust9.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

Public Sub mnucust10_Click()

  Dim hCls As CReportCustom

  If txtencid.Text Then
    hCls = New CReportCustom(Trim(txtencid.Text), mnucust10.Tag, "ReportSize", MMain.$defUnit)
    hCls.Preview()
  Endif

End

''==================== chart ====================
Public Sub mnuvitaltable_Click()

  Dim hForm As FmVitalTable

  If txtencid.Text Then
    hForm = New FmVitalTable(Trim(txtencid.Text))
    hForm.ShowModal()
  Endif

End

Public Sub mnuessenexam_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), "Essential Examinations", modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Private Sub FillCustomFormMenu()

  Dim xList As String[]

  xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldtitle) as col from tbldepartchart where (fldcomp=&1 or fldcomp=&2)", modBasic.$compID, "%"))

  If xList.Count > 0 Then
    mnucustform1.Caption = xList[0]
    mnucustform1.Tag = xList[0]
    mnucustform1.Enabled = True
  Endif

  If xList.Count > 1 Then
    mnucustform2.Caption = xList[1]
    mnucustform2.Tag = xList[1]
    mnucustform2.Enabled = True
  Endif

  If xList.Count > 2 Then
    mnucustform3.Caption = xList[2]
    mnucustform3.Tag = xList[2]
    mnucustform3.Enabled = True
  Endif

  If xList.Count > 3 Then
    mnucustform4.Caption = xList[3]
    mnucustform4.Tag = xList[3]
    mnucustform4.Enabled = True
  Endif

  If xList.Count > 4 Then
    mnucustform5.Caption = xList[4]
    mnucustform5.Tag = xList[4]
    mnucustform5.Enabled = True
  Endif

  If xList.Count > 5 Then
    mnucustform6.Caption = xList[5]
    mnucustform6.Tag = xList[5]
    mnucustform6.Enabled = True
  Endif

  If xList.Count > 6 Then
    mnucustform7.Caption = xList[6]
    mnucustform7.Tag = xList[6]
    mnucustform7.Enabled = True
  Endif

  If xList.Count > 7 Then
    mnucustform8.Caption = xList[7]
    mnucustform8.Tag = xList[7]
    mnucustform8.Enabled = True
  Endif

  If xList.Count > 8 Then
    mnucustform9.Caption = xList[8]
    mnucustform9.Tag = xList[8]
    mnucustform9.Enabled = True
  Endif

  If xList.Count > 9 Then
    mnucustform10.Caption = xList[9]
    mnucustform10.Tag = xList[9]
    mnucustform10.Enabled = True
  Endif

End

Public Sub mnucustform1_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform1.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform2_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform2.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform3_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform3.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform4_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform4.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform5_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform5.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform6_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform6.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform7_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform7.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform8_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform8.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform9_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform9.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

Public Sub mnucustform10_Click()

  Dim hForm As FmMultiChart

  If txtencid.Text Then
    hForm = New FmMultiChart(Trim(txtencid.Text), mnucustform10.Tag, modLabSub.GetTestUnitFromButton(rbsi, rbmetric))
    modWorkSpace.Add(hForm)
  Endif

End

''===================== Structured exams==========================
Private Sub FillStructExamMenu()

  If $ExamLst.Count > 0 Then
    mnurec1.Text = $ExamLst[0]
    mnurec1.Enabled = True
  Endif

  If $ExamLst.Count > 1 Then
    mnurec2.Text = $ExamLst[1]
    mnurec2.Enabled = True
  Endif

  If $ExamLst.Count > 2 Then
    mnurec3.Text = $ExamLst[2]
    mnurec3.Enabled = True
  Endif

  If $ExamLst.Count > 3 Then
    mnurec4.Text = $ExamLst[3]
    mnurec4.Enabled = True
  Endif

  If $ExamLst.Count > 4 Then
    mnurec5.Text = $ExamLst[4]
    mnurec5.Enabled = True
  Endif

  If $ExamLst.Count > 5 Then
    mnurec6.Text = $ExamLst[5]
    mnurec6.Enabled = True
  Endif

  If $ExamLst.Count > 6 Then
    mnurec7.Text = $ExamLst[6]
    mnurec7.Enabled = True
  Endif

  If $ExamLst.Count > 7 Then
    mnurec8.Text = $ExamLst[7]
    mnurec8.Enabled = True
  Endif

  If $ExamLst.Count > 8 Then
    mnurec9.Text = $ExamLst[8]
    mnurec9.Enabled = True
  Endif

  If $ExamLst.Count > 9 Then
    mnurec10.Text = $ExamLst[9]
    mnurec10.Enabled = True
  Endif

End

Public Sub mnurec1_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec1.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec2_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec2.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec3_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec3.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec4_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec4.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec5_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec5.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec6_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec6.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec7_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec7.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec8_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec8.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec9_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec9.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

Public Sub mnurec10_Click()

  Dim hForm As FmWardHistory

  If txtencid.Text Then
    hForm = New FmWardHistory(mnurec10.Text, Trim(txtencid.Text), "Physician Examinations")
    modAppSupport.FindWorSpace(modHelpVariable.$LogInCategory).Add(hForm)
  Endif

End

''------------------------ Algorithms ---------------------------------------------
Private Sub SHowALgorithmList()

  Dim asx1 As String[]
  Dim asx2 As String[]
  Dim asx3 As String[]
  Dim asx4 As String[]
  Dim asx5 As String[]

  If txtencid.Text Then
    $RuleChartLst = modClinChart.GetClinicalChartsList(Trim(txtencid.Text))
    If $RuleChartLst And If $RuleChartLst.Count Then

      If $RuleChartLst.Count > 0 Then
        asx1 = Split($RuleChartLst[0], "|")
        mnualgo1.Caption = asx1[0]
        mnualgo1.Tag = CLong(asx1[1])
        mnualgo1.Enabled = True
      Endif

      If $RuleChartLst.Count > 1 Then
        asx2 = Split($RuleChartLst[1], "|")
        mnualgo2.Caption = asx2[0]
        mnualgo2.Tag = CLong(asx2[1])
        mnualgo2.Enabled = True
      Endif

      If $RuleChartLst.Count > 2 Then
        asx3 = Split($RuleChartLst[2], "|")
        mnualgo3.Caption = asx3[0]
        mnualgo3.Tag = CLong(asx3[1])
        mnualgo3.Enabled = True
      Endif

      If $RuleChartLst.Count > 3 Then
        asx4 = Split($RuleChartLst[3], "|")
        mnualgo4.Caption = asx4[0]
        mnualgo4.Tag = CLong(asx4[1])
        mnualgo4.Enabled = True
      Endif

      If $RuleChartLst.Count > 4 Then
        asx5 = Split($RuleChartLst[4], "|")
        mnualgo5.Caption = asx5[0]
        mnualgo5.Tag = CLong(asx5[1])
        mnualgo5.Enabled = True
      Endif

    Endif
  Endif

End

Public Sub mnualgo1_Click()

  If txtencid.Text Then
    modClinChart.LoadRuleChart(Trim(txtencid.Text), mnualgo1.Tag, mnualgo1.Caption)
  Endif

End

Public Sub mnualgo2_Click()

  If txtencid.Text Then
    modClinChart.LoadRuleChart(Trim(txtencid.Text), mnualgo2.Tag, mnualgo2.Caption)
  Endif

End

Public Sub mnualgo3_Click()

  If txtencid.Text Then
    modClinChart.LoadRuleChart(Trim(txtencid.Text), mnualgo3.Tag, mnualgo3.Caption)
  Endif

End

Public Sub mnualgo4_Click()

  If txtencid.Text Then
    modClinChart.LoadRuleChart(Trim(txtencid.Text), mnualgo4.Tag, mnualgo4.Caption)
  Endif

End

Public Sub mnualgo5_Click()

  If txtencid.Text Then
    modClinChart.LoadRuleChart(Trim(txtencid.Text), mnualgo5.Tag, mnualgo5.Caption)
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key["O"] And If Key.Control Then
    btnwebcam_Click()
  Else If Key.Code = Key["F"] And If Key.Control Then
    txtencid.Text = GetEncid()
  Else If Key.Code = Key["X"] And If Key.Control Then
    Me.Close()
  Else
    modGeneralmain.GoToNextControlTab()
  Endif

End

Public Sub mnulastencid_Click()

  txtencid.Text = modSettings.ShowLogValues("LastValue/Encounter")

End

Public Sub rbsi_Click()

  modSettings.SaveSettingsToFile("TestUnit/Default", "SI")

End

Public Sub rbmetric_Click()

  modSettings.SaveSettingsToFile("TestUnit/Default", "Metric")

End

Public Sub btnreportall_Click()

  Dim xpath As String

  If txtencid.Text Then
    Inc Application.Busy
    xpath = modPatSurgery.ShowUniProcedureReport($ProcIndex, Trim(txtencid.Text))
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(Trim(txtencid.Text), xPath, "ReportSize")
  Endif

End

Public Sub btncomplrepo_Click()

  Dim xpath As String

  If txtencid.Text Then
    Inc Application.Busy
    xpath = modPatSurgery.GetProcedureReportAll(Trim(txtencid.Text))
    Dec Application.Busy
    modControlSub.OpenHTMLPreview(Trim(txtencid.Text), xPath, "ReportSize")
  Endif

End

Public Sub mnulabrequest_Click()

  Dim hForm As FmTestList

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Test") = True Then
      hForm = New FmTestList(Trim(txtencid.Text), $billModeTest)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub mnuradiorequest_Click()

  Dim hForm As FmRadioList

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Radio") = True Then
      hForm = New FmRadioList(Trim(txtencid.Text), $billModeRadio)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub mnuconsultreq_Click()

  Dim hForm As FmMiniConsult

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Service") = True Then
      If modBasic.$AutoRegistNoBillHour Then
        If DateDiff($dtRegist, Now(), gb.Hour) < CInt(modBasic.$AutoRegistNoBillHour) Then
          hForm = New FmMiniConsult(Trim(txtencid.Text), $billModeService)
        Endif
      Else
        hForm = New FmMiniConsult(Trim(txtencid.Text), $billModeService)
      Endif
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnequip_Click()

  Dim hForm6 As FmEquipment

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Equipment") = True Then
      hForm6 = New FmEquipment(Trim(txtencid.Text), modNonMedical.DefaultBillingScheme(Trim(txtencid.Text), modBasic.$compID))
      hForm6.ShowModal
    Endif
  Endif

End

Public Sub btnevent_Click()

  Dim hForm As FmEventTime

  If txtencid.Text Then
    hForm = New FmEventTime(Trim(txtencid.Text), "Events")
    hForm.ShowModal
  Endif

End

Public Sub mnugenservice_Click()

  Dim hForm As FmMiniService

  If txtencid.Text Then
    If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Service") = True Then
      hForm = New FmMiniService(Trim(txtencid.Text), $billModeService, $billModeProcedure, $billModeOthers, $billModePharmacy)
      hForm.ShowModal
    Endif
  Endif

End

Public Sub mnudeviceuse_Click()

  Dim hForm As FmDeviceUse

  If txtencid.Text Then
    hForm = New FmDeviceUse(Trim(txtencid.Text), "Devices")
    hForm.ShowModal
  Endif

End

Public Sub btnvital_Click()

  Dim hForm As FmVItalMobile

  If txtencid.Text Then
    hForm = New FmVItalMobile(Trim(txtencid.Text))
    hForm.ShowModal
  Endif

End

Public Sub btntriage_Click()

  Dim xcol As String

  If txtencid.Text Then
    xcol = InputColor("Triage", txtcolor.Background)
    If xcol Then
      txtcolor.Background = CInt(xcol)
      modPatient.SetPatientColor(Trim(txtencid.Text), xcol)
    Endif
  Endif

End

Public Sub btnpacs_Click()

  Dim hForm As FmPacsFind
  Dim hForm1 As FmWebKitNormal

  If txtencid.Text Then
    If modBasic.$RadioPACSForm = "Embedded" Then
      hForm1 = New FmWebKitNormal("", Trim(txtencid.Text), "PACS")
      modWorkSpace.Add(hForm1)
    Else
      hForm = New FmPacsFind(Trim(txtencid.Text), "Visit")
      hForm.ShowModal
    Endif
  Endif

End

Public Sub btnscreendraw_Click()

  Dim sPath As String
  Dim xxx As String[]
  Dim xval As String

  If txtencid.Text Then
    xxx = CustomDraw()
    If xxx Then
      sPath = xxx[0]
      If sPath Then
        xval = modImage.SaveClinicScreenDraw(Trim(txtencid.Text), xxx[1], sPath)
      Endif
    Endif
  Endif

End

''================== Initialize ===============================
Private Sub InitializeProcedures()

  Dim hForm As FmPatCheckList

  Dim res As Result
  Dim res1 As Result

  If txtencid.Text Then
    res = modDatabase.$myConn.Exec("select fldid,fldnewdate,flditem,fldreportquali,fldtime,fldsave,flddetail,fldbillingmode,fldstatus,fldgroupid from tblpatgeneral where fldencounterval=&1 and fldid=&2", Trim(txtencid.Text), $ProcIndex)
    If res.Available Then
      TabPanel1.Enabled = True
      cmbstatus.Clear()
      If res["fldstatus"] = "Waiting" Then
        cmbstatus.List = ["Referred", "On Hold", "Cancelled", "Done"]
      Else
        cmbstatus.List = ["On Hold", "Done"]
      Endif

      If res["fldgroupid"] Then
        $ProcBill = res["fldgroupid"]
      Endif
      cmbprocedure.Text = res["flditem"]
      cmbstatus.Text = res["fldreportquali"]
      dtplan.Value = res["fldnewdate"]
      txtcomment.RichText = res["flddetail"]
      txtbillmode.Text = res["fldbillingmode"]

      res1 = modDatabase.$myConn.Exec("select fldpayto,fldrefer,fldstatus,fldparent from tblpatbilling where fldencounterval=&1 and fldid=&2", Trim(txtencid.Text), $BillIndex)
      If res1.Available Then
        btnrefer.Tag = res1["fldrefer"]
        btnrefer.Text = modGeneral.GetUserFullName(btnrefer.Tag)
        btnpayto.Tag = res1["fldpayto"]
        btnpayto.Text = modGeneral.GetUserFullName(btnpayto.Tag)
        If res1["fldstatus"] = "Cancelled" Then
          Panel32.Enabled = False
        Else If res1["fldparent"] Then
          Panel32.Enabled = False
        Else
          Panel32.Enabled = True
        Endif
      Endif

      $PositionList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldusertype) as col from tblprocedureshare where flditemtype=&1 and fldbillingmode like &2 and (flditemname like &3 or flditemname=&4) and fldactive=&5", "Procedures", txtbillmode.Text, res["flditem"], "%", "Active"))
      ShowSurgUser()

      hForm = New FmPatCheckList(Trim(txtencid.Text), cmbprocedure.Text)
      hForm.ShowModal()
    Endif

  Endif

End

Public Sub TabPanel1_Click()

  If TabPanel1.Index = 0 Then
  Else If TabPanel1.Index = 1 Then
  Else If TabPanel1.Index = 2 Then
    rbonproced.Value = True
    ShowComponentExams()
  Else If TabPanel1.Index = 3 Then
    FillDosingGrid("Current")
  Else If TabPanel1.Index = 4 Then
  Else If TabPanel1.Index = 5 Then
    lsticdisease.List = modPathoSub.GetSelectedDiagnosisList("Final Diagnosis", Trim(txtencid.Text))
  Endif

End

Public Sub btnsubChange_Click()

  Dim res As Result
  Dim Row As Integer
  Dim rex As Result
  Dim xadv As String

  If $ProcIndex Then
    If cmbstatus.Text Then

      Inc Application.Busy
      modDatabase.$myConn.Begin
      res = modDatabase.$myConn.Edit("tblpatgeneral", "fldid=&1 and fldsave=&2 and fldreportquali<>&3", $ProcIndex, False, "Done")
      If res.Available Then
        res["fldnewdate"] = dtplan.Value
        res["fldreportquali"] = cmbstatus.Text
        res["flduserid"] = modBasic.$lbluser
        res["flduptime"] = Now()
        res["fldcomp"] = modBasic.$compID
        res["xyz"] = False
        res.Update()
      Endif
      Wait

      If cmbstatus.Text = "Done" Then
        If GridView1.Rows.Count Then
          If modBasic.$AutoBillAdvReceipt = "Enable" Then
            xadv = modBillLock.AdvanceReceiptString("Advance Receipt")
          Else
            xadv = ""
          Endif
          For Row = 0 To GridView1.Rows.Count - 1
            rex = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1 and fldencounterval= &2 and fldstatus=&3", GridView1[Row, 0].Text, Trim(txtencid.Text), "Punched")
            If rex.Available Then
              SavePartialEntry(rex, xadv)
            Endif
          Next
        Endif

        ' btnaddperson.Enabled = False
        ' SaveProcedureBilling($ProcIndex)
      Endif
      modDatabase.$myConn.Commit
      Dec Application.Busy
      ShowFInalProcedures()
      Balloon.Info(("Information updated"), btnsubChange)
      Balloon.Delay = modBasic.$BalloonDelay

    Endif
  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End

Private Sub SavePartialEntry(res As Result, Optional advReceipt As String)

  res["fldstatus"] = "Done"
  If advReceipt Then
    res["fldextracol"] = advReceipt
  Endif
  res["fldsample"] = "Sampled"
  res["fldsave"] = True
  res["flduserid"] = modBasic.$lbluser
  res["fldtime"] = Now()
  res["fldcomp"] = modBasic.$compID
  res["xyz"] = False
  res.Update()

End

Public Sub btncomment_Click()

  Dim res As Result

  If $ProcIndex Then
    res = modDatabase.$myConn.Edit("tblpatgeneral", "fldid=&1", $ProcIndex)
    res["flddetail"] = txtcomment.RichText
    res["xyz"] = False
    res.Update
    Balloon.Info(("Information updated"), btncomment)
    Balloon.Delay = modBasic.$BalloonDelay
  Endif

End

Public Sub cmblabdepart_Click()

  Dim resx As Result
  Dim rey As Result

  If cmblabdepart.Text Then
    If Not $LabMode Then
      resx = modDatabase.$myConn.Exec("select fldmode,fldbillingmode,fldacledger,fldbilltype,fldreference,fldlimit,fldlockstate from tbldiscount where fldtype=&1", $billModePharmacy)
      If resx.Available Then
        If resx["fldbillingmode"] Then
          $LabMode = resx["fldbillingmode"]
        Else
          $LabMode = modPatient.GetPatBillingMode(Trim(txtencid.Text))
        Endif
      Endif
    Endif

    If $LabMode Then
      rey = modDatabase.$myConn.Exec("select distinct(fldgroupname) as col from tblgrouptest where fldgroupname in(select flditemname from tblservicecost where (fldgroup=&1 or fldgroup=&2) and fldstatus=&3) and fldtestid in(select fldtestid from tbltest where fldcategory=&4) ORDER BY fldtestid", $LabMode, "%", "Active", cmblabdepart.Text)
      cmblabtest.List = modControlSub.GetDirectFillresult(rey)
    Endif
  Endif

End

Public Sub btnlabtest_Click()

  If cmblabtest.Text Then
    If modBasic.$AutoBillTest = "Standard" Or If modBasic.$AutoBillTest = "Full" Or If modBasic.$AutoBillTest = "Partial" Then
      modBillings.GetAutoBillingClinic(Trim(txtencid.Text), $billModePharmacy, "Test", cmblabtest.Text, 1, "Punched", 0, False, False, "", "")
      Message.Info("Information saved", ("OK"))
    Endif
  Endif

End

''=========================== Add Team members =================
Public Sub btnconperson_Click()

  Dim xMedUser As String[]

  If modBasic.$PayableUserFormat = "Restricted" Then
    xMedUser = MedicalSelectedValue(("Select Sharing User"), modGeneral.CategoricalUserList("fldpayable", cmbpertype.Text))
  Else
    xMedUser = MedicalSelectedValue(("Select Sharing User"), modGeneral.CategoricalUserList("fldpayable"))
  Endif
  If xMedUser And If xMedUser.Count Then
    btnconperson.Tag = xMedUser[0]
    btnconperson.Text = xMedUser[1]
  Else
    btnconperson.Tag = ""
    btnconperson.Text = ""
  Endif

End

Public Sub btnaddperson_Click()

  If $ProcBill Then
    If cmbpertype.Text And If btnconperson.Tag Then
      If Not btnpayto.Tag Then
        modPatientGeneral.AddClinicalSharingUser("Procedures", $ProcBill, Trim(txtencid.Text), cmbpertype.Text, btnconperson.Tag, "", $sLevel, 100)
        ' ' modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), cmbpertype.Text, btnconsult.Tag, "")
        ShowSurgUser()
        cmbpertype.Text = ""
        btnconperson.Tag = ""
        btnconperson.Text = ""
        btnconperson.Enabled = True
        cmbpertype.SetFocus
      Endif
    Endif
  Else
    Message.Warning("User Sharing can be added only after Billing", ("OK"))
  Endif

End

Private Sub ShowSurgUser()

  Dim Column As Integer
  Dim fld As ResultField
  Dim $sData3 As Result
  Dim posList As String[]

  $sData3 = modDatabase.$myConn.Exec("select fldid,fldtime,fldusertype,fldvalue,fldreport from tblpatgenshare where flditemid=&1 and fldcategory=&2 and fldactive=&3", $ProcBill, "Procedures", $sLevel)

  grdperson.Clear
  grdperson.Columns.Count = $sData3.Fields.Count
  grdperson.Rows.Count = $sData3.Count

  posList = New String[]
  For Each $sData3
    posList.Add($sData3["fldusertype"])
    Column = 0
    For Each fld In $sData3.Fields
      modGeneralMain.GridExplicitDecoration(grdperson, $sData3.Index, Column)
      If Column = 3 Then
        grdperson[$sData3.Index, Column].Text = modGeneral.GetUserFullName($sData3[fld.Name])
      Else
        grdperson[$sData3.Index, Column].Text = $sData3[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  grdperson.Row = 0
  cmbpertype.List = modString.GetRemainingArray($PositionList, posList)

  With grdperson
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 100 * modBasic.$AppWidthRatio
    .Columns[3].Width = 175 * modBasic.$AppWidthRatio
    .Columns[4].Width = 250 * modBasic.$AppWidthRatio

    .Columns[2].Text = "Category"
    .Columns[3].Text = "User Name"
    .Columns[4].Text = "Description"
  End With

End

Public Sub grdperson_Click()

  Dim res As Result
  Dim xx As String

  If grdperson.Column = 4 Then
    xx = GetTextArea(grdperson[grdperson.Row, 0].Text, grdperson[grdperson.Row, 4].Text)
    If xx Then
      res = modDatabase.$myConn.Edit("tblpatgenshare", "fldid=&1 and fldsave=&2", grdperson[grdperson.Row, 0].Text, True)
      res["fldreport"] = xx
      res["flduptime"] = Now()
      res["xyz"] = False
      res.Update
      ShowSurgUser()
    Endif
  Endif

End

Public Sub grdperson_Menu()

  mnudelperson.Popup()

End

Public Sub mnudelsurguser_Click()

  If grdperson.Rows.Selection.Count Then
    If cmbstatus.Text <> "Done" Then
      modDatabase.$myConn.Delete("tblpatgenshare", "fldid=&1 and fldsave=&2", grdperson[grdperson.Row, 0].Text, True)
      ShowSurgUser()
    Endif
  Endif

End

''=========================== Summary ========================
Public Sub dtneplan_Click()

  Dim xx As String

  xx = BSDateFormat(("Enter BS Date in yyyy/mm/dd format"), ("Date Converter"), modDate.ConvertToLocaldate(dtplan.Value))
  If xx Then
    dtplan.Value = modDate.ConvertToEnglishdate(xx)
  Endif

End

Public Sub cmbstatus_GotFocus()

  If cmbprocedure.Text Then
    If modNonMedical.GetControlServCombo(cmbprocedure.Text) = False Then
      cmbprocedure.Text = ""
      Balloon.Warning(("Item not listed"), cmbprocedure)
      Balloon.Delay = modBasic.$BalloonDelay
      cmbprocedure.SetFocus
    Endif
  Endif

End

Public Sub cmbstatus_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbstatus)
  modFillContainer.RestrictComboToContent(cmbstatus)

End

Public Sub btnpayto_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Payable User"), modBasic.$PayUserList)
  If xMedUser And If xMedUser.Count Then
    btnpayto.Tag = xMedUser[0]
    btnpayto.Text = xMedUser[1]
  Else
    btnpayto.Tag = ""
    btnpayto.Text = ""
  Endif

End

Public Sub btnpayto_Change()

  If btnpayto.Text = "" Then
    btnpayto.Tag = ""
  Endif

End

Public Sub btnpayto_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    If btnpayto.Tag Then
    Else
      btnpayto_Click()
    Endif
  Endif

End

''
Public Sub btnrefer_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Referral User"), modBasic.$ReferUserList)
  If xMedUser And If xMedUser.Count Then
    btnrefer.Tag = xMedUser[0]
    btnrefer.Text = xMedUser[1]
  Else
    btnrefer.Tag = ""
    btnrefer.Text = ""
  Endif

End

Public Sub btnrefer_Change()

  If btnrefer.Text = "" Then
    btnrefer.Tag = ""
  Endif

End

Public Sub btnrefer_KeyRelease()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.AltKey Then
    If btnrefer.Tag Then
    Else
      btnrefer_Click()
    Endif
  Endif

End

''================ Summary ========================
Public Sub dctnewsummry_Click()

  Dim xx As String

  xx = GetRichTextArea("Summary of Procedure", txtcomment.RichText)
  If xx Then
    txtcomment.RichText = xx
  Endif

End

Public Sub btnnewsummry_Click()

  txtcomment.RichText = txtcomment.RichText & modCloudAI.GetPatCloudAIResponse(Trim(txtencid.Text), txtcomment.Text)

End

Public Sub btntemplnewsummary_Click()

  txtcomment.RichText = txtcomment.RichText & DictionaryVIew("Summary of Procedure")

End

''===================== component  =============================
Private Sub ShowComponentExams()

  If txtencid.Text And If $ProcIndex Then
    TabPanel2.Index = 0
    TabPanel2.Enabled = True
    If rbpreproc.Value = True Then
      TabPanel2[3].Visible = False
      hOwnStockForm.SetOwnDepartment("Pre-Operative:" & CStr($ProcIndex))
      hOwnStockForm.RearrangeGrid()

      GetExamList("Pre-Operative", gridVariable)
      FillExamtable("Pre-Operative Exam:" & CStr($ProcIndex), gridvalues)

      pnlabs.Visible = False
      lblindication.Text = "Indication"
      cmbprocindication.Text = GetLastValueProc("fldreportquali", "Pre-Operative Indication")
      txtproccomment.RichText = GetLastValueProc("fldreport", "Pre-Operative Note")

    Else If rbonproced.Value = True Then
      TabPanel2[3].Visible = True
      hOwnStockForm.SetOwnDepartment("Operative:" & CStr($ProcIndex))
      hOwnStockForm.RearrangeGrid()

      GetExamList("Operative", gridVariable)
      FillExamtable("Operative Exam:" & CStr($ProcIndex), gridvalues)

      pnlabs.Visible = True
      lblindication.Text = "Indication"
      cmbprocindication.Text = GetLastValueProc("fldreportquali", "Operative Indication")
      txtproccomment.RichText = GetLastValueProc("fldreport", "Operation Note")

      txtincision.RichText = GetLastValueProc("fldreport", "Incision")
      txtfindings.RichText = GetLastValueProc("fldreport", "Findings")
      txtprocedures.RichText = GetLastValueProc("fldreport", "Proedures")
      txtclosure.RichText = GetLastValueProc("fldreport", "Closure")

    Else If rbanesthe.Value = True Then
      TabPanel2[3].Visible = False
      hOwnStockForm.SetOwnDepartment("Anaesthesia:" & CStr($ProcIndex))
      hOwnStockForm.RearrangeGrid()

      GetExamList("Anaesthesia", gridVariable)
      FillExamtable("Anaesthesia:" & CStr($ProcIndex), gridvalues)

      pnlabs.Visible = False
      lblindication.Text = "Technique"
      cmbprocindication.Text = GetLastValueProc("fldreportquali", "Anaesthesia Technique")
      txtproccomment.RichText = GetLastValueProc("fldreport", "Anaesthesia Note")

    Else If rbpostproc.Value = True Then
      TabPanel2[3].Visible = False
      hOwnStockForm.SetOwnDepartment("Post-Operative:" & CStr($ProcIndex))
      hOwnStockForm.RearrangeGrid()

      GetExamList("Post-Operative", gridVariable)
      FillExamtable("Post-Operative Exam:" & CStr($ProcIndex), gridvalues)

      pnlabs.Visible = False
      lblindication.Text = "Indication"
      cmbprocindication.Text = GetLastValueProc("fldreportquali", "Post-Operative Indication")
      txtproccomment.RichText = GetLastValueProc("fldreport", "Post-Operative Note")
    Endif

  Else
    TabPanel2.Enabled = False
  Endif

End

Public Sub rbpreproc_Click()

  ShowComponentExams()

End

Public Sub rbonproced_Click()

  ShowComponentExams()

End

Public Sub rbanesthe_Click()

  ShowComponentExams()

End

Public Sub rbpostproc_Click()

  ShowComponentExams()

End

''========================= Examination ===========================
Private Function GetLastValueProc(sFIeld As String, sCategory As String) As String

  Dim res As Result
  Dim sql As String
  Dim xx As String

  sql = Subst("select &1 as col from tblpatsubgeneral", sFIeld)
  res = modDatabase.$myConn.Exec(sql & " where flditemid=&1 and fldencounterval=&2 and fldchapter=&3", $ProcIndex, Trim(txtencid.Text), sCategory)
  If res.Available Then
    res.MoveLast
    xx = res["col"]
  Endif
  Return xx

End

Private Function GetExamList(sType As String, xGridView As GridView) As String[]

  Dim res As Result
  Dim Column As Integer
  Dim fld As ResultField

  res = modDatabase.$myConn.Exec("select fldexamid,fldtype,fldsysconst,fldexamid,fldtanswertype from tbldeptexam where flddept=&1", sType)
  xGridView.Clear
  xGridView.Columns.Count = res.Fields.Count
  xGridView.Rows.Count = res.Count

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(xGridView, res.Index, Column)
      If Column = 3 Then
        xGridView[res.Index, Column].Text = modFixClinic.GetExamtOptionType(res[fld.Name])
      Else
        xGridView[res.Index, Column].Text = res[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  xGridView.Row = 0

  With xGridView
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 250 * modBasic.$AppWidthRatio
    .Columns[1].Width = 1
    .Columns[2].Width = 1
    .Columns[3].Width = 1
    .Columns[4].Width = 1
  End With

End

Private Function ProcedureExamType(sCateg As String) As String

  Dim xx As String

  If sCateg = "Pre-Operative Exam" Then
    xx = "Pre-Operative"
  Else If sCateg = "Operative Exam" Then
    xx = "Operative"
  Else If sCateg = "Anaesthesia" Then
    xx = "Anaesthesia"
  Else If sCateg = "Post-Operative Exam" Then
    xx = "Post-Operative"
  Endif
  Return xx

End

Private Function GetComponentTile() As String

  Dim xexam As String

  If rbpreproc.Value = True Then
    xexam = "Pre-Operative"
  Else If rbonproced.Value = True Then
    xexam = "Operative"
  Else If rbanesthe.Value = True Then
    xexam = "Anaesthesia"
  Else If rbpostproc.Value = True Then
    xexam = "Post-Operative"
  Endif

  Return xexam

End

Public Sub gridVariable_Click()

  Dim xIndex As String

  If rbpreproc.Value = True Then
    xIndex = "Pre-Operative Exam:" & CStr($ProcIndex)
  Else If rbonproced.Value = True Then
    xIndex = "Operative Exam:" & CStr($ProcIndex)
  Else If rbanesthe.Value = True Then
    xIndex = "Anaesthesia:" & CStr($ProcIndex)
  Else If rbpostproc.Value = True Then
    xIndex = "Post-Operative Exam:" & CStr($ProcIndex)
  Endif
  AddExamSelectionProc(Trim(txtencid.Text), gridVariable[gridVariable.Row, 0].Text, gridVariable[gridVariable.Row, 2].Text, gridVariable[gridVariable.Row, 1].Text, gridVariable[gridVariable.Row, 4].Text, xIndex)
  FillExamtable(xIndex, gridvalues)

End

Private Sub AddExamSelectionProc(encid As String, sExamLabel As String, sysConst As String, sType As String, OptionType As String, xid As String)

  Dim sName As String
  Dim xquantival As Variant[]
  Dim yqualival As Variant[]
  Dim lftrtval As Variant[]
  Dim xlimit As Float[]
  Dim opt As String[]
  Dim sVal As String[]
  Dim asx As String[]
  Dim xdate As Date
  Dim xval As String
  Dim xdefval As Float
  Dim xstrval As String

  Dim cForm As CFindExam
  Dim examtype As String
  Dim sExam As String
  Dim sOptName As String
  Dim sDefault As String

  If sysConst Then
    cForm = New CFindExam(sysConst)
    examtype = cForm.GetExamMode()
    sExam = cForm.GetExamName()
    sOptName = cForm.GetExamOption()
    sDefault = cForm.GetExamDefault()
  Endif

  If sExam Then
    sName = sExam
  Else
    sName = sExamLabel
  Endif

  If sType = "Quantitative" Then
    xdefval = 0
    If sysConst Then
      If OptionType = "Sys Constant" And If sOptName = "Calculated" Then
        If sDefault Then
          xdefval = modReportVar.GetCalcValueFloat(sDefault, encid)
        Endif
      Else If OptionType = "Calculated" Then
        xdefval = modReportVar.GetCalcValueFloat(sysConst, encid)
      Else If OptionType = "CopyValue" Then
        xdefval = modReportVar.GetLastQuantiParamValue(examtype, sExam, encid)
      Endif
      xlimit = modClinic.GetBothQuantiExamVal(sExam, encid)
    Else
      xlimit = [0, 0]
    Endif
    xquantival = GetQuantiValues(examtype, Trim(txtencid.Text), sName, xlimit[0], xlimit[1], xdefval)
    If xquantival Then
      modClinSub.AddQuantiData(encid, "", sExamLabel, OptionType, xquantival[0], xquantival[1], xid, sysConst)
    Endif

  Else
    If sysConst Then
      xstrval = ""
      If OptionType = "Sys Constant" Then
        If sOptName = "Calculated" Then
          If sDefault Then
            xstrval = modReportVar.GetCalcValueVariant(sDefault, encid)
          Endif
          yqualival = GetQualiValues(sName, xstrval, examtype)
        Else
          yqualival = modExamOption.GetQualiExamOptionDirectValue(sExam, "", examtype, sOptName)
        Endif
      Else If OptionType = "Calculated" Then
        xstrval = modReportVar.GetCalcValueVariant(sysConst, encid)
        yqualival = GetQualiValues(sName, xstrval, examtype)
      Else If OptionType = "CopyValue" Then
        xstrval = modReportVar.GetLastQualiParamValue(examtype, sExam, encid)
        yqualival = GetQualiValues(sName, xstrval, examtype)
      Endif

    Else
      If OptionType = "Date Time" Then
        xdate = GetDateValue(("Select Date Time"), sName, "")
        If xdate Then
          yqualival = [modDate.DateStringForExam(xdate), False]
        Endif

      Else If OptionType = "BS Date" Then
        xdate = GetDateValue(("Select Date Time"), sName, "")
        If xdate Then
          yqualival = [modDate.ConvertToLocaldate(xdate), False]
        Endif

      Else If OptionType = "Qualitative" Then
        yqualival = GetQualiString(sName, "", "Exam")

      Else If OptionType = "Left and Right" Then
        lftrtval = CLeftRight(sName, "", modFixClinic.GetLeftRightMainHeader("Exam", sName))
        If lftrtval Then
          yqualival = [lftrtval[0], lftrtval[1]]
        Endif

      Else If OptionType = "Single Selection" Or If OptionType = "Dichotomous" Or If OptionType = "Multiple Selection" Then
        asx = Split(xid, ":")
        opt = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select fldanswer from tbldeptexamoption where fldexamid=&1 and flddept=&2 and fldtanswertype=&3 ORDER BY fldindex", sExamLabel, ProcedureExamType(asx[0]), OptionType))
        If opt.Count Then
          sVal = SubChoose(opt, OptionType, sExamLabel)
          If sVal Then
            yqualival = [sVal.Join(gb.NewLine), False]
          Endif
        Else
          yqualival = GetQualiValues(sName, "", "Exam")
        Endif

      Else If OptionType = "Text Table" Then
        asx = Split(xid, ":")
        opt = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select fldanswer from tbldeptexamoption where fldexamid=&1 and flddept=&2 and fldtanswertype=&3 ORDER BY fldindex", sExamLabel, ProcedureExamType(asx[0]), OptionType))
        If opt.Count Then
          xval = TableEntry(opt, sExamLabel, "")
          If xval Then
            yqualival = [modString.GetTableFormatFromText(xval), False]
          Endif
        Else
          yqualival = GetQualiValues(sName, "", "Exam")
        Endif

      Else If OptionType = "RichText Area" Then
        yqualival = GetQualiRich(sName, "", "Exam")

      Else
        yqualival = GetQualiValues(sName, "", "Exam")
      Endif
    Endif

    If yqualival Then
      If yqualival.Count = 3 And If yqualival[2] Then
        modClinSub.AddClinicExam(encid, "", sExamLabel, OptionType, yqualival[0], CFloat(yqualival[2]), yqualival[1], xid, sysConst, "Regular")
      Else
        modClinSub.AddClinicExam(encid, "", sExamLabel, OptionType, yqualival[0], 0, yqualival[1], xid, sysConst, "Regular")
      Endif
    Endif
  Endif ''quali or quanti

End

Public Sub FillExamtable(xcateg As String, xGridView As GridView)

  Dim Column As Integer
  Dim fld As ResultField
  Dim $sData1 As Result

  $sData1 = modDatabase.$myConn.Exec("select fldid,fldtype,fldhead,fldabnormal,fldid,fldid,fldtime,fldencounterval,fldrepquali,fldsysconst,flduserid,fldcomp from tblpatientexam where fldencounterval=&1 and fldinput=&2 and fldsave=&3", Trim(txtencid.Text), xcateg, True)
  xGridView.Clear
  xGridView.Columns.Count = $sData1.Fields.Count
  xGridView.Rows.Count = $sData1.Count

  With xGridView
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 250 * modBasic.$AppWidthRatio
    .Columns[3].Width = 25 * modBasic.$AppWidthRatio
    .Columns[4].Width = 350 * modBasic.$AppWidthRatio
    .Columns[5].Width = 25 * modBasic.$AppWidthRatio
    .Columns[6].Width = 150 * modBasic.$AppWidthRatio
    .Columns[7].Width = 1
    .Columns[8].Width = 1
    .Columns[9].Width = 1
    .Columns[10].Width = 100 * modBasic.$AppWidthRatio
    .Columns[11].Width = 100 * modBasic.$AppWidthRatio

    .Columns[2].Text = "Examination"
    .Columns[4].Text = "Observation"
    .Columns[6].Text = "ReportTime"
    .Columns[10].Text = "UserID"
    .Columns[11].Text = "Location"
  End With

  For Each $sData1
    Column = 0
    For Each fld In $sData1.Fields
      modGeneralMain.GridExplicitDecoration(xGridView, $sData1.Index, Column)
      If Column = 3 Then
        xGridView[$sData1.Index, Column].Picture = Picture[modMisc.GetGridIcon($sData1[fld.Name])]
        xGridView[$sData1.Index, Column].Text = ""
      Else If Column = 4 Then
        xGridView[$sData1.Index, Column].RichText = modClinic.GetExamValueString(Trim(txtencid.Text), $sData1["fldid"], False)
        If modBasic.$RichtextResizeRow = "Yes" Then
          xGridView.Rows[$sData1.Index].Height = Max(xGridView.Rows[$sData1.Index].Height, xGridView[$sData1.Index, Column].Font.RichTextHeight(xGridView[$sData1.Index, Column].RichText, xGridView.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (xGridView.Rows.Height - xGridView.Font.Height))
        Endif
      Else If Column = 5 Then
        xGridView[$sData1.Index, Column].Picture = Picture["icon:/tiny/cancel"]
        xGridView[$sData1.Index, Column].Text = ""
      Else If Column = 6 Then
        xGridView[$sData1.Index, Column].Text = modReportVar.GetDateTimeReport($sData1["fldtime"], gb.GeneralDate)
      Else
        xGridView[$sData1.Index, Column].Text = $sData1[fld.Name]
      Endif
      xGridView.Rows[$sData1.Index].Height = Max(xGridView.Rows[$sData1.Index].Height, xGridView[$sData1.Index, Column].Font.RichTextHeight(xGridView[$sData1.Index, Column].Text, xGridView.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (xGridView.Rows.Height - xGridView.Font.Height))
      xGridView[$sData1.Index, Column].WordWrap = True

      Column = Column + 1
    Next
  Next
  xGridView.Row = 0

End

''======================== Notes =============================
Public Sub btnpreindication_Click()

  If txtencid.Text And If $ProcIndex Then
    If cmbprocindication.Text Then

      If rbpreproc.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Pre-Operative Indication", cmbprocindication.Text, "")
      Else If rbonproced.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Operative Indication", cmbprocindication.Text, "")
      Else If rbanesthe.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Anaesthesia Technique", cmbprocindication.Text, "")
      Else If rbpostproc.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Post-Operative Indication", cmbprocindication.Text, "")
      Endif
      Balloon.Info(("Information saved"), btnpreindication)
      Balloon.Delay = modBasic.$BalloonDelay

    Endif
  Endif

End

Public Sub btnprecomment_Click()

  If txtencid.Text And If $ProcIndex Then
    If txtproccomment.Text Then

      If rbpreproc.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Pre-Operative Note", txtproccomment.KeyList.Join(";"), txtproccomment.RichText)
      Else If rbonproced.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Operation Note", txtproccomment.KeyList.Join(";"), txtproccomment.RichText)
      Else If rbanesthe.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Anaesthesia Note", txtproccomment.KeyList.Join(";"), txtproccomment.RichText)
      Else If rbpostproc.Value = True Then
        modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Post-Operative Note", txtproccomment.KeyList.Join(";"), txtproccomment.RichText)
      Endif
      Balloon.Info(("Information saved"), btnprecomment)
      Balloon.Delay = modBasic.$BalloonDelay

    Endif
  Endif

End

Public Sub dcthelppre_Click()

  Dim xx As String

  xx = GetRichTextArea(GetComponentTile(), txtproccomment.RichText)
  If xx Then
    txtproccomment.RichText = xx
  Endif

End

Public Sub btnhelppre_Click()

  txtproccomment.RichText = txtproccomment.RichText & modCloudAI.GetPatCloudAIResponse(Trim(txtencid.Text), txtproccomment.Text)

End

Public Sub btntemplpre_Click()

  txtproccomment.RichText = txtproccomment.RichText & DictionaryVIew(GetComponentTile())

End

''====================== Pharmacy =======================
Public Sub btnorderpre_Click()

  Dim hForm As FmMedOrder

  If modNonMedical.AllowEntryWithDeposit(Trim(txtencid.Text), "Pharmacy") = True Then
    If modBasic.$MedRequestForm = "Separate" Then
    Else
      hForm = New FmMedOrder(Trim(txtencid.Text), $sTatus, $billModePharmacy)
      hForm.ShowModal
    Endif
    FillDosingGrid("Current")
    hOwnStockForm.RefreshList()
  Endif

End

Public Sub btndosepre_Click()

  Dim hForm As FmDoseMobile

  If txtencid.Text Then
    If $ProcIndex Then
      hForm = New FmDoseMobile(Trim(txtencid.Text))
      hForm.ShowModal
      FillDosingGrid("Current")
    Endif
  Endif

End

Public Sub btninfusionpre_Click()

  Dim hForm As FmIVInfusion

  If txtencid.Text Then
    If $ProcIndex Then
      hForm = New FmIVInfusion(Trim(txtencid.Text))
      hForm.ShowModal
      FillDosingGrid("Current")
    Endif
  Endif

End

Public Sub btnshowallpre_Click()

  If txtencid.Text Then
    If btnall.Value = True Then
      FillDosingGrid("All")
    Else If btnall.Value = False Then
      FillDosingGrid("Current")
    Endif
  Endif

End

Private Sub FillDosingGrid(strType As String)

  Dim sql As String
  Dim Column As Integer
  Dim fld As ResultField
  Dim res As Result

  If strType = "Current" Then
    sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,(fldqtydisp-fldqtyret) as qty,fldlabel,fldcurval from tblpatdosing where fldencounterval=&1 and fldcomp_order=&2 and fldsave_order=&3 and flditemtype=&4"                                                   ''
    res = modDatabase.$myConn.Exec(sql, Trim(txtencid.Text), modBasic.$compID, True, "Medicines")
  Else If strType = "All" Then
    sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,(fldqtydisp-fldqtyret) as qty,fldlabel,fldcurval from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and flditemtype=&3"                                                   ''
    res = modDatabase.$myConn.Exec(sql, Trim(txtencid.Text), True, "Medicines")
  Endif

  grdpharm.Clear
  grdpharm.Columns.Count = res.Fields.Count
  grdpharm.Rows.Count = res.Count

  With grdpharm
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 150 * modBasic.$AppWidthRatio
    .Columns[2].Width = 75 * modBasic.$AppWidthRatio
    .Columns[3].Width = 425 * modBasic.$AppWidthRatio
    .Columns[4].Width = 75 * modBasic.$AppWidthRatio
    .Columns[5].Width = 75 * modBasic.$AppWidthRatio
    .Columns[6].Width = 50 * modBasic.$AppWidthRatio
    .Columns[7].Width = 50 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 100 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Start"
    .Columns[2].Text = "Route"
    .Columns[3].Text = "Particulars"
    .Columns[4].Text = "Dose"
    .Columns[5].Text = "Freq"
    .Columns[6].Text = "Days"
    .Columns[7].Text = "QTY"
    .Columns[9].Text = "Status"
  End With

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(grdpharm, res.Index, Column)
      If Column = 1 Then
        grdpharm[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldstarttime"], gb.GeneralDate)
      Else
        grdpharm[res.Index, Column].Text = res[fld.Name]
      Endif
      grdpharm.Rows[res.Index].Height = Max(grdpharm.Rows[res.Index].Height, grdpharm[res.Index, Column].Font.RichTextHeight(grdpharm[res.Index, Column].Text, grdpharm.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (grdpharm.Rows.Height - grdpharm.Font.Height))
      grdpharm[res.Index, Column].WordWrap = True

      Column = Column + 1
    Next
  Next
  grdpharm.Row = 0

End

Public Sub grdpharm_Click()

  UpdateMedStatus()
  FillDosingGrid("Current")

End

Private Sub UpdateMedStatus()

  Dim xx As String[] = ["Continue", "Completed", "Discontinue", "On Hold", "Change", "ReWrite", "Cancelled", "Wasted"]
  Dim res As Result
  Dim xval As String

  If grdpharm.Column = 9 Then
    xval = InputCombo(grdpharm[grdpharm.Row, 3].Text, ("Select Current Status"), xx, grdpharm[grdpharm.Row, 9].Text, True)
    If xval Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1", grdpharm[grdpharm.Row, 0].Text)
      res["fldcurval"] = xval
      res["xyz"] = False
      res.Update()
    Endif
  Endif

End

''============== Structured Operation Note ======================
Public Sub dcthelpincis_Click()

  Dim xx As String

  xx = GetRichTextArea("Explain Incision", txtincision.RichText)
  If xx Then
    txtincision.RichText = xx
  Endif

End

Public Sub btnhelpincis_Click()

  txtincision.RichText = txtincision.RichText & modCloudAI.GetPatCloudAIResponse(Trim(txtencid.Text), txtincision.Text)

End

Public Sub btnlstincis_Click()

  txtincision.RichText = txtincision.RichText & DictionaryVIew("Explain Incision")

End

Public Sub dcthelpfind_Click()

  Dim xx As String

  xx = GetRichTextArea("Explain Findings", txtfindings.RichText)
  If xx Then
    txtfindings.RichText = xx
  Endif

End

Public Sub btnhelpfind_Click()

  txtfindings.RichText = txtfindings.RichText & modCloudAI.GetPatCloudAIResponse(Trim(txtencid.Text), txtfindings.Text)

End

Public Sub btnlstfind_Click()

  txtfindings.RichText = txtfindings.RichText & DictionaryVIew("Explain Findings")

End

Public Sub dcthelpproc_Click()

  Dim xx As String

  xx = GetRichTextArea("Explain Procedure", txtprocedures.RichText)
  If xx Then
    txtprocedures.RichText = xx
  Endif

End

Public Sub btnhelpproc_Click()

  txtprocedures.RichText = txtprocedures.RichText & modCloudAI.GetPatCloudAIResponse(Trim(txtencid.Text), txtprocedures.Text)

End

Public Sub btnlstproc_Click()

  txtprocedures.RichText = txtprocedures.RichText & DictionaryVIew("Explain Procedure")

End

Public Sub dcthelpclose_Click()

  Dim xx As String

  xx = GetRichTextArea("Explain Closure", txtclosure.RichText)
  If xx Then
    txtclosure.RichText = xx
  Endif

End

Public Sub btnhelpclos_Click()

  txtclosure.RichText = txtclosure.RichText & modCloudAI.GetPatCloudAIResponse(Trim(txtencid.Text), txtclosure.Text)

End

Public Sub btnlstclose_Click()

  txtclosure.RichText = txtclosure.RichText & DictionaryVIew("Explain Closure")

End

Public Sub btnsaveincision_Click()

  If txtencid.Text And If $ProcIndex Then
    If txtincision.Text Then
      modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Incision", txtincision.KeyList.Join(";"), txtincision.RichText)
      Balloon.Info(("Information saved"), btnsaveincision)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

Public Sub btnsavefinding_Click()

  If txtencid.Text And If $ProcIndex Then
    If txtfindings.Text Then
      modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Findings", txtfindings.KeyList.Join(";"), txtfindings.RichText)
      Balloon.Info(("Information saved"), btnsavefinding)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

Public Sub btnsaveprocedure_Click()

  If txtencid.Text And If $ProcIndex Then
    If txtprocedures.Text Then
      modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Proedures", txtprocedures.KeyList.Join(";"), txtprocedures.RichText)
      Balloon.Info(("Information saved"), btnsaveprocedure)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

Public Sub btnsaveclosure_Click()

  If txtencid.Text And If $ProcIndex Then
    If txtclosure.Text Then
      modPatientGeneral.AddSubGeneralQualiData($ProcIndex, Trim(txtencid.Text), "Closure", txtclosure.KeyList.Join(";"), txtclosure.RichText)
      Balloon.Info(("Information saved"), btnsaveclosure)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

''================== final procedure ======================
Public Sub btnaddprocpast_Click()

  Dim res As Result

  res = modDatabase.$myConn.Edit("tblpatbilling", "fldencounterval=&1 and fldid=&2 and fldparent=&3 and (fldstatus=&4 or fldstatus=&5)", Trim(txtencid.Text), $BillIndex, 0, "Punched", "Done")
  If res.Available Then
    res["fldparent"] = $ProcIndex
    res.Update
    ShowFInalProcedures()
    Balloon.Info(("Information updated"), btnaddprocpast)
    Balloon.Delay = modBasic.$BalloonDelay
  Endif

End

Public Sub btndelprocpast_Click()

  Dim rex As Result

  rex = modDatabase.$myConn.Edit("tblpatbilling", "fldid=&1 and fldencounterval= &2 and fldstatus=&3", $BillIndex, Trim(txtencid.Text), "Punched")
  If rex.Available Then
    rex["fldstatus"] = "Cancelled"
    rex.Update
    ShowFInalProcedures()
    Balloon.Info(("Information updated"), btndelprocpast)
    Balloon.Delay = modBasic.$BalloonDelay
  Endif

End

Public Sub btnaddprocnew_Click()

  Dim xmode As String
  Dim xList As String[]
  Dim xitem As String
  Dim xrefer As String
  Dim xTarg As String

  xrefer = modBillings.GetReferralUserSetting("Procedure", Trim(txtencid.Text))
  xmode = modNonMedical.GetDiscBindBillMode(cmbdisctype.Text)
  If xmode Then
    xList = modNonMedical.GetServiceSectionArray("Procedures", xmode)
    If xList And If xList.Count Then
      xitem = GridViewGroup("Select Final Procedures", xList, False)
      If xitem Then
        xTarg = modNonMedical.GetBillingTargeDept(cmbprocedure.Text, "Procedure")
        modBillings.GetAutoBillingEntry(Trim(txtencid.Text), cmbdisctype.Text, "Procedure", xitem, 1, "Punched", $ProcIndex, False, False, "", xrefer, xTarg)
        ShowFInalProcedures()
      Endif
    Endif
  Endif

End

Private Sub ShowFInalProcedures()

  Dim sql As String

  sql = "select fldid,flditemname,fldstatus from tblpatbilling where fldencounterval=&1 and flditemtype=&2 and fldparent=&3"
  $rData = modDatabase.$myConn.Exec(sql, Trim(txtencid.Text), "Procedures", $ProcIndex)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView1, $rData, $aMyFields)

  With GridView1
    .Columns[0].Width = 1
    .Columns[1].Width = 350 * modBasic.$AppWidthRatio
    .Columns[2].Width = 75 * modBasic.$AppWidthRatio
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "Status"
  End With

End

Public Sub GridView1_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView1, Row)
  GridView1.Data.Text = $rData[$aMyFields[Column]]

End

''----------------------- Outcome ------------------
Public Sub btnplan_Click()

  If txtencid.Text Then
    If txtplan.Text Then
      modPatientGeneral.AddPatientParagraph(Trim(txtencid.Text), "Notes", "Doctor Order", "", txtplan.RichText, False)
      Balloon.Info(("Information saved"), btnplan)
      Balloon.Delay = modBasic.$BalloonDelay
    Endif
  Endif

End

Public Sub tlbtndelfinal_Click()

  Dim res As Result

  If txtencid.Text Then
    If lsticdisease.Text Then
      If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
        res = modDatabase.$myConn.Edit("tblpatfindings", "fldcode=&1 and fldencounterval=&2 and fldtype=&3 and fldsave=&4", lsticdisease.Text, Trim(txtencid.Text), "Final Diagnosis", True)
        res["fldsave"] = False
        res["xyz"] = False
        res.Update
        lsticdisease.List = modPathoSub.GetSelectedDiagnosisList("Final Diagnosis", Trim(txtencid.Text))
        Balloon.Delete(("Information deleted"), tlbtndelfinal)
        Balloon.Delay = modBasic.$BalloonDelay
      Endif
    Endif
  Endif

End

Public Sub tbnfinaldisease_Click()

  Dim sName As String[]

  If txtencid.Text Then
    If modBasic.$FinalDiagnosisRule = "Obstetrics" Then
      sName = DiagnoObstetrics(Trim(txtencid.Text), True)
    Else
      sName = GetSyndromes()
    Endif

    If sName Then
      If sName[1] And If sName[0] Then
        modPatientGeneral.AddPatientFindings("Final Diagnosis", Trim(txtencid.Text), sName[0], sName[1], sName[1])
        lsticdisease.List = modPathoSub.GetSelectedDiagnosisList("Final Diagnosis", Trim(txtencid.Text))
      Endif
    Endif
  Endif

End

Public Sub btnfinalsyndro_Click()

  Dim sName As String[]
  Dim xGroup As String

  If txtencid.Text Then
    If MMain.$Ayurveda = "Yes" Then
      sName = AyurvedicDiagnosis(modAMISRep.$AyurvedicDiagnosis)
    Else
      If modBasic.$ClinICDPunchFormat = "GridView" Then
        sName = ICDGridView("Select Diseases")
      Else
        xGroup = modPathoSub.GetDiagnoGroupForService(txtbedno.Text)
        If xGroup Then
          sName = ICDTree(modDatabase.$icdConn, "Disease", modBasic.$ClinDiagnoChapterGrouped, xGroup, modBasic.$FixDiagnoGroupER, modBasic.$ClinDiagnoSelectGrouped, modBasic.$ClinDiagnoSelectERGroup)
        Else
          sName = ICDTree(modDatabase.$icdConn, "Disease", modBasic.$ClinDiagnoChapterGrouped, modBasic.$FixDiagnoGroupOPD, modBasic.$FixDiagnoGroupER, modBasic.$ClinDiagnoSelectGrouped, modBasic.$ClinDiagnoSelectERGroup)
        Endif
      Endif
    Endif
    If sName Then
      If sName[1] And If sName[0] Then
        modPatientGeneral.AddPatientFindings("Final Diagnosis", Trim(txtencid.Text), sName[0], sName[1], sName[2])
        lsticdisease.List = modPathoSub.GetSelectedDiagnosisList("Final Diagnosis", Trim(txtencid.Text))
      Endif
    Endif
  Endif

End

Public Sub btnfinalcustom_Click()

  Dim xx As String

  If txtencid.Text Then
    xx = InputBox(("Enter custom Final Diagnosis"), ("Final Diagnosis"), "")
    If xx Then
      modPatientGeneral.AddPatientFindings("Final Diagnosis", Trim(txtencid.Text), xx, "Other", "Other")
      lsticdisease.List = modPathoSub.GetSelectedDiagnosisList("Final Diagnosis", Trim(txtencid.Text))
    Endif
  Endif

End

''--------------- Image buttons ----
Public Sub mnuscanfile_Click()

  Dim hForm As FmScanForm

  If txtencid.Text Then
    hForm = New FmScanForm(Trim(txtencid.Text), "Scanned Images", "")
    hForm.ShowModal
  Endif

End

Public Sub mnupatimage_Click()

  Dim hForm As FmPatImage

  If txtencid.Text Then
    hForm = New FmPatImage("IMAGE", Trim(txtencid.Text), "")
    hForm.ShowModal
  Endif

End

Public Sub mnudicom_Click()

  Dim hForm As FmPatImage

  If txtencid.Text Then
    hForm = New FmPatImage("DICOM", Trim(txtencid.Text), "")
    hForm.ShowModal
  Endif

End

Public Sub mnuscreendraw_Click()

  Dim sPath As String
  Dim xxx As String[]
  Dim xval As String

  If txtencid.Text Then
    xxx = CustomDraw()
    If xxx Then
      sPath = xxx[0]
      If sPath Then
        xval = modImage.SaveClinicScreenDraw(Trim(txtencid.Text), xxx[1], sPath)
      Endif
    Endif
  Endif

End

Public Sub mnupatvideos_Click()

  Dim hForm8 As FmPatVideo

  If txtencid.Text Then
    hForm8 = New FmPatVideo("VIDEO", Trim(txtencid.Text), "")
    hForm8.ShowModal
  Endif

End
