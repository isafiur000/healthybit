' Gambas class file

Private $encid As String
Private $status As String
Private $Dept As String
Public $DiscPackage As String

Private $LedgerAC As String
Private $xBillType As String
Private $sBillMode As String

Private $rData As Result
Private $aMyFields As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]

Public Sub _new(encid As String, sStatus As String, DiscPackage As String)

  $encid = encid
  $status = sStatus
  $DiscPackage = DiscPackage

End

Public Sub Form_Open()

  Select $status
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $Dept = "IPD"
    Case Else
      $Dept = "OPD"
  End Select
  ShowBillingParam($DiscPackage)
  ShowUsedGridViewList()
  rbroute.Value = True
  rbroute_Click()

End

Public Sub SetOwnDepartment(sIndex As String)

  $Dept = sIndex
  ShowUsedGridViewList()

End

Public Sub UpdateBillingParam()

  ShowBillingParam($DiscPackage)

End

Public Sub RearrangeGrid()

  ResizeGrid()

End

Private Sub ShowBillingParam(sDisctype As String)

  Dim resx As Result

  resx = modDatabase.$myConn.Exec("select fldmode,fldbillingmode,fldacledger,fldbilltype,fldreference,fldlimit,fldlockstate from tbldiscount where fldtype=&1", sDisctype)
  If resx.Available Then
    ''billingmode
    If resx["fldbillingmode"] Then
      $sBillMode = resx["fldbillingmode"]
    Else
      $sBillMode = modPatient.GetPatBillingMode($encid)
    Endif
    ''ledger A/C
    $LedgerAC = resx["fldacledger"]
    ''BillType
    $xBillType = resx["fldbilltype"]
    If Not $xBillType Then
      $xBillType = "Cash"
    Endif
  Endif

End

Public Sub rbroute_Click()

  chkall.Value = False
  chkall.Enabled = False
  cmbgroup.List = modMedicine.ComboRoute()

End

Public Sub rbcash_Click()

  chkall.Enabled = True
  cmbgroup.List = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldmedgroup) as col from tblproductgroup"))

End

Public Sub cmbgroup_Click()

  If cmbgroup.Text Then
    If rbroute.Value = True Then
      ShowCurrStockGrid(cmbgroup.Text, "%")
    Else If rbcash.Value = True Then
      ShowProtocolStockGrid(cmbgroup.Text, "%")
    Endif
    txtsearch.SetFocus
  Endif

End

Public Sub txtsearch_Change()

  Dim xText As String

  If chkleftmain.Value = True Then
    xText = "%" & LCase(txtsearch.Text) & "%"
  Else
    xText = LCase(txtsearch.Text) & "%"
  Endif

  If cmbgroup.Text Then
    If rbroute.Value = True Then
      ShowCurrStockGrid(cmbgroup.Text, xText)
    Else If rbcash.Value = True Then
      ShowProtocolStockGrid(cmbgroup.Text, xText)
    Endif
  Endif

End

Private Sub ShowCurrStockGrid(sRoute As String, sSearch As String)

  Dim xType As String
  Dim xList As String[]

  xType = modNonMedical.GetBillItemCategoryFromCombo(sRoute)
  Select xType
    Case "Medicines"
      $rData = modDatabase.$syConn.Exec("select t1.fldbrandid,t1.fldbrandid,t1.fldbrandid,t2.fldroute from tblmedbrand as t1 inner join tbldrug as t2 on t1.flddrug=t2.flddrug where t1.fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and t2.fldroute=&3 and lower(t1.fldbrandid) like &4 ORDER BY t1.fldbrandid ASC", 0, modBasic.$compID, sRoute, sSearch)                                ''
    Case "Surgicals"
      $rData = modDatabase.$syConn.Exec("select t1.fldbrandid,t1.fldbrandid,t1.fldbrandid,t2.fldsurgcateg from tblsurgbrand as t1 inner join tblsurgicals as t2 on t1.fldsurgid=t2.fldsurgid where t1.fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and t2.fldsurgcateg=&3 and lower(t1.fldbrandid) like &4 ORDER BY t1.fldbrandid ASC", 0, modBasic.$compID, sRoute, sSearch)
    Case "Extra Items"
      xList = ["fldbrandid", "fldbrandid", "fldbrandid"]
      xList.Add(Quote("extra"))
      $rData = modDatabase.$syConn.Exec("select " & xList.Join(",") & " from tblextrabrand where fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and lower(fldbrandid) like &3 ORDER BY fldbrandid ASC", 0, modBasic.$compID, sSearch)
  End Select
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView3, $rData, $aMyFields)

  With GridView3
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = GridView3.Width
    .Columns[2].Width = 50 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "Stock"
  End With

End

Private Sub ShowProtocolStockGrid(sPack As String, sSearch As String)

  $rData = modDatabase.$myConn.Exec("select fldid,flditem,fldqty,fldroute from tblproductgroup where fldmedgroup=&1 and flditem like &2", sPack, sSearch)
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView3, $rData, $aMyFields)
  With GridView3
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = 300 * modBasic.$AppWidthRatio
    .Columns[2].Width = 50 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "QTY"
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView3, Row)
  If Column = 0 Then
    GridView3.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 1 Then
    GridView3.Data.Text = $rData[$aMyFields[Column]]
    GridView3.Rows[Row].Height = Max(GridView3.Rows[Row].Height, GridView3.Data.Font.RichTextHeight(GridView3.Data.Text, GridView3.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView3.Rows.Height - GridView3.Font.Height))
    GridView3.Data.WordWrap = True
  Else If Column = 2 Then
    If rbroute.Value = True Then
      GridView3.Data.Text = modStock.TotalQTYbyBrand($rData[$aMyFields[Column]], modBasic.$compID)
    Else
      GridView3.Data.Text = $rData[$aMyFields[Column]]
    Endif
  Else
    GridView3.Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub GridView3_Click()

  If GridView3.Column = 0 Then
    modGridView.CheckUncheckGridNoDB(GridView3, 0)
  Endif

End

Public Sub chkall_Click()

  Dim Row As Integer

  For Row = 0 To GridView3.Rows.Count - 1
    If GridView3[Row, 0].Picture = Picture["icons/unchecked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/checked.png"]
    Else If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub btnselect_Click()

  Dim Row As Integer
  Dim sType As String
  Dim xqty As Float

  If GridView3.Rows.Count Then
    For Row = 0 To GridView3.Rows.Count - 1
      If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then
        sType = modNonMedical.GetBillItemCategoryFromCombo(GridView3[Row, 3].Text)
        xqty = 0
        If rbroute.Value = True Then
          xqty = 1
        Else If rbcash.Value = True Then
          xqty = GridView3[Row, 2].Text
        Endif
        If xqty Then
          EntryUseOwndata(sType, GridView3[Row, 1].Text, xqty)
        Endif
        GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
      Endif
    Next

    ShowUsedGridViewList()
  Endif

End

Private Sub EntryUseOwndata(sType As String, sItem As String, sQty As Float)

  Dim xroute As String
  Dim xtax As Float
  Dim xdisc As Float
  Dim xdose As Float
  Dim xfixrate As Float
  Dim xfixname As String

  Dim itemmode As String
  Dim CPharmFix As CFixRatePharmacy

  CPharmFix = New CFixRatePharmacy(sType, sItem, $sBillMode)
  xfixrate = CPharmFix.GetFixRate()
  xfixname = CPharmFix.GetFixItem()

  itemmode = $sBillMode
  xtax = modNonMedical.ShowTaxValues(sType, sItem)
  xdisc = modNonMedical.DiscPercentForCategoryValue($encid, $DiscPackage, sType, sItem, itemmode)
  xroute = modMedicine.GetRouteFromItem(sItem, sType)

  If sType = "Medicines" Then
    xdose = sQty * modPharmLabel.GetPackVolValue(sItem) * modMedConstant.GetDrugInitialStrength(sItem)
    If $Dept = "OPD" Then
      modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, $DiscPackage, $LedgerAC, xroute, sItem, xdose, "stat", 1, sQty, $status, "", "", 0, xtax, xdisc, xfixname, xfixrate, "UseOwn", $Dept, "", False)
    Else
      modPharmSub.InsertDosingEntry($encid, $xBillType, $sBillMode, $DiscPackage, $LedgerAC, xroute, sItem, xdose, "SOS", 1, sQty, $status, "", "", 0, xtax, xdisc, xfixname, xfixrate, "UseOwn", $Dept, "", False)
    Endif
  Else
    modPharmSub.InsertNonMedDosingEntry(sType, $encid, $xBillType, $sBillMode, $DiscPackage, $LedgerAC, xroute, sItem, sQty, $status, 0, xtax, xdisc, xfixname, xfixrate, "UseOwn", $Dept, "", False)
  Endif

End

Private Sub ShowUsedGridViewList()

  Dim sql As String

  Select $Dept
    Case "OPD", "IPD"
      sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and fldcurval=&5"
    Case Else
      sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldid,fldstarttime from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and fldcurval=&5 and flddispmode=&6"
  End Select
  $rData1 = modDatabase.$myConn.Exec(sql, $encid, False, $status, "UseOwn", "Continue", $Dept)
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView4, $rData1, $aMyFields1)
  ResizeGrid()

End

Private Sub ResizeGrid()

  With GridView4
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 1
    .Columns[3].Width = GridView4.Width - 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 1
    .Columns[5].Width = 1
    .Columns[6].Width = 1
    .Columns[7].Width = 35 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 35 * modBasic.$AppWidthRatio
    .Columns[10].Width = 1
    .Columns[11].Width = 1

    .Columns[3].Text = "Particulars"
    .Columns[7].Text = "QTY"
  End With

End

Public Sub GridView4_Data(Row As Integer, Column As Integer)

  $rData1.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView4, Row)
  If Column = 9 Then
    GridView4.Data.Picture = Picture["icon:/tiny/cancel"]
    GridView4.Data.Text = ""
  Else If Column = 3 Then
    GridView4.Data.Text = $rData1[$aMyFields1[Column]]
    GridView4.Rows[Row].Height = Max(GridView4.Rows[Row].Height, GridView4.Data.Font.RichTextHeight(GridView4.Data.Text, GridView4.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView4.Rows.Height - GridView4.Font.Height))
    GridView4.Data.WordWrap = True
  Else
    GridView4.Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub GridView4_Click()

  Dim xval As Float
  Dim Row As Integer
  Dim res As Result

  If GridView4.Column = 7 Then
    Row = GridView4.Row
    xval = InputValue(GridView4[GridView4.Row, 3].Text, ("Change Value"), GridView4[GridView4.Row, 7].Text)
    modPharmSub.UpdateQTYBefDispensing(GridView4[GridView4.Row, 0].Text, xval)
    ShowUsedGridViewList()
    GridView4.Row = Row

  Else If GridView4.Column = 9 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView4[GridView4.Row, 0].Text, False)
      If modGeneral.AllowClinicalEdit(res["flduserid_order"]) = True Then
        modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView4[GridView4.Row, 0].Text, False)
      Else
        res["fldcurval"] = "Cancelled"
        res["flduserid_order"] = modBasic.$lbluser
        res["xyz"] = False
        res.Update
      Endif
      ShowUsedGridViewList()
    Endif

  Endif

End

Public Sub btnsave_Click()

  Dim Row As Integer

  If GridView4.Rows.Count Then
    If chksaveall.Value = True Then
      For Row = 0 To GridView4.Rows.Count - 1
        SaveOwnDispensing(GridView4[Row, 0].Text, "Completed")
      Next
    Else
      If GridView4.Rows.Selection.Count Then
        SaveOwnDispensing(GridView4[GridView4.Row, 0].Text, "Completed")
      Endif
    Endif

    ShowUsedGridViewList()
  Endif

End

Private Sub SaveOwnDispensing(sID As Long, sStatus As String)

  Dim sql1 As String
  Dim res1 As Result
  Dim res2 As Result
  Dim sql2 As String

  Dim tax As Float
  Dim disc As Float
  Dim xrate As Float
  Dim xitem As String

  Dim qtynew As Float
  Dim xcateg As String
  ' Dim xdose As Float
  ' Dim xunit As String
  Dim xerr As String

  Dim xrefer As String
  Dim xpayble As String
  Dim xallow As Boolean
  Dim xCshCrd As Float

  xrefer = modBillings.GetReferralUserSetting("Pharmacy", $encid)
  xpayble = modBillings.GetPayableUserSetting("Pharmacy", $encid)

  xerr = ""
  sql1 = "select fldid,fldtime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,fldlabel,flditemtype,fldfixname,fldfixrate,fldtaxper,flddiscper,fldbillingmode,flddisctype,fldacledger,fldbilltype,fldcashincredit from tblpatdosing where fldid=&1"                                                   ''
  res1 = modDatabase.$myConn.Exec(sql1, sID)
  If res1.Available = True Then

    'get tax and discount percentages
    xcateg = res1["flditemtype"]
    If res1["fldtaxper"] Then
      tax = res1["fldtaxper"]
    Else
      tax = 0
    Endif
    If res1["flddiscper"] Then
      disc = res1["flddiscper"]
    Else
      disc = 0
    Endif
    If res1["fldcashincredit"] Then
      xCshCrd = res1["fldcashincredit"]
    Else
      xCshCrd = 0
    Endif

    If res1["fldfixrate"] Then
      xrate = res1["fldfixrate"]
    Else
      xrate = modStock.GetCurrentSellingPrice(res1["flditem"], modBasic.$compID)
    Endif
    xallow = modNonMedical.AllowPharmProceedPreBill($encid, $DiscPackage, res1["fldqtydisp"], xrate, res1["flddiscper"], res1["fldbilltype"], xCshCrd, res1["fldroute"], res1["flditem"])
    If xallow = True Then

      Inc Application.Busy

      qtynew = res1["fldqtydisp"]
      modDatabase.$myConn.Begin
      While qtynew > 0
        'get stockno, rate and quantity based on expiry check
        sql2 = "select fldstockno,fldqty from tblentry where fldstockid=&1 and fldcomp=&2 and fldstatus=&3 and fldqty>&4"
        res2 = modDatabase.$myConn.Exec(sql2, res1["flditem"], modBasic.$compID, 1, 0)
        If res2.Available Then
          res2.MoveFirst

          xitem = res1["flditem"]
          If res1["fldfixname"] Then
            xitem = res1["fldfixname"]
            If res1["fldfixrate"] Then
              xrate = res1["fldfixrate"]
            Else
              xrate = 0
            Endif
          Else
            xrate = modStock.GetSellingPriceByStockNo(res2["fldstockno"], $sBillMode)
          Endif

          If qtynew <= res2["fldqty"] Then
            If modBasic.$AutoBillUseOwn = "Enable" Then
              modBillings.InsertBlankBillItemNewApp($encid, res1["fldbilltype"], res1["fldbillingmode"], res1["flddisctype"], res1["fldacledger"], res1["flditemtype"], res2["fldstockno"], xitem, xrate, qtynew, tax, disc, xCshCrd, "Done", res1["fldid"], True, False, "", xpayble, xrefer)
            Endif
            modStockSub.AddToExistEntry(res2["fldstockno"], (0 - qtynew), modBasic.$compID)
            qtynew = 0
          Else If qtynew > res2["fldqty"] Then
            If modBasic.$AutoBillUseOwn = "Enable" Then
              modBillings.InsertBlankBillItemNewApp($encid, res1["fldbilltype"], res1["fldbillingmode"], res1["flddisctype"], res1["fldacledger"], res1["flditemtype"], res2["fldstockno"], xitem, xrate, res2["fldqty"], tax, disc, xCshCrd, "Done", res1["fldid"], True, False, "", xpayble, xrefer)
            Endif
            modStockSub.AddToExistEntry(res2["fldstockno"], (0 - res2["fldqty"]), modBasic.$compID)
            qtynew = qtynew - res2["fldqty"]
          Endif
          Wait
        Else
          Break
        Endif
      Wend

      If res1["fldqtydisp"] > qtynew Then
        If qtynew > 0 Then
          modPharmSub.DuplicateRecordWithQTY(res1["fldid"], qtynew)
          modPharmSub.UpdateQTYBefDispensing(res1["fldid"], res1["fldqtydisp"] - qtynew)
        Endif
        If sStatus = "Completed" Then
          modPharmSub.UpdateDispensing(res1["fldid"], True, True)
        Else
          modPharmSub.UpdateDispensing(res1["fldid"], True, False)
        Endif
      Endif
      modDatabase.$myConn.Commit

      ''Why to insert dosing when save from local stock?
      ' If modNonMedical.GetBillItemCategoryFromCombo(res1["fldroute"]) = "Medicines" Then
      '   xdose = Round(res1["flddose"] / modMedConstant.GetDrugInitialStrength(res1["flditem"]), -2)
      '   xunit = modPharmLabel.GetDosageFormForLabel(res1["flditem"], "Inpatient")
      '   modPharmSub.InsertNurDosing(res1["fldid"], $encid, xdose, xunit, "")
      ' Endif
      Dec Application.Busy

    Else
      xerr = xerr & res1["fldfixname"] & gb.NewLine
    Endif
  Endif
  If xerr Then
    Balloon.Warning("<b>Over Set Discount/Credit Limit:</b>" & gb.NewLine & xerr, GridView4)
  Endif

Catch
  modDatabase.$myConn.Rollback
  Dec Application.Busy
  modHelpVariable.CreateErrorReport()

End
