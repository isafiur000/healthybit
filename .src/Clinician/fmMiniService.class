' Gambas class file

Private $xFinClear As Boolean
Private $PatientNum As String
Private $xNHISCode As String
Private $sTatus As String
Private $Dept As String

Private $rData2 As Result
Private $aMyFields2 As String[]
Private $rDataM As Result
Private $aMyFieldsM As String[]
Private $allVar As Variant[]
Private $GridVar As Variant[]
Private $cashPack As String[]

Private $rData As Result
Private $aMyFields As String[]
Private $rData1 As Result
Private $aMyFields1 As String[]

Private $encid As String
Private $discModeService As String
Private $discModeProcedure As String
Private $discModeOthers As String
Private $discModePharmacy As String

Private $ratePlanService As String
Private $ratePlanProcedure As String
Private $ratePlanOthers As String
Private $ratePlanPharm As String

Private $ClaimStateService As String
Private $ClaimStateProcedure As String
Private $ClaimStateOthers As String
Private $ClaimStatePharm As String

Private $phmLedger As String
Private $phmBillType As String

''------- group
Private $billReference As String
Private $billModeTest As String
Private $billModeRadio As String
Private $billModePharmacy As String
Private $billModeProcedure As String
Private $billModeEquipment As String
Private $billModeService As String
Private $billModeOthers As String

Public Sub _new(encid As String, packService As String, packProced As String, packOthers As String, packPharm As String)

  $encid = encid
  $discModeService = packService
  $discModeProcedure = packProced
  $discModeOthers = packOthers
  $discModePharmacy = packPharm

End

Public Sub Form_Open()

  modGeneralMain.ArrangeFormCentre(Me, "False")

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $sTatus = modPatient.CurrentAdmissionStatus($encid)
  $xNHISCode = modPatient.GetPatientExtCOdebyEnc($encid)
  $xFinClear = modNonMedical.GetFinanceClearance($encid)
  GetDefaultBillingmodes()

  Select $sTatus
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $Dept = "IPD"
    Case Else
      $Dept = "OPD"
  End Select

  ''Service
  cmbdiscservice.List = modBasic.$BillDiscountCash
  If cmbdiscservice.List.Count = 0 Then
    cmbdiscservice.Add($discModeService)
  Endif
  cmbdiscservice.Text = $discModeService
  ShowServiceParam(cmbdiscservice.Text)

  ''Procedures
  cmbdiscprocedure.List = modBasic.$BillDiscountCash
  If cmbdiscprocedure.List.Count = 0 Then
    cmbdiscprocedure.Add($discModeProcedure)
  Endif
  cmbdiscprocedure.Text = $discModeProcedure
  ShowProcedureParam(cmbdiscprocedure.Text)

  ''Others
  cmbdiscother.List = modBasic.$BillDiscountCash
  If cmbdiscother.List.Count = 0 Then
    cmbdiscother.Add($discModeOthers)
  Endif
  cmbdiscother.Text = $discModeOthers
  ShowOthersParam(cmbdiscother.Text)

  ''Surgicals
  cmbdiscpharmacy.List = modBasic.$BillDiscountCash
  If cmbdiscpharmacy.List.Count = 0 Then
    cmbdiscpharmacy.Add($discModePharmacy)
  Endif
  cmbdiscpharmacy.Text = $discModePharmacy
  ShowPharmacyParam(cmbdiscpharmacy.Text)

  btnrefer.Tag = modBillings.GetReferralUserSetting("Service", $encid)
  If btnrefer.Tag Then
    btnrefer.Text = modGeneral.GetUserFullName(btnrefer.Tag)
  Endif
  If modBasic.$ReferralLockEntry = "Yes" Then
    btnrefer.Enabled = False
  Endif
  rbcategory.Value = True
  GetFirstList()
  $cashPack = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblcostgroup where fldcomp=&1 or fldcomp=&2", modBasic.$compID, "%"))
  If $cashPack.Count Then
    lstgroup.List = $cashPack.Sort()
  Endif

  FillLabtable()
  CompleteGrid()
  ShowGroupGrid()
  FillDosingGrid()
  If $xFinClear = True Then
    btnaddone.Enabled = False
    btnaddgrp.Enabled = False
  Endif

End

Public Sub TabPanel1_Click()

  If TabPanel1.Index = 0 Then
    FillLabtable()
  Else If TabPanel1.Index = 1 Then
    CompleteGrid()
  Else If TabPanel1.Index = 2 Then
    rbroute.Value = True
    rbroute_Click()
    ShowUsedGridViewList()
  Else If TabPanel1.Index = 3 Then
    ShowGroupGrid()
    FillDosingGrid()
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Endif

End

Public Sub btnrefer_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Consultant"), modBasic.$OPConsulUserList)
  If xMedUser And If xMedUser.Count Then
    btnrefer.Tag = xMedUser[0]
    btnrefer.Text = xMedUser[1]
  Else
    btnrefer.Tag = ""
    btnrefer.Text = ""
  Endif

End

Public Sub btnrefer_Change()

  If btnrefer.Text = "" Then
    btnrefer.Tag = ""
  Endif

End

Public Sub btnsms_Click()

  If btnrefer.Tag Then
    modDevice.SendMessageToRegistPhysician($encid, btnrefer.Tag)
  Endif

End

Public Sub cmbdiscservice_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscservice)
  modFillContainer.RestrictComboToContent(cmbdiscservice)

End

Public Sub cmbdiscprocedure_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscprocedure)
  modFillContainer.RestrictComboToContent(cmbdiscprocedure)

End

Public Sub cmbdiscother_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscother)
  modFillContainer.RestrictComboToContent(cmbdiscother)

End

''----------------- service -----------
Private Sub ShowServiceParam(sPack As String)

  Dim hForm As CPackageParams

  hForm = New CPackageParams($encid, sPack)
  $ratePlanService = hForm.GetBillingMode()
  $ClaimStateService = hForm.GetClaimState()

End

Public Sub cmbdiscservice_Click()

  If cmbdiscservice.Text Then
    ShowServiceParam(cmbdiscservice.Text)
    GetFirstList()
  Endif

End

''-------------------- procedure ---------------------
Private Sub ShowProcedureParam(sPack As String)

  Dim hForm As CPackageParams

  hForm = New CPackageParams($encid, sPack)
  $ratePlanProcedure = hForm.GetBillingMode()
  $ClaimStateProcedure = hForm.GetClaimState()

End

Public Sub cmbdiscprocedure_Click()

  If cmbdiscprocedure.Text Then
    ShowProcedureParam(cmbdiscprocedure.Text)
    GetFirstList()
  Endif

End

''--------------------- Other ---------------------------
Private Sub ShowOthersParam(sPack As String)

  Dim hForm As CPackageParams

  hForm = New CPackageParams($encid, sPack)
  $ratePlanOthers = hForm.GetBillingMode()
  $ClaimStateOthers = hForm.GetClaimState()

End

Public Sub cmbdiscother_Click()

  If cmbdiscother.Text Then
    ShowOthersParam(cmbdiscother.Text)
    GetFirstList()
  Endif

End

''------------------- pharmacy -------------
Private Sub ShowPharmacyParam(sPack As String)

  Dim hForm As CPackageParams

  hForm = New CPackageParams($encid, sPack)
  $ratePlanPharm = hForm.GetBillingMode()
  $ClaimStatePharm = hForm.GetClaimState()
  $phmLedger = hForm.GetLedgerAC()
  $phmBillType = hForm.GetBillType()

End

Public Sub cmbdiscpharmacy_Click()

  If cmbdiscpharmacy.Text Then
    ShowPharmacyParam(cmbdiscpharmacy.Text)
  Endif

End

''--------------- grouping ---------------------
Private Sub GetDefaultBillingmodes()

  Dim xpackage As String

  $billReference = modNonMedical.GetFixedReference($encid)
  Select $sTatus
    Case "Admitted", "Discharged", "LAMA", "Death", "Refer", "Absconder"
      $billModeTest = modNonMedical.GetAutoIPBillingPack("Test", $encid)
      $billModeRadio = modNonMedical.GetAutoIPBillingPack("Radio", $encid)
      $billModePharmacy = modNonMedical.GetAutoIPBillingPack("Pharmacy", $encid)
      $billModeEquipment = modNonMedical.GetAutoIPBillingPack("Equipment", $encid)
      $billModeProcedure = modNonMedical.GetAutoIPBillingPack("Procedure", $encid)
      $billModeService = modNonMedical.GetAutoIPBillingPack("Service", $encid)
      $billModeOthers = modNonMedical.GetAutoIPBillingPack("Others", $encid)
    Case Else
      xpackage = modNonMedical.DefaultBillingScheme($encid, modBasic.$compID)
      $billModeTest = xpackage
      $billModeRadio = xpackage
      $billModePharmacy = xpackage
      $billModeEquipment = xpackage
      $billModeProcedure = xpackage
      $billModeService = xpackage
      $billModeOthers = xpackage
  End Select

End

Private Sub GetFirstList()

  Dim res1 As Result
  Dim res2 As Result
  Dim res3 As Result

  If rbcategory.Value = True Then
    cmbsection.List = ["General Services", "Procedures", "Other Items"]
  Else If rbsection.Value = True Then
    res1 = modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3", $ratePlanService, "Active", "General Services")
    res2 = modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3", $ratePlanProcedure, "Active", "Procedures")
    res3 = modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3", $ratePlanOthers, "Active", "Other Items")
    cmbsection.List = GetTriColumnList(res1, res2, res3)
  Else If rbgroup.Value = True Then
    res1 = modDatabase.$myConn.Exec("select distinct(fldbillitem) as col from tblservicecost where fldgroup=&1 and fldbillitem IS NOT NULL and fldstatus=&2 and flditemtype=&3", $ratePlanService, "Active", "General Services")
    res2 = modDatabase.$myConn.Exec("select distinct(fldbillitem) as col from tblservicecost where fldgroup=&1 and fldbillitem IS NOT NULL and fldstatus=&2 and flditemtype=&3", $ratePlanProcedure, "Active", "Procedures")
    res3 = modDatabase.$myConn.Exec("select distinct(fldbillitem) as col from tblservicecost where fldgroup=&1 and fldbillitem IS NOT NULL and fldstatus=&2 and flditemtype=&3", $ratePlanOthers, "Active", "Other Items")
    cmbsection.List = GetTriColumnList(res1, res2, res3)
  Else If rbcashpack.Value = True Then
    res1 = modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblservicegroup where flditemname in(select flditemname from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3)", $ratePlanService, "Active", "General Services")
    res2 = modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblservicegroup where flditemname in(select flditemname from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3)", $ratePlanProcedure, "Active", "Procedures")
    res3 = modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblservicegroup where flditemname in(select flditemname from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3)", $ratePlanOthers, "Active", "Other Items")
    cmbsection.List = GetTriColumnList(res1, res2, res3)
  Endif
  If cmbsection.List.Count Then
    cmbsection.Index = 0
  Endif

End

Private Function GetTriColumnList(res1 As Result, res2 As Result, res3 As Result) As String[]

  Dim aList As String[]
  Dim bList As String[]
  Dim cList As String[]

  Dim xList As String[]
  Dim yList As String[]

  xList = New String[]

  aList = modControlSub.GetDirectFillresultNoNull(res1)
  If aList And If aList.Count Then
    xList.Insert(aList)
  Endif

  bList = modControlSub.GetDirectFillresultNoNull(res2)
  If bList And If bList.Count Then
    xList.Insert(bList)
  Endif

  cList = modControlSub.GetDirectFillresultNoNull(res3)
  If cList And If cList.Count Then
    xList.Insert(cList)
  Endif

  yList = modString.GetDistinctStringArray(xList)
  Return yList

End

Public Sub rbcategory_Click()

  GetFirstList()
  chkall.Enabled = False

End

Public Sub rbsection_Click()

  GetFirstList()
  chkall.Enabled = False

End

Public Sub rbgroup_Click()

  GetFirstList()
  chkall.Enabled = False

End

Public Sub rbcashpack_Click()

  GetFirstList()
  chkall.Enabled = True

End

Public Sub cmbsection_Click()

  If cmbsection.Text Then
    LoadItemList()
  Endif

End

Public Sub txtsearch_Change()

  Dim xVar As Variant[]

  xVar = modString.SelectStringVariantToText($allVar, CStr(1), txtsearch.Text, chkleftmain.Value)
  LoadSelectGridView(xVar)

End

Private Sub LoadItemList()

  Dim res As Result
  Dim res1 As Result
  Dim res2 As Result
  Dim res3 As Result

  $allVar = New Variant[]
  If rbcategory.Value = True Then
    If cmbsection.Text = "General Services" Then
      res = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 ORDER BY flditemname", $ratePlanService, "Active", "General Services")
    Else If cmbsection.Text = "Procedures" Then
      res = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures")
    Else If cmbsection.Text = "Other Items" Then
      res = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items")
    Endif
    modTextDB.COnvertResultToCollection(res, $allVar)

  Else If rbsection.Value = True Then
    res1 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldreport=&4 ORDER BY flditemname", $ratePlanService, "Active", "General Services", cmbsection.Text)
    If res1.Available Then
      modTextDB.COnvertResultToCollection(res1, $allVar)
    Endif
    res2 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldreport=&4 ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures", cmbsection.Text)
    If res2.Available Then
      modTextDB.COnvertResultToCollection(res2, $allVar)
    Endif
    res3 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldreport=&4 ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items", cmbsection.Text)
    If res3.Available Then
      modTextDB.COnvertResultToCollection(res3, $allVar)
    Endif

  Else If rbgroup.Value = True Then
    res1 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldbillitem=&4 ORDER BY flditemname", $ratePlanService, "Active", "General Services", cmbsection.Text)
    If res1.Available Then
      modTextDB.COnvertResultToCollection(res1, $allVar)
    Endif
    res2 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldbillitem=&4 ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures", cmbsection.Text)
    If res2.Available Then
      modTextDB.COnvertResultToCollection(res2, $allVar)
    Endif
    res3 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldbillitem=&4 ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items", cmbsection.Text)
    If res3.Available Then
      modTextDB.COnvertResultToCollection(res3, $allVar)
    Endif

  Else If rbcashpack.Value = True Then
    res1 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and flditemname in(select flditemname from tblservicegroup where fldgroup=&4) ORDER BY flditemname", $ratePlanService, "Active", "General Services", cmbsection.Text)
    If res1.Available Then
      modTextDB.COnvertResultToCollection(res1, $allVar)
    Endif
    res2 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and flditemname in(select flditemname from tblservicegroup where fldgroup=&4) ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures", cmbsection.Text)
    If res2.Available Then
      modTextDB.COnvertResultToCollection(res2, $allVar)
    Endif
    res3 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and flditemname in(select flditemname from tblservicegroup where fldgroup=&4) ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items", cmbsection.Text)
    If res3.Available Then
      modTextDB.COnvertResultToCollection(res3, $allVar)
    Endif

  Endif

  LoadSelectGridView($allVar)

End

Private Sub LoadSelectGridView(sVar As Variant[])

  $GridVar = sVar
  GridView3.Clear()
  GridView3.Columns.Count = 4
  GridView3.Rows.Count = $GridVar.Count
  With GridView3
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 35 * modBasic.$AppWidthRatio
    .Columns[1].Expand = True
    .Columns[2].Width = 1
    .Columns[3].Width = 1
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer)

  modGeneralMain.GridViewDecoration(GridView3, Row)
  If Column = 0 Then
    GridView3.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 1 Then
    GridView3.Data.Text = $GridVar[Row][CStr(Column)]
    GridView3.Rows[Row].Height = Max(GridView3.Rows[Row].Height, GridView3.Data.Font.RichTextHeight(GridView3.Data.Text, GridView3.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView3.Rows.Height - GridView3.Font.Height))
  Else
    GridView3.Data.Text = $GridVar[Row][CStr(Column)]
  Endif
  GridView3.Data.WordWrap = True

End

Public Sub GridView3_Select()

  Dim xform As String
  Dim xpackg As String
  Dim xdate As Date

  If GridView3.Rows.Selection.Count Then
    xform = modNonMedical.GetServiceKeyFromCategory($GridVar[GridView3.Row][CStr(2)])
    If xform = "Service" Then
      xpackg = cmbdiscservice.Text
    Else If xform = "Procedure" Then
      xpackg = cmbdiscprocedure.Text
    Else If xform = "Others" Then
      xpackg = cmbdiscother.Text
    Endif
    xdate = modBillings.CheckLastSalesItemDate(GridView3[GridView3.Row, 1].Text, $PatientNum, $xNHISCode, xpackg)
    If xdate Then
      txtlastsaledate.Text = modReportVar.GetDateTimeReport(xdate, gb.MediumDate)
      If DateDiff(xdate, Now(), gb.Month) <= 3 Then
        txtlastsaledate.Foreground = Color.Red
      Else
        txtlastsaledate.Foreground = Color.Default
      Endif
    Else
      txtlastsaledate.Text = ""
      txtlastsaledate.Foreground = Color.Default
    Endif
  Endif

End

Public Sub GridView3_Click()

  If GridView3.Column = 0 Then
    modGridView.CheckUncheckGridNoDB(GridView3, 0)
  Endif

End

Public Sub chkall_Click()

  Dim Row As Integer

  For Row = 0 To GridView3.Rows.Count - 1
    If GridView3[Row, 0].Picture = Picture["icons/unchecked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/checked.png"]
    Else If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub btnaddone_Click()

  Dim xList As String[]
  Dim Row As Integer

  If GridView3.Rows.Selection.Count Then
    If modMisc.AllowDiagnoBilling($encid) = True Then
      For Row = 0 To GridView3.Rows.Count - 1
        If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then

          If chknextvisit.Value = True Then
            InsertClinicService(GridView3[Row, 2].Text, GridView3[Row, 1].Text, 1, "Planned")
          Else
            xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(flditemname) as col from tblpatbilling where fldencounterval=&1 and flditemname in(select flditemname as col from tblservicecost where flditemtype=&2 and (fldtarget=&3 or fldtarget=&4))", $encid, "Procedures", "Major", "Intermediate"))
            If modMisc.GetDuplicationAllow(xList, GridView3[Row, 1].Text, btnaddone) = True Then
              InsertClinicService(GridView3[Row, 2].Text, GridView3[Row, 1].Text, 1, "Punched")
            Endif
          Endif

          GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
        Endif
      Next
      FillLabtable()
    Else
      Message.Warning("Diagnosis not provided", ("OK"))
    Endif
  Endif

End

Private Sub InsertClinicService(sCateg As String, sItem As String, sQty As Float, xState As String)

  Dim xform As String
  Dim xauto As String
  Dim xrefer As String
  Dim xpayble As String
  Dim xpackg As String

  xform = modNonMedical.GetServiceKeyFromCategory(sCateg)
  If xform = "Service" Then
    xauto = modBasic.$AutoBillService
    xpackg = cmbdiscservice.Text
  Else If xform = "Procedure" Then
    xauto = modBasic.$AutoBillProcedure
    xpackg = cmbdiscprocedure.Text
  Else If xform = "Others" Then
    xauto = modBasic.$AutoBillOthers
    xpackg = cmbdiscother.Text
  Endif

  If xauto Then
    If xauto = "Standard" Or If xauto = "Full" Or If xauto = "Partial" Then
      If btnrefer.Tag Then
        xrefer = btnrefer.Tag
      Else
        xrefer = modBillings.GetReferralUserSetting(xform, $encid)
      Endif
      xpayble = modBillings.GetPayableUserSetting(xform, $encid)
      modBillings.GetAutoBillingClinic($encid, xpackg, xform, sItem, sQty, xState, 0, False, False, xpayble, xrefer)
    Endif
  Endif

End

Public Sub FillLabtable()

  Dim sql As String
  Dim Column As Integer
  Dim fld As ResultField
  Dim res As Result

  sql = "select fldid,flditemname,fldid,flditemqty,fldordtime,fldstatus from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and (fldstatus=&5 or fldstatus=&6) and (flditemtype=&7 or flditemtype=&8 or flditemtype=&9)"                                             ''
  res = modDatabase.$myConn.Exec(sql, $encid, False, False, modBasic.$compID, "Punched", "Planned", "General Services", "Procedures", "Other Items")

  GridView1.Clear
  GridView1.Columns.Count = res.Fields.Count
  GridView1.Rows.Count = res.Count

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView1, res.Index, Column)
      If Column = 4 Then
        GridView1[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldordtime"], gb.GeneralDate)
      Else If Column = 2 Then
        GridView1[res.Index, Column].Picture = Picture["icon:/tiny/cancel"]
        GridView1[res.Index, Column].Text = ""
      Else
        GridView1[res.Index, Column].Text = res[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  GridView1.Row = 0

  With GridView1
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 300 * modBasic.$AppWidthRatio
    .Columns[2].Width = 25 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Particulars"
    .Columns[3].Text = "QTY"
    .Columns[4].Text = "DateTime"
    .Columns[5].Text = "Status"
  End With

End

Public Sub GridView1_Click()

  If GridView1.Column = 2 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      modDatabase.$myConn.Delete("tblpatbilling", "fldid=&1 and fldsave=&2", GridView1[GridView1.Row, 0].Text, False)
      FillLabtable()
    Endif
  Endif

End

Public Sub btnsave_Click()

  Dim xform As String
  Dim res As Result
  Dim xauto As String
  Dim xadv As String
  Dim xstate As String

  Inc Application.Busy
  res = modDatabase.$myConn.Edit("tblpatbilling", "fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and (flditemtype=&6 or flditemtype=&7 or flditemtype=&8)", $encid, False, False, modBasic.$compID, "Punched", "General Services", "Procedures", "Other Items")                 ''
  If res.Available Then
    If modBasic.$AutoBillAdvReceipt = "Enable" Then
      xadv = modBillLock.AdvanceReceiptString("Advance Receipt")
    Else
      xadv = ""
    Endif

    For Each res
      xform = modNonMedical.GetServiceKeyFromCategory(res["flditemtype"])
      If xform = "Service" Then
        xauto = modBasic.$AutoBillService
        xstate = $ClaimStateService
      Else If xform = "Procedure" Then
        xauto = modBasic.$AutoBillProcedure
        xstate = $ClaimStateProcedure
      Else If xform = "Others" Then
        xauto = modBasic.$AutoBillOthers
        xstate = $ClaimStateOthers
      Endif

      If xauto = "Standard" Then
        If modNonMedical.AllowPreCheckDeposit($encid, xform, res["flditemname"], res["fldditemamt"], res["fldbilltype"], btnsave) = True Then
          SavePartialEntry(res, xstate, xadv)
        Endif
      Else If xauto = "Full" Then
        If modNonMedical.AllowPreEntryWithDeposit($encid, xform, res["flditemname"], res["fldditemamt"], res["fldbilltype"], btnsave) = True Then
          SavePartialEntry(res, xstate, xadv)
        Endif
      Else
        If modBasic.$AutoBillSaveZero = "Yes" And If res["flditemrate"] = 0 Then
          SavePartialEntry(res, xstate, xadv)
        Else If modBasic.$AutoBillSaveZero = "Yes" And If res["flddiscper"] = 100 Then
          SavePartialEntry(res, xstate, xadv)
        Else If modBasic.$AutoBillSaveFullCredit = "Yes" And If res["fldbilltype"] = "Credit" And If res["fldcashincredit"] = 0 Then
          SavePartialEntry(res, xstate, xadv)
        Endif
      Endif

    Next
  Endif
  Dec Application.Busy
  FillLabtable()
  CompleteGrid()

End

Private Sub SavePartialEntry(res As Result, xstate As String, Optional advReceipt As String)

  Dim xdate As Date
  Dim xcapday As Integer
  Dim xgo As Boolean

  xgo = True
  If xstate = "Consultation" Or If xstate = "Patient Ward" Then
    xdate = modBillings.CheckLastSalesItemDate(res["flditemname"], $PatientNum, $xNHISCode, res["flddisctype"])
    If xdate Then
      xcapday = modNonMedical.GetCappingDayFromItemName(res["flditemname"])
      If xcapday Then
        If DateDiff(xdate, Now(), gb.Day) <= xcapday Then
          xgo = False
        Endif
      Endif
    Endif
  Endif
  If xgo = True Then
    res["fldstatus"] = "Done"
    If advReceipt Then
      res["fldextracol"] = advReceipt
    Endif
    res["fldsave"] = True
    res["flduserid"] = modBasic.$lbluser
    res["fldtime"] = Now()
    res["fldcomp"] = modBasic.$compID
    res["xyz"] = False
    res.Update()
  Endif

End

''================= Completed Tab =========================
Private Sub CompleteGrid()

  Dim sql As String

  sql = "select fldid,fldordtime,flditemname,flditemqty,fldid,flditemtype,flddisctype from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldordcomp like &3 and (flditemtype=&4 or flditemtype=&5 or flditemtype=&6)"
  $rData2 = modDatabase.$myConn.Exec(sql, $encid, True, modBasic.$compID, "General Services", "Procedures", "Other Items")
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)

  With GridView2
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 150 * modBasic.$AppWidthRatio
    .Columns[2].Width = 350 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 1
    .Columns[5].Width = 150 * modBasic.$AppWidthRatio
    .Columns[6].Width = 150 * modBasic.$AppWidthRatio

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Particulars"
    .Columns[3].Text = "QTY"
    .Columns[5].Text = "Category"
    .Columns[6].Text = "Scheme"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData2.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 1 Then
    GridView2.Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else
    GridView2.Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End

''==================== Packages ======================
Public Sub txtgrpsearch_Change()

  If $cashPack.Count Then
    lstgroup.List = modString.SelectStringArrayToText(txtgrpsearch.Text, $cashPack)
  Endif

End

Public Sub btnaddgrp_Click()

  If lstgroup.Text Then
    AddPackageItems(lstgroup.Text)
    AddMedProtocols(lstgroup.Text)
  Endif

End

Private Function GetAutoStatus(xform As String) As String

  Dim xauto As String

  If xform = "Test" Then
    xauto = modBasic.$AutoBillTest
  Else If xform = "Radio" Then
    xauto = modBasic.$AutoBillRadio
  Else If xform = "Equipment" Then
    xauto = modBasic.$AutoBillEquipment
  Else If xform = "Service" Then
    xauto = modBasic.$AutoBillService
  Else If xform = "Procedure" Then
    xauto = modBasic.$AutoBillProcedure
  Else If xform = "Others" Then
    xauto = modBasic.$AutoBillOthers
  Endif

  Return xauto

End

Private Function GetSchemeName(xform As String) As String

  Dim xpackg As String

  If xform = "Test" Then
    xpackg = $billModeTest
  Else If xform = "Radio" Then
    xpackg = $billModeRadio
  Else If xform = "Equipment" Then
    xpackg = $billModeEquipment
  Else If xform = "Service" Then
    xpackg = $billModeService
  Else If xform = "Procedure" Then
    xpackg = $billModeProcedure
  Else If xform = "Others" Then
    xpackg = $billModeOthers
  Endif

  Return xpackg

End

Private Function GetReference(xform As String) As String

  Dim xstate As String
  Dim xscheme As String
  Dim xrefer As String

  xscheme = GetSchemeName(xform)
  If xscheme Then
    xrefer = modNonMedical.GetFixedReferenceScheme(xscheme)
    If xrefer And If xrefer = "Claim Code" Then
      xstate = modClaim.GetHIClaimState(xrefer)
    Endif
  Endif

  Return xstate

End

Private Sub AddMedProtocols(sProtocol As String)

  Dim xtypLst As String[] = ["suture", "msurg", "ortho", "extra"]
  Dim xbilMode As String
  Dim xLedger As String
  Dim xBillType As String

  Dim res As Result
  Dim xtax As Float
  Dim xdisc As Float
  Dim itemtype As String
  Dim xfixrate As Float
  Dim xfixname As String
  ' Dim xvarfix As Variant[]
  Dim itemmode As String
  Dim xcurVal As String
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean
  Dim i As Integer

  For i = 0 To xtypLst.Count - 1
    xtypLst[i] = "'" & xtypLst[i] & "'"
  Next

  If chknextvisit.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  xbilMode = modNonMedical.GetDiscBindBillMode($billModePharmacy)
  xLedger = modNonMedical.GetLedgerFromDiscount($billModePharmacy)
  xBillType = modNonMedical.GetFixedInvType($billModePharmacy)

  res = modDatabase.$myConn.Exec("select flditemname,flditemtype,fldqty from tblcostgroup where fldgroup=&1 and flditemtype in(" & xtypLst.Join(",") & ")", sProtocol)
  If res.Available Then
    For Each res
      itemtype = modNonMedical.GetBillItemCategoryFromCombo(res["flditemtype"])

      xgo = False
      If modBasic.$BillPharmFixedModes.Exist(xbilMode) = True Then
        CPharmFix = New CFixRatePharmacy(itemtype, res["flditemname"], xbilMode)
        xfixrate = CPharmFix.GetFixRate()
        xfixname = CPharmFix.GetFixItem()
        If xfixname Then
          xgo = True
        Else
          xgo = False
        Endif
      Else
        xgo = True
      Endif
      If xgo = True Then
        itemmode = xbilMode
        xtax = modNonMedical.ShowTaxValues(itemtype, res["flditemname"])
        xdisc = modNonMedical.DiscPercentForCategoryValue($encid, $billModePharmacy, itemtype, res["flditemname"], itemmode)
        Select res["flditemtype"]
          Case "suture", "msurg", "ortho"
            modPharmSub.InsertNonMedDosingEntry("Surgicals", $encid, xBillType, xbilMode, $billModePharmacy, xBillType, res["flditemtype"], res["flditemname"], res["fldqty"], $status, 0, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, "", False, xcurVal)
          Case "extra"
            modPharmSub.InsertNonMedDosingEntry("Extra Items", $encid, xBillType, xbilMode, $billModePharmacy, xBillType, res["flditemtype"], res["flditemname"], res["fldqty"], $status, 0, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, "", False, xcurVal)
        End Select
      Endif

    Next
    FillDosingGrid()
  Endif

End

Private Sub AddPackageItems(sGroup As String)

  Dim xList As String[]
  Dim xtypLst As String[] = ["Test", "Radio", "Equipment", "Service", "Procedure", "Others"]
  Dim xform As String
  Dim res As Result
  Dim xauto As String
  Dim xpackg As String
  Dim xbilMode As String
  Dim xrefer As String
  Dim xpayble As String
  Dim j As Integer

  xList = New String[]
  For j = 0 To GridView4.Rows.Count - 1
    xList.Add(GridView4[j, 1].Text)
  Next

  For Each xform In xtypLst
    xauto = GetAutoStatus(xform)
    xpackg = GetSchemeName(xform)
    If btnrefer.Tag Then
      xrefer = btnrefer.Tag
    Else
      xrefer = modBillings.GetReferralUserSetting(xform, $encid)
    Endif
    xpayble = modBillings.GetPayableUserSetting(xform, $encid)
    If xpackg And If xauto Then
      xbilMode = modNonMedical.GetDiscBindBillMode(xpackg)
      res = modDatabase.$myConn.Exec("select flditemname,flditemtype from tblcostgroup where fldgroup=&1 and flditemtype=&2 and flditemname in(select flditemname from tblservicecost where fldgroup=&2 or fldgroup=&3)", sGroup, xform, xbilMode, "%")
      If res.Available Then

        For Each res
          If xauto = "Standard" Or If xauto = "Full" Or If xauto = "Partial" Then
            If chknextvisitgrp.Value = True Then
              modBillings.GetAutoBillingClinic($encid, xpackg, xform, res["flditemname"], 1, "Planned", 0, False, False, xpayble, xrefer)
            Else
              If modMisc.GetDuplicationAllow(xList, res["flditemname"], btnaddgrp) = True Then
                modBillings.GetAutoBillingClinic($encid, xpackg, xform, res["flditemname"], 1, "Punched", 0, False, False, xpayble, xrefer)
              Endif
            Endif
          Endif
        Next

      Endif
    Endif
  Next
  ShowGroupGrid()

End

Private Sub ShowGroupGrid()

  Dim xtypLst As String[]
  Dim sql As String
  Dim res As Result
  Dim i As Integer

  xtypLst = modNonMedical.BillServiceCategory()
  For i = 0 To xtypLst.Count - 1
    xtypLst[i] = "'" & xtypLst[i] & "'"
  Next
  sql = "select fldid,flditemname,fldid,flditemqty,fldordtime,fldstatus from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and (fldstatus=&5 or fldstatus=&6) and flditemtype in(" & xtypLst.Join(",") & ")"     ''
  res = modDatabase.$myConn.Exec(sql, $encid, False, False, modBasic.$compID, "Punched", "Planned")
  ShowInitialGridView(res)

End

Private Sub ShowInitialGridView(res As Result)

  Dim Column As Integer
  Dim fld As ResultField

  GridView4.Clear
  GridView4.Columns.Count = res.Fields.Count
  GridView4.Rows.Count = res.Count

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView4, res.Index, Column)
      If Column = 4 Then
        GridView4[res.Index, Column].Text = modReportVar.GetDateTimeReport(res[fld.Name], gb.GeneralDate)
      Else If Column = 2 Then
        GridView4[res.Index, Column].Picture = Picture["icon:/tiny/cancel"]
        GridView4[res.Index, Column].Text = ""
      Else
        GridView4[res.Index, Column].Text = res[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  GridView4.Row = 0

  With GridView4
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 400 * modBasic.$AppWidthRatio
    .Columns[2].Width = 25 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio
    .Columns[5].Width = 100 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Particulars"
    .Columns[3].Text = "QTY"
    .Columns[4].Text = "DateTime"
    .Columns[5].Text = "Status"
  End With

End

Public Sub GridView4_Click()

  If GridView4.Column = 2 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      modDatabase.$myConn.Delete("tblpatbilling", "fldid=&1 and fldsave=&2", GridView4[GridView4.Row, 0].Text, False)
      ShowGroupGrid()
    Endif
  Endif

End

Private Sub FillDosingGrid()

  Dim sql As String

  sql = "select fldid,fldroute,flditem,fldqtydisp,fldstarttime,fldid,fldcurval from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and (fldcurval=&5 or fldcurval=&6 or fldcurval=&7)"                                                   ''
  $rDataM = modDatabase.$myConn.Exec(sql, $encid, False, $sTatus, "Request", "Continue", "Reserve", "Planned")
  $aMyFieldsM = New String[]
  modGridView.ReadSmallData(GridView5, $rDataM, $aMyFieldsM)

  With GridView5
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 400 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio
    .Columns[5].Width = 25 * modBasic.$AppWidthRatio
    .Columns[6].Width = 75 * modBasic.$AppWidthRatio

    .Columns[2].Text = "Particulars"
    .Columns[3].Text = "QTY"
    .Columns[4].Text = "Date"
    .Columns[6].Text = "Status"
  End With

End

Public Sub GridView5_Data(Row As Integer, Column As Integer)

  $rDataM.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView5, Row)
  If Column = 4 Then
    GridView5.Data.Text = modReportVar.GetDateTimeReport($rDataM[$aMyFieldsM[Column]], gb.GeneralDate)
  Else If Column = 5 Then
    GridView5.Data.Picture = Picture["icon:/tiny/cancel"]
    GridView5.Data.Text = ""
  Else
    GridView5.Data.Text = $rDataM[$aMyFieldsM[Column]]
  Endif
  GridView5.Rows[Row].Height = Max(GridView5.Rows[Row].Height, GridView5.Data.Font.RichTextHeight(GridView5.Data.Text, GridView5.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView5.Rows.Height - GridView5.Font.Height))
  GridView5.Data.WordWrap = True

End

Public Sub GridView5_Click()

  Dim xval As Float
  Dim Column As Integer
  Dim Row As Integer
  Dim res As Result

  Row = GridView5.Row
  Column = GridView5.Column
  If GridView5.Column = 3 Then
    xval = InputValue(GridView5[GridView5.Row, 2].Text, ("Alter Quantity"), GridView5[GridView5.Row, 3].Text)
    If xval Then
      modPharmSub.UpdateQTYBefDispensing(GridView5[GridView5.Row, 0].Text, xval)
      FillDosingGrid()
    Endif

  Else If GridView5.Column = 5 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView5[GridView5.Row, 0].Text, False)
      If modGeneral.AllowClinicalEdit(res["flduserid_order"]) = True Then
        modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView5[GridView5.Row, 0].Text, False)
      Else
        res["fldcurval"] = "Cancelled"
        res["flduserid_order"] = modBasic.$lbluser
        res["xyz"] = False
        res.Update
      Endif
      FillDosingGrid()
    Endif

  Endif
  GridView5.Row = Row
  GridView5.Column = Column

End

''=========== save ==============
Public Sub btnsavegroup_Click()

  Dim xtypLst As String[]
  Dim xform As String
  Dim res As Result
  Dim xauto As String
  Dim xadv As String
  Dim xstate As String
  Dim i As Integer

  xtypLst = modNonMedical.BillServiceCategory()
  For i = 0 To xtypLst.Count - 1
    xtypLst[i] = "'" & xtypLst[i] & "'"
  Next

  Inc Application.Busy
  res = modDatabase.$myConn.Edit("tblpatbilling", "fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and flditemtype in(" & xtypLst.Join(",") & ")", $encid, False, False, modBasic.$compID, "Punched")                 ''
  If res.Available Then
    If modBasic.$AutoBillAdvReceipt = "Enable" Then
      xadv = modBillLock.AdvanceReceiptString("Advance Receipt")
    Else
      xadv = ""
    Endif

    For Each res
      xform = modNonMedical.GetServiceKeyFromCategory(res["flditemtype"])
      xauto = GetAutoStatus(xform)
      xstate = GetReference(xform)

      If xauto = "Standard" Then
        If modNonMedical.AllowPreCheckDeposit($encid, xform, res["flditemname"], res["fldditemamt"], res["fldbilltype"], btnsave) = True Then
          SavePartialEntry(res, xstate, xadv)
        Endif
      Else If xauto = "Full" Then
        If modNonMedical.AllowPreEntryWithDeposit($encid, xform, res["flditemname"], res["fldditemamt"], res["fldbilltype"], btnsave) = True Then
          SavePartialEntry(res, xstate, xadv)
        Endif
      Else
        If modBasic.$AutoBillSaveZero = "Yes" And If res["flditemrate"] = 0 Then
          SavePartialEntry(res, xstate, xadv)
        Else If modBasic.$AutoBillSaveZero = "Yes" And If res["flddiscper"] = 100 Then
          SavePartialEntry(res, xstate, xadv)
        Else If modBasic.$AutoBillSaveFullCredit = "Yes" And If res["fldbilltype"] = "Credit" And If res["fldcashincredit"] = 0 Then
          SavePartialEntry(res, xstate, xadv)
        Endif
      Endif

    Next
  Endif
  Dec Application.Busy
  ShowGroupGrid()

End

''================================ Pharmacy ==============================
Private Sub LoadCategories()

  If rbroute.Value = True Then
    chkall2.Value = False
    chkall2.Enabled = False
    cmbgroup.List = modMedicine.RouteNonMedicine()
    btnselect.Text = "+1"

  Else If rbprot.Value = True Then
    chkall2.Enabled = True
    cmbgroup.List = modMedicine.GetNonMedicineProcolsList()
    btnselect.Text = ""

  Endif
  ShowUsedGridViewList()

End

Public Sub rbroute_Click()

  LoadCategories()

End

Public Sub rbprot_Click()

  LoadCategories()

End

Public Sub cmbgroup_Click()

  If cmbgroup.Text Then
    If rbroute.Value = True Then
      ShowCurrStockGrid(cmbgroup.Text, "%")
    Else If rbprot.Value = True Then
      ShowProtocolStockGrid(cmbgroup.Text, "%")
    Endif
    txtsearch2.SetFocus
  Endif

End

Public Sub txtsearch2_Change()

  Dim xText As String

  If chkleftmain2.Value = True Then
    xText = "%" & LCase(txtsearch2.Text) & "%"
  Else
    xText = LCase(txtsearch2.Text) & "%"
  Endif

  If cmbgroup.Text Then
    If rbroute.Value = True Then
      ShowCurrStockGrid(cmbgroup.Text, xText)
    Else If rbprot.Value = True Then
      ShowProtocolStockGrid(cmbgroup.Text, xText)
    Endif
  Endif

End

Private Sub ShowCurrStockGrid(sRoute As String, sSearch As String)

  Dim xType As String
  Dim xList As String[]

  xType = modNonMedical.GetBillItemCategoryFromCombo(sRoute)
  Select xType
    Case "Surgicals"
      $rData = modDatabase.$syConn.Exec("select t1.fldbrandid,t1.fldbrandid,t1.fldbrandid,t2.fldsurgcateg from tblsurgbrand as t1 inner join tblsurgicals as t2 on t1.fldsurgid=t2.fldsurgid where t1.fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and t2.fldsurgcateg=&3 and lower(t1.fldbrandid) like &4 ORDER BY t1.fldbrandid ASC", 0, modBasic.$compID, sRoute, sSearch)
    Case "Extra Items"
      xList = ["fldbrandid", "fldbrandid", "fldbrandid"]
      xList.Add(Quote("extra"))
      $rData = modDatabase.$syConn.Exec("select " & xList.Join(",") & " from tblextrabrand where fldbrandid in(select fldstockid from tblentry where fldqty>&1 and fldcomp like &2) and lower(fldbrandid) like &3 ORDER BY fldbrandid ASC", 0, modBasic.$compID, sSearch)
  End Select

  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView6, $rData, $aMyFields)

  With GridView6
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = GridView6.Width
    .Columns[2].Width = 50 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "Stock"
  End With

End

Private Sub ShowProtocolStockGrid(sPack As String, sSearch As String)

  $rData = modDatabase.$myConn.Exec("select fldid,flditem,fldqty,fldroute from tblproductgroup where fldmedgroup=&1 and (fldcomp=&2 or fldcomp=&3) and flditem like &4 and (fldroute=&5 or fldroute=&6 or fldroute=&7 or fldroute=&8)", sPack, modBasic.$compID, "%", sSearch, "suture", "msurg", "ortho", "extra")
  $aMyFields = New String[]
  modGridView.ReadSmallData(GridView6, $rData, $aMyFields)
  With GridView6
    .Columns[0].Width = 25 * modBasic.$AppWidthRatio
    .Columns[1].Width = 300 * modBasic.$AppWidthRatio
    .Columns[2].Width = 50 * modBasic.$AppWidthRatio
    .Columns[3].Width = 1
    .Columns[1].Text = "Particulars"
    .Columns[2].Text = "QTY"
  End With

End

Public Sub GridView6_Data(Row As Integer, Column As Integer)

  $rData.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView6, Row)
  If Column = 0 Then
    GridView6.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 1 Then
    GridView6.Data.Text = $rData[$aMyFields[Column]]
    GridView6.Rows[Row].Height = Max(GridView6.Rows[Row].Height, GridView6.Data.Font.RichTextHeight(GridView6.Data.Text, GridView6.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView6.Rows.Height - GridView6.Font.Height))
    GridView6.Data.WordWrap = True
  Else If Column = 2 Then
    If rbroute.Value = True Then
      GridView6.Data.Text = modStock.TotalQTYbyBrand($rData[$aMyFields[Column]], modBasic.$compID)
    Else
      GridView6.Data.Text = $rData[$aMyFields[Column]]
    Endif
  Else
    GridView6.Data.Text = $rData[$aMyFields[Column]]
  Endif

End

Public Sub GridView6_Click()

  If GridView6.Column = 0 Then
    modGridView.CheckUncheckGridNoDB(GridView6, 0)
  Endif

End

Public Sub chkall2_Click()

  Dim Row As Integer

  For Row = 0 To GridView6.Rows.Count - 1
    If GridView6[Row, 0].Picture = Picture["icons/unchecked.png"] Then
      GridView6[Row, 0].Picture = Picture["icons/checked.png"]
    Else If GridView6[Row, 0].Picture = Picture["icons/checked.png"] Then
      GridView6[Row, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub btnselect_Click()

  Dim Row As Integer
  Dim sType As String
  Dim xqty As Float

  If GridView6.Rows.Count Then
    For Row = 0 To GridView6.Rows.Count - 1
      If GridView6[Row, 0].Picture = Picture["icons/checked.png"] Then
        sType = modNonMedical.GetBillItemCategoryFromCombo(GridView6[Row, 3].Text)
        xqty = 0
        If rbroute.Value = True Then
          xqty = 1
        Else If rbprot.Value = True Then
          xqty = GridView6[Row, 2].Text
        Endif
        If xqty Then
          EntryPharmRequest(sType, GridView6[Row, 1].Text, xqty)
        Endif
        GridView6[Row, 0].Picture = Picture["icons/unchecked.png"]
      Endif
    Next

    ShowUsedGridViewList()
  Endif

End

Private Sub EntryPharmRequest(sType As String, sItem As String, sQty As Float)

  Dim xroute As String
  Dim xtax As Float
  Dim xdisc As Float
  Dim xfixrate As Float
  Dim xfixname As String
  Dim xcurVal As String

  Dim itemmode As String
  Dim CPharmFix As CFixRatePharmacy
  Dim xgo As Boolean

  If chknextvisit2.Value = True Then
    xcurVal = "Planned"
  Else
    If modBasic.$DispRequestStatus = "Reserve" Then
      xcurVal = "Reserve"
    Else
      xcurVal = "Continue"
    Endif
  Endif

  xgo = False
  If modBasic.$BillPharmFixedModes.Exist($ratePlanPharm) = True Then
    CPharmFix = New CFixRatePharmacy(sType, sItem, $ratePlanPharm)
    xfixrate = CPharmFix.GetFixRate()
    xfixname = CPharmFix.GetFixItem()
    If xfixname Then
      xgo = True
    Else
      xgo = False
    Endif
  Else
    xgo = True
  Endif
  If xgo = True Then
    itemmode = $ratePlanPharm
    xtax = modNonMedical.ShowTaxValues(sType, sItem)
    xdisc = modNonMedical.DiscPercentForCategoryValue($encid, cmbdiscpharmacy.Text, sType, sItem, itemmode)
    xroute = modMedicine.GetRouteFromItem(sItem, sType)

    modPharmSub.InsertNonMedDosingEntry(sType, $encid, $phmBillType, $ratePlanPharm, cmbdiscpharmacy.Text, $phmLedger, xroute, sItem, sQty, $status, 0, xtax, xdisc, xfixname, xfixrate, "Request", $Dept, "", False, xcurVal)
  Endif

End

Private Sub ShowUsedGridViewList()

  Dim sql As String

  sql = "select fldid,fldstarttime,fldroute,flditem,flddose,fldfreq,flddays,fldqtydisp,flduserid_order,fldid,fldcurval from tblpatdosing where fldencounterval=&1 and fldsave_order=&2 and fldstatus=&3 and fldorder=&4 and (fldcurval=&5 or fldcurval=&6)"
  $rData1 = modDatabase.$myConn.Exec(sql, $encid, False, $status, "Request", "Continue", "Planned")
  $aMyFields1 = New String[]
  modGridView.ReadSmallData(GridView7, $rData1, $aMyFields1)
  ResizeGrid()

End

Private Sub ResizeGrid()

  With GridView7
    .Columns[0].Width = 1
    .Columns[1].Width = 1
    .Columns[2].Width = 1
    .Columns[3].Width = GridView7.Width - 100 * modBasic.$AppWidthRatio
    .Columns[4].Width = 1
    .Columns[5].Width = 1
    .Columns[6].Width = 1
    .Columns[7].Width = 35 * modBasic.$AppWidthRatio
    .Columns[8].Width = 1
    .Columns[9].Width = 35 * modBasic.$AppWidthRatio
    .Columns[10].Width = 75 * modBasic.$AppWidthRatio

    .Columns[3].Text = "Particulars"
    .Columns[7].Text = "QTY"
    .Columns[10].Text = "Status"
  End With

End

Public Sub GridView7_Data(Row As Integer, Column As Integer)

  $rData1.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView7, Row)
  If Column = 9 Then
    GridView7.Data.Picture = Picture["icon:/tiny/cancel"]
    GridView7.Data.Text = ""
  Else If Column = 3 Then
    GridView7.Data.Text = $rData1[$aMyFields1[Column]]
    GridView7.Rows[Row].Height = Max(GridView7.Rows[Row].Height, GridView7.Data.Font.RichTextHeight(GridView7.Data.Text, GridView7.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView7.Rows.Height - GridView7.Font.Height))
    GridView7.Data.WordWrap = True
  Else
    GridView7.Data.Text = $rData1[$aMyFields1[Column]]
  Endif

End

Public Sub GridView7_Click()

  Dim xval As Float
  Dim Row As Integer
  Dim res As Result

  If GridView7.Column = 7 Then
    Row = GridView7.Row
    xval = InputValue(GridView7[GridView7.Row, 3].Text, ("Change Value"), GridView7[GridView7.Row, 7].Text)
    modPharmSub.UpdateQTYBefDispensing(GridView7[GridView7.Row, 0].Text, xval)
    ShowUsedGridViewList()
    GridView7.Row = Row

  Else If GridView7.Column = 9 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      res = modDatabase.$myConn.Edit("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView7[GridView7.Row, 0].Text, False)
      If modGeneral.AllowClinicalEdit(res["flduserid_order"]) = True Then
        modDatabase.$myConn.Delete("tblpatdosing", "fldid=&1 and fldsave_order=&2", GridView7[GridView7.Row, 0].Text, False)
      Else
        res["fldcurval"] = "Cancelled"
        res["flduserid_order"] = modBasic.$lbluser
        res["xyz"] = False
        res.Update
      Endif
      ShowUsedGridViewList()
    Endif

  Endif

End
