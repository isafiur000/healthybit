' Gambas class file

Private $xFinClear As Boolean
Private $PatientNum As String
Private $xNHISCode As String

Private $rData2 As Result
Private $aMyFields2 As String[]
Private $allVar As Variant[]
Private $GridVar As Variant[]

Private $encid As String
Private $billModeService As String
Private $billModeProcedure As String
Private $billModeOthers As String

Private $ratePlanService As String
Private $ratePlanProcedure As String
Private $ratePlanOthers As String

Public Sub _new(encid As String, packService As String, packProced As String, packOthers As String)

  $encid = encid
  $billModeService = packService
  $billModeProcedure = packProced
  $billModeOthers = packOthers

End

Public Sub Form_Open()

  modGeneralMain.ArrangeFormCentre(Me, "False")

  cmbdiscservice.List = modBasic.$BillDiscountCash
  If cmbdiscservice.List.Count = 0 Then
    cmbdiscservice.Add($billModeService)
  Endif
  cmbdiscservice.Text = $billModeService
  $ratePlanService = modNonMedical.GetDiscBindBillMode(cmbdiscservice.Text)
  If Not $ratePlanService Then
    $ratePlanService = modpatient.GetPatBillingMode($encid)
  Endif

  cmbdiscprocedure.List = modBasic.$BillDiscountCash
  If cmbdiscprocedure.List.Count = 0 Then
    cmbdiscprocedure.Add($billModeProcedure)
  Endif
  cmbdiscprocedure.Text = $billModeProcedure
  $ratePlanProcedure = modNonMedical.GetDiscBindBillMode(cmbdiscprocedure.Text)
  If Not $ratePlanProcedure Then
    $ratePlanProcedure = modpatient.GetPatBillingMode($encid)
  Endif

  cmbdiscother.List = modBasic.$BillDiscountCash
  If cmbdiscother.List.Count = 0 Then
    cmbdiscother.Add($billModeOthers)
  Endif
  cmbdiscother.Text = $billModeOthers
  $ratePlanOthers = modNonMedical.GetDiscBindBillMode(cmbdiscother.Text)
  If Not $ratePlanOthers Then
    $ratePlanOthers = modpatient.GetPatBillingMode($encid)
  Endif

  txtpatientname.Text = modPatient.GetPatientNameByEnc($encid)
  $PatientNum = modPatient.GetPatientNoByEnc($encid)
  $xNHISCode = modPatient.GetPatientExtCOdebyEnc($encid)

  $xFinClear = modNonMedical.GetFinanceClearance($encid)
  btnrefer.Tag = modBillings.GetReferralUserSetting("Service", $encid)
  If btnrefer.Tag Then
    btnrefer.Text = modGeneral.GetUserFullName(btnrefer.Tag)
  Endif
  If modBasic.$ReferralLockEntry = "Yes" Then
    btnrefer.Enabled = False
  Endif
  rbcategory.Value = True
  GetFirstList()

  FillLabtable()
  CompleteGrid()
  If $xFinClear = True Then
    btnaddone.Enabled = False
  Endif

End

Public Sub Form_KeyRelease()

  If Key.Code = Key.Esc Then
    Me.Close
  Endif

End

Public Sub btnrefer_Click()

  Dim xMedUser As String[]

  xMedUser = MedicalSelectedValue(("Select Consultant"), modBasic.$OPConsulUserList)
  If xMedUser And If xMedUser.Count Then
    btnrefer.Tag = xMedUser[0]
    btnrefer.Text = xMedUser[1]
  Else
    btnrefer.Tag = ""
    btnrefer.Text = ""
  Endif

End

Public Sub btnrefer_Change()

  If btnrefer.Text = "" Then
    btnrefer.Tag = ""
  Endif

End

Public Sub btnsms_Click()

  If btnrefer.Tag Then
    modDevice.SendMessageToRegistPhysician($encid, btnrefer.Tag)
  Endif

End

Public Sub cmbdiscservice_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscservice)
  modFillContainer.RestrictComboToContent(cmbdiscservice)

End

Public Sub cmbdiscprocedure_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscprocedure)
  modFillContainer.RestrictComboToContent(cmbdiscprocedure)

End

Public Sub cmbdiscother_KeyRelease()

  modFillContainer.AutoFillComboBox(cmbdiscother)
  modFillContainer.RestrictComboToContent(cmbdiscother)

End

Public Sub cmbdiscservice_Click()

  If cmbdiscservice.Text Then
    $ratePlanService = modNonMedical.GetDiscBindBillMode(cmbdiscservice.Text)
    If Not $ratePlanService Then
      $ratePlanService = modpatient.GetPatBillingMode($encid)
    Endif
    GetFirstList()
  Endif

End

Public Sub cmbdiscprocedure_Click()

  If cmbdiscprocedure.Text Then
    $ratePlanProcedure = modNonMedical.GetDiscBindBillMode(cmbdiscprocedure.Text)
    If Not $ratePlanProcedure Then
      $ratePlanProcedure = modpatient.GetPatBillingMode($encid)
    Endif
    GetFirstList()
  Endif

End

Public Sub cmbdiscother_Click()

  If cmbdiscother.Text Then
    $ratePlanOthers = modNonMedical.GetDiscBindBillMode(cmbdiscother.Text)
    If Not $ratePlanOthers Then
      $ratePlanOthers = modpatient.GetPatBillingMode($encid)
    Endif
    GetFirstList()
  Endif

End

Private Sub GetFirstList()

  Dim res1 As Result
  Dim res2 As Result
  Dim res3 As Result

  If rbcategory.Value = True Then
    cmbsection.List = ["General Services", "Procedures", "Other Items"]
  Else If rbsection.Value = True Then
    res1 = modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3", $ratePlanService, "Active", "General Services")
    res2 = modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3", $ratePlanProcedure, "Active", "Procedures")
    res3 = modDatabase.$myConn.Exec("select distinct(fldreport) as col from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3", $ratePlanOthers, "Active", "Other Items")
    cmbsection.List = GetTriColumnList(res1, res2, res3)
  Else If rbgroup.Value = True Then
    res1 = modDatabase.$myConn.Exec("select distinct(fldbillitem) as col from tblservicecost where fldgroup=&1 and fldbillitem IS NOT NULL and fldstatus=&2 and flditemtype=&3", $ratePlanService, "Active", "General Services")
    res2 = modDatabase.$myConn.Exec("select distinct(fldbillitem) as col from tblservicecost where fldgroup=&1 and fldbillitem IS NOT NULL and fldstatus=&2 and flditemtype=&3", $ratePlanProcedure, "Active", "Procedures")
    res3 = modDatabase.$myConn.Exec("select distinct(fldbillitem) as col from tblservicecost where fldgroup=&1 and fldbillitem IS NOT NULL and fldstatus=&2 and flditemtype=&3", $ratePlanOthers, "Active", "Other Items")
    cmbsection.List = GetTriColumnList(res1, res2, res3)
  Else If rbcashpack.Value = True Then
    res1 = modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblservicegroup where flditemname in(select flditemname from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3)", $ratePlanService, "Active", "General Services")
    res2 = modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblservicegroup where flditemname in(select flditemname from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3)", $ratePlanProcedure, "Active", "Procedures")
    res3 = modDatabase.$myConn.Exec("select distinct(fldgroup) as col from tblservicegroup where flditemname in(select flditemname from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3)", $ratePlanOthers, "Active", "Other Items")
    cmbsection.List = GetTriColumnList(res1, res2, res3)
  Endif
  If cmbsection.List.Count Then
    cmbsection.Index = 0
  Endif

End

Private Function GetTriColumnList(res1 As Result, res2 As Result, res3 As Result) As String[]

  Dim aList As String[]
  Dim bList As String[]
  Dim cList As String[]

  Dim xList As String[]
  Dim yList As String[]

  xList = New String[]

  aList = modControlSub.GetDirectFillresultNoNull(res1)
  If aList And If aList.Count Then
    xList.Insert(aList)
  Endif

  bList = modControlSub.GetDirectFillresultNoNull(res2)
  If bList And If bList.Count Then
    xList.Insert(bList)
  Endif

  cList = modControlSub.GetDirectFillresultNoNull(res3)
  If cList And If cList.Count Then
    xList.Insert(cList)
  Endif

  yList = modString.GetDistinctStringArray(xList)
  Return yList

End

Public Sub rbcategory_Click()

  GetFirstList()
  chkall.Enabled = False

End

Public Sub rbsection_Click()

  GetFirstList()
  chkall.Enabled = False

End

Public Sub rbgroup_Click()

  GetFirstList()
  chkall.Enabled = False

End

Public Sub rbcashpack_Click()

  GetFirstList()
  chkall.Enabled = True

End

Public Sub cmbsection_Click()

  If cmbsection.Text Then
    LoadItemList()
  Endif

End

Public Sub txtsearch_Change()

  Dim xVar As Variant[]

  xVar = modString.SelectStringVariantToText($allVar, CStr(1), txtsearch.Text, chkleftmain.Value)
  LoadSelectGridView(xVar)

End

Private Sub LoadItemList()

  Dim res As Result
  Dim res1 As Result
  Dim res2 As Result
  Dim res3 As Result

  $allVar = New Variant[]
  If rbcategory.Value = True Then
    If cmbsection.Text = "General Services" Then
      res = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 ORDER BY flditemname", $ratePlanService, "Active", "General Services")
    Else If cmbsection.Text = "Procedures" Then
      res = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures")
    Else If cmbsection.Text = "Other Items" Then
      res = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items")
    Endif
    modTextDB.COnvertResultToCollection(res, $allVar)

  Else If rbsection.Value = True Then
    res1 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldreport=&4 ORDER BY flditemname", $ratePlanService, "Active", "General Services", cmbsection.Text)
    If res1.Available Then
      modTextDB.COnvertResultToCollection(res1, $allVar)
    Endif
    res2 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldreport=&4 ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures", cmbsection.Text)
    If res2.Available Then
      modTextDB.COnvertResultToCollection(res2, $allVar)
    Endif
    res3 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldreport=&4 ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items", cmbsection.Text)
    If res3.Available Then
      modTextDB.COnvertResultToCollection(res3, $allVar)
    Endif

  Else If rbgroup.Value = True Then
    res1 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldbillitem=&4 ORDER BY flditemname", $ratePlanService, "Active", "General Services", cmbsection.Text)
    If res1.Available Then
      modTextDB.COnvertResultToCollection(res1, $allVar)
    Endif
    res2 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldbillitem=&4 ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures", cmbsection.Text)
    If res2.Available Then
      modTextDB.COnvertResultToCollection(res2, $allVar)
    Endif
    res3 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and fldbillitem=&4 ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items", cmbsection.Text)
    If res3.Available Then
      modTextDB.COnvertResultToCollection(res3, $allVar)
    Endif

  Else If rbcashpack.Value = True Then
    res1 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and flditemname in(select flditemname from tblservicegroup where fldgroup=&4) ORDER BY flditemname", $ratePlanService, "Active", "General Services", cmbsection.Text)
    If res1.Available Then
      modTextDB.COnvertResultToCollection(res1, $allVar)
    Endif
    res2 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and flditemname in(select flditemname from tblservicegroup where fldgroup=&4) ORDER BY flditemname", $ratePlanProcedure, "Active", "Procedures", cmbsection.Text)
    If res2.Available Then
      modTextDB.COnvertResultToCollection(res2, $allVar)
    Endif
    res3 = modDatabase.$myConn.Exec("select flditemname,flditemname,flditemtype,fldgroup from tblservicecost where fldgroup=&1 and fldstatus=&2 and flditemtype=&3 and flditemname in(select flditemname from tblservicegroup where fldgroup=&4) ORDER BY flditemname", $ratePlanOthers, "Active", "Other Items", cmbsection.Text)
    If res3.Available Then
      modTextDB.COnvertResultToCollection(res3, $allVar)
    Endif

  Endif

  LoadSelectGridView($allVar)

End

Private Sub LoadSelectGridView(sVar As Variant[])

  $GridVar = sVar
  GridView3.Clear()
  GridView3.Columns.Count = 4
  GridView3.Rows.Count = $GridVar.Count
  With GridView3
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 35 * modBasic.$AppWidthRatio
    .Columns[1].Expand = True
    .Columns[2].Width = 1
    .Columns[3].Width = 1
  End With

End

Public Sub GridView3_Data(Row As Integer, Column As Integer)

  modGeneralMain.GridViewDecoration(GridView3, Row)
  If Column = 0 Then
    GridView3.Data.Picture = Picture["icons/unchecked.png"]
  Else If Column = 1 Then
    GridView3.Data.Text = $GridVar[Row][CStr(Column)]
    GridView3.Rows[Row].Height = Max(GridView3.Rows[Row].Height, GridView3.Data.Font.RichTextHeight(GridView3.Data.Text, GridView3.Columns[Column].Width - 5 * modBasic.$AppWidthRatio) + (GridView3.Rows.Height - GridView3.Font.Height))
  Else
    GridView3.Data.Text = $GridVar[Row][CStr(Column)]
  Endif
  GridView3.Data.WordWrap = True

End

Public Sub GridView3_Select()

  Dim xform As String
  Dim xpackg As String
  Dim xdate As Date

  If GridView3.Rows.Selection.Count Then
    xform = modNonMedical.GetServiceKeyFromCategory($GridVar[GridView3.Row][CStr(2)])
    If xform = "Service" Then
      xpackg = cmbdiscservice.Text
    Else If xform = "Procedure" Then
      xpackg = cmbdiscprocedure.Text
    Else If xform = "Others" Then
      xpackg = cmbdiscother.Text
    Endif
    xdate = modBillings.CheckLastSalesItemDate(GridView3[GridView3.Row, 1].Text, $PatientNum, $xNHISCode, xpackg)
    If xdate Then
      txtlastsaledate.Text = modReportVar.GetDateTimeReport(xdate, gb.MediumDate)
      If DateDiff(xdate, Now(), gb.Month) <= 3 Then
        txtlastsaledate.Foreground = Color.Red
      Else
        txtlastsaledate.Foreground = Color.Default
      Endif
    Else
      txtlastsaledate.Text = ""
      txtlastsaledate.Foreground = Color.Default
    Endif
  Endif

End

Public Sub GridView3_Click()

  If GridView3.Column = 0 Then
    modGridView.CheckUncheckGridNoDB(GridView3, 0)
  Endif

End

Public Sub chkall_Click()

  Dim Row As Integer

  For Row = 0 To GridView3.Rows.Count - 1
    If GridView3[Row, 0].Picture = Picture["icons/unchecked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/checked.png"]
    Else If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then
      GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
    Endif
  Next

End

Public Sub btnaddone_Click()

  Dim xList As String[]
  Dim Row As Integer

  If GridView3.Rows.Selection.Count Then
    If modMisc.AllowDiagnoBilling($encid) = True Then
      For Row = 0 To GridView3.Rows.Count - 1
        If GridView3[Row, 0].Picture = Picture["icons/checked.png"] Then

          xList = modControlSub.GetDirectFillresult(modDatabase.$myConn.Exec("select distinct(flditemname) as col from tblpatbilling where fldencounterval=&1 and flditemname in(select flditemname as col from tblservicecost where flditemtype=&2 and (fldtarget=&3 or fldtarget=&4))", $encid, "Procedures", "Major", "Intermediate"))
          If modMisc.GetDuplicationAllow(xList, GridView3[Row, 1].Text, btnaddone) = True Then
            InsertClinicService(GridView3[Row, 2].Text, GridView3[Row, 1].Text, 1)
          Endif

          GridView3[Row, 0].Picture = Picture["icons/unchecked.png"]
        Endif
      Next
      FillLabtable()
    Else
      Message.Warning("Diagnosis not provided", ("OK"))
    Endif
  Endif

End

Private Sub InsertClinicService(sCateg As String, sItem As String, sQty As Float)

  Dim xform As String
  Dim xauto As String
  Dim xrefer As String
  Dim xpayble As String
  Dim xpackg As String

  xform = modNonMedical.GetServiceKeyFromCategory(sCateg)
  If xform = "Service" Then
    xauto = modBasic.$AutoBillService
    xpackg = cmbdiscservice.Text
  Else If xform = "Procedure" Then
    xauto = modBasic.$AutoBillProcedure
    xpackg = cmbdiscprocedure.Text
  Else If xform = "Others" Then
    xauto = modBasic.$AutoBillOthers
    xpackg = cmbdiscother.Text
  Endif

  If xauto Then
    If xauto = "Standard" Or If xauto = "Full" Or If xauto = "Partial" Then
      If btnrefer.Tag Then
        xrefer = btnrefer.Tag
      Else
        xrefer = modBillings.GetReferralUserSetting(xform, $encid)
      Endif
      xpayble = modBillings.GetPayableUserSetting(xform, $encid)
      modBillings.GetAutoBillingClinic($encid, xpackg, xform, sItem, sQty, "Punched", 0, False, False, xpayble, xrefer)
    Endif
  Endif

End

Public Sub FillLabtable()

  Dim sql As String
  Dim Column As Integer
  Dim fld As ResultField
  Dim res As Result

  sql = "select fldid,flditemname,fldid,flditemqty,fldordtime from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and (flditemtype=&6 or flditemtype=&7 or flditemtype=&8)"                                             ''
  res = modDatabase.$myConn.Exec(sql, $encid, False, False, modBasic.$compID, "Punched", "General Services", "Procedures", "Other Items")

  GridView1.Clear
  GridView1.Columns.Count = res.Fields.Count
  GridView1.Rows.Count = res.Count

  For Each res
    Column = 0
    For Each fld In res.Fields
      modGeneralMain.GridExplicitDecoration(GridView1, res.Index, Column)
      If Column = 4 Then
        GridView1[res.Index, Column].Text = modReportVar.GetDateTimeReport(res["fldordtime"], gb.GeneralDate)
      Else If Column = 2 Then
        GridView1[res.Index, Column].Picture = Picture["icon:/tiny/cancel"]
        GridView1[res.Index, Column].Text = ""
      Else
        GridView1[res.Index, Column].Text = res[fld.Name]
      Endif
      Column = Column + 1
    Next
  Next
  GridView1.Row = 0

  With GridView1
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 300 * modBasic.$AppWidthRatio
    .Columns[2].Width = 25 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 150 * modBasic.$AppWidthRatio

    .Columns[1].Text = "Particulars"
    .Columns[3].Text = "QTY"
    .Columns[4].Text = "DateTime"
  End With

End

Public Sub GridView1_Click()

  If GridView1.Column = 2 Then
    If Message.Question(("Are you sure?"), ("No"), ("Yes")) = 2 Then
      modDatabase.$myConn.Delete("tblpatbilling", "fldid=&1 and fldsave=&2", GridView1[GridView1.Row, 0].Text, False)
      FillLabtable()
    Endif
  Endif

End

Public Sub btnsave_Click()

  Dim xform As String
  Dim res As Result
  Dim xauto As String
  Dim xadv As String

  Inc Application.Busy
  res = modDatabase.$myConn.Edit("tblpatbilling", "fldencounterval=&1 and fldsave=&2 and fldprint=&3 and fldordcomp like &4 and fldstatus=&5 and (flditemtype=&6 or flditemtype=&7 or flditemtype=&8)", $encid, False, False, modBasic.$compID, "Punched", "General Services", "Procedures", "Other Items")                 ''
  If res.Available Then
    If modBasic.$AutoBillAdvReceipt = "Enable" Then
      xadv = modBillLock.AdvanceReceiptString("Advance Receipt")
    Else
      xadv = ""
    Endif

    For Each res
      xform = modNonMedical.GetServiceKeyFromCategory(res["flditemtype"])
      If xform = "Service" Then
        xauto = modBasic.$AutoBillService
      Else If xform = "Procedure" Then
        xauto = modBasic.$AutoBillProcedure
      Else If xform = "Others" Then
        xauto = modBasic.$AutoBillOthers
      Endif

      If xauto = "Standard" Then
        If modNonMedical.AllowPreCheckDeposit($encid, res["fldditemamt"], res["fldbilltype"]) = True Then
          SavePartialEntry(res, xadv)
        Endif
      Else If xauto = "Full" Then
        If modNonMedical.AllowPreEntryWithDeposit($encid, xform, res["fldditemamt"], res["fldbilltype"], btnsave) = True Then
          SavePartialEntry(res, xadv)
        Endif
      Else
        If modBasic.$AutoBillSaveZero = "Yes" And If res["flditemrate"] = 0 Then
          SavePartialEntry(res, xadv)
        Else If modBasic.$AutoBillSaveZero = "Yes" And If res["flddiscper"] = 100 Then
          SavePartialEntry(res, xadv)
        Else If modBasic.$AutoBillSaveFullCredit = "Yes" And If res["fldbilltype"] = "Credit" And If res["fldcashincredit"] = 0 Then
          SavePartialEntry(res, xadv)
        Endif
      Endif

    Next
  Endif
  Dec Application.Busy
  FillLabtable()
  CompleteGrid()

End

Private Sub SavePartialEntry(res As Result, Optional advReceipt As String)

  res["fldstatus"] = "Done"
  If advReceipt Then
    res["fldextracol"] = advReceipt
  Endif
  res["fldsave"] = True
  res["flduserid"] = modBasic.$lbluser
  res["fldtime"] = Now()
  res["fldcomp"] = modBasic.$compID
  res["xyz"] = False
  res.Update()

End

''================= Completed Tab =========================
Private Sub CompleteGrid()

  Dim sql As String

  sql = "select fldid,fldordtime,flditemname,flditemqty,fldid,flditemtype,flddisctype from tblpatbilling where fldencounterval=&1 and fldsave=&2 and fldordcomp like &3 and (flditemtype=&4 or flditemtype=&5 or flditemtype=&6)"
  $rData2 = modDatabase.$myConn.Exec(sql, $encid, True, modBasic.$compID, "General Services", "Procedures", "Other Items")
  $aMyFields2 = New String[]
  modGridView.ReadSmallData(GridView2, $rData2, $aMyFields2)

  With GridView2
    .Rows.Height = modBasic.$AppGridRowHeight
    .Columns[0].Width = 1
    .Columns[1].Width = 150 * modBasic.$AppWidthRatio
    .Columns[2].Width = 350 * modBasic.$AppWidthRatio
    .Columns[3].Width = 50 * modBasic.$AppWidthRatio
    .Columns[4].Width = 1
    .Columns[5].Width = 150 * modBasic.$AppWidthRatio
    .Columns[6].Width = 150 * modBasic.$AppWidthRatio

    .Columns[1].Text = "DateTime"
    .Columns[2].Text = "Particulars"
    .Columns[3].Text = "QTY"
    .Columns[5].Text = "Category"
    .Columns[6].Text = "Scheme"
  End With

End

Public Sub GridView2_Data(Row As Integer, Column As Integer)

  $rData2.MoveTo(Row)
  modGeneralMain.GridViewDecoration(GridView2, Row)
  If Column = 1 Then
    GridView2.Data.Text = modReportVar.GetDateTimeReport($rData2[$aMyFields2[Column]], gb.GeneralDate)
  Else
    GridView2.Data.Text = $rData2[$aMyFields2[Column]]
  Endif

End
