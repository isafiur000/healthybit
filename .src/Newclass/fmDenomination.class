' Gambas class file

Private $xConv As Float
Private $sValue As Variant[]
Private $sColl As Collection

Public Sub Run(sConv As Float) As Variant[]

  $xConv = sConv
  If Me.ShowModal() Then Return $sValue

End

Public Sub Form_Open()

  txtconversion.Value = $xConv
  $sColl = New Collection

End

Public Function valuegroup_Change()

  Dim xcont As Control
  Dim xvalubox As ValueBox
  Dim xtot As Float

  xtot = 0
  For Each xcont In Me.Controls
    If xcont Is ValueBox Then
      xvalubox = xcont
      If xvalubox.Tag Then
        If xvalubox.Value Then
          xtot = xtot + modMisc.GetDenominationValue(xvalubox.Tag, txtconversion.Value) * xvalubox.Value
        Endif
      Endif
    Endif
  Next
  txttotalval.Value = xtot

End

Public Sub btnsave_Click()

  Dim xcont As Control
  Dim xvalubox As ValueBox
  Dim xVar As Variant[]

  For Each xcont In Me.Controls
    If xcont Is ValueBox Then
      xvalubox = xcont
      If xvalubox.Tag Then
        If xvalubox.Value Then
          $sColl.Add(xvalubox.Value, xvalubox.Tag)
        Endif
      Endif
    Endif
  Next
  xVar = New Variant[]
  xVar.Add(txttotalval.Value)
  xVar.Add(JSON.Encode($sColl))
  $sValue = xVar
  Me.Close(True)

End

Public Sub btnclear_Click()

  Dim xcont As Control
  Dim xvalubox As ValueBox

  For Each xcont In Me.Controls
    If xcont Is ValueBox Then
      xvalubox = xcont
      xvalubox.Value = 0
    Endif
  Next

End
